<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×©×¢×•×ª - ×˜×›× ×•×“×¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- SheetJS with Style support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Default Theme Colors */
            --bg-color: #0a0e27;
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --card-bg: #1a1f3a;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --text-primary: #e4e7eb;
            --text-secondary: #9ca3af;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        /* Light Theme */
        body[data-theme="light"] {
            --bg-color: #f1f5f9;
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --card-bg: #ffffff;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border-color: rgba(100, 116, 139, 0.2);
        }

        /* Purple Theme */
        body[data-theme="purple"] {
            --bg-color: #1e1b2e;
            --primary-color: #9333ea;
            --secondary-color: #ec4899;
            --card-bg: #2d2640;
        }

        /* Green Theme */
        body[data-theme="green"] {
            --bg-color: #0a1f1a;
            --primary-color: #10b981;
            --secondary-color: #059669;
            --card-bg: #1a2f2a;
        }

        /* Orange Theme */
        body[data-theme="orange"] {
            --bg-color: #1a0f0a;
            --primary-color: #f97316;
            --secondary-color: #ea580c;
            --card-bg: #2a1f1a;
        }

        /* Custom Theme - Will be dynamically set */
        body[data-theme="custom"] {
            --bg-color: var(--custom-bg-color, #0a0e27);
            --primary-color: var(--custom-primary-color, #3b82f6);
            --secondary-color: var(--custom-secondary-color, #8b5cf6);
            --card-bg: var(--custom-card-bg, #1a1f3a);
        }

        body {
            font-family: 'Bricolage Grotesque', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-container {
            max-width: 550px;
            width: 90%;
            margin: 0 auto;
            padding: 60px 70px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .login-header img {
            width: 180px;
            height: 180px;
            object-fit: contain;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .login-header p {
            font-size: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .error-message,
        .success-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--error-color);
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            width: 100%;
            text-align: center;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success-color);
        }

        .error-message.show,
        .success-message.show {
            display: block;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Bricolage Grotesque', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
        }

        .google-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            font-size: 16px;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .login-footer {
            margin-top: 30px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* App Container */
        .app-container {
            max-width: 1400px;
            width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--card-bg) 0%, #151829 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px 40px;
            margin-bottom: 30px;
            position: relative;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 16px 16px 0 0;
        }

        .datetime-display {
            position: absolute;
            top: 10px;
            right: 40px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .greeting {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .user-name {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
        }

        body[data-theme="light"] .user-name {
            color: #1e293b;
        }

        .logo-small {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-color: transparent;
            color: #ffffff;
        }

        .logout-btn {
            padding: 12px 24px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: var(--error-color);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Statistics Navigation Buttons */
        .stats-nav-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .stats-nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .stats-nav-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .stats-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chart Period Buttons */
        .chart-period-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-period-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .chart-period-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* Chart Cards */
        .chart-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .line-chart-container,
        .bar-chart-container,
        .pie-chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }

        /* Content Area */
        .app-content {
            background: linear-gradient(135deg, var(--card-bg) 0%, #151829 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Month Navigation */
        .content-header {
            margin-bottom: 30px;
        }

        .month-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .month-nav-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body[data-theme="light"] .month-nav-btn {
            background: #ffffff;
            border: 1px solid #cbd5e1;
        }

        .month-nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .month-nav-btn.export-enabled {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .month-nav-btn.export-enabled:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        body[data-theme="light"] .month-nav-btn:hover {
            background: #e2e8f0;
        }

        .month-title {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            min-width: 200px;
            text-align: center;
        }

        body[data-theme="light"] .month-title {
            color: #1e293b;
        }

        /* Timesheet Table */
        .timesheet-container {
            margin-bottom: 30px;
        }

        .table-wrapper {
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(15, 23, 42, 0.5);
        }

        .timesheet-table thead {
            background: rgba(15, 23, 42, 0.8);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .timesheet-table th {
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            background: rgba(15, 23, 42, 0.95);
        }

        .timesheet-table th.sticky-col {
            position: sticky;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 11;
        }

        .timesheet-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            transition: background 0.2s ease;
        }

        .timesheet-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .timesheet-table td {
            padding: 8px 6px;
            text-align: center;
            font-size: 13px;
            color: var(--text-primary);
        }

        .timesheet-table td.sticky-col {
            position: sticky;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            font-weight: 600;
        }

        body[data-theme="light"] .timesheet-table td.sticky-col {
            background: rgba(241, 245, 249, 0.98);
        }

        body[data-theme="light"] .timesheet-table th.sticky-col {
            background: rgba(226, 232, 240, 0.98);
        }

        .timesheet-table td.total-col {
            font-weight: 700;
            color: var(--accent-color);
        }

        .timesheet-table select {
            width: 60px;
            padding: 4px 6px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Bricolage Grotesque', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timesheet-table select:hover {
            background: rgba(15, 23, 42, 1);
            border-color: var(--primary-color);
        }

        .timesheet-table select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .morning-section {
            background: rgba(59, 130, 246, 0.05);
            border-left: 2px solid rgba(59, 130, 246, 0.3);
        }

        .morning-section:first-of-type {
            border-right: 3px solid rgba(59, 130, 246, 0.5);
        }

        .afternoon-section {
            background: rgba(245, 158, 11, 0.05);
            border-left: 2px solid rgba(245, 158, 11, 0.3);
        }

        .afternoon-section:first-of-type {
            border-right: 3px solid rgba(245, 158, 11, 0.5);
        }

        .shift-label {
            font-weight: 700;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.08);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .shift-label.morning {
            color: #60a5fa;
            border-right: 3px solid rgba(59, 130, 246, 0.5);
        }

        .shift-label.afternoon {
            color: #fbbf24;
            border-right: 3px solid rgba(245, 158, 11, 0.5);
        }

        thead .morning-section:first-of-type {
            border-right: 3px solid rgba(59, 130, 246, 0.5);
        }

        thead .afternoon-section:first-of-type {
            border-right: 3px solid rgba(245, 158, 11, 0.5);
        }

        .edited-cell {
            background: rgba(139, 92, 246, 0.1) !important;
            border: 1px solid rgba(139, 92, 246, 0.3);
            position: relative;
        }

        .edited-cell::after {
            content: 'ğŸ“';
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
        }

        .has-hours-select:not(:focus) {
            background: rgba(16, 185, 129, 0.25) !important;
            border: 2px solid rgba(16, 185, 129, 0.5) !important;
            font-weight: 700;
        }

        body[data-theme="light"] .has-hours-select:not(:focus) {
            background: rgba(16, 185, 129, 0.15) !important;
            border: 2px solid rgba(16, 185, 129, 0.6) !important;
        }

        .coord-edited-select:not(:focus) {
            background: rgba(59, 130, 246, 0.25) !important;
            border: 2px solid rgba(59, 130, 246, 0.5) !important;
            font-weight: 700;
        }

        body[data-theme="light"] .coord-edited-select:not(:focus) {
            background: rgba(59, 130, 246, 0.15) !important;
            border: 2px solid rgba(59, 130, 246, 0.6) !important;
        }

        /* Fix for select dropdown options visibility */
        select option {
            background: #1e293b;
            color: #e2e8f0;
        }

        body[data-theme="light"] select option {
            background: #ffffff;
            color: #1e293b;
        }

        .subject-header {
            border-left: 1px solid var(--border-color);
        }

        .subject-name {
            font-size: 12px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 3px;
        }

        body[data-theme="light"] .subject-name {
            color: #1e293b;
        }

        .subject-types {
            display: flex;
            gap: 4px;
            justify-content: center;
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Monthly Summary */
        .monthly-summary {
            margin-bottom: 30px;
        }

        .monthly-summary h3 {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        body[data-theme="light"] .monthly-summary h3 {
            color: #1e293b;
        }

        .summary-table-wrapper {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(15, 23, 42, 0.5);
        }

        .summary-table thead {
            background: rgba(15, 23, 42, 0.8);
        }

        .summary-table th {
            padding: 16px 20px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .summary-table td {
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .summary-table tfoot {
            background: rgba(15, 23, 42, 0.8);
        }

        .summary-table tfoot td {
            font-weight: 700;
            font-size: 18px;
            color: var(--accent-color);
            border-bottom: none;
        }

        /* Submit Buttons */
        .submit-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .submit-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Bricolage Grotesque', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Personal Tab */
        .personal-card {
            max-width: 800px;
            margin: 0 auto;
        }

        .personal-card h2 {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 24px;
        }

        body[data-theme="light"] .personal-card h2 {
            color: #1e293b;
        }

        .personal-info {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .info-row {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .info-section {
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .info-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
        }

        body[data-theme="light"] .info-section h3 {
            color: #1e293b;
        }

        .subjects-list,
        .coordinators-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subjects-list li,
        .coordinators-list li {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subjects-list li::before {
            content: 'â€¢';
            color: var(--primary-color);
            font-size: 20px;
        }

        .coordinators-list li::before {
            content: 'ğŸ‘¤';
            font-size: 16px;
        }

        /* Settings Tab */
        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section h2 {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
        }

        body[data-theme="light"] .settings-section h2 {
            color: #1e293b;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .theme-card {
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .theme-card.selected {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .theme-preview {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .theme-color {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-name {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            text-align: center;
        }

        body[data-theme="light"] .theme-name {
            color: #1e293b;
        }

        .radio-label {
            display: flex;
            justify-content: center;
        }

        .radio-label input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Backups */
        .backups-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .backup-item {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backup-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .backup-action {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
        }

        body[data-theme="light"] .backup-action {
            color: #1e293b;
        }

        .backup-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .restore-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .no-backups {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: #ffffff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                padding: 20px;
            }
            
            .datetime-display {
                position: static;
                margin-bottom: 10px;
            }
            
            .app-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-header">
            <img src="https://media.getmood.io/warehouse/dynamic/217495.png" alt="×˜×›× ×•×“×¢">
            <h1>××¢×¨×›×ª × ×™×”×•×œ ×©×¢×•×ª</h1>
            <p>×˜×›× ×•×“×¢</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <button class="btn google-btn" id="googleSignInBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            ×”×ª×—×‘×¨ ×¢× Google
        </button>

        <div class="login-footer">
            <p>Â© 2025 ×˜×›× ×•×“×¢ - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="app-header">
            <div class="header-content">
                <!-- Right Side: User Info -->
                <div class="header-right">
                    <div class="user-info" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button id="versionBtn" style="background: rgba(99, 102, 241, 0.15); border: 1px solid rgba(99, 102, 241, 0.3); padding: 4px 12px; border-radius: 8px; color: var(--accent-color); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'Bricolage Grotesque', sans-serif;" onmouseover="this.style.background='rgba(99, 102, 241, 0.25)'" onmouseout="this.style.background='rgba(99, 102, 241, 0.15)'">
                                v2.2
                            </button>
                            <span class="greeting">×©×œ×•×</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="userProfileImage" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid var(--accent-color); flex-shrink: 0; display: none;">
                                <img id="userProfileImg" src="" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <span class="user-name" id="userName">××©×ª××©</span>
                        </div>
                    </div>
                </div>

                <!-- Center: Navigation -->
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="timesheet">×“×™×•×•×— ×©×¢×•×ª</button>
                    <button class="nav-tab" data-tab="personal">× ×ª×•× ×™× ××™×©×™×™×</button>
                    <!-- Instructor statistics tab -->
                    <button class="nav-tab" data-tab="statistics" style="display:none;">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
                    <!-- Coordinator tabs -->
                    <button class="nav-tab" data-tab="manage-instructors" style="display:none;">× ×™×”×•×œ ××“×¨×™×›×™×</button>
                    <button class="nav-tab" data-tab="approvals" style="display:none;">×“×™×•×•×—×™× ×œ××“×¨×™×›×™× ×©×œ×™</button>
                    <!-- Finance tabs -->
                    <button class="nav-tab" data-tab="finance-reports" style="display:none;">ğŸ’° ×“×•×—×•×ª ×œ××™×©×•×¨</button>
                    <button class="nav-tab" data-tab="finance-status" style="display:none;">ğŸ“Š ×¡×˜×˜×•×¡ ×“×™×•×•×—×™×</button>
                    <button class="nav-tab" data-tab="finance-notifications" style="display:none; position: relative;">
                        ğŸ”” ×”×ª×¨××•×ª
                        <span id="notificationBadge" style="display: none; position: absolute; top: -4px; left: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-color);">0</span>
                    </button>
                    <!-- Admin tabs -->
                    <button class="nav-tab" data-tab="admin-manage-users" style="display:none;">ğŸ‘¨â€ğŸ’¼ × ×™×”×•×œ ××“×¨×™×›×™×</button>
                    <button class="nav-tab" data-tab="admin-manage-coordinators" style="display:none;">ğŸ‘” × ×™×”×•×œ ×¨×›×–×™×</button>
                    <button class="nav-tab" data-tab="admin-manage-finance" style="display:none;">ğŸ’° × ×™×”×•×œ ×× ×”×œ×•×ª ×›×¡×¤×™×</button>
                    <button class="nav-tab" data-tab="admin-manage-departments" style="display:none;">ğŸ¢ × ×™×”×•×œ ××—×œ×§×•×ª</button>
                    <button class="nav-tab" data-tab="settings">×”×’×“×¨×•×ª</button>
                </nav>

                <!-- Left Side: DateTime, Logo and Logout -->
                <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div class="datetime-display" id="datetimeDisplay" style="position: static; transform: none;"></div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <img class="logo-small" src="https://media.getmood.io/warehouse/dynamic/217495.png" alt="×˜×›× ×•×“×¢" style="height: 45px;">
                        <button class="logout-btn" id="logoutBtn">×™×¦×™××”</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-content">
            <!-- Timesheet Tab -->
            <div class="tab-content active" id="timesheetTab">
                <div class="content-header">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <!-- Export Button (Left) -->
                        <button id="exportInstructorTimesheetBtn" class="month-nav-btn" style="position: relative; opacity: 0.5; cursor: not-allowed;" disabled title="×™×™×¦×•× ×œ××§×¡×œ ××ª×‘×¦×¢ ×¨×§ ×¢× ×©×™×’×•×¨ ×œ×¨×›×–">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>

                        <!-- Month Navigation (Center) -->
                        <div class="month-navigation">
                            <button class="month-nav-btn" id="prevMonthBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                            <h2 class="month-title" id="currentMonthTitle">× ×•×‘××‘×¨ 2025</h2>
                            <button class="month-nav-btn" id="nextMonthBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                        </div>

                        <!-- Placeholder for symmetry (Right) -->
                        <div style="width: 40px;"></div>
                    </div>
                </div>

                <div class="timesheet-container">
                    <div class="table-wrapper">
                        <table class="timesheet-table" id="timesheetTable">
                            <thead><tr><th class="sticky-col">×ª××¨×™×š</th><th class="sticky-col">××©××¨×ª</th></tr></thead>
                            <tbody id="timesheetTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="monthly-summary">
                    <h3>×¡×™×›×•× ×—×•×“×©×™</h3>
                    <div class="summary-table-wrapper">
                        <table class="summary-table">
                            <thead>
                                <tr><th>××§×¦×•×¢</th><th>×”×“×¨×›×”</th><th>×”×©×ª×œ××•×ª</th><th>×¡×”"×›</th></tr>
                            </thead>
                            <tbody id="summaryTableBody"></tbody>
                            <tfoot>
                                <tr><td>×¡×”"×›</td><td id="totalTeaching">0</td><td id="totalTraining">0</td><td id="totalHours">0</td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="submit-buttons" id="submitButtons"></div>
            </div>

            <!-- Personal Tab -->
            <div class="tab-content" id="personalTab">
                <div class="personal-card">
                    <h2>ğŸ“‹ × ×ª×•× ×™× ××™×©×™×™×</h2>
                    <div class="personal-info">
                        <div class="info-row">
                            <span class="info-label">×©×:</span>
                            <span class="info-value" id="personalName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">××™×™×œ:</span>
                            <span class="info-value" id="personalEmail">-</span>
                        </div>
                        <div class="info-section">
                            <h3>×¢×•×‘×“ ×‘×‘×•×§×¨ ×‘:</h3>
                            <ul class="subjects-list" id="morningSubjects"></ul>
                        </div>
                        <div class="info-section">
                            <h3>×¢×•×‘×“ ××—×”"×¦ ×‘:</h3>
                            <ul class="subjects-list" id="afternoonSubjects"></ul>
                        </div>
                        <div class="info-section">
                            <h3>×¨×›×–×™× ××©×•×™×›×™×:</h3>
                            <ul class="coordinators-list" id="assignedCoordinators"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab (Instructor Only) -->
            <div class="tab-content" id="statisticsTab" style="display: none;">
                <div class="statistics-container">
                    <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 32px; text-align: center; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª
                    </h1>

                    <!-- Sub Navigation for Statistics -->
                    <div class="statistics-nav" style="display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap; justify-content: center;">
                        <button class="stats-nav-btn active" data-stats-tab="overview">
                            ğŸ  ×¡×§×™×¨×” ×›×œ×œ×™×ª
                        </button>
                        <button class="stats-nav-btn" data-stats-tab="charts">
                            ğŸ“ˆ ×’×¨×¤×™× ×•××’××•×ª
                        </button>
                        <button class="stats-nav-btn" data-stats-tab="subjects">
                            ğŸ“š × ×™×ª×•×— ×œ×¤×™ ××§×¦×•×¢
                        </button>
                        <button class="stats-nav-btn" data-stats-tab="periods">
                            ğŸ“… × ×™×ª×•×— ×œ×¤×™ ×ª×§×•×¤×”
                        </button>
                        <button class="stats-nav-btn" data-stats-tab="coordinators">
                            ğŸ‘¥ × ×™×ª×•×— ×œ×¤×™ ×¨×›×–×™×
                        </button>
                        <button class="stats-nav-btn" data-stats-tab="records">
                            ğŸ† ×©×™××™× ×•×©×‘×¨×™ ×©×™××™×
                        </button>
                    </div>

                    <!-- Statistics Content Areas -->
                    <div class="stats-content-area">
                        <!-- Overview Tab -->
                        <div class="stats-content active" id="stats-overview">
                            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">ğŸ  ×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>

                            <!-- Stats Cards Grid -->
                            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px;">
                                <!-- Current Month Card -->
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 24px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 32px;">ğŸ“…</span>
                                        <h3 style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">×”×—×•×“×© ×”× ×•×›×—×™</h3>
                                    </div>
                                    <div id="currentMonthTotal" style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                        --
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 14px;">×¡×”"×› ×©×¢×•×ª</p>
                                    <div style="display: flex; gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <div>
                                            <span style="color: #f97316; font-weight: 600;" id="currentMonthTeaching">--</span>
                                            <span style="color: var(--text-secondary); font-size: 12px;"> ×”×“×¨×›×”</span>
                                        </div>
                                        <div>
                                            <span style="color: #34ebbd; font-weight: 600;" id="currentMonthTraining">--</span>
                                            <span style="color: var(--text-secondary); font-size: 12px;"> ×”×©×ª×œ××•×ª</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Last Month Comparison Card -->
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 24px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 32px;">ğŸ“Š</span>
                                        <h3 style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">×”×©×•×•××” ×œ×—×•×“×© ×©×¢×‘×¨</h3>
                                    </div>
                                    <div id="comparisonPercentage" style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #22c55e 0%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                        --
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 14px;">×©×™× ×•×™ ×‘××—×•×–×™×</p>
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <span style="color: var(--text-secondary); font-size: 13px;">×—×•×“×© ×©×¢×‘×¨: </span>
                                        <span style="font-weight: 600;" id="lastMonthTotal">--</span>
                                        <span style="color: var(--text-secondary); font-size: 13px;"> ×©×¢×•×ª</span>
                                    </div>
                                </div>

                                <!-- Year Total Card -->
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 16px; padding: 24px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 32px;">ğŸ¯</span>
                                        <h3 style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">×¡×”"×› ×”×©× ×”</h3>
                                    </div>
                                    <div id="yearTotal" style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                        --
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 14px;">×©×¢×•×ª ×¢×“ ×›×” ×‘-<span id="currentYear">2025</span></p>
                                    <div style="display: flex; gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <div>
                                            <span style="color: #f97316; font-weight: 600;" id="yearTeaching">--</span>
                                            <span style="color: var(--text-secondary); font-size: 12px;"> ×”×“×¨×›×”</span>
                                        </div>
                                        <div>
                                            <span style="color: #34ebbd; font-weight: 600;" id="yearTraining">--</span>
                                            <span style="color: var(--text-secondary); font-size: 12px;"> ×”×©×ª×œ××•×ª</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Average per Month Card -->
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 16px; padding: 24px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 32px;">ğŸ“ˆ</span>
                                        <h3 style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">×××•×¦×¢ ×—×•×“×©×™</h3>
                                    </div>
                                    <div id="monthlyAverage" style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                        --
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 14px;">×©×¢×•×ª ×œ×—×•×“×© (×××•×¦×¢)</p>
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <span style="color: var(--text-secondary); font-size: 13px;">××‘×•×¡×¡ ×¢×œ </span>
                                        <span style="font-weight: 600;" id="monthsCount">--</span>
                                        <span style="color: var(--text-secondary); font-size: 13px;"> ×—×•×“×©×™×</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats Bar -->
                            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">ğŸ“Œ ××™×“×¢ × ×•×¡×£</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div>
                                        <span style="color: var(--text-secondary); font-size: 13px;">×™××™ ×¢×‘×•×“×” ×”×—×•×“×©:</span>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);" id="workingDays">--</div>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary); font-size: 13px;">×××•×¦×¢ ×©×¢×•×ª ×œ×™×•×:</span>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);" id="avgPerDay">--</div>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary); font-size: 13px;">××§×¦×•×¢×•×ª ×¤×¢×™×œ×™×:</span>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);" id="activeSubjects">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Tab -->
                        <div class="stats-content" id="stats-charts" style="display: none;">
                            <h2>ğŸ“ˆ ×’×¨×¤×™× ×•××’××•×ª</h2>

                            <!-- Time Period Selector -->
                            <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">
                                <button class="chart-period-btn active" data-period="6">6 ×—×•×“×©×™×</button>
                                <button class="chart-period-btn" data-period="12">×©× ×”</button>
                                <button class="chart-period-btn" data-period="24">×©× ×ª×™×™×</button>
                            </div>

                            <!-- Charts Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">

                                <!-- Line Chart: 6-Month Trend -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“Š ××’××ª ×©×¢×•×ª - <span id="trendPeriodLabel">6 ×—×•×“×©×™× ××—×¨×•× ×™×</span></h3>
                                    <div class="line-chart-container">
                                        <canvas id="trendLineChart" width="400" height="250"></canvas>
                                    </div>
                                </div>

                                <!-- Bar Chart: Teaching vs Training -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“š ×”×“×¨×›×” ××•×œ ×”×©×ª×œ××•×ª</h3>
                                    <div class="bar-chart-container">
                                        <canvas id="teachingVsTrainingChart" width="400" height="250"></canvas>
                                    </div>
                                </div>

                                <!-- Pie Chart: Subject Distribution -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ¯ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××§×¦×•×¢×•×ª</h3>
                                    <div class="pie-chart-container">
                                        <canvas id="subjectPieChart" width="400" height="250"></canvas>
                                    </div>
                                    <div id="subjectLegend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 13px;"></div>
                                </div>

                                <!-- Yearly Comparison Bar Chart -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“… ×”×©×•×•××” ×‘×™×Ÿ ×©× ×™×</h3>
                                    <div class="bar-chart-container">
                                        <canvas id="yearlyComparisonChart" width="400" height="250"></canvas>
                                    </div>
                                </div>

                            </div>

                            <!-- Summary Stats Below Charts -->
                            <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px solid var(--border-color);">
                                <h3 style="margin-bottom: 15px; color: var(--text-color);">ğŸ“ˆ ×ª×•×‘× ×•×ª ××”×’×¨×¤×™×</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">ğŸ“Š ××’××” ×›×œ×œ×™×ª</p>
                                        <p id="overallTrend" style="color: var(--text-color); font-weight: 600; font-size: 16px;">--</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">ğŸ† ×”×—×•×“×© ×”×˜×•×‘ ×‘×™×•×ª×¨</p>
                                        <p id="bestMonth" style="color: var(--text-color); font-weight: 600; font-size: 16px;">--</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">ğŸ¯ ×”××§×¦×•×¢ ×”×¤×•×¤×•×œ×¨×™</p>
                                        <p id="topSubject" style="color: var(--text-color); font-weight: 600; font-size: 16px;">--</p>
                                    </div>
                                    <div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">âš–ï¸ ×™×—×¡ ×”×“×¨×›×”/×”×©×ª×œ××•×ª</p>
                                        <p id="teachingRatio" style="color: var(--text-color); font-weight: 600; font-size: 16px;">--</p>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Subjects Tab -->
                        <div class="stats-content" id="stats-subjects" style="display: none;">
                            <h2>ğŸ“š × ×™×ª×•×— ×œ×¤×™ ××§×¦×•×¢</h2>

                            <!-- Summary Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);">
                                    <div id="totalSubjects" style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">××§×¦×•×¢×•×ª ×‘×¡×”"×›</p>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);">
                                    <div id="topSubjectName" style="font-size: 20px; font-weight: 700; color: #10b981; margin-bottom: 5px;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×”××§×¦×•×¢ ×”××•×‘×™×œ</p>
                                    <div id="topSubjectHours" style="font-size: 16px; font-weight: 600; color: #10b981; margin-top: 5px;">-- ×©×¢×•×ª</div>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);">
                                    <div id="avgHoursPerSubject" style="font-size: 36px; font-weight: 700; color: #f59e0b;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×××•×¦×¢ ×©×¢×•×ª ×œ××§×¦×•×¢</p>
                                </div>
                            </div>

                            <!-- Horizontal Bar Chart -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“Š ×”×©×•×•××” ×‘×™×Ÿ ××§×¦×•×¢×•×ª</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <canvas id="subjectsBarChart" width="700" height="400"></canvas>
                                </div>
                            </div>

                            <!-- Detailed Table -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“‹ ×¤×™×¨×•×˜ ××œ×</h3>
                                <div style="overflow-x: auto;">
                                    <table id="subjectsTable" style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: rgba(255, 255, 255, 0.05); border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">#</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">××§×¦×•×¢</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×“×¨×›×”</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×©×ª×œ××•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×¡×”"×› ×©×¢×•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">××—×•×– ××›×œ×œ ×”×©×¢×•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×××•×¦×¢ ×œ×—×•×“×©</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subjectsTableBody">
                                            <tr>
                                                <td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <!-- Periods Tab -->
                        <div class="stats-content" id="stats-periods" style="display: none;">
                            <h2>ğŸ“… × ×™×ª×•×— ×œ×¤×™ ×ª×§×•×¤×”</h2>

                            <!-- Year Selector -->
                            <div style="margin: 20px 0; text-align: center;">
                                <label style="color: var(--text-color); margin-left: 10px; font-weight: 600;">×‘×—×¨ ×©× ×”:</label>
                                <select id="periodYearSelector" style="padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 14px; cursor: pointer;">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Monthly Comparison Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
                                <!-- Current Month vs Last Month -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 15px; color: var(--text-color); font-size: 16px;">ğŸ—“ï¸ ×—×•×“×© × ×•×›×—×™ ××•×œ ×—×•×“×© ×§×•×“×</h3>
                                    <div style="display: flex; justify-content: space-around; align-items: center;">
                                        <div style="text-align: center;">
                                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×—×•×“×© × ×•×›×—×™</p>
                                            <div id="currentMonthPeriod" style="font-size: 28px; font-weight: 700; color: #3b82f6;">--</div>
                                            <p id="currentMonthName" style="color: var(--text-secondary); font-size: 11px; margin-top: 5px;">--</p>
                                        </div>
                                        <div id="monthComparisonArrow" style="font-size: 32px; color: var(--text-secondary);">â†”ï¸</div>
                                        <div style="text-align: center;">
                                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×—×•×“×© ×§×•×“×</p>
                                            <div id="lastMonthPeriod" style="font-size: 28px; font-weight: 700; color: #8b5cf6;">--</div>
                                            <p id="lastMonthName" style="color: var(--text-secondary); font-size: 11px; margin-top: 5px;">--</p>
                                        </div>
                                    </div>
                                    <div id="monthDifferenceText" style="text-align: center; margin-top: 15px; padding: 8px; background: rgba(255, 255, 255, 0.03); border-radius: 6px; font-size: 13px; font-weight: 600;">--</div>
                                </div>

                                <!-- Quarterly Analysis -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 15px; color: var(--text-color); font-size: 16px;">ğŸ“Š × ×™×ª×•×— ×¨×‘×¢×•× ×™</h3>
                                    <div id="quarterlyStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>

                                <!-- Year Summary -->
                                <div class="chart-card">
                                    <h3 style="margin-bottom: 15px; color: var(--text-color); font-size: 16px;">ğŸ“ˆ ×¡×™×›×•× ×©× ×ª×™</h3>
                                    <div style="text-align: center;">
                                        <div id="yearTotalPeriod" style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;">--</div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">×¡×”"×› ×©×¢×•×ª</p>
                                        <div style="display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                            <div>
                                                <div id="yearTeachingPeriod" style="font-size: 20px; font-weight: 700; color: #3b82f6;">--</div>
                                                <p style="color: var(--text-secondary); font-size: 11px;">×”×“×¨×›×”</p>
                                            </div>
                                            <div>
                                                <div id="yearTrainingPeriod" style="font-size: 20px; font-weight: 700; color: #8b5cf6;">--</div>
                                                <p style="color: var(--text-secondary); font-size: 11px;">×”×©×ª×œ××•×ª</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Breakdown Table -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“‹ ×¤×™×¨×•×˜ ×—×•×“×©×™ - <span id="selectedYearDisplay">--</span></h3>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: rgba(255, 255, 255, 0.05); border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">×—×•×“×©</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×“×¨×›×”</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×©×ª×œ××•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×¡×”"×› ×©×¢×•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×™××™ ×¢×‘×•×“×”</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×××•×¦×¢ ×œ×™×•×</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">××’××”</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthlyBreakdownBody">
                                            <tr>
                                                <td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Monthly Bar Chart -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“Š ×’×¨×£ ×—×•×“×©×™</h3>
                                <canvas id="monthlyPeriodChart" width="800" height="300"></canvas>
                            </div>

                        </div>

                        <!-- Coordinators Tab -->
                        <div class="stats-content" id="stats-coordinators" style="display: none;">
                            <h2>ğŸ‘¥ × ×™×ª×•×— ×œ×¤×™ ×¨×›×–×™×</h2>

                            <!-- Summary Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);">
                                    <div id="totalCoordinators" style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×¨×›×–×™× ×‘×¡×”"×›</p>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);">
                                    <div id="topCoordinatorName" style="font-size: 18px; font-weight: 700; color: #10b981; margin-bottom: 5px;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×”×¨×›×– ×”××•×‘×™×œ</p>
                                    <div id="topCoordinatorHours" style="font-size: 16px; font-weight: 600; color: #10b981; margin-top: 5px;">-- ×©×¢×•×ª</div>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);">
                                    <div id="avgHoursPerCoordinator" style="font-size: 36px; font-weight: 700; color: #f59e0b;">--</div>
                                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×××•×¦×¢ ×©×¢×•×ª ×œ×¨×›×–</p>
                                </div>
                            </div>

                            <!-- Pie Chart Distribution -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ¯ ×”×ª×¤×œ×’×•×ª ×©×¢×•×ª ×œ×¤×™ ×¨×›×–×™×</h3>
                                <div style="display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap;">
                                    <div style="flex: 0 0 auto;">
                                        <canvas id="coordinatorsPieChart" width="300" height="300"></canvas>
                                    </div>
                                    <div id="coordinatorsLegend" style="flex: 1 1 300px; display: flex; flex-direction: column; gap: 10px;"></div>
                                </div>
                            </div>

                            <!-- Horizontal Bar Chart -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“Š ×”×©×•×•××” ×‘×™×Ÿ ×¨×›×–×™×</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <canvas id="coordinatorsBarChart" width="700" height="400"></canvas>
                                </div>
                            </div>

                            <!-- Detailed Table -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“‹ ×¤×™×¨×•×˜ ××œ×</h3>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: rgba(255, 255, 255, 0.05); border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">#</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">×¨×›×–</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">××™×™×œ</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×“×¨×›×”</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×©×¢×•×ª ×”×©×ª×œ××•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">×¡×”"×› ×©×¢×•×ª</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">××—×•×–</th>
                                                <th style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 600;">××§×¦×•×¢×•×ª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="coordinatorsTableBody">
                                            <tr>
                                                <td colspan="8" style="padding: 40px; text-align: center; color: var(--text-secondary);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <!-- Records Tab -->
                        <div class="stats-content" id="stats-records" style="display: none;">
                            <h2>ğŸ† ×©×™××™× ×•×©×‘×¨×™ ×©×™××™×</h2>

                            <!-- Personal Bests Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0;">

                                <!-- Best Month Ever -->
                                <div class="chart-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%); border: 2px solid #f59e0b;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¥‡</div>
                                        <h3 style="color: #f59e0b; margin-bottom: 15px; font-size: 16px;">×”×—×•×“×© ×”×˜×•×‘ ×‘×™×•×ª×¨</h3>
                                        <div id="bestMonthValue" style="font-size: 42px; font-weight: 700; color: #f59e0b; margin-bottom: 5px;">--</div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×©×¢×•×ª</p>
                                        <div id="bestMonthDate" style="margin-top: 10px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; color: #f59e0b; font-weight: 600; font-size: 13px;">--</div>
                                    </div>
                                </div>

                                <!-- Best Single Day -->
                                <div class="chart-card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(219, 39, 119, 0.1) 100%); border: 2px solid #ec4899;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸŒŸ</div>
                                        <h3 style="color: #ec4899; margin-bottom: 15px; font-size: 16px;">×”×™×•× ×”×›×™ ×¤×¨×•×“×•×§×˜×™×‘×™</h3>
                                        <div id="bestDayValue" style="font-size: 42px; font-weight: 700; color: #ec4899; margin-bottom: 5px;">--</div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×©×¢×•×ª ×‘×™×•× ××—×“</p>
                                        <div id="bestDayDate" style="margin-top: 10px; padding: 8px; background: rgba(236, 72, 153, 0.1); border-radius: 6px; color: #ec4899; font-weight: 600; font-size: 13px;">--</div>
                                    </div>
                                </div>

                                <!-- Longest Streak -->
                                <div class="chart-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border: 2px solid #10b981;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”¥</div>
                                        <h3 style="color: #10b981; margin-bottom: 15px; font-size: 16px;">×¨×¦×£ ×™××™× ××¨×•×š ×‘×™×•×ª×¨</h3>
                                        <div id="longestStreakValue" style="font-size: 42px; font-weight: 700; color: #10b981; margin-bottom: 5px;">--</div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×™××™× ×¨×¦×•×¤×™×</p>
                                        <div id="longestStreakDate" style="margin-top: 10px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; color: #10b981; font-weight: 600; font-size: 13px;">--</div>
                                    </div>
                                </div>

                                <!-- Most Productive Subject -->
                                <div class="chart-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); border: 2px solid #3b82f6;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“š</div>
                                        <h3 style="color: #3b82f6; margin-bottom: 15px; font-size: 16px;">×”××§×¦×•×¢ ×”××•×‘×™×œ</h3>
                                        <div id="topSubjectName" style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-bottom: 5px;">--</div>
                                        <div id="topSubjectValue" style="font-size: 32px; font-weight: 700; color: #3b82f6; margin-bottom: 5px;">--</div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">×¡×”"×› ×©×¢×•×ª</p>
                                    </div>
                                </div>

                            </div>

                            <!-- Additional Stats -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª × ×•×¡×¤×•×ª</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">ğŸ“ˆ ×××•×¦×¢ ×©×¢×•×ª ×œ×™×•× ×¢×‘×•×“×”</p>
                                        <div id="avgHoursPerWorkingDay" style="font-size: 28px; font-weight: 700; color: var(--text-color);">--</div>
                                    </div>

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">ğŸ“… ×××•×¦×¢ ×©×¢×•×ª ×œ×—×•×“×©</p>
                                        <div id="avgHoursPerMonth" style="font-size: 28px; font-weight: 700; color: var(--text-color);">--</div>
                                    </div>

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">ğŸ“Š ×××•×¦×¢ ×©×¢×•×ª ×œ×©×‘×•×¢</p>
                                        <div id="avgHoursPerWeek" style="font-size: 28px; font-weight: 700; color: var(--text-color);">--</div>
                                    </div>

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">ğŸ¯ ×™××™ ×¢×‘×•×“×” ×›×•×œ×œ</p>
                                        <div id="totalWorkingDays" style="font-size: 28px; font-weight: 700; color: var(--text-color);">--</div>
                                    </div>

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">âš¡ ××—×•×– ×”×“×¨×›×”</p>
                                        <div id="teachingPercentage" style="font-size: 28px; font-weight: 700; color: #3b82f6;">--</div>
                                    </div>

                                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">ğŸ“ ××—×•×– ×”×©×ª×œ××•×ª</p>
                                        <div id="trainingPercentage" style="font-size: 28px; font-weight: 700; color: #8b5cf6;">--</div>
                                    </div>

                                </div>
                            </div>

                            <!-- Milestones -->
                            <div class="chart-card" style="margin: 20px 0;">
                                <h3 style="margin-bottom: 20px; color: var(--text-color);">ğŸ¯ ××‘× ×™ ×“×¨×š</h3>
                                <div id="milestonesList" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settingsTab">
                <div class="settings-section">
                    <h2>ğŸ¨ ×¢×¨×›×•×ª × ×•×©×</h2>
                    <div class="theme-grid">
                        <div class="theme-card selected" data-theme="default">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: #0a0e27;"></div>
                                <div class="theme-color" style="background: #3b82f6;"></div>
                                <div class="theme-color" style="background: #34ebbd;"></div>
                            </div>
                            <div class="theme-name">×‘×¨×™×¨×ª ××—×“×œ</div>
                            <div class="radio-label">
                                <input type="radio" name="theme" value="default" checked>
                            </div>
                        </div>
                        <div class="theme-card" data-theme="purple">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: #1e1b2e;"></div>
                                <div class="theme-color" style="background: #9333ea;"></div>
                                <div class="theme-color" style="background: #ec4899;"></div>
                            </div>
                            <div class="theme-name">×—×œ×•× ×¡×’×•×œ</div>
                            <div class="radio-label">
                                <input type="radio" name="theme" value="purple">
                            </div>
                        </div>
                        <div class="theme-card" data-theme="green">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: #0a1f1a;"></div>
                                <div class="theme-color" style="background: #10b981;"></div>
                                <div class="theme-color" style="background: #059669;"></div>
                            </div>
                            <div class="theme-name">××–××¨×œ×“ ×¤×¨×•</div>
                            <div class="radio-label">
                                <input type="radio" name="theme" value="green">
                            </div>
                        </div>
                        <div class="theme-card" data-theme="orange">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: #1a0f0a;"></div>
                                <div class="theme-color" style="background: #f97316;"></div>
                                <div class="theme-color" style="background: #ea580c;"></div>
                            </div>
                            <div class="theme-name">×©×§×™×¢×” ×‘×•×¢×¨×ª</div>
                            <div class="radio-label">
                                <input type="radio" name="theme" value="orange">
                            </div>
                        </div>
                        <div class="theme-card" data-theme="custom">
                            <div class="theme-preview" id="customThemePreview">
                                <div class="theme-color" style="background: #0a0e27;"></div>
                                <div class="theme-color" style="background: #3b82f6;"></div>
                                <div class="theme-color" style="background: #8b5cf6;"></div>
                            </div>
                            <div class="theme-name">××•×ª×× ××™×©×™×ª âœ¨</div>
                            <div class="radio-label">
                                <input type="radio" name="theme" value="custom">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Theme Color Picker -->
                    <div id="customThemePanel" style="display: none; margin-top: 24px; padding: 24px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">ğŸ¨ ×¢×¦×‘ ××ª ×¢×¨×›×ª ×”× ×•×©× ×©×œ×š</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    ğŸ¨ ×¦×‘×¢ ×¨×§×¢
                                </label>
                                <input type="color" id="customBgColor" value="#0a0e27" style="width: 100%; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer;">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    âœ¨ ×¦×‘×¢ ×¨××©×™
                                </label>
                                <input type="color" id="customPrimaryColor" value="#3b82f6" style="width: 100%; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer;">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    ğŸ’œ ×¦×‘×¢ ××©× ×™
                                </label>
                                <input type="color" id="customSecondaryColor" value="#8b5cf6" style="width: 100%; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer;">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="applyCustomThemeBtn" style="margin-top: 20px; width: 100%;">âœ… ×”×—×œ ×¢×¨×›×ª × ×•×©× ××•×ª×××ª</button>
                    </div>

                    <button class="btn btn-primary" id="saveThemeBtn" style="margin-top: 16px;">×©××•×¨ ×¢×¨×›×ª × ×•×©×</button>
                </div>

                <div class="settings-section">
                    <h2>ğŸ“¸ ×ª××•× ×ª ×¤×¨×•×¤×™×œ (××•×¤×¦×™×•× ×œ×™)</h2>
                    <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                        <div id="profileImagePreview" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid var(--border-color); background: var(--card-bg); display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 48px;">ğŸ‘¤</span>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <label for="profileImageInput" class="btn btn-primary" style="cursor: pointer; margin: 0;">
                                ğŸ“¤ ×”×¢×œ×” ×ª××•× ×”
                                <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                            </label>
                            <button class="btn" id="removeProfileImageBtn" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; display: none;">
                                ğŸ—‘ï¸ ×”×¡×¨ ×ª××•× ×”
                            </button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); text-align: center;">
                            ×’×•×“×œ ××•××œ×¥: 200x200 ×¤×™×§×¡×œ×™× | ×¤×•×¨××˜: JPG, PNG
                        </p>
                    </div>
                </div>

                <div class="settings-section">
                    <h2 onclick="toggleBackupsList()" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <span id="backupsToggleIcon">â–¼</span> ğŸ’¾ ×©×—×–×•×¨ ××’×™×‘×•×™
                    </h2>
                    <div class="backups-list" id="backupsList" style="display: none; margin-top: 16px;">
                        <div class="no-backups">××™×Ÿ ×’×™×‘×•×™×™× ×–××™× ×™× ×›×¨×’×¢</div>
                    </div>
                </div>

                <div class="settings-section">
                    <h2>ğŸ“§ ×›×ª×•×‘×ª ××™×™×œ ×œ×§×‘×œ×ª ×”×•×“×¢×•×ª</h2>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6;">
                        ×©× ×” ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×œ×§×‘×œ×ª ×”×•×“×¢×•×ª ××”××¢×¨×›×ª. <strong>×©×™× ×œ×‘:</strong> ×›×ª×•×‘×ª ×”××™×™×œ ×œ×›× ×™×¡×” ×œ××¢×¨×›×ª ×œ× ××©×ª× ×”.
                    </p>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            ğŸ“¬ ×›×ª×•×‘×ª ××™×™×œ × ×•×›×—×™×ª ×œ×§×‘×œ×ª ×”×•×“×¢×•×ª:
                        </label>
                        <div id="currentNotificationEmail" style="padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; margin-bottom: 16px;">
                            ×˜×•×¢×Ÿ...
                        </div>
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            âœï¸ ×›×ª×•×‘×ª ××™×™×œ ×—×“×©×”:
                        </label>
                        <input type="email" id="newNotificationEmail" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª ××™×™×œ ×—×“×©×” (×œ×“×•×’××”: name@company.com)" style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            ğŸ’¡ × ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××¨×’×•× ×™×ª ××• ××™×©×™×ª
                        </p>
                    </div>
                    <button class="btn btn-primary" id="updateNotificationEmailBtn">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™ ×›×ª×•×‘×ª</button>
                    <button class="btn" id="resetNotificationEmailBtn" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #dc2626; margin-right: 12px;">
                        â†©ï¸ ××™×¤×•×¡ ×œ×›×ª×•×‘×ª ×‘×¨×™×¨×ª ××—×“×œ
                    </button>
                </div>

                <div class="settings-section">
                    <h2>ğŸ’¬ ×”×¢×¨×•×ª ×œ××¤×ª×—</h2>
                    <div class="form-group">
                        <label>× ×•×©×:</label>
                        <input type="text" id="noteSubject" placeholder="× ×•×©× ×”×”×¢×¨×”">
                    </div>
                    <div class="form-group">
                        <label>×”×•×“×¢×”:</label>
                        <textarea id="noteMessage" placeholder="×ª××¨ ××ª ×”×‘×¢×™×” ××• ×”×”×¢×¨×”"></textarea>
                    </div>
                    <button class="btn btn-primary" id="sendNoteBtn">ğŸ“§ ×©×œ×— ×”×¢×¨×”</button>
                </div>
            </div>

            <!-- Coordinator: Approvals Tab -->
            <div class="tab-content" id="approvalsTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ“‹ ××™×©×•×¨ ×“×™×•×•×—×™ ×©×¢×•×ª
                </h2>

                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 24px;">
                    <!-- Export Button (Left) -->
                    <button id="exportCoordReportsBtn" class="month-nav-btn" style="color: #10b981; border-color: rgba(16, 185, 129, 0.3);" title="×™×™×¦×•× ×œ××§×¡×œ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>

                    <!-- Month Navigation (Center) -->
                    <div class="month-navigation">
                        <button class="month-nav-btn" id="coordPrevMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <h2 class="month-title" id="coordMonthTitle">× ×•×‘××‘×¨ 2025</h2>
                        <button class="month-nav-btn" id="coordNextMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <!-- Placeholder for symmetry (Right) -->
                    <div style="width: 40px;"></div>
                </div>

                <!-- Section 1: Regular Instructors -->
                <div style="background: var(--card-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); margin-bottom: 32px;">
                    <h3 style="font-size: 24px; font-weight: 600; color: rgba(59, 130, 246, 1); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        ğŸ‘¥ ××“×¨×™×›×™× ×§×‘×•×¢×™×
                    </h3>
                    <div id="monthlyReportsList">
                        <!-- Will be populated dynamically with collapsible instructor reports -->
                    </div>

                    <!-- Submit to Finance Button for Regular Instructors -->
                    <div style="text-align: center; margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border-radius: 12px; border: 2px dashed rgba(99, 102, 241, 0.3);">
                        <button id="submitToFinanceBtn" class="btn btn-primary" style="font-size: 18px; padding: 16px 48px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #059669;">
                            ğŸ’° ×©×’×¨ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                        </button>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">
                            ×©×’×¨ ××ª ×›×œ ×”×“×•×—×•×ª ×”×××•×©×¨×™× ×©×œ ×”××“×¨×™×›×™× ×”×§×‘×•×¢×™× ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                        </p>
                    </div>
                </div>

                <!-- Section 2: Substitution Instructors -->
                <div style="background: var(--card-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color);">
                    <h3 style="font-size: 24px; font-weight: 600; color: rgba(139, 92, 246, 1); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        ğŸ”„ ××“×¨×™×›×™ ×”×—×œ×¤×•×ª
                    </h3>
                    <div id="substitutionInstructorsList">
                        <!-- Will be populated dynamically -->
                    </div>

                    <!-- Submit to Finance Button for Substitution Instructors -->
                    <div id="submitSubstitutionsToFinanceContainer" style="text-align: center; margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%); border-radius: 12px; border: 2px dashed rgba(139, 92, 246, 0.3); display: none;">
                        <button id="submitSubstitutionsToFinanceBtnMain" class="btn btn-primary" style="font-size: 18px; padding: 16px 48px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%); border-color: rgba(139, 92, 246, 0.5);">
                            ğŸ’° ×©×’×¨ ×”×—×œ×¤×•×ª ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                        </button>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">
                            ×©×’×¨ ××ª ×›×œ ×”×—×œ×¤×•×ª ×”×××•×©×¨×•×ª ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                        </p>
                    </div>
                </div>
            </div>

            <!-- Coordinator: Manage Instructors Tab -->
            <div class="tab-content" id="manage-instructorsTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ‘¥ × ×™×”×•×œ ××“×¨×™×›×™×
                </h2>

                <div style="background: var(--card-bg); border-radius: 16px; padding: 32px; border: 1px solid var(--border-color); margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                        â• ×©×™×•×š ××“×¨×™×š ×—×“×©
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                                ×‘×—×¨ ××“×¨×™×š:
                            </label>
                            <select id="selectInstructorToAssign" style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;">
                                <option value="">-- ×‘×—×¨ ××“×¨×™×š --</option>
                            </select>
                        </div>

                        <!-- Subject selection area (will be populated dynamically) -->
                        <div id="subjectSelectionArea" style="display: none;">
                            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                ×‘×—×¨ ××§×¦×•×¢×•×ª ×œ×©×™×•×š:
                            </label>
                            <div id="subjectCheckboxes" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Checkboxes will be populated here -->
                            </div>
                            <button class="btn btn-primary" id="assignInstructorBtn" style="display: none; padding: 12px; font-size: 14px; width: 100%; margin-top: 16px;">
                                ×©×™×™×š ××“×¨×™×š
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                        ğŸ“‹ ×”××“×¨×™×›×™× ×©×œ×™
                    </h3>
                    <div id="myInstructorsList">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Finance: Reports Tab -->
            <div class="tab-content" id="finance-reportsTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ’° ××¢×¨×›×ª × ×™×”×•×œ ×›×¡×¤×™×
                </h2>

                <!-- Finance Sub-Tabs -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">
                    <button class="finance-subtab active" data-subtab="by-name" style="padding: 12px 24px; background: rgba(99, 102, 241, 0.1); border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; color: var(--text-primary); font-family: 'Bricolage Grotesque', sans-serif;">
                        ğŸ‘¤ ×“×™×•×•×—×™× ×œ×¤×™ ×©×
                    </button>
                    <button class="finance-subtab" data-subtab="by-department" style="padding: 12px 24px; background: transparent; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; color: var(--text-secondary); font-family: 'Bricolage Grotesque', sans-serif;">
                        ğŸ¢ ×“×™×•×•×—×™× ×œ×¤×™ ××—×œ×§×”
                    </button>
                    <button class="finance-subtab" data-subtab="export" style="padding: 12px 24px; background: transparent; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; color: var(--text-secondary); font-family: 'Bricolage Grotesque', sans-serif;">
                        ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ
                    </button>
                </div>

                <!-- By Name Sub-Tab -->
                <div class="finance-subtab-content" id="financeByNameTab">
                    <div class="month-navigation" style="margin-bottom: 24px;">
                        <button class="month-nav-btn" id="financePrevMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <h2 class="month-title" id="financeMonthTitle">× ×•×‘××‘×¨ 2025</h2>
                        <button class="month-nav-btn" id="financeNextMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <!-- Search Box with Autocomplete -->
                    <div style="margin-bottom: 24px;">
                        <div style="position: relative;">
                            <input type="text" id="instructorSearchInput" placeholder="ğŸ” ×—×¤×© ××“×¨×™×š ×œ×¤×™ ×©×..."
                                style="width: 100%; padding: 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; font-family: 'Bricolage Grotesque', sans-serif;"
                                autocomplete="off">
                            <div id="searchSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-top: 4px; max-height: 300px; overflow-y: auto; display: none; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
                        </div>
                    </div>

                    <!-- Filters Section -->
                    <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <!-- Coordinator Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×¨×›×–</label>
                            <select id="coordinatorFilter" style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; cursor: pointer;">
                                <option value="">×›×œ ×”×¨×›×–×™×</option>
                            </select>
                        </div>

                        <!-- Program Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×›× ×™×ª</label>
                            <select id="programFilter" style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; cursor: pointer;">
                                <option value="">×›×œ ×”×ª×›× ×™×•×ª</option>
                            </select>
                        </div>

                        <!-- Clear Filters Button -->
                        <div style="display: flex; align-items: flex-end;">
                            <button id="clearFiltersBtn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #dc2626; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; transition: all 0.2s;">
                                ğŸ—‘ï¸ × ×§×” ×¡×™× ×•×Ÿ
                            </button>
                        </div>
                    </div>

                    <!-- Salary Status Zones -->
                    <div style="margin-bottom: 24px;">
                        <!-- Not Sent By Coordinator Zone (Red) -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #dc2626; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ğŸ”´ ×¢×“×™×™×Ÿ ×œ× ×©×•×’×¨ ×“×•×— ×¢"×™ ×”×¨×›×–
                            </h3>
                            <div id="instructorsListNotSentByCoord" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                <!-- Will be populated with instructors not sent by coordinator -->
                            </div>
                        </div>

                        <!-- Not Reported Zone (Orange) -->
                        <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #d97706; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ğŸŸ  ×“×•×•×— ×¢"×™ ×”×¨×›×–, ×œ× ×“×•×•×— ×©×›×¨ ×œ××¢×¨×›×ª
                            </h3>
                            <div id="instructorsListNotReported" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                <!-- Will be populated with instructors not reported -->
                            </div>
                        </div>

                        <!-- Reported Zone (Green) -->
                        <div style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #16a34a; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ğŸŸ¢ ×“×•×•×— ×©×›×¨ ×œ××¢×¨×›×ª
                            </h3>
                            <div id="instructorsListReported" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                <!-- Will be populated with instructors reported -->
                            </div>
                        </div>
                    </div>

                    <!-- Selected Instructor Report -->
                    <div id="selectedInstructorReport" style="display: none;">
                        <!-- Will show full report -->
                    </div>
                </div>

                <!-- By Department Sub-Tab -->
                <div class="finance-subtab-content" id="financeByDepartmentTab" style="display: none;">
                    <div class="month-navigation" style="margin-bottom: 24px;">
                        <button class="month-nav-btn" id="departmentPrevMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <h2 class="month-title" id="departmentMonthTitle">× ×•×‘××‘×¨ 2025</h2>
                        <button class="month-nav-btn" id="departmentNextMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <!-- Departments List -->
                    <div id="departmentsList">
                        <!-- Will be populated with departments -->
                    </div>

                    <!-- Selected Department Instructor Report -->
                    <div id="selectedDepartmentInstructorReport" style="display: none;">
                        <!-- Will show instructor's report for specific subject -->
                    </div>
                </div>

                <!-- Export Sub-Tab -->
                <div class="finance-subtab-content" id="financeExportTab" style="display: none;">
                    <div class="month-navigation" style="margin-bottom: 24px;">
                        <button class="month-nav-btn" id="exportPrevMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <h2 class="month-title" id="exportMonthTitle">× ×•×‘××‘×¨ 2025</h2>
                        <button class="month-nav-btn" id="exportNextMonthBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                        ğŸ“Š ×™×™×¦×•× ×“×•×—×•×ª ×œ××§×¡×œ
                    </h2>

                    <!-- Layout Selection -->
                    <div style="background: var(--card-bg); border: 2px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                            ğŸ¨ ×‘×—×¨ ×¤×¨×™×¡×ª ×”×§×•×‘×¥
                        </h3>
                        <div style="display: flex; gap: 12px;">
                            <!-- Single Sheet Layout (Default) -->
                            <label style="flex: 1; cursor: pointer; padding: 16px; border: 2px solid rgba(99, 102, 241, 0.3); border-radius: 10px; background: rgba(99, 102, 241, 0.05); transition: all 0.2s;">
                                <input type="radio" name="exportLayout" value="single" checked style="margin-left: 8px; cursor: pointer;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <div style="font-size: 32px;">ğŸ“„</div>
                                    <span style="color: var(--text-primary); font-size: 14px; font-weight: 600; text-align: center;">×¤×¨×™×¡×” ×‘×’×œ×™×•×Ÿ ××—×“</span>
                                    <span style="color: var(--text-secondary); font-size: 12px; text-align: center;">×›×œ ×”××“×¨×™×›×™× ×‘×™×—×“</span>
                                </div>
                            </label>
                            <!-- Multiple Sheets Layout -->
                            <label style="flex: 1; cursor: pointer; padding: 16px; border: 2px solid var(--border-color); border-radius: 10px; background: transparent; transition: all 0.2s;">
                                <input type="radio" name="exportLayout" value="sheets" style="margin-left: 8px; cursor: pointer;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <div style="font-size: 32px;">ğŸ“‘</div>
                                    <span style="color: var(--text-primary); font-size: 14px; font-weight: 600; text-align: center;">×¤×¨×™×¡×” ×œ×¤×™ ×’×œ×™×•× ×•×ª</span>
                                    <span style="color: var(--text-secondary); font-size: 12px; text-align: center;">×›×œ ××“×¨×™×š ×‘×’×œ×™×•×Ÿ × ×¤×¨×“</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div style="display: grid; gap: 24px;">

                        <!-- Option 1: By Instructor Name -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                ğŸ‘¤ ×™×™×¦×•× ×œ×¤×™ ×©× ××“×¨×™×š
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                ×‘×—×¨ ××“×¨×™×š ××—×“ ××• ×™×•×ª×¨ ×•×™×™×¦× ××ª ×”×“×•×—×•×ª ×©×œ×”× ×œ×§×•×‘×¥ ××§×¡×œ
                            </p>

                            <div style="margin-bottom: 16px;">
                                <input type="text" id="exportInstructorSearch" placeholder="ğŸ” ×—×¤×© ××“×¨×™×š..."
                                    style="width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit;">
                            </div>

                            <!-- Select All / Deselect All Buttons -->
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <button id="selectAllInstructorsBtn" style="flex: 1; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; color: #16a34a; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s;">
                                    âœ“ ×‘×—×¨ ×”×›×œ
                                </button>
                                <button id="deselectAllInstructorsBtn" style="flex: 1; padding: 8px 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s;">
                                    âœ• ×‘×˜×œ ×‘×—×™×¨×”
                                </button>
                            </div>

                            <div id="exportInstructorsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                                <!-- Will be populated with checkboxes -->
                            </div>

                            <button id="exportByInstructorBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                ğŸ“¥ ×™×™×¦× ××“×¨×™×›×™× × ×‘×—×¨×™×
                            </button>
                        </div>

                        <!-- Option 2: By Department -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                ğŸ¢ ×™×™×¦×•× ×œ×¤×™ ××—×œ×§×”
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                ×‘×—×¨ ××—×œ×§×” ×•×™×™×¦× ××ª ×›×œ ×”××“×¨×™×›×™× ×©×œ×” ×œ×§×•×‘×¥ ××§×¡×œ
                            </p>

                            <div style="margin-bottom: 16px;">
                                <select id="exportDepartmentSelect" style="width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; cursor: pointer;">
                                    <option value="">×‘×—×¨ ××—×œ×§×”...</option>
                                    <!-- Will be populated -->
                                </select>
                            </div>

                            <button id="exportByDepartmentBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                ğŸ“¥ ×™×™×¦× ××—×œ×§×”
                            </button>
                        </div>

                        <!-- Option 3: By Salary Status -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                ğŸ’° ×™×™×¦×•× ×œ×¤×™ ×“×™×•×•×— ×©×›×¨
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                ×™×™×¦× ××“×¨×™×›×™× ×œ×¤×™ ×¡×˜×˜×•×¡ ×“×™×•×•×— ×”×©×›×¨ ×©×œ×”×
                            </p>

                            <div style="margin-bottom: 16px;">
                                <select id="exportSalaryStatusSelect" style="width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; cursor: pointer;">
                                    <option value="">×‘×—×¨ ×¡×˜×˜×•×¡...</option>
                                    <option value="reported">ğŸŸ© ×“×•×•×— ×©×›×¨</option>
                                    <option value="not-reported">ğŸŸ¨ ×œ× ×“×•×•×— ×©×›×¨</option>
                                </select>
                            </div>

                            <button id="exportBySalaryStatusBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                ğŸ“¥ ×™×™×¦× ×œ×¤×™ ×¡×˜×˜×•×¡ ×©×›×¨
                            </button>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Finance: Status Tab -->
            <div class="tab-content" id="finance-statusTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ“Š ×¡×˜×˜×•×¡ ×“×™×•×•×—×™×
                </h2>

                <!-- Month selector -->
                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 24px;">
                    <div class="month-navigation">
                        <button class="month-nav-btn" id="prevStatusMonth">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <h2 class="month-title" id="statusMonthTitle"></h2>
                        <button class="month-nav-btn" id="nextStatusMonth">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Coordinators list with reporting status -->
                <div id="coordinatorsStatusList" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Coordinators will be dynamically loaded here -->
                </div>
            </div>

            <!-- Finance: Notifications Tab -->
            <div class="tab-content" id="finance-notificationsTab" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin: 0;">
                        ğŸ”” ×”×ª×¨××•×ª
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button id="markAllReadBtn" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: none;">
                            âœ“ ×§×¨××ª×™ ×”×›×œ
                        </button>
                        <button id="clearNotificationsBtn" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: none;">
                            ğŸ—‘ï¸ ××—×§ ×”×ª×¨××•×ª
                        </button>
                    </div>
                </div>

                <!-- Notifications List -->
                <div id="notificationsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Will be populated with notifications -->
                </div>

                <!-- Empty State -->
                <div id="notificationsEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
                    <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">ğŸ””</div>
                    <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        ××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ×›××©×¨ ×¨×›×–×™× ×™×©×’×¨×• ×“×•×—×•×ª ×—×“×©×™×, ×”×ª×¨××•×ª ×™×•×¤×™×¢×• ×›××Ÿ
                    </p>
                </div>
            </div>

            <!-- Admin: Manage Users Tab -->
            <div class="tab-content" id="admin-manage-usersTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ‘¨â€ğŸ’¼ × ×™×”×•×œ ××“×¨×™×›×™×
                </h2>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <p style="color: #ef4444; font-weight: 600; margin: 0;">
                        âš ï¸ ××–×•×¨ ××“××™×Ÿ ×‘×œ×‘×“ - ×¤×¢×•×œ×•×ª ××—×™×§×” ×”×Ÿ ×‘×œ×ª×™ ×”×¤×™×›×•×ª!
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                    <button id="registerInstructorBtn" style="padding: 16px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; transition: transform 0.2s, box-shadow 0.2s;">
                        â• ×¨×™×©×•× ××“×¨×™×š ×—×“×©
                    </button>
                </div>

                <!-- Search Box -->
                <div style="margin-bottom: 24px;">
                    <input type="text" id="adminSearchInput" placeholder="ğŸ” ×—×¤×© ××“×¨×™×š ×œ×¤×™ ×©× ××• ××™××™×™×œ..."
                        style="width: 100%; padding: 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; font-family: 'Bricolage Grotesque', sans-serif;">
                </div>

                <!-- Instructors List -->
                <div id="adminInstructorsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Will be populated -->
                </div>
            </div>

            <!-- Admin: Manage Coordinators Tab -->
            <div class="tab-content" id="admin-manage-coordinatorsTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ‘” × ×™×”×•×œ ×¨×›×–×™×
                </h2>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <p style="color: #ef4444; font-weight: 600; margin: 0;">
                        âš ï¸ ××–×•×¨ ××“××™×Ÿ ×‘×œ×‘×“ - ×¤×¢×•×œ×•×ª ××—×™×§×” ×”×Ÿ ×‘×œ×ª×™ ×”×¤×™×›×•×ª!
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                    <button id="addCoordinatorBtn" style="padding: 16px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; transition: transform 0.2s, box-shadow 0.2s;">
                        â• ×”×•×¡×¤×ª ×¨×›×– ×—×“×©
                    </button>
                </div>

                <!-- Search Box -->
                <div style="margin-bottom: 24px;">
                    <input type="text" id="coordinatorSearchInput" placeholder="ğŸ” ×—×¤×© ×¨×›×– ×œ×¤×™ ×©× ××• ××™××™×™×œ..."
                        style="width: 100%; padding: 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; font-family: 'Bricolage Grotesque', sans-serif;">
                </div>

                <!-- Coordinators List -->
                <div id="adminCoordinatorsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Will be populated -->
                </div>
            </div>

            <!-- Admin: Manage Finance Managers Tab -->
            <div class="tab-content" id="admin-manage-financeTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ’° × ×™×”×•×œ ×× ×”×œ×•×ª ×›×¡×¤×™×
                </h2>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <p style="color: #ef4444; font-weight: 600; margin: 0;">
                        âš ï¸ ××–×•×¨ ××“××™×Ÿ ×‘×œ×‘×“ - ×¤×¢×•×œ×•×ª ××—×™×§×” ×”×Ÿ ×‘×œ×ª×™ ×”×¤×™×›×•×ª!
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                    <button id="addFinanceManagerBtn" style="padding: 16px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; transition: transform 0.2s, box-shadow 0.2s;">
                        â• ×”×•×¡×¤×ª ×× ×”×œ×ª ×›×¡×¤×™× ×—×“×©×”
                    </button>
                </div>

                <!-- Search Box -->
                <div style="margin-bottom: 24px;">
                    <input type="text" id="financeManagerSearchInput" placeholder="ğŸ” ×—×¤×© ×× ×”×œ×ª ×›×¡×¤×™× ×œ×¤×™ ×©× ××• ××™××™×™×œ..."
                        style="width: 100%; padding: 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; font-family: 'Bricolage Grotesque', sans-serif;">
                </div>

                <!-- Finance Managers List -->
                <div id="adminFinanceManagersList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Will be populated -->
                </div>
            </div>

            <!-- Admin: Manage Departments Tab -->
            <div class="tab-content" id="admin-manage-departmentsTab" style="display: none;">
                <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 24px;">
                    ğŸ¢ × ×™×”×•×œ ××—×œ×§×•×ª
                </h2>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <p style="color: #ef4444; font-weight: 600; margin: 0;">
                        âš ï¸ ××–×•×¨ ××“××™×Ÿ ×‘×œ×‘×“ - ×¤×¢×•×œ×•×ª ××—×™×§×” ×”×Ÿ ×‘×œ×ª×™ ×”×¤×™×›×•×ª!
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                    <button id="addDepartmentBtn" style="padding: 16px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; transition: transform 0.2s, box-shadow 0.2s;">
                        â• ×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”
                    </button>
                </div>

                <!-- Departments List -->
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Morning Departments -->
                    <div>
                        <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            ğŸŒ… ××—×œ×§×•×ª ×‘×•×§×¨
                        </h3>
                        <div id="morningDepartmentsList" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Afternoon Departments -->
                    <div>
                        <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            ğŸŒ† ××—×œ×§×•×ª ××—×¨ ×”×¦×”×¨×™×™×
                        </h3>
                        <div id="afternoonDepartmentsList" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>×˜×•×¢×Ÿ...</p>
    </div>

    <!-- Register Instructor Modal -->
    <div id="registerInstructorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    â• ×¨×™×©×•× ××“×¨×™×š ×—×“×©
                </h2>
                <button id="closeRegisterModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <form id="registerInstructorForm" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Full Name -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©× ××œ×: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="instructorFullName" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="×”×›× ×¡ ×©× ××œ×">
                </div>

                <!-- Email -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×›×ª×•×‘×ª ××™××™×™×œ: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="email" id="instructorEmail" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="example@example.com">
                </div>

                <!-- Coordinator Selection (Optional) -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©×™×•×š ×œ×¨×›×– (××•×¤×¦×™×•× ×œ×™):
                    </label>
                    <select id="registerInstructorCoordinator" style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;">
                        <option value="">-- ×‘×—×¨ ×¨×›×– (××•×¤×¦×™×•× ×œ×™) --</option>
                    </select>
                </div>

                <!-- Subjects Selection (Optional - appears when coordinator is selected) -->
                <div id="registerSubjectsArea" style="display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©×™×•×š ×œ××§×¦×•×¢×•×ª (××•×¤×¦×™×•× ×œ×™):
                    </label>
                    <div id="registerSubjectsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; min-height: 100px;">
                        <!-- Subjects will be populated here -->
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" style="padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px;">
                    âœ… ×¨×©×•× ××“×¨×™×š
                </button>
            </form>
        </div>
    </div>

    <!-- Delete Instructor Modal -->
    <div id="deleteInstructorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    ğŸ—‘ï¸ ××—×™×§×ª ××“×¨×™×›×™×
                </h2>
                <button id="closeDeleteModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                <p style="color: #ef4444; font-weight: 600; margin: 0;">
                    âš ï¸ ××–×”×¨×”: ××—×™×§×ª ××“×¨×™×š ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ×• ×œ×¦××™×ª×•×ª!
                </p>
            </div>

            <!-- Search Box -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="deleteSearchInput" placeholder="ğŸ” ×—×¤×© ××“×¨×™×š ×œ××—×™×§×”..."
                    style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;">
            </div>

            <!-- Instructors List for Deletion -->
            <div id="deleteInstructorsList" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                <!-- Will be populated -->
            </div>
        </div>
    </div>

    <!-- Assign Instructor to Coordinator Modal -->
    <div id="assignToCoordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    ğŸ”— ×©×™×•×š ××“×¨×™×š ×œ×¨×›×–
                </h2>
                <button id="closeAssignToCoordModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Select Instructor -->
                <div id="adminInstructorDisplay">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ××“×¨×™×š:
                    </label>
                    <div id="adminSelectedInstructorName" style="padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600;">
                    </div>
                </div>

                <!-- Select Coordinator -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×‘×—×¨ ×¨×›×–: <span style="color: #ef4444;">*</span>
                    </label>
                    <select id="adminSelectCoordinator" style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;">
                        <option value="">-- ×‘×—×¨ ×¨×›×– --</option>
                    </select>
                </div>

                <!-- Current Assignments (shown when instructor is selected) -->
                <div id="adminCurrentAssignments" style="display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                        ×©×™×•×›×™× ×§×™×™××™×:
                    </label>
                    <div id="adminCurrentAssignmentsList" style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px;">
                        <!-- Current assignments will be shown here -->
                    </div>
                </div>

                <!-- Subject Selection (shown after coordinator is selected) -->
                <div id="adminSubjectSelectionArea" style="display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                        ×‘×—×¨ ××§×¦×•×¢×•×ª ×œ×©×™×•×š (××•×¤×¦×™×•× ×œ×™):
                    </label>
                    <div id="adminSubjectCheckboxes" style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px;">
                        <!-- Checkboxes will be populated here -->
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="confirmAssignToCoordBtn" style="padding: 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px; opacity: 0.5; pointer-events: none;">
                    âœ… ×©×™×™×š ××“×¨×™×š
                </button>
            </div>
        </div>
    </div>

    <!-- Add Coordinator Modal -->
    <div id="addCoordinatorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    â• ×”×•×¡×¤×ª ×¨×›×– ×—×“×©
                </h2>
                <button id="closeAddCoordinatorModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <form id="addCoordinatorForm" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Full Name -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©× ××œ×: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="coordinatorFullName" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="×”×›× ×¡ ×©× ××œ×">
                </div>

                <!-- Email -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×›×ª×•×‘×ª ××™××™×™×œ: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="email" id="coordinatorEmail" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="example@example.com">
                </div>

                <!-- Employment Type -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×¡×•×’ ×”×¢×¡×§×”: <span style="color: #ef4444;">*</span>
                    </label>
                    <select id="coordinatorEmploymentType" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;">
                        <option value="">-- ×‘×—×¨ ×¡×•×’ ×”×¢×¡×§×” --</option>
                        <option value="global">×¢×•×‘×“ ×’×œ×•×‘×œ×™ (×œ× ×¦×¨×™×š ×œ×“×•×•×— ×©×¢×•×ª)</option>
                        <option value="hourly">×¢×•×‘×“ ×©×¢×ª×™ (×¦×¨×™×š ×œ×“×•×•×— ×©×¢×•×ª)</option>
                    </select>
                </div>

                <!-- Submit Button -->
                <button type="submit" style="padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px;">
                    âœ… ×”×•×¡×£ ×¨×›×–
                </button>
            </form>
        </div>
    </div>

    <!-- Add Finance Manager Modal -->
    <div id="addFinanceManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    â• ×”×•×¡×¤×ª ×× ×”×œ×ª ×›×¡×¤×™× ×—×“×©×”
                </h2>
                <button id="closeAddFinanceManagerModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <form id="addFinanceManagerForm" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Full Name -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©× ××œ×: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="financeManagerFullName" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="×”×›× ×¡ ×©× ××œ×">
                </div>

                <!-- Email -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×›×ª×•×‘×ª ××™××™×™×œ: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="email" id="financeManagerEmail" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="example@example.com">
                </div>

                <!-- Submit Button -->
                <button type="submit" style="padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px;">
                    âœ… ×”×•×¡×£ ×× ×”×œ×ª ×›×¡×¤×™×
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Finance Manager Modal -->
    <div id="editFinanceManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    âœï¸ ×¢×¨×™×›×ª ×× ×”×œ×ª ×›×¡×¤×™×
                </h2>
                <button id="closeEditFinanceManagerModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <form id="editFinanceManagerForm" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Email (hidden field) -->
                <input type="hidden" id="editFinanceManagerEmail">

                <!-- Full Name -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©× ××œ×: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="editFinanceManagerName" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="×”×›× ×¡ ×©× ××œ×">
                </div>

                <!-- Submit Button -->
                <button type="submit" style="padding: 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px;">
                    ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
                </button>
            </form>
        </div>
    </div>

    <!-- Coordinator Export Modal -->
    <div id="coordExportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; margin: 40px auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    ğŸ“Š ×™×™×¦×•× ×“×•×—×•×ª ×œ××§×¡×œ
                </h2>
                <button id="closeCoordExportModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">
                    Ã—
                </button>
            </div>

            <!-- Layout Selection -->
            <div style="background: rgba(99, 102, 241, 0.05); border: 2px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                    ğŸ¨ ×‘×—×¨ ×¤×¨×™×¡×ª ×”×§×•×‘×¥
                </h3>
                <div style="display: flex; gap: 12px;">
                    <!-- Single Sheet Layout (Default) -->
                    <label style="flex: 1; cursor: pointer; padding: 16px; border: 2px solid rgba(99, 102, 241, 0.3); border-radius: 10px; background: rgba(99, 102, 241, 0.05); transition: all 0.2s;">
                        <input type="radio" name="coordExportLayout" value="single" checked style="margin-left: 8px; cursor: pointer;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="font-size: 32px;">ğŸ“„</div>
                            <span style="color: var(--text-primary); font-size: 14px; font-weight: 600; text-align: center;">×¤×¨×™×¡×” ×‘×’×œ×™×•×Ÿ ××—×“</span>
                            <span style="color: var(--text-secondary); font-size: 12px; text-align: center;">×›×œ ×”××“×¨×™×›×™× ×‘×™×—×“</span>
                        </div>
                    </label>
                    <!-- Multiple Sheets Layout -->
                    <label style="flex: 1; cursor: pointer; padding: 16px; border: 2px solid var(--border-color); border-radius: 10px; background: transparent; transition: all 0.2s;">
                        <input type="radio" name="coordExportLayout" value="sheets" style="margin-left: 8px; cursor: pointer;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="font-size: 32px;">ğŸ“‘</div>
                            <span style="color: var(--text-primary); font-size: 14px; font-weight: 600; text-align: center;">×¤×¨×™×¡×” ×œ×¤×™ ×’×œ×™×•× ×•×ª</span>
                            <span style="color: var(--text-secondary); font-size: 12px; text-align: center;">×›×œ ××“×¨×™×š ×‘×’×œ×™×•×Ÿ × ×¤×¨×“</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Filter Options -->
            <div style="background: rgba(16, 185, 129, 0.05); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                    ğŸ¯ ×‘×—×¨ ××“×¨×™×›×™× ×œ×™×™×¦×•×
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Option 1: All instructors who submitted -->
                    <label style="cursor: pointer; padding: 16px; border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 10px; background: rgba(16, 185, 129, 0.05); transition: all 0.2s; display: flex; align-items: center; gap: 12px;">
                        <input type="radio" name="coordExportFilter" value="submitted" checked style="cursor: pointer; width: 20px; height: 20px;">
                        <div style="flex: 1;">
                            <div style="color: var(--text-primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">×›×œ ×”××“×¨×™×›×™× ×©×©×™×’×¨×• ××œ×™×™</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">×™×™×¦×•× ×›×œ ×”×“×•×—×•×ª ×©×”×ª×§×‘×œ×•</div>
                        </div>
                    </label>
                    <!-- Option 2: Only those sent to finance -->
                    <label style="cursor: pointer; padding: 16px; border: 2px solid var(--border-color); border-radius: 10px; background: transparent; transition: all 0.2s; display: flex; align-items: center; gap: 12px;">
                        <input type="radio" name="coordExportFilter" value="approved" style="cursor: pointer; width: 20px; height: 20px;">
                        <div style="flex: 1;">
                            <div style="color: var(--text-primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">×¨×§ ×”××“×¨×™×›×™× ×©×©×™×’×¨×ª×™ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">×™×™×¦×•× ×“×•×—×•×ª ×××•×©×¨×™× ×‘×œ×‘×“</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Export Button -->
            <button id="confirmCoordExportBtn" class="btn" style="width: 100%; padding: 16px; font-size: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 600;">
                ğŸ“¥ ×™×™×¦× ×“×•×—×•×ª ×œ××§×¡×œ
            </button>
        </div>
    </div>

    <!-- Confirmation Modal (Generic) -->
    <div id="confirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; border: 2px solid var(--border-color);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div id="confirmationIcon" style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                <h2 id="confirmationTitle" style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px 0;"></h2>
                <p id="confirmationMessage" style="font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin: 0; white-space: pre-line;"></p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmationCancelBtn" style="flex: 1; padding: 14px; background: rgba(100, 116, 139, 0.2); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                    ×‘×™×˜×•×œ
                </button>
                <button id="confirmationConfirmBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                    ××™×©×•×¨
                </button>
            </div>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="addDepartmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    â• ×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”
                </h2>
                <button id="closeAddDepartmentModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <form id="addDepartmentForm" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Department Name -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ×©× ×”××—×œ×§×”: <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="departmentName" required
                        style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif;"
                        placeholder="×œ×“×•×’××”: ×‘×™×•×œ×•×’×™×”, ×›×™××™×”">
                </div>

                <!-- Time of Day -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                        ×–××Ÿ ×”×•×¨××”: <span style="color: #ef4444;">*</span>
                    </label>
                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: rgba(15, 23, 42, 0.6); border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="timeOfDay" value="morning" required style="cursor: pointer;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">ğŸŒ… ×‘×•×§×¨</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: rgba(15, 23, 42, 0.6); border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="timeOfDay" value="afternoon" required style="cursor: pointer;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">ğŸŒ† ××—×¨ ×”×¦×”×¨×™×™×</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" style="padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px;">
                    âœ… ×”×•×¡×£ ××—×œ×§×”
                </button>
            </form>
        </div>
    </div>

    <!-- Assign Subject to Coordinator Modal -->
    <div id="assignSubjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 20px; padding: 32px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                    ğŸ“š ×©×™×•×š ××§×¦×•×¢ ×œ×¨×›×–
                </h2>
                <button id="closeAssignSubjectModal" style="background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Current Subjects Display -->
                <div id="currentSubjectsDisplay">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                        ××§×¦×•×¢×•×ª × ×•×›×—×™×™×:
                    </label>
                    <div id="currentSubjectsList" style="padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px; min-height: 50px;">
                        <!-- Current subjects will appear here -->
                    </div>
                </div>

                <!-- Subject Selection by Time of Day -->
                <div id="subjectSelectionArea">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                        ×‘×—×¨ ××§×¦×•×¢×•×ª:
                    </label>

                    <!-- Morning Subjects -->
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--accent-blue); margin-bottom: 8px;">
                            ğŸŒ… ×‘×•×§×¨:
                        </div>
                        <div id="morningSubjectsCheckboxes" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border-color); border-radius: 8px;">
                            <!-- Morning subject checkboxes will be populated here -->
                        </div>
                    </div>

                    <!-- Afternoon Subjects -->
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--accent-purple); margin-bottom: 8px;">
                            ğŸŒ† ××—×¨ ×”×¦×”×¨×™×™×:
                        </div>
                        <div id="afternoonSubjectsCheckboxes" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border-color); border-radius: 8px;">
                            <!-- Afternoon subject checkboxes will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="confirmAssignSubjectBtn" type="button" style="padding: 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif; margin-top: 8px; opacity: 0.5; pointer-events: none;">
                    âœ… ×©××•×¨ ×©×™× ×•×™×™×
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp as initApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD357-RIAaYH5gWs1bukbRcrsx3GQyFDRE",
            authDomain: "hours-73365.firebaseapp.com",
            databaseURL: "https://hours-73365-default-rtdb.firebaseio.com",
            projectId: "hours-73365",
            storageBucket: "hours-73365.firebasestorage.app",
            messagingSenderId: "364657795969",
            appId: "1:364657795969:web:00594c91a28ff31ff6fe80"
        };

        const app = initApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // Initialize EmailJS
        (function(){
            emailjs.init("Y0yqKFQQ4ONQ4j396");
        })();

        // EmailJS Configuration
        const EMAILJS_CONFIG = {
            serviceId: 'service_0bxbros',
            templateId: 'template_4prhrfi', // For coordinator resubmit notifications
            developerNoteTemplateId: 'template_b8nnp9r', // For developer notes
            financeUpdateTemplateId: 'template_zo2b81n' // For finance manager report updates
        };

        // User Roles - All users will be loaded from Firebase
        let userRoles = {};

        // Subject Period Definitions - Define which subjects belong to morning/afternoon
        const MORNING_SUBJECTS = ['×ª×›× ×™×ª ×”×‘×•×§×¨', '×ª×›× ×™×ª ×‘×•×§×¨', '××—×•× × ×™×', '×¨×¤×•××” ×‘×•×§×¨', '×¨×¤×•××”'];
        const AFTERNOON_SUBJECTS = ['×›×™××™×”', '××—×©×‘×™×', '××¡×˜×¨×•× ×•××™×”', '×‘×™×•×œ×•×’×™×”', '×¨×¤×•××”', '×§×¨×§×¡', '××©× ×‘ ×œ××“×¢', '×—×•×’ FLL', '×—×•×’ ×œ×’×• ××ª×’×¨×™', '×—×•×’ ××™×§×¨×•×‘×™×˜', '×—×•×’×™ ×¨×¤×•××”', '×›×™×¦×“ ×–×” ×¤×•×¢×œ', '××“×¢ ×œ×˜×£ ×\'', '××“×¢ ×œ×˜×£ ×‘\'', '××¦×•×™×™× ×•×ª', '×—×•×’ ×¤×™×–×™×§×”', '×—×™×“×•×ª ×•×—×“×¨×™ ×‘×¨×™×—×”', '××¡×¢ ×™×¦×™×¨×ª×™'];

        // Global State
        let currentUser = null;
        let currentUserData = null;

        // Calculate default month: if before the 5th of the month, default to previous month
        const today = new Date();
        const dayOfMonth = today.getDate();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth() + 1;

        if (dayOfMonth < 5) {
            // Before the 5th - use previous month
            currentMonth--;
            if (currentMonth === 0) {
                currentMonth = 12;
                currentYear--;
            }
        }
        let currentTimesheet = {};
        let userSubjects = [];
        let coordinators = [];
        let availableSubstitutionDepartments = []; // Departments available for substitutions (all departments minus user's departments)
        let isTimesheetLocked = false; // Track if timesheet is locked after submission (loaded from DB)
        let hasBeenSubmitted = false; // Track if timesheet has been submitted (loaded from DB)
        let hasSeenEditWarning = sessionStorage.getItem('hasSeenEditWarning') === 'true'; // Track if user has seen the edit warning popup in this session
        let needsResubmitTo = {}; // Track which coordinators need resubmit: { coordEmail: true/false }

        // Undo/Redo functionality
        let undoStack = [];
        let redoStack = [];
        const MAX_UNDO_STACK = 50; // Limit undo history to prevent memory issues

        // Generate hours options from 0 to 12.5 with 0.5 increments
        function generateHoursOptions(selectedValue = 0) {
            const options = [];
            for (let i = 0; i <= 12.5; i += 0.5) {
                const value = i;
                const displayValue = value % 1 === 0 ? value.toFixed(0) : value.toFixed(1);
                const selected = value === selectedValue ? 'selected' : '';
                options.push(`<option value="${value}" ${selected}>${displayValue}</option>`);
            }
            return options.join('');
        }

        // Save current state to undo stack
        function saveStateToUndoStack() {
            // Create a deep copy of current entries
            const currentState = {
                year: currentYear,
                month: currentMonth,
                entries: currentTimesheet.entries ? JSON.parse(JSON.stringify(currentTimesheet.entries)) : {}
            };

            undoStack.push(currentState);

            // Limit stack size
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift(); // Remove oldest entry
            }

            // Clear redo stack when new change is made
            redoStack = [];
        }

        // Save coordinator edit state to undo stack (when coordinator edits instructor's timesheet)
        async function saveCoordinatorEditStateToUndoStack(instructorEmail, year, month) {
            try {
                const sanitizedEmail = sanitizeEmail(instructorEmail);
                const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}`);
                const snapshot = await get(timesheetRef);

                const currentState = {
                    year: year,
                    month: month,
                    instructorEmail: instructorEmail, // Track which instructor's data this is
                    entries: snapshot.exists() ? JSON.parse(JSON.stringify(snapshot.val().entries || {})) : {}
                };

                undoStack.push(currentState);

                // Limit stack size
                if (undoStack.length > MAX_UNDO_STACK) {
                    undoStack.shift();
                }

                // Clear redo stack when new change is made
                redoStack = [];
            } catch (error) {
                console.error('Error saving coordinator edit state:', error);
            }
        }

        // Undo function - restore previous state
        async function undo() {
            if (undoStack.length === 0) {
                showError('××™×Ÿ ×©×™× ×•×™×™× ×œ×‘×™×˜×•×œ');
                return;
            }

            try {
                showLoading(true);

                // Pop previous state from undo stack
                const previousState = undoStack.pop();

                // Check if this is a coordinator edit (has instructorEmail) or instructor's own edit
                if (previousState.instructorEmail) {
                    // Coordinator is undoing their edit of instructor's timesheet

                    // Load current state for redo
                    const sanitizedEmail = sanitizeEmail(previousState.instructorEmail);
                    const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${previousState.year}/${previousState.month}`);
                    const snapshot = await get(timesheetRef);

                    const currentState = {
                        year: previousState.year,
                        month: previousState.month,
                        instructorEmail: previousState.instructorEmail,
                        entries: snapshot.exists() ? JSON.parse(JSON.stringify(snapshot.val().entries || {})) : {}
                    };
                    redoStack.push(currentState);

                    // Restore previous state to Firebase
                    const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${previousState.year}/${previousState.month}/entries`);
                    await set(entriesRef, previousState.entries);

                    showSuccess('×”×©×™× ×•×™ ×‘×•×˜×œ ×‘×”×¦×œ×—×”');
                } else {
                    // Instructor is undoing their own edit

                    // Save current state to redo stack
                    const currentState = {
                        year: currentYear,
                        month: currentMonth,
                        entries: currentTimesheet.entries ? JSON.parse(JSON.stringify(currentTimesheet.entries)) : {}
                    };
                    redoStack.push(currentState);

                    // Restore previous state to Firebase
                    const sanitizedEmail = sanitizeEmail(currentUser.email);
                    const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${previousState.year}/${previousState.month}/entries`);
                    await set(entriesRef, previousState.entries);

                    // Update local state
                    currentTimesheet.entries = previousState.entries;

                    // Reset hasSeenEditWarning so popup can appear again after undo
                    hasSeenEditWarning = false;
                    sessionStorage.removeItem('hasSeenEditWarning');

                    // Reload the timesheet to reflect changes - keep edit state to preserve lock status
                    await loadMonthlyTimesheet(previousState.year, previousState.month, true);

                    showSuccess('×”×©×™× ×•×™ ×‘×•×˜×œ ×‘×”×¦×œ×—×”');
                }

            } catch (error) {
                console.error('Error in undo:', error);
                showError('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×©×™× ×•×™');
            } finally {
                showLoading(false);
            }
        }

        // Redo function - restore next state
        async function redo() {
            if (redoStack.length === 0) {
                showError('××™×Ÿ ×©×™× ×•×™×™× ×œ×©×—×–×•×¨');
                return;
            }

            try {
                showLoading(true);

                // Pop next state from redo stack
                const nextState = redoStack.pop();

                // Check if this is a coordinator edit or instructor's own edit
                if (nextState.instructorEmail) {
                    // Coordinator is redoing their edit of instructor's timesheet

                    // Load current state for undo
                    const sanitizedEmail = sanitizeEmail(nextState.instructorEmail);
                    const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${nextState.year}/${nextState.month}`);
                    const snapshot = await get(timesheetRef);

                    const currentState = {
                        year: nextState.year,
                        month: nextState.month,
                        instructorEmail: nextState.instructorEmail,
                        entries: snapshot.exists() ? JSON.parse(JSON.stringify(snapshot.val().entries || {})) : {}
                    };
                    undoStack.push(currentState);

                    // Restore next state to Firebase
                    const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${nextState.year}/${nextState.month}/entries`);
                    await set(entriesRef, nextState.entries);

                    showSuccess('×”×©×™× ×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”');
                } else {
                    // Instructor is redoing their own edit

                    // Save current state to undo stack
                    const currentState = {
                        year: currentYear,
                        month: currentMonth,
                        entries: currentTimesheet.entries ? JSON.parse(JSON.stringify(currentTimesheet.entries)) : {}
                    };
                    undoStack.push(currentState);

                    // Restore next state to Firebase
                    const sanitizedEmail = sanitizeEmail(currentUser.email);
                    const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${nextState.year}/${nextState.month}/entries`);
                    await set(entriesRef, nextState.entries);

                    // Update local state
                    currentTimesheet.entries = nextState.entries;

                    // Reset hasSeenEditWarning so popup can appear again after redo
                    hasSeenEditWarning = false;
                    sessionStorage.removeItem('hasSeenEditWarning');

                    // Reload the timesheet to reflect changes - keep edit state to preserve lock status
                    await loadMonthlyTimesheet(nextState.year, nextState.month, true);

                    showSuccess('×”×©×™× ×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”');
                }

            } catch (error) {
                console.error('Error in redo:', error);
                showError('×©×’×™××” ×‘×©×—×–×•×¨ ×”×©×™× ×•×™');
            } finally {
                showLoading(false);
            }
        }

        // Setup keyboard shortcuts for Undo/Redo
        function setupUndoRedoKeyboardShortcuts() {
            document.addEventListener('keydown', async (e) => {
                // Only work for instructors and coordinators (roles that edit timesheets)
                if (!currentUserData || (currentUserData.role !== 'instructor' && currentUserData.role !== 'coordinator')) {
                    return;
                }

                // Check if Ctrl (or Cmd on Mac) is pressed
                const isCtrlOrCmd = e.ctrlKey || e.metaKey;

                // Use e.code instead of e.key to handle different keyboard layouts (Hebrew, Caps Lock, etc.)
                // e.code represents the physical key position, not the character
                const code = e.code;

                // Ctrl+Z - Undo (KeyZ is the physical Z key regardless of language/caps lock)
                if (isCtrlOrCmd && code === 'KeyZ' && !e.shiftKey) {
                    e.preventDefault(); // Prevent browser's default undo
                    await undo();
                }

                // Ctrl+Y - Redo (KeyY is the physical Y key)
                if (isCtrlOrCmd && code === 'KeyY') {
                    e.preventDefault(); // Prevent browser's default redo
                    await redo();
                }

                // Ctrl+Shift+Z - Alternative Redo
                if (isCtrlOrCmd && code === 'KeyZ' && e.shiftKey) {
                    e.preventDefault(); // Prevent browser's default redo
                    await redo();
                }
            });

            console.log('âœ… Undo/Redo keyboard shortcuts initialized (Ctrl+Z / Ctrl+Y)');
        }

        console.log('ğŸ¬ INITIAL STATE on page load:', {
            isTimesheetLocked,
            hasBeenSubmitted,
            hasSeenEditWarning,
            sessionStorageRaw: {
                hasSeenEditWarning: sessionStorage.getItem('hasSeenEditWarning')
            }
        });

        // Coordinator report viewing state
        // Initialize with the appropriate report month (same logic as getCurrentReportMonth)
        const initCoordDate = () => {
            const now = new Date();
            const day = now.getDate();
            let year = now.getFullYear();
            let month = now.getMonth() + 1;
            if (day <= 4) {
                month--;
                if (month === 0) { month = 12; year--; }
            }
            return { year, month };
        };
        const { year: initialCoordYear, month: initialCoordMonth } = initCoordDate();
        let coordReportYear = initialCoordYear;
        let coordReportMonth = initialCoordMonth;

        // Load users from Firebase
        async function loadUsersFromFirebase() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);

                if (snapshot.exists()) {
                    const firebaseUsers = snapshot.val();

                    // Check if new hierarchical structure exists
                    if (firebaseUsers.instructors || firebaseUsers.coordinators || firebaseUsers.admins || firebaseUsers.finance) {
                        // New hierarchical structure
                        console.log('Loading users from hierarchical structure');

                        // Load instructors
                        if (firebaseUsers.instructors) {
                            Object.entries(firebaseUsers.instructors).forEach(([sanitizedEmail, userData]) => {
                                const normalEmail = unsanitizeEmail(sanitizedEmail);
                                userRoles[normalEmail] = userData;
                            });
                        }

                        // Load coordinators - Skip here, will be loaded by listener
                        // Coordinators are loaded via the onValue listener for 'users/coordinators'

                        // Load admins
                        if (firebaseUsers.admins) {
                            Object.entries(firebaseUsers.admins).forEach(([sanitizedEmail, userData]) => {
                                const normalEmail = unsanitizeEmail(sanitizedEmail);
                                userRoles[normalEmail] = userData;
                            });
                        }

                        // Load finance
                        if (firebaseUsers.finance) {
                            Object.entries(firebaseUsers.finance).forEach(([sanitizedEmail, userData]) => {
                                const normalEmail = unsanitizeEmail(sanitizedEmail);
                                userRoles[normalEmail] = userData;
                            });
                        }
                    } else {
                        // Old flat structure - backward compatibility
                        console.log('Loading users from flat structure (backward compatibility)');
                        Object.entries(firebaseUsers).forEach(([sanitizedEmail, userData]) => {
                            const normalEmail = unsanitizeEmail(sanitizedEmail);
                            userRoles[normalEmail] = userData;
                        });
                    }

                    console.log('Users loaded from Firebase:', Object.keys(userRoles).length);
                    console.log('User emails:', Object.keys(userRoles));
                    return true;
                } else {
                    console.log('No users found in Firebase, using hardcoded users');
                    return false;
                }
            } catch (error) {
                console.error('Error loading users from Firebase:', error);
                return false;
            }
        }

        // Helper Functions
        function sanitizeEmail(email) {
            // Convert email to Firebase-safe key
            // example@gmail.com -> example@gmail_com
            return email.replace(/\./g, '_');
        }

        function getCurrentReportMonth() {
            // Returns the month to display for reports
            // If today is 1-4 of the month, show previous month
            // Otherwise show current month
            const now = new Date();
            const day = now.getDate();
            let year = now.getFullYear();
            let month = now.getMonth() + 1;

            if (day <= 4) {
                month--;
                if (month === 0) {
                    month = 12;
                    year--;
                }
            }

            return { year, month };
        }

        function unsanitizeEmail(sanitized) {
            // Convert Firebase key back to email
            // example@gmail_com -> example@gmail.com
            // Simply replace all underscores with dots
            // This works because sanitizeEmail replaces ALL dots with underscores
            return sanitized.replace(/_/g, '.');
        }

        function getUserPath(email) {
            // Get the correct Firebase path for a user based on their role
            const sanitizedEmail = sanitizeEmail(email);
            const userData = userRoles[email];

            if (!userData || !userData.role) {
                // Fallback to flat structure for backward compatibility
                return `users/${sanitizedEmail}`;
            }

            const role = userData.role;

            switch (role) {
                case 'instructor':
                    return `users/instructors/${sanitizedEmail}`;
                case 'coordinator':
                    return `users/coordinators/${sanitizedEmail}`;
                case 'admin':
                    return `users/admins/${sanitizedEmail}`;
                case 'finance':
                    return `users/finance/${sanitizedEmail}`;
                default:
                    // Fallback to flat structure
                    return `users/${sanitizedEmail}`;
            }
        }

        function getSubjectPeriod(subjectName) {
            // Determine if a subject belongs to morning or afternoon
            // First check in the static lists for backwards compatibility
            if (MORNING_SUBJECTS.includes(subjectName)) {
                return 'morning';
            } else if (AFTERNOON_SUBJECTS.includes(subjectName)) {
                return 'afternoon';
            }

            // If not found in static lists, search in coordinators' subjects
            for (const [email, userData] of Object.entries(userRoles)) {
                if (userData.role === 'coordinator' && userData.subjects) {
                    if (userData.subjects.morning?.includes(subjectName)) {
                        return 'morning';
                    }
                    if (userData.subjects.afternoon?.includes(subjectName)) {
                        return 'afternoon';
                    }
                }
            }

            // Default to afternoon for unknown subjects
            return 'afternoon';
        }

        function getAllUserSubjects(userData) {
            // Get all subjects for a user, handling both old (array) and new (object) formats
            if (!userData || !userData.subjects) {
                return [];
            }

            const subjects = userData.subjects;

            // New format: { morning: [...], afternoon: [...] }
            if (typeof subjects === 'object' && !Array.isArray(subjects)) {
                const morning = subjects.morning || [];
                const afternoon = subjects.afternoon || [];
                return [...morning, ...afternoon];
            }

            // Old format: [...] - simple array
            if (Array.isArray(subjects)) {
                return subjects;
            }

            return [];
        }

        function getSubjectsForUser(userData, userEmail) {
            // Get subjects for a user based on their role
            // For hourly coordinators: return only subjects they're assigned to (as instructors)
            // For regular coordinators/instructors: return their subjects

            if (!userData) return [];

            // If hourly coordinator, get subjects from assignments
            if (userData.role === 'coordinator' && userData.employmentType === 'hourly') {
                const assignedSubjects = [];

                // Find all coordinators and check if this user is assigned to them
                Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                    if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                        coordData.assignedInstructors.forEach(assignment => {
                            const assignmentEmail = typeof assignment === 'string' ? assignment : assignment.email;
                            if (assignmentEmail === userEmail && assignment.subjects) {
                                assignedSubjects.push(...assignment.subjects);
                            }
                        });
                    }
                });

                // Return unique subjects
                return [...new Set(assignedSubjects)];
            }

            // For all others (regular coordinators, instructors), return their subjects
            return getAllUserSubjects(userData);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            // Show/hide tabs based on role
            setupRoleBasedUI();
        }

        function setupRoleBasedUI() {
            const role = currentUserData?.role;
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            // Hide all tabs and remove active class first
            navTabs.forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            tabContents.forEach(content => content.style.display = 'none');

            if (role === 'instructor') {
                // Instructor sees: ×“×™×•×•×— ×©×¢×•×ª, × ×ª×•× ×™× ××™×©×™×™×, ×¡×˜×˜×™×¡×˜×™×§×•×ª, ×”×’×“×¨×•×ª
                document.querySelector('[data-tab="timesheet"]').style.display = 'block';
                document.querySelector('[data-tab="personal"]').style.display = 'block';
                document.querySelector('[data-tab="statistics"]').style.display = 'block';
                document.querySelector('[data-tab="settings"]').style.display = 'block';
                // Show first tab
                document.getElementById('timesheetTab').style.display = 'block';
                document.querySelector('[data-tab="timesheet"]').classList.add('active');
            } else if (role === 'coordinator') {
                // Coordinator sees different tabs based on employment type
                const employmentType = currentUserData.employmentType || 'global';

                // All coordinators see these tabs
                document.querySelector('[data-tab="approvals"]').style.display = 'block';
                document.querySelector('[data-tab="manage-instructors"]').style.display = 'block';
                document.querySelector('[data-tab="settings"]').style.display = 'block';

                // Hourly coordinators also see timesheet and statistics tabs (like instructors)
                if (employmentType === 'hourly') {
                    document.querySelector('[data-tab="timesheet"]').style.display = 'block';
                    document.querySelector('[data-tab="statistics"]').style.display = 'block';
                }

                // Show first tab
                document.getElementById('approvalsTab').style.display = 'block';
                document.querySelector('[data-tab="approvals"]').classList.add('active');
                // Load coordinator data
                loadCoordinatorData();
            } else if (role === 'finance') {
                // Finance sees: ×“×•×—×•×ª ×œ××™×©×•×¨, ×¡×˜×˜×•×¡ ×“×™×•×•×—×™×, ×”×ª×¨××•×ª, ×”×’×“×¨×•×ª
                document.querySelector('[data-tab="finance-reports"]').style.display = 'block';
                document.querySelector('[data-tab="finance-status"]').style.display = 'block';
                document.querySelector('[data-tab="finance-notifications"]').style.display = 'block';
                document.querySelector('[data-tab="settings"]').style.display = 'block';
                // Show first tab
                document.getElementById('finance-reportsTab').style.display = 'block';
                document.querySelector('[data-tab="finance-reports"]').classList.add('active');
                // Load finance data
                loadFinanceReports();
                // Load notifications and setup listener
                loadNotifications();
                setupNotificationsListener();
            } else if (role === 'admin') {
                // Admin sees: × ×™×”×•×œ ××“×¨×™×›×™×, × ×™×”×•×œ ×¨×›×–×™×, × ×™×”×•×œ ×× ×”×œ×•×ª ×›×¡×¤×™×, × ×™×”×•×œ ××—×œ×§×•×ª, ×”×’×“×¨×•×ª
                document.querySelector('[data-tab="admin-manage-users"]').style.display = 'block';
                document.querySelector('[data-tab="admin-manage-coordinators"]').style.display = 'block';
                document.querySelector('[data-tab="admin-manage-finance"]').style.display = 'block';
                document.querySelector('[data-tab="admin-manage-departments"]').style.display = 'block';
                document.querySelector('[data-tab="settings"]').style.display = 'block';
                // Show first tab
                document.getElementById('admin-manage-usersTab').style.display = 'block';
                document.querySelector('[data-tab="admin-manage-users"]').classList.add('active');
                // Load admin data
                loadAdminInstructorsList();
                loadAdminCoordinatorsList();
                loadAdminFinanceManagersList();
                loadAdminDepartmentsList();
            }
        }

        function showInfo(msg) {
            const el = document.getElementById('successMessage');
            el.textContent = msg;
            el.style.background = 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)';
            el.classList.add('show');
            setTimeout(() => {
                el.classList.remove('show');
                el.style.background = '';
            }, 5000);
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMessage');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Show confirmation modal (replaces confirm())
        function showConfirmation(title, message, icon = 'âš ï¸') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                document.getElementById('confirmationIcon').textContent = icon;

                modal.style.display = 'flex';

                const handleConfirm = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    document.getElementById('confirmationConfirmBtn').removeEventListener('click', handleConfirm);
                    document.getElementById('confirmationCancelBtn').removeEventListener('click', handleCancel);
                };

                document.getElementById('confirmationConfirmBtn').addEventListener('click', handleConfirm);
                document.getElementById('confirmationCancelBtn').addEventListener('click', handleCancel);
            });
        }

        function getMonthName(month) {
            const months = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            return months[month - 1];
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const el = document.getElementById('datetimeDisplay');
            if (el) {
                el.textContent = now.toLocaleDateString('he-IL', options);
            }

            // Update greeting based on time
            updateGreeting();
        }

        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting;

            if (hour >= 5 && hour < 12) {
                greeting = '×‘×•×§×¨ ×˜×•×‘';
            } else if (hour >= 12 && hour < 14) {
                greeting = '×¦×”×¨×™×™× ×˜×•×‘×™×';
            } else if (hour >= 14 && hour < 17) {
                greeting = '××—×¨ ×”×¦×”×¨×™×™× ×˜×•×‘×™×';
            } else if (hour >= 17 && hour < 21) {
                greeting = '×¢×¨×‘ ×˜×•×‘';
            } else {
                greeting = '×œ×™×œ×” ×˜×•×‘';
            }

            const greetingEl = document.querySelector('.greeting');
            if (greetingEl) {
                greetingEl.textContent = greeting;
            }
        }

        // Check User Authorization (from hardcoded list)
        function checkUserAuthorization(email) {
            const userData = userRoles[email];
            if (userData) {
                return { 
                    authorized: true, 
                    role: userData.role, 
                    fullName: userData.fullName,
                    userData: userData 
                };
            }
            return { authorized: false };
        }

        // Initialize Auth - Check if already signed in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Load users from Firebase first
                await loadUsersFromFirebase();

                currentUser = user;
                const authCheck = checkUserAuthorization(user.email);

                if (authCheck.authorized) {
                    currentUserData = authCheck.userData;
                    await initializeApp();
                    showApp();
                } else {
                    showError('××™× ×š ××•×¨×©×” ×œ×”×©×ª××© ×‘××¢×¨×›×ª ×–×•');
                    await signOut(auth);
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // Google Sign In with Popup (like in your working code)
        document.getElementById('googleSignInBtn')?.addEventListener('click', async () => {
            showLoading(true);

            try {
                // Load users from Firebase first
                await loadUsersFromFirebase();

                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user is authorized (from hardcoded list + Firebase)
                const authCheck = checkUserAuthorization(user.email);

                if (!authCheck.authorized) {
                    await signOut(auth);
                    throw new Error('×”××©×ª××© ××™× ×• ××•×¨×©×” ×œ×’×©×ª ×œ××¢×¨×›×ª');
                }

                // User is authorized - data will be loaded by onAuthStateChanged
                showSuccess(`×©×œ×•× ${authCheck.fullName}! × ×›× ×¡×ª ×‘×”×¦×œ×—×”`);
                
            } catch (error) {
                console.error('Sign in error:', error);
                
                let errorMsg = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMsg = '×”×”×ª×—×‘×¨×•×ª ×‘×•×˜×œ×” ×¢×œ ×™×“×™ ×”××©×ª××©';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = '×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
                } else if (error.message.includes('××•×¨×©×”') || error.message.includes('× ×ª××š')) {
                    errorMsg = error.message;
                }
                
                showError(errorMsg);
                showLoading(false);
            }
        });

        // ============================================
        // COORDINATOR FUNCTIONS
        // ============================================

        async function loadCoordinatorData() {
            try {
                // Load list of all instructors
                await populateInstructorDropdown();
                // Load assigned instructors
                await loadMyInstructors();
                // Load substitution instructors
                await loadSubstitutionInstructors();
                // Load instructor reports for approval
                await loadInstructorReports();
            } catch (error) {
                console.error('Error loading coordinator data:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×¨×›×–');
            }
        }

        async function populateInstructorDropdown() {
            const dropdown = document.getElementById('selectInstructorToAssign');
            if (!dropdown) return;

            // Get all instructors from userRoles
            const instructors = Object.entries(userRoles).filter(([email, data]) => data.role === 'instructor');

            dropdown.innerHTML = '<option value="">-- ×‘×—×¨ ××“×¨×™×š --</option>';

            instructors.forEach(([email, data]) => {
                const option = document.createElement('option');
                option.value = email;
                option.textContent = data.fullName;
                dropdown.appendChild(option);
            });

            // Add event listener to show subject checkboxes when instructor is selected
            dropdown.addEventListener('change', showSubjectSelection);
        }

        function showSubjectSelection() {
            const dropdown = document.getElementById('selectInstructorToAssign');
            const selectedEmail = dropdown.value;
            const subjectSelectionArea = document.getElementById('subjectSelectionArea');
            const subjectCheckboxes = document.getElementById('subjectCheckboxes');
            const assignBtn = document.getElementById('assignInstructorBtn');

            if (!selectedEmail) {
                subjectSelectionArea.style.display = 'none';
                if (assignBtn) assignBtn.style.display = 'none';
                return;
            }

            // Get coordinator's subjects (from both morning and afternoon)
            const coordSubjects = getAllUserSubjects(currentUserData);

            if (coordSubjects.length === 0) {
                subjectSelectionArea.style.display = 'none';
                showError('××™×Ÿ ×œ×š ××§×¦×•×¢×•×ª ×œ× ×™×”×•×œ');
                return;
            }

            // Clear previous checkboxes
            subjectCheckboxes.innerHTML = '';

            // Separate subjects by period - get directly from coordinator's subjects structure
            const morningSubjs = currentUserData.subjects?.morning || [];
            const afternoonSubjs = currentUserData.subjects?.afternoon || [];

            // Add morning section header
            if (morningSubjs.length > 0) {
                const morningHeader = document.createElement('div');
                morningHeader.style.cssText = 'font-weight: 700; font-size: 15px; color: #3b82f6; margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border-radius: 10px; border-left: 5px solid #3b82f6; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); letter-spacing: 0.3px;';
                morningHeader.innerHTML = 'ğŸ“… ××©××¨×ª ×‘×•×§×¨';
                subjectCheckboxes.appendChild(morningHeader);

                // Container for morning checkboxes with wrapping
                const morningContainer = document.createElement('div');
                morningContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;';
                subjectCheckboxes.appendChild(morningContainer);

                // Add morning subjects with blue styling
                morningSubjs.forEach(subject => {
                    const checkboxWrapper = document.createElement('label');
                    checkboxWrapper.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(59, 130, 246, 0.08); border: 1.5px solid rgba(59, 130, 246, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; min-width: 140px;';
                    checkboxWrapper.onmouseover = function() {
                        this.style.background = 'rgba(59, 130, 246, 0.15)';
                        this.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                        this.style.transform = 'translateY(-1px)';
                    };
                    checkboxWrapper.onmouseout = function() {
                        this.style.background = 'rgba(59, 130, 246, 0.08)';
                        this.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                        this.style.transform = 'translateY(0)';
                    };

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = subject;
                    checkbox.checked = false;
                    checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';

                    const label = document.createElement('span');
                    label.textContent = subject;
                    label.style.cssText = 'color: var(--text-primary); font-size: 14px; font-weight: 500;';

                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.appendChild(label);
                    morningContainer.appendChild(checkboxWrapper);
                });
            }

            // Add afternoon section header
            if (afternoonSubjs.length > 0) {
                const afternoonHeader = document.createElement('div');
                afternoonHeader.style.cssText = 'font-weight: 700; font-size: 15px; color: #f59e0b; margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); border-radius: 10px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1); letter-spacing: 0.3px;';
                afternoonHeader.innerHTML = 'ğŸŒ… ××©××¨×ª ××—×¨ ×”×¦×”×¨×™×™×';
                subjectCheckboxes.appendChild(afternoonHeader);

                // Container for afternoon checkboxes with wrapping
                const afternoonContainer = document.createElement('div');
                afternoonContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px;';
                subjectCheckboxes.appendChild(afternoonContainer);

                // Add afternoon subjects with yellow styling
                afternoonSubjs.forEach(subject => {
                    const checkboxWrapper = document.createElement('label');
                    checkboxWrapper.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(245, 158, 11, 0.08); border: 1.5px solid rgba(245, 158, 11, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; min-width: 140px;';
                    checkboxWrapper.onmouseover = function() {
                        this.style.background = 'rgba(245, 158, 11, 0.15)';
                        this.style.borderColor = 'rgba(245, 158, 11, 0.5)';
                        this.style.transform = 'translateY(-1px)';
                    };
                    checkboxWrapper.onmouseout = function() {
                        this.style.background = 'rgba(245, 158, 11, 0.08)';
                        this.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                        this.style.transform = 'translateY(0)';
                    };

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = subject;
                    checkbox.checked = false;
                    checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';

                    const label = document.createElement('span');
                    label.textContent = subject;
                    label.style.cssText = 'color: var(--text-primary); font-size: 14px; font-weight: 500;';

                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.appendChild(label);
                    afternoonContainer.appendChild(checkboxWrapper);
                });
            }

            // Show the subject selection area and button
            subjectSelectionArea.style.display = 'block';
            if (assignBtn) assignBtn.style.display = 'block';
        }

        async function loadMyInstructors() {
            const container = document.getElementById('myInstructorsList');
            if (!container) return;

            const myInstructors = currentUserData.assignedInstructors || [];

            if (myInstructors.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™× ×›×¨×’×¢</div>';
                return;
            }

            container.innerHTML = '';

            // Get current report month
            const { year: reportYear, month: reportMonth } = getCurrentReportMonth();

            for (const instructorAssignment of myInstructors) {
                // Support both old format (string) and new format (object)
                const instructorEmail = typeof instructorAssignment === 'string' ? instructorAssignment : instructorAssignment.email;
                const assignedSubjects = typeof instructorAssignment === 'object' ? instructorAssignment.subjects : null;

                const instructorData = userRoles[instructorEmail];
                if (!instructorData) continue;

                // Check submission status for this instructor to this coordinator
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
                const statusRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${reportYear}/${reportMonth}/submissions/${sanitizedCoordEmail}`);
                let isSubmitted = false;
                try {
                    const statusSnapshot = await get(statusRef);
                    isSubmitted = statusSnapshot.exists();
                } catch (error) {
                    console.error('Error loading submission status:', error);
                }

                const card = document.createElement('div');
                card.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); margin-bottom: 16px;';

                // Show only assigned subjects if available, otherwise show all relevant subjects
                let displaySubjects = [];

                if (assignedSubjects && assignedSubjects.length > 0) {
                    // New format: show only assigned subjects with color coding (no text labels)
                    assignedSubjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        if (period === 'morning') {
                            displaySubjects.push(`<span style="background: rgba(59, 130, 246, 0.25); color: #3b82f6; padding: 6px 12px; border-radius: 6px; display: inline-block; margin: 2px; font-weight: 600; border: 1px solid rgba(59, 130, 246, 0.4);">${subj}</span>`);
                        } else {
                            displaySubjects.push(`<span style="background: rgba(245, 158, 11, 0.25); color: #f59e0b; padding: 6px 12px; border-radius: 6px; display: inline-block; margin: 2px; font-weight: 600; border: 1px solid rgba(245, 158, 11, 0.4);">${subj}</span>`);
                        }
                    });
                } else {
                    // Old format: show all subjects that match coordinator's subjects
                    const coordSubjects = getAllUserSubjects(currentUserData);
                    const instructorSubjects = instructorData.subjects || { morning: [], afternoon: [] };

                    instructorSubjects.morning?.forEach(subj => {
                        if (coordSubjects.includes(subj)) displaySubjects.push(`<span style="background: rgba(59, 130, 246, 0.25); color: #3b82f6; padding: 6px 12px; border-radius: 6px; display: inline-block; margin: 2px; font-weight: 600; border: 1px solid rgba(59, 130, 246, 0.4);">${subj}</span>`);
                    });
                    instructorSubjects.afternoon?.forEach(subj => {
                        if (coordSubjects.includes(subj)) displaySubjects.push(`<span style="background: rgba(245, 158, 11, 0.25); color: #f59e0b; padding: 6px 12px; border-radius: 6px; display: inline-block; margin: 2px; font-weight: 600; border: 1px solid rgba(245, 158, 11, 0.4);">${subj}</span>`);
                    });
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                ğŸ‘¤ ${instructorData.fullName}
                            </h4>
                            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                                ğŸ“§ ${instructorEmail}
                            </p>
                            <div style="font-size: 14px; color: var(--text-primary);">
                                <strong>××§×¦×•×¢×•×ª ××©×•×™×›×™×:</strong><br>
                                <div style="margin-top: 8px;">
                                    ${displaySubjects.length > 0 ? displaySubjects.join(' ') : '<span style="color: var(--text-secondary);">××™×Ÿ ××§×¦×•×¢×•×ª ××©×•×™×›×™×</span>'}
                                </div>
                            </div>
                            <div style="margin-top: 12px; font-size: 13px;">
                                <strong>×¡×˜×˜×•×¡ ×“×•×— ${getMonthName(reportMonth)} ${reportYear}:</strong>
                                <div style="margin-top: 6px;">
                                    ${isSubmitted ?
                                        '<span style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 6px 12px; border-radius: 6px; display: inline-block; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.3);">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–</span>' :
                                        '<span style="background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 6px 12px; border-radius: 6px; display: inline-block; font-weight: 600; border: 1px solid rgba(239, 68, 68, 0.3);">âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-primary" onclick="viewInstructorReport('${instructorEmail}', ${reportYear}, ${reportMonth})" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">
                                ğŸ‘ï¸ ×¦×¤×” ×‘×“×•×—
                            </button>
                            <button class="btn" onclick="editInstructorAssignment('${instructorEmail}')" style="padding: 8px 16px; font-size: 13px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; white-space: nowrap;">
                                âœï¸ ×¢×¨×•×š
                            </button>
                            <button class="btn" onclick="unassignInstructor('${instructorEmail}')" style="padding: 8px 16px; font-size: 13px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; white-space: nowrap;">
                                ğŸ—‘ï¸ ×”×¡×¨ ×©×™×•×š
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            }
        }

        // Load substitution instructors for coordinator
        async function loadSubstitutionInstructors() {
            const container = document.getElementById('substitutionInstructorsList');
            if (!container) {
                console.log('âŒ substitutionInstructorsList container not found');
                return;
            }

            // Use coordinator's selected month, not current month
            const reportYear = coordReportYear;
            const reportMonth = coordReportMonth;

            console.log(`ğŸ” Loading substitutions for coordinator: ${currentUser.email}`);
            console.log(`ğŸ“… Year: ${reportYear}, Month: ${reportMonth}`);

            // Group substitutions by instructor - load from each instructor's timesheet
            const substByInstructor = {};

            try {
                // Get all instructors who might have substitutions
                const timesheetsRef = ref(database, 'timesheets');
                const timesheetsSnapshot = await get(timesheetsRef);

                if (!timesheetsSnapshot.exists()) {
                    console.log('âš ï¸ No timesheets found');
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">××™×Ÿ ×”×—×œ×¤×•×ª ×›×¨×’×¢</div>';
                    return;
                }

                const allTimesheets = timesheetsSnapshot.val();

                // Iterate through all instructors' timesheets
                for (const [sanitizedEmail, instructorData] of Object.entries(allTimesheets)) {
                    const yearData = instructorData[reportYear];
                    if (!yearData) continue;

                    const monthData = yearData[reportMonth];
                    if (!monthData || !monthData.entries) continue;

                    const entries = monthData.entries;
                    const instructorEmail = Object.keys(userRoles).find(email => sanitizeEmail(email) === sanitizedEmail);
                    if (!instructorEmail) continue;

                    // Look for substitution entries for this coordinator's departments
                    Object.entries(entries).forEach(([key, entry]) => {
                        if (key.includes('_substitution_')) {
                            // Check if this substitution is for one of this coordinator's departments
                            const coordDepartments = getAllUserSubjects(currentUserData);
                            if (!coordDepartments.includes(entry.department)) {
                                return; // Skip if not this coordinator's department
                            }

                            const date = key.split('_substitution_')[0];

                            if (!substByInstructor[instructorEmail]) {
                                const userData = userRoles[instructorEmail];
                                substByInstructor[instructorEmail] = {
                                    name: userData?.fullName || instructorEmail,
                                    substitutions: []
                                };
                            }

                            substByInstructor[instructorEmail].substitutions.push({
                                key: key,
                                date: date,
                                department: entry.department || '×œ× ×¦×•×™×Ÿ',
                                period: entry.period || 'morning',
                                hours: entry.hours || { teaching: 0, training: 0 },
                                status: entry.status,
                                submittedAt: entry.submittedAt
                            });
                        }
                    });
                }

                if (Object.keys(substByInstructor).length === 0) {
                    console.log('âš ï¸ No substitutions found for coordinator departments');
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">××™×Ÿ ×”×—×œ×¤×•×ª ×›×¨×’×¢</div>';
                    return;
                }

                console.log('âœ… Substitutions by instructor:', substByInstructor);

                // Render cards
                container.innerHTML = '';

                for (const [instructorEmail, data] of Object.entries(substByInstructor)) {
                    // Check if already submitted to finance
                    const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                    const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                    const financeEmail = Object.keys(userRoles).find(email => userRoles[email].role === 'finance');
                    let isSubmittedToFinance = false;

                    if (financeEmail) {
                        const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                        const financeSubmissionRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${reportYear}/${reportMonth}/${sanitizedInstructorEmail}_${sanitizedCoordEmail}`);
                        try {
                            const snapshot = await get(financeSubmissionRef);
                            isSubmittedToFinance = snapshot.exists();
                        } catch (error) {
                            console.error('Error checking finance submission:', error);
                        }
                    }

                    const card = document.createElement('div');
                    const cardStyle = isSubmittedToFinance
                        ? 'background: rgba(34, 197, 94, 0.1); border-radius: 16px; padding: 24px; border: 2px solid rgba(34, 197, 94, 0.5); margin-bottom: 16px;'
                        : 'background: rgba(139, 92, 246, 0.05); border-radius: 16px; padding: 24px; border: 1px solid rgba(139, 92, 246, 0.3); margin-bottom: 16px;';
                    card.style.cssText = cardStyle;
                    card.id = `subst-card-${sanitizedInstructorEmail}`;

                    // Calculate totals
                    let totalTeaching = 0;
                    let totalTraining = 0;
                    data.substitutions.forEach(s => {
                        totalTeaching += s.hours.teaching || 0;
                        totalTraining += s.hours.training || 0;
                    });

                    const substitutionsList = data.substitutions.map(s => {
                        // Format date to dd/mm/yy
                        const [year, month, day] = s.date.split('-');
                        const formattedDate = `${day}/${month}/${year.slice(-2)}`;

                        return `
                        <div style="padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">ğŸ“… ${formattedDate}</span>
                                <span style="font-size: 12px; color: var(--text-secondary);">${s.department} (${s.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})</span>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px;">
                                <span style="color: #f97316;">ğŸ“ ×”×“×¨×›×”: ${s.hours.teaching || 0}</span>
                                <span style="color: #34ebbd;">ğŸ“š ×”×©×ª×œ××•×ª: ${s.hours.training || 0}</span>
                            </div>
                        </div>
                    `;
                    }).join('');

                    const statusBadge = isSubmittedToFinance
                        ? '<span style="display: inline-block; padding: 4px 12px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 20px; font-size: 12px; font-weight: 600; color: #22c55e; margin-right: 12px;">âœ… ×©×•×’×¨ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×</span>'
                        : '<span style="display: inline-block; padding: 4px 12px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.5); border-radius: 20px; font-size: 12px; font-weight: 600; color: #f59e0b; margin-right: 12px;">â³ ×××ª×™×Ÿ ×œ×©×œ×™×—×”</span>';

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                    ğŸ‘¤ ${data.name}
                                    ${statusBadge}
                                </h4>
                                <div style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                                    <strong style="color: var(--text-primary);">×¡×”"×› ×©×¢×•×ª:</strong>
                                    <div style="display: flex; gap: 16px; margin-top: 6px; font-size: 15px; font-weight: 600;">
                                        <span style="color: #f97316;">ğŸ“ ${totalTeaching} ×”×“×¨×›×”</span>
                                        <span style="color: #34ebbd;">ğŸ“š ${totalTraining} ×”×©×ª×œ××•×ª</span>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px;">
                                    <strong>×”×—×œ×¤×•×ª (${data.substitutions.length}):</strong>
                                </div>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${substitutionsList}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-right: 16px;">
                                <button class="btn btn-primary" onclick="viewSubstitutionReport('${instructorEmail}', ${reportYear}, ${reportMonth})" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">
                                    ğŸ‘ï¸ ×¦×¤×” ×‘×“×•×—
                                </button>
                                <button class="btn" onclick="editSubstitutionHours('${instructorEmail}', ${reportYear}, ${reportMonth})" style="padding: 8px 16px; font-size: 13px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; white-space: nowrap;">
                                    âœï¸ ×¢×¨×•×š ×©×¢×•×ª
                                </button>
                            </div>
                        </div>
                    `;

                    container.appendChild(card);
                }

                // Show submit to finance button if there are substitutions
                const submitContainer = document.getElementById('submitSubstitutionsToFinanceContainer');
                if (submitContainer) {
                    submitContainer.style.display = Object.keys(substByInstructor).length > 0 ? 'block' : 'none';
                }

            } catch (error) {
                console.error('Error loading substitution instructors:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×—×œ×¤×•×ª</div>';

                // Hide submit button on error
                const submitContainer = document.getElementById('submitSubstitutionsToFinanceContainer');
                if (submitContainer) {
                    submitContainer.style.display = 'none';
                }
            }
        }

        // View substitution report in modal
        window.viewSubstitutionReport = async function(instructorEmail, year, month) {
            const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
            const substRef = ref(database, `substitutions/${sanitizedCoordEmail}/${year}/${month}`);

            try {
                const snapshot = await get(substRef);
                if (!snapshot.exists()) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                const substitutionsData = snapshot.val();
                const instructorSubstitutions = [];

                Object.entries(substitutionsData).forEach(([key, subst]) => {
                    if (subst.instructorEmail === instructorEmail) {
                        instructorSubstitutions.push({
                            key: key,
                            date: subst.date,
                            department: subst.department,
                            period: subst.period,
                            hours: subst.hours
                        });
                    }
                });

                if (instructorSubstitutions.length === 0) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;';

                // Header
                const userData = userRoles[instructorEmail];
                const instructorName = userData?.fullName || instructorEmail;

                modalContent.innerHTML = `
                    <h2 style="font-size: 24px; font-weight: 700; color: rgba(139, 92, 246, 1); margin-bottom: 8px; text-align: center;">
                        ×“×•×— ×”×—×œ×¤×•×ª
                    </h2>
                    <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; text-align: center;">
                        ${instructorName} - ${getMonthName(month)} ${year}
                    </p>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(139, 92, 246, 0.1); border-bottom: 2px solid rgba(139, 92, 246, 0.3);">
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">×ª××¨×™×š</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">××—×œ×§×”</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">××©××¨×ª</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">×”×“×¨×›×”</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">×”×©×ª×œ××•×ª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${instructorSubstitutions.map(s => {
                                    // Format date to dd/mm/yy
                                    const [year, month, day] = s.date.split('-');
                                    const formattedDate = `${day}/${month}/${year.slice(-2)}`;

                                    return `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px; text-align: center; color: var(--text-primary);">${formattedDate}</td>
                                        <td style="padding: 12px; text-align: center; color: var(--text-primary);">${s.department}</td>
                                        <td style="padding: 12px; text-align: center; color: var(--text-secondary);">${s.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'}</td>
                                        <td style="padding: 12px; text-align: center; color: #f97316; font-weight: 600;">${s.hours.teaching || 0}</td>
                                        <td style="padding: 12px; text-align: center; color: #34ebbd; font-weight: 600;">${s.hours.training || 0}</td>
                                    </tr>
                                `;
                                }).join('')}
                                <tr style="background: rgba(139, 92, 246, 0.05); border-top: 2px solid rgba(139, 92, 246, 0.3); font-weight: 700;">
                                    <td colspan="3" style="padding: 12px; text-align: center; color: var(--text-primary);">×¡×”"×›</td>
                                    <td style="padding: 12px; text-align: center; color: #f97316; font-weight: 700;">${instructorSubstitutions.reduce((sum, s) => sum + (s.hours.teaching || 0), 0)}</td>
                                    <td style="padding: 12px; text-align: center; color: #34ebbd; font-weight: 700;">${instructorSubstitutions.reduce((sum, s) => sum + (s.hours.training || 0), 0)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; justify-content: center; margin-top: 24px;">
                        <button id="closeReportModalBtn" style="padding: 12px 24px; background: var(--accent-color); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ×¡×’×•×¨
                        </button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Add close button event listener
                const closeBtn = document.getElementById('closeReportModalBtn');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

            } catch (error) {
                console.error('Error viewing substitution report:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
            }
        }

        // Edit substitution hours
        window.editSubstitutionHours = async function(instructorEmail, year, month) {
            const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
            const substRef = ref(database, `substitutions/${sanitizedCoordEmail}/${year}/${month}`);

            try {
                const snapshot = await get(substRef);
                if (!snapshot.exists()) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                const substitutionsData = snapshot.val();
                const instructorSubstitutions = [];

                Object.entries(substitutionsData).forEach(([key, subst]) => {
                    if (subst.instructorEmail === instructorEmail) {
                        instructorSubstitutions.push({
                            key: key,
                            ...subst
                        });
                    }
                });

                if (instructorSubstitutions.length === 0) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                // Create edit modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;';

                const userData = userRoles[instructorEmail];
                const instructorName = userData?.fullName || instructorEmail;

                const entriesHTML = instructorSubstitutions.map((s, index) => {
                    // Format date to dd/mm/yy
                    const [year, month, day] = s.date.split('-');
                    const formattedDate = `${day}/${month}/${year.slice(-2)}`;

                    return `
                    <div style="padding: 16px; background: var(--card-bg); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <strong style="color: var(--text-primary);">×ª××¨×™×š:</strong> ${formattedDate}<br>
                                <strong style="color: var(--text-primary);">××—×œ×§×”:</strong> ${s.department} (${s.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <label style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 13px; color: #f97316; font-weight: 600;">×”×“×¨×›×”</span>
                                <select class="edit-teaching-hours" data-index="${index}" data-key="${s.key}" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                                    ${generateHoursOptions(s.hours.teaching || 0)}
                                </select>
                            </label>
                            <label style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 13px; color: #34ebbd; font-weight: 600;">×”×©×ª×œ××•×ª</span>
                                <select class="edit-training-hours" data-index="${index}" data-key="${s.key}" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                                    ${generateHoursOptions(s.hours.training || 0)}
                                </select>
                            </label>
                        </div>
                    </div>
                `;
                }).join('');

                modalContent.innerHTML = `
                    <h2 style="font-size: 24px; font-weight: 700; color: rgba(139, 92, 246, 1); margin-bottom: 8px; text-align: center;">
                        ×¢×¨×•×š ×©×¢×•×ª ×”×—×œ×¤×•×ª
                    </h2>
                    <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; text-align: center;">
                        ${instructorName} - ${getMonthName(month)} ${year}
                    </p>
                    <div id="substitutionEntriesContainer">
                        ${entriesHTML}
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button id="cancelEditBtn" style="padding: 12px 24px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 600;">
                            ×‘×™×˜×•×œ
                        </button>
                        <button id="saveEditBtn" style="padding: 12px 24px; background: rgba(139, 92, 246, 0.9); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ×©××•×¨ ×©×™× ×•×™×™×
                        </button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Event listeners
                document.getElementById('cancelEditBtn').onclick = () => document.body.removeChild(modal);
                document.getElementById('saveEditBtn').onclick = async () => {
                    try {
                        const teachingSelects = modal.querySelectorAll('.edit-teaching-hours');
                        const trainingSelects = modal.querySelectorAll('.edit-training-hours');

                        for (let i = 0; i < instructorSubstitutions.length; i++) {
                            const key = instructorSubstitutions[i].key;
                            const teachingHours = parseFloat(teachingSelects[i].value);
                            const trainingHours = parseFloat(trainingSelects[i].value);

                            const hoursRef = ref(database, `substitutions/${sanitizedCoordEmail}/${year}/${month}/${key}/hours`);
                            await set(hoursRef, {
                                teaching: teachingHours,
                                training: trainingHours
                            });
                        }

                        showSuccess('×”×©×¢×•×ª ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”');
                        document.body.removeChild(modal);
                        await loadSubstitutionInstructors();

                    } catch (error) {
                        console.error('Error updating substitution hours:', error);
                        showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×¢×•×ª');
                    }
                };

            } catch (error) {
                console.error('Error editing substitution hours:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
            }
        }

        // Submit substitutions to finance manager
        window.submitSubstitutionsToFinance = async function(instructorEmail, year, month) {
            const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
            const substRef = ref(database, `substitutions/${sanitizedCoordEmail}/${year}/${month}`);

            try {
                const snapshot = await get(substRef);
                if (!snapshot.exists()) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                const substitutionsData = snapshot.val();
                const instructorSubstitutions = [];

                Object.entries(substitutionsData).forEach(([key, subst]) => {
                    if (subst.instructorEmail === instructorEmail) {
                        instructorSubstitutions.push({
                            key: key,
                            ...subst
                        });
                    }
                });

                if (instructorSubstitutions.length === 0) {
                    showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ××“×¨×™×š ×–×”');
                    return;
                }

                // Save to finance submissions
                const submissionData = {
                    instructorEmail: instructorEmail,
                    instructorName: instructorSubstitutions[0].instructorName,
                    coordinatorEmail: currentUser.email,
                    coordinatorName: currentUser.displayName || currentUser.email,
                    substitutions: instructorSubstitutions.map(s => ({
                        date: s.date,
                        department: s.department,
                        period: s.period,
                        hours: s.hours
                    })),
                    submittedAt: Date.now(),
                    year: year,
                    month: month
                };

                // Save to finance submissions path
                const financeSubstRef = ref(database, `finance_submissions/substitutions/${year}/${month}/${sanitizedInstructorEmail}_${sanitizedCoordEmail}`);
                await set(financeSubstRef, submissionData);

                // Update status in coordinator's substitutions
                for (const subst of instructorSubstitutions) {
                    const statusRef = ref(database, `substitutions/${sanitizedCoordEmail}/${year}/${month}/${subst.key}/submittedToFinance`);
                    await set(statusRef, true);
                }

                showSuccess('×”×”×—×œ×¤×•×ª ×©×•×’×¨×• ×œ×× ×”×œ×ª ×”×›×¡×¤×™× ×‘×”×¦×œ×—×”');
                await loadSubstitutionInstructors();

            } catch (error) {
                console.error('Error submitting substitutions to finance:', error);
                showError('×©×’×™××” ×‘×©×™×’×•×¨ ×”×”×—×œ×¤×•×ª ×œ×›×¡×¤×™×');
            }
        }

        async function loadInstructorReports() {
            const container = document.getElementById('monthlyReportsList');
            if (!container) return;

            const myInstructors = currentUserData.assignedInstructors || [];

            if (myInstructors.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™× ×›×¨×’×¢</div>';
                return;
            }

            container.innerHTML = '';

            // Use coordinator's selected month
            const reportYear = coordReportYear;
            const reportMonth = coordReportMonth;

            // Update the month title
            const monthName = getMonthName(reportMonth);
            const coordMonthTitle = document.getElementById('coordMonthTitle');
            if (coordMonthTitle) {
                coordMonthTitle.textContent = `${monthName} ${reportYear}`;
            }

            // Separate instructors into three groups: pending review (orange), submitted to finance (green), and not submitted (red)
            const pendingReview = [];
            const submittedToFinance = [];
            const notSubmittedToFinance = [];

            // First, check finance submission status and pending review status for all instructors
            for (const instructorAssignment of myInstructors) {
                const instructorEmail = typeof instructorAssignment === 'string' ? instructorAssignment : instructorAssignment.email;
                const instructorData = userRoles[instructorEmail];
                if (!instructorData) continue;

                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                // First check if submitted to finance
                const financeEmails = Object.keys(userRoles).filter(email => userRoles[email].role === 'finance');
                let isSubmittedToFinance = false;

                for (const financeEmail of financeEmails) {
                    const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                    const financeSubmissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${reportYear}/${reportMonth}/financeSubmissions/${sanitizedFinanceEmail}/${sanitizedCoordEmail}`);
                    try {
                        const snapshot = await get(financeSubmissionRef);
                        if (snapshot.exists()) {
                            isSubmittedToFinance = true;
                            break;
                        }
                    } catch (error) {
                        console.error('Error checking finance submission:', error);
                    }
                }

                // Then check if report is in pending review status (edited after submission to coordinator)
                const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${reportYear}/${reportMonth}/submissions/${sanitizedCoordEmail}`);
                let isPendingReview = false;
                try {
                    const submissionSnapshot = await get(submissionRef);
                    if (submissionSnapshot.exists()) {
                        const submissionData = submissionSnapshot.val();
                        // Pending review means instructor edited and resubmitted after initial submission
                        if (submissionData.status === 'pending_review' && submissionData.needsCoordinatorReview === true) {
                            isPendingReview = true;
                        }
                    }
                } catch (error) {
                    console.error('Error checking pending review status:', error);
                }

                // Categorize based on status
                if (isPendingReview) {
                    pendingReview.push(instructorAssignment);
                } else if (isSubmittedToFinance) {
                    submittedToFinance.push(instructorAssignment);
                } else {
                    notSubmittedToFinance.push(instructorAssignment);
                }
            }

            // Display PENDING REVIEW group (ORANGE) - always create containers
            const pendingReviewHeader = document.createElement('div');
            pendingReviewHeader.id = 'pendingReviewHeader';
            pendingReviewHeader.style.cssText = `background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; ${pendingReview.length === 0 ? 'display: none;' : ''}`;
            pendingReviewHeader.innerHTML = `
                <h3 style="font-size: 18px; font-weight: 600; color: #f59e0b; margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸŸ  ×“×•×—×•×ª ×©×¢×‘×¨×• ×¢×¨×™×›×” × ×•×¡×¤×ª - ×××ª×™×Ÿ ×œ××™×©×•×¨ (${pendingReview.length})
                </h3>
                <p style="font-size: 13px; color: #92400e; margin: 8px 0 0 0;">
                    ×”××“×¨×™×š ×¢×¨×š ××ª ×”×“×•×— ××—×¨×™ ×”×©×™×’×•×¨ ×”×¨××©×•× ×™. × × ×œ×‘×“×•×§ ××ª ×”×©×™× ×•×™×™× ×•×œ××©×¨.
                </p>
            `;
            container.appendChild(pendingReviewHeader);

            const pendingReviewContainer = document.createElement('div');
            pendingReviewContainer.id = 'pendingReviewList';
            pendingReviewContainer.style.cssText = `margin-bottom: 24px; ${pendingReview.length === 0 ? 'display: none;' : ''}`;
            container.appendChild(pendingReviewContainer);

            for (const instructorAssignment of pendingReview) {
                await createInstructorCard(instructorAssignment, pendingReviewContainer, reportYear, reportMonth, 'orange', true);
            }

            // Display NOT submitted to finance group (RED) - always create containers
            const notSubmittedHeader = document.createElement('div');
            notSubmittedHeader.id = 'notSubmittedToFinanceHeader';
            notSubmittedHeader.style.cssText = `background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; ${notSubmittedToFinance.length === 0 ? 'display: none;' : ''}`;
            notSubmittedHeader.innerHTML = `
                <h3 style="font-size: 18px; font-weight: 600; color: #ef4444; margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸ”´ ×œ× ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™× (${notSubmittedToFinance.length})
                </h3>
            `;
            container.appendChild(notSubmittedHeader);

            const notSubmittedContainer = document.createElement('div');
            notSubmittedContainer.id = 'notSubmittedToFinanceList';
            notSubmittedContainer.style.cssText = `margin-bottom: 24px; ${notSubmittedToFinance.length === 0 ? 'display: none;' : ''}`;
            container.appendChild(notSubmittedContainer);

            for (const instructorAssignment of notSubmittedToFinance) {
                await createInstructorCard(instructorAssignment, notSubmittedContainer, reportYear, reportMonth, 'red', false);
            }

            // Display submitted to finance group (GREEN) - always create containers
            const submittedHeader = document.createElement('div');
            submittedHeader.id = 'submittedToFinanceHeader';
            submittedHeader.style.cssText = `background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; ${submittedToFinance.length === 0 ? 'display: none;' : ''}`;
            submittedHeader.innerHTML = `
                <h3 style="font-size: 18px; font-weight: 600; color: #22c55e; margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸŸ¢ ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™× (${submittedToFinance.length})
                </h3>
            `;
            container.appendChild(submittedHeader);

            const submittedContainer = document.createElement('div');
            submittedContainer.id = 'submittedToFinanceList';
            submittedContainer.style.cssText = submittedToFinance.length === 0 ? 'display: none;' : '';
            container.appendChild(submittedContainer);

            for (const instructorAssignment of submittedToFinance) {
                await createInstructorCard(instructorAssignment, submittedContainer, reportYear, reportMonth, 'green', false);
            }
        }

        // Helper function to create instructor card
        async function createInstructorCard(instructorAssignment, container, reportYear, reportMonth, borderColor, isPendingReview = false) {
            const instructorEmail = typeof instructorAssignment === 'string' ? instructorAssignment : instructorAssignment.email;
            const instructorData = userRoles[instructorEmail];
            if (!instructorData) return;

            // Check submission status and get resubmit reason if exists
            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
            const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
            const statusRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${reportYear}/${reportMonth}/submissions/${sanitizedCoordEmail}`);
            let isSubmitted = false;
            let resubmitReason = '';
            let submittedByCoordinator = false;
            try {
                const statusSnapshot = await get(statusRef);
                isSubmitted = statusSnapshot.exists();
                if (statusSnapshot.exists()) {
                    const submissionData = statusSnapshot.val();
                    resubmitReason = submissionData.resubmitReason || '';
                    submittedByCoordinator = submissionData.submittedBy === currentUser.email;
                }
            } catch (error) {
                console.error('Error loading submission status:', error);
            }

            // Set border color based on status
            let borderStyle = '';
            if (borderColor === 'orange') {
                borderStyle = 'border: 2px solid rgba(245, 158, 11, 0.5);';
            } else if (borderColor === 'green') {
                borderStyle = 'border: 2px solid rgba(34, 197, 94, 0.5);';
            } else {
                borderStyle = 'border: 2px solid rgba(239, 68, 68, 0.5);';
            }

            // Create expandable card (LITE version)
            const cardId = `instructor-${instructorEmail.replace(/\./g, '_')}`;
            const card = document.createElement('div');
            card.id = `card-${cardId}`;
            card.style.cssText = `background: var(--card-bg); border-radius: 8px; padding: 16px; ${borderStyle} margin-bottom: 12px; transition: all 0.3s;`;

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleLiteReport('${cardId}', '${instructorEmail}', ${reportYear}, ${reportMonth})">
                    <div style="flex: 1;">
                        <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                            ğŸ‘¤ ${instructorData.fullName}
                        </span>
                        <span style="font-size: 14px; color: var(--text-secondary); margin-right: 12px;">
                            (${instructorEmail})
                        </span>
                        <button id="${cardId}-view-toggle" onclick="event.stopPropagation(); toggleTableView('${cardId}', '${instructorEmail}', ${reportYear}, ${reportMonth})" style="padding: 4px 12px; margin-right: 12px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); transition: all 0.2s;">
                            ğŸ“Š ×ª×¦×•×’×” ××œ××”
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        ${isPendingReview ?
                            `<button onclick="event.stopPropagation(); approveChanges('${instructorEmail}', ${reportYear}, ${reportMonth})" class="btn" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%); border: 1px solid rgba(245, 158, 11, 0.6); color: #d97706; font-weight: 600; font-size: 13px; cursor: pointer;">
                                ğŸŸ  ×œ×—×¦×• ×œ××™×©×•×¨ ×”×©×™× ×•×™×™×
                            </button>` :
                            `<div style="display: flex; align-items: center; justify-content: space-between; gap: 30px; flex-wrap: nowrap;">
                                ${!isSubmitted ?
                                    `<button id="${cardId}-override-btn" onclick="event.stopPropagation(); submitOnBehalfOfInstructor('${instructorEmail}', ${reportYear}, ${reportMonth}, '${cardId}')" class="btn" style="padding: 3px 5px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4); color: #3b82f6; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap;">
                                        ğŸ”„ ×©×’×¨ ×‘××§×•× ×”××“×¨×™×š
                                    </button>` :
                                    ''
                                }
                                <span id="${cardId}-status" style="font-size: 13px; font-weight: 600; white-space: nowrap;">
                                    ${isSubmitted ?
                                        (submittedByCoordinator ?
                                            '<span style="color: #22c55e;">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×– (×©×•×’×¨ ×¢"×™ ×”×¨×›×–)</span>' :
                                            '<span style="color: #22c55e;">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–</span>') :
                                        '<span style="color: #ef4444;">âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–</span>'
                                    }
                                </span>
                            </div>`
                        }
                        <span id="${cardId}-arrow" style="transition: transform 0.3s; font-size: 20px;">â–¼</span>
                    </div>
                </div>
                ${isPendingReview && resubmitReason ? `
                    <div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-right: 3px solid #f59e0b; border-radius: 4px;">
                        <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">ğŸ“ ×¡×™×‘×ª ×”×¢×¨×™×›×”:</div>
                        <div style="font-size: 13px; color: #78350f;">${resubmitReason}</div>
                    </div>
                ` : ''}
                <div id="${cardId}-content" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                </div>
            `;

            container.appendChild(card);

            // Setup realtime listener for submission status
            const listenerInstructorEmail = sanitizeEmail(instructorEmail);
            const listenerCoordEmail = sanitizeEmail(currentUser.email);
            const liveSubmissionRef = ref(database, `timesheets/${listenerInstructorEmail}/${reportYear}/${reportMonth}/submissions/${listenerCoordEmail}`);

            onValue(liveSubmissionRef, (snapshot) => {
                const statusElement = document.getElementById(`${cardId}-status`);
                const overrideButton = document.getElementById(`${cardId}-override-btn`);
                const cardElement = document.getElementById(`card-${cardId}`);
                if (!cardElement) return;

                if (statusElement) {
                    const isNowSubmitted = snapshot.exists();
                    const submittedByCoord = snapshot.exists() && snapshot.val().submittedBy === currentUser.email;

                    statusElement.innerHTML = isNowSubmitted ?
                        (submittedByCoord ?
                            '<span style="color: #22c55e;">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×– (×©×•×’×¨ ×¢"×™ ×”×¨×›×–)</span>' :
                            '<span style="color: #22c55e;">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–</span>') :
                        '<span style="color: #ef4444;">âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–</span>';

                    // Show/hide override button
                    if (overrideButton) {
                        overrideButton.style.display = isNowSubmitted ? 'none' : 'inline-block';
                    }
                }

                // Check if status changed to/from pending_review
                if (snapshot.exists()) {
                    const submissionData = snapshot.val();
                    const isPendingReviewNow = submissionData.status === 'pending_review' && submissionData.needsCoordinatorReview === true;

                    if (isPendingReviewNow && cardElement.parentElement?.id !== 'pendingReviewList') {
                        // Move to orange list
                        const orangeContainer = document.getElementById('pendingReviewList');
                        if (orangeContainer) {
                            cardElement.style.border = '2px solid rgba(245, 158, 11, 0.5)';
                            orangeContainer.appendChild(cardElement);
                            updateFinanceSubmissionCounters();
                            // Reload the page to show reason and approve button
                            loadInstructorReports();
                        }
                    } else if (!isPendingReviewNow && submissionData.status === 'submitted' && cardElement.parentElement?.id === 'pendingReviewList') {
                        // Status changed back to submitted - check finance status to determine list
                        updateFinanceSubmissionCounters();
                        loadInstructorReports(); // Reload to move to correct list
                    }
                }
            });

            // Setup realtime listener for finance submission status - to move card between lists
            const financeEmails = Object.keys(userRoles).filter(email => userRoles[email].role === 'finance');
            for (const financeEmail of financeEmails) {
                const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                const financeSubmissionRef = ref(database, `timesheets/${listenerInstructorEmail}/${reportYear}/${reportMonth}/financeSubmissions/${sanitizedFinanceEmail}/${listenerCoordEmail}`);

                onValue(financeSubmissionRef, (snapshot) => {
                    const cardElement = document.getElementById(`card-${cardId}`);
                    if (!cardElement) return;

                    const isSubmittedToFinance = snapshot.exists();

                    // Move card between lists dynamically
                    if (isSubmittedToFinance) {
                        // Move to green list
                        const greenContainer = document.getElementById('submittedToFinanceList');
                        if (greenContainer && cardElement.parentElement?.id !== 'submittedToFinanceList') {
                            cardElement.style.border = '2px solid rgba(34, 197, 94, 0.5)';
                            greenContainer.appendChild(cardElement);
                            // Update counters
                            updateFinanceSubmissionCounters();
                        }
                    } else {
                        // Move to red list
                        const redContainer = document.getElementById('notSubmittedToFinanceList');
                        if (redContainer && cardElement.parentElement?.id !== 'notSubmittedToFinanceList') {
                            cardElement.style.border = '2px solid rgba(239, 68, 68, 0.5)';
                            redContainer.appendChild(cardElement);
                            // Update counters
                            updateFinanceSubmissionCounters();
                        }
                    }
                });
            }
        }

        // Helper function to update counters in headers
        function updateFinanceSubmissionCounters() {
            const orangeContainer = document.getElementById('pendingReviewList');
            const redContainer = document.getElementById('notSubmittedToFinanceList');
            const greenContainer = document.getElementById('submittedToFinanceList');
            const orangeHeader = document.getElementById('pendingReviewHeader');
            const redHeader = document.getElementById('notSubmittedToFinanceHeader');
            const greenHeader = document.getElementById('submittedToFinanceHeader');

            if (orangeContainer && orangeHeader) {
                const orangeCount = orangeContainer.children.length;
                orangeHeader.querySelector('h3').innerHTML = `ğŸŸ  ×“×•×—×•×ª ×©×¢×‘×¨×• ×¢×¨×™×›×” × ×•×¡×¤×ª - ×××ª×™×Ÿ ×œ××™×©×•×¨ (${orangeCount})`;
                orangeHeader.style.display = orangeCount > 0 ? 'block' : 'none';
                orangeContainer.style.display = orangeCount > 0 ? 'block' : 'none';
            }

            if (redContainer && redHeader) {
                const redCount = redContainer.children.length;
                redHeader.querySelector('h3').innerHTML = `ğŸ”´ ×œ× ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™× (${redCount})`;
                redHeader.style.display = redCount > 0 ? 'block' : 'none';
                redContainer.style.display = redCount > 0 ? 'block' : 'none';
            }

            if (greenContainer && greenHeader) {
                const greenCount = greenContainer.children.length;
                greenHeader.querySelector('h3').innerHTML = `ğŸŸ¢ ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™× (${greenCount})`;
                greenHeader.style.display = greenCount > 0 ? 'block' : 'none';
                greenContainer.style.display = greenCount > 0 ? 'block' : 'none';
            }
        }

        // Submit report on behalf of instructor (Coordinator Override)
        window.submitOnBehalfOfInstructor = async function(instructorEmail, year, month, cardId) {
            const instructorData = userRoles[instructorEmail];
            if (!instructorData) {
                showError('××“×¨×™×š ×œ× × ××¦×');
                return;
            }

            // ×™×¦×™×¨×ª ××•×“×œ ××–×”×¨×”
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 500px; width: 100%; border: 2px solid rgba(239, 68, 68, 0.5);';

            modalContent.innerHTML = `
                <div style="font-size: 48px; text-align: center; margin-bottom: 16px;">âš ï¸</div>
                <h2 style="font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; text-align: center;">
                    ×©×œ×™×—×ª ×“×•×— ×‘××§×•× ×”××“×¨×™×š/×”
                </h2>
                <div style="background: rgba(239, 68, 68, 0.1); border-right: 3px solid #ef4444; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 15px; color: var(--text-primary); margin: 0 0 12px 0; line-height: 1.6;">
                        ××ª×” ×¢×•××“ ×œ×©×’×¨ ××ª ×”×“×•×— ×©×œ <strong>${instructorData.fullName}</strong> ×œ××¨×•×ª ×©×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ××•×ª×• ×‘×¢×¦××•.
                    </p>
                    <p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 8px 0; line-height: 1.6;">
                        ğŸ“Œ ×‘×“×¨×š ×›×œ×œ ×–×” × ×¢×©×” ×›××©×¨:
                    </p>
                    <ul style="font-size: 14px; color: var(--text-secondary); margin: 0; padding-right: 20px; line-height: 1.6;">
                        <li>×”××“×¨×™×š/×” ×œ× ×“×™×•×•×—/×” ×©×¢×•×ª ×”×—×•×“×© (×‘×ª×™××•× ××¨××©)</li>
                        <li>×™×© ×”×¡×›××” ××¨××© ×©×œ× ×™×”×™×• ×©×¢×•×ª ×œ×“×™×•×•×—</li>
                    </ul>
                </div>
                <div style="background: rgba(59, 130, 246, 0.1); border-right: 3px solid #3b82f6; padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                        ğŸ’¡ <strong>×—×©×•×‘:</strong> ××•××œ×¥ ×œ×™×™×“×¢ ××ª ×”××“×¨×™×š/×” ×©×”×“×•×— ×©×•×’×¨ ×¢×‘×•×¨×•/×”
                    </p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="cancelOverrideBtn" class="btn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; font-size: 14px; font-weight: 600;">
                        ×‘×™×˜×•×œ
                    </button>
                    <button id="confirmOverrideBtn" class="btn btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); font-size: 14px; font-weight: 600;">
                        âœ… ××™×©×•×¨ ×•×©×œ×™×—×”
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // ×›×¤×ª×•×¨ ×‘×™×˜×•×œ
            document.getElementById('cancelOverrideBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // ×›×¤×ª×•×¨ ××™×©×•×¨
            document.getElementById('confirmOverrideBtn').addEventListener('click', async () => {
                try {
                    showLoading(true);
                    document.body.removeChild(modal);

                    const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                    const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                    // ×™×¦×™×¨×ª ×¨×©×•××ª ×©×™×’×•×¨ ×¢× ×”×¨×›×– ×›×©×•×œ×—
                    const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/submissions/${sanitizedCoordEmail}`);

                    await set(submissionRef, {
                        status: 'submitted',
                        submittedAt: Date.now(),
                        submittedBy: currentUser.email  // ×§×¨×™×˜×™: ××™×™×œ ×©×œ ×”×¨×›×–, ×œ× ×©×œ ×”××“×¨×™×š
                    });

                    showSuccess(`×”×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×” ×‘××§×•× ${instructorData.fullName}`);
                    showLoading(false);

                    // ×”-Listener ×‘×–××Ÿ ×××ª ×™×¢×“×›×Ÿ ××ª ×”×××©×§ ××•×˜×•××˜×™×ª
                } catch (error) {
                    console.error('Error submitting on behalf:', error);
                    showError('×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—');
                    showLoading(false);
                }
            });

            // ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            // ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        };

        // Store view state for each instructor (default = assigned subjects only)
        const instructorViewState = {};

        // Toggle between showing only assigned subjects vs all subjects
        window.toggleTableView = async function(cardId, instructorEmail, year, month) {
            const content = document.getElementById(`${cardId}-content`);
            const toggleButton = document.getElementById(`${cardId}-view-toggle`);

            // Initialize state if not exists
            if (!instructorViewState[instructorEmail]) {
                instructorViewState[instructorEmail] = 'assigned'; // Show only assigned subjects
            }

            // Toggle state
            if (instructorViewState[instructorEmail] === 'assigned') {
                // Switch to show ALL subjects
                instructorViewState[instructorEmail] = 'all';
                toggleButton.innerHTML = 'ğŸ“‹ ××§×¦×•×¢×•×ª ××©×•×™×™×›×™×';
                toggleButton.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

                // Reload table with ALL subjects
                await loadLiteTimesheetTable(instructorEmail, content, year, month, true); // true = show all subjects
            } else {
                // Switch back to assigned subjects only
                instructorViewState[instructorEmail] = 'assigned';
                toggleButton.innerHTML = 'ğŸ“Š ×›×œ ×”××§×¦×•×¢×•×ª';
                toggleButton.style.background = 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)';

                // Reload table with only assigned subjects
                await loadLiteTimesheetTable(instructorEmail, content, year, month, false); // false = assigned only
            }
        };

        // Toggle expand/collapse for LITE report
        window.toggleLiteReport = async function(cardId, instructorEmail, year, month) {
            const content = document.getElementById(`${cardId}-content`);
            const arrow = document.getElementById(`${cardId}-arrow`);

            if (content.style.display === 'none') {
                // Expand
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';

                // Load compact table - check current view state
                const showAllSubjects = instructorViewState[instructorEmail] === 'all';
                await loadLiteTimesheetTable(instructorEmail, content, year, month, showAllSubjects);
            } else {
                // Collapse
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        async function loadLiteTimesheetTable(instructorEmail, container, year, month, showAllSubjects = false) {
            const sanitizedEmail = sanitizeEmail(instructorEmail);
            const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}`);
            const snapshot = await get(timesheetRef);

            let timesheetData = {};
            if (snapshot.exists()) {
                const data = snapshot.val();
                timesheetData = data.entries || {};
            }

            let instructorSubjects = [];

            if (showAllSubjects) {
                // Show ALL subjects from ALL coordinators that have this instructor
                const allSubjects = { morning: [], afternoon: [] };

                // Get all coordinators
                const coordinatorsRef = ref(database, 'users/coordinators');
                const coordinatorsSnapshot = await get(coordinatorsRef);
                const coordinators = coordinatorsSnapshot.exists() ? coordinatorsSnapshot.val() : {};

                // Collect all subjects for this instructor from all assigned coordinators
                Object.entries(coordinators).forEach(([coordKey, coordData]) => {
                    if (coordData.assignedInstructors) {
                        const assignment = coordData.assignedInstructors.find(assign => {
                            const assignmentEmail = typeof assign === 'string' ? assign : assign.email;
                            return assignmentEmail === instructorEmail;
                        });

                        if (assignment) {
                            // Get the assigned subjects for this specific instructor
                            let assignedSubjects = [];
                            if (typeof assignment === 'object' && assignment.subjects) {
                                // New format: use only the subjects assigned to this instructor
                                assignedSubjects = assignment.subjects;
                            } else {
                                // Old format: use all coordinator's subjects
                                assignedSubjects = getAllUserSubjects(coordData);
                            }

                            // Add subjects to appropriate period
                            assignedSubjects.forEach(subject => {
                                // Determine period for this subject
                                let period = null;
                                if (coordData.subjects?.morning?.includes(subject)) {
                                    period = 'morning';
                                } else if (coordData.subjects?.afternoon?.includes(subject)) {
                                    period = 'afternoon';
                                }

                                if (period) {
                                    if (!allSubjects[period].includes(subject)) {
                                        allSubjects[period].push(subject);
                                    }
                                }
                            });
                        }
                    }
                });

                // Convert to instructorSubjects format
                allSubjects.morning.forEach(subj => {
                    instructorSubjects.push({ name: subj, period: 'morning' });
                });
                allSubjects.afternoon.forEach(subj => {
                    instructorSubjects.push({ name: subj, period: 'afternoon' });
                });

            } else {
                // Show only assigned subjects to THIS coordinator
                const currentCoordAssignment = currentUserData.assignedInstructors?.find(
                    assignment => (typeof assignment === 'string' ? assignment : assignment.email) === instructorEmail
                );

                if (currentCoordAssignment && typeof currentCoordAssignment === 'object' && currentCoordAssignment.subjects) {
                    currentCoordAssignment.subjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        instructorSubjects.push({ name: subj, period });
                    });
                }
            }

            // Build compact table
            const tableHTML = generateLiteTimesheetTable(timesheetData, instructorSubjects, instructorEmail, year, month, showAllSubjects);
            const summaryHTML = generateCompactSummary(timesheetData, instructorSubjects);

            container.innerHTML = tableHTML + summaryHTML;

            // Setup realtime listener
            setupLiteRealtimeListener(instructorEmail, container, instructorSubjects, year, month, showAllSubjects);
        }


        function generateLiteTimesheetTable(timesheetData, subjects, instructorEmail, year, month, showAllSubjects = false) {
            console.log('generateLiteTimesheetTable called with showAllSubjects:', showAllSubjects);
            const daysInMonth = new Date(year, month, 0).getDate();

            // Split subjects by period
            const morningSubjects = subjects.filter(s => s.period === 'morning');
            const afternoonSubjects = subjects.filter(s => s.period === 'afternoon');

            // Build header - two rows
            let headerRow1 = '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; border-left: 1px solid var(--border-color);">×ª××¨×™×š</th>';
            headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; border-left: 1px solid var(--border-color);">×™×•×</th>';

            let headerRow2 = '';

            // Morning subjects
            if (morningSubjects.length > 0) {
                headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; background: rgba(59, 130, 246, 0.1); border-left: 1px solid var(--border-color);">××©××¨×ª</th>';
                morningSubjects.forEach(subject => {
                    headerRow1 += `<th style="padding: 6px 10px; font-size: 13px; text-align: center; background: rgba(59, 130, 246, 0.05); border-left: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);">${subject.name}</th>`;
                    headerRow2 += `<th style="padding: 4px 8px; font-size: 11px; text-align: center; background: rgba(59, 130, 246, 0.05); border-left: 1px solid var(--border-color); color: var(--text-secondary);">×”×“×¨×›×” | ×”×©×ª×œ××•×ª</th>`;
                });
            }

            // Afternoon subjects
            if (afternoonSubjects.length > 0) {
                headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; background: rgba(245, 158, 11, 0.1); border-left: 1px solid var(--border-color);">××©××¨×ª</th>';
                afternoonSubjects.forEach(subject => {
                    headerRow1 += `<th style="padding: 6px 10px; font-size: 13px; text-align: center; background: rgba(245, 158, 11, 0.05); border-left: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);">${subject.name}</th>`;
                    headerRow2 += `<th style="padding: 4px 8px; font-size: 11px; text-align: center; background: rgba(245, 158, 11, 0.05); border-left: 1px solid var(--border-color); color: var(--text-secondary);">×”×“×¨×›×” | ×”×©×ª×œ××•×ª</th>`;
                });
            }

            if (showAllSubjects) {
                console.log('Adding substitutions column to header');
                headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; min-width: 120px; background: rgba(139, 92, 246, 0.15); border-left: 1px solid var(--border-color);">×”×—×œ×¤×•×ª</th>';
            } else {
                console.log('NOT adding substitutions column - showAllSubjects is false');
            }
            headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; min-width: 150px; max-width: 200px; border-left: 1px solid var(--border-color);">×”×¢×¨×•×ª</th>';
            headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; background: rgba(99, 102, 241, 0.15); border-left: 1px solid var(--border-color);">×¡×”"×› ×”×“×¨×›×”</th>';
            headerRow1 += '<th rowspan="2" style="padding: 6px 10px; font-size: 13px; background: rgba(99, 102, 241, 0.15); border-left: 1px solid var(--border-color);">×¡×”"×› ×”×©×ª×œ××•×ª</th>';

            let tableHTML = `<table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 12px; border: 1px solid var(--border-color);">
                <thead>
                    <tr style="background: rgba(15, 23, 42, 0.5);">${headerRow1}</tr>
                    <tr style="background: rgba(15, 23, 42, 0.3); border-bottom: 1px solid var(--border-color);">${headerRow2}</tr>
                </thead>
                <tbody>`;

            let monthlyTeachingTotal = 0;
            let monthlyTrainingTotal = 0;
            let monthlySubstitutionTeaching = 0;
            let monthlySubstitutionTraining = 0;

            // Track monthly totals per subject
            const subjectMonthlyTotals = {};
            subjects.forEach(subject => {
                subjectMonthlyTotals[subject.name] = { teaching: 0, training: 0 };
            });

            // Generate rows
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayName = getHebrewDayName(year, month, day);

                let dailyTeachingTotal = 0;
                let dailyTrainingTotal = 0;

                tableHTML += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 5px 10px; font-size: 13px; border-left: 1px solid var(--border-color);">${day}.${month}</td>
                    <td style="padding: 5px 10px; font-size: 13px; border-left: 1px solid var(--border-color);">${dayName}</td>`;

                // Morning subjects
                if (morningSubjects.length > 0) {
                    tableHTML += '<td style="padding: 5px 8px; font-size: 13px; font-weight: 600; background: rgba(59, 130, 246, 0.08); border-left: 1px solid var(--border-color);">×‘×•×§×¨</td>';

                    morningSubjects.forEach(subject => {
                        const entryKey = `${date}_morning_${subject.name}`;
                        const entry = timesheetData[entryKey];
                        const teachingValue = entry?.hours?.teaching || 0;
                        const trainingValue = entry?.hours?.training || 0;
                        const editedByCoord = entry?.editedBy === 'coordinator';
                        const hasChanges = entry?.hasChanges === true;
                        const teachingChange = entry?.changes?.teaching;
                        const trainingChange = entry?.changes?.training;

                        dailyTeachingTotal += teachingValue;
                        dailyTrainingTotal += trainingValue;
                        monthlyTeachingTotal += teachingValue;
                        monthlyTrainingTotal += trainingValue;

                        // Track per subject
                        subjectMonthlyTotals[subject.name].teaching += teachingValue;
                        subjectMonthlyTotals[subject.name].training += trainingValue;

                        // Priority: Red for changes after submission > Blue for coordinator edits > Green for regular entries
                        let cellColor = '';
                        if (hasChanges && (teachingChange || trainingChange)) {
                            cellColor = 'rgba(239, 68, 68, 0.15)'; // Red - instructor edited after submission
                        } else if (editedByCoord && (teachingValue > 0 || trainingValue > 0)) {
                            cellColor = 'rgba(59, 130, 246, 0.2)'; // Blue - coordinator edit
                        } else if (teachingValue > 0 || trainingValue > 0) {
                            cellColor = 'rgba(34, 197, 94, 0.1)'; // Green - regular entry
                        }

                        // Build cell content - show changes if exist
                        let cellContent = '<div style="display: flex; gap: 3px; justify-content: center; align-items: center;">';

                        // Teaching hours - show change indicator first (if exists), then select
                        if (teachingChange) {
                            const diff = teachingValue - teachingChange.oldValue;
                            const diffColor = diff > 0 ? '#22c55e' : '#ef4444';
                            const diffSign = diff > 0 ? '+' : '-';
                            const absDiff = Math.abs(diff);
                            cellContent += `<span style="color: ${diffColor}; font-weight: 700; font-size: 12px; margin-left: 2px;">${absDiff}${diffSign}</span>`;
                        }
                        cellContent += `<select onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'teaching')" data-original="${teachingValue}" style="width: 60px; padding: 2px; font-size: 13px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            ${generateHoursOptions(teachingValue)}
                        </select>`;

                        cellContent += '<span style="color: var(--text-secondary); font-size: 11px;">|</span>';

                        // Training hours - show select first, then change indicator (if exists)
                        cellContent += `<select onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'training')" data-original="${trainingValue}" style="width: 60px; padding: 2px; font-size: 13px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            ${generateHoursOptions(trainingValue)}
                        </select>`;
                        if (trainingChange) {
                            const diff = trainingValue - trainingChange.oldValue;
                            const diffColor = diff > 0 ? '#22c55e' : '#ef4444';
                            const diffSign = diff > 0 ? '+' : '-';
                            const absDiff = Math.abs(diff);
                            cellContent += `<span style="color: ${diffColor}; font-weight: 700; font-size: 12px; margin-right: 2px;">${absDiff}${diffSign}</span>`;
                        }

                        cellContent += '</div>';

                        tableHTML += `<td style="padding: 3px; text-align: center; background: ${cellColor}; border-left: 1px solid var(--border-color);">
                            ${cellContent}
                        </td>`;
                    });
                }

                // Afternoon subjects
                if (afternoonSubjects.length > 0) {
                    tableHTML += '<td style="padding: 5px 8px; font-size: 13px; font-weight: 600; background: rgba(245, 158, 11, 0.08); border-left: 1px solid var(--border-color);">××—×”"×¦</td>';

                    afternoonSubjects.forEach(subject => {
                        const entryKey = `${date}_afternoon_${subject.name}`;
                        const entry = timesheetData[entryKey];
                        const teachingValue = entry?.hours?.teaching || 0;
                        const trainingValue = entry?.hours?.training || 0;
                        const editedByCoord = entry?.editedBy === 'coordinator';
                        const hasChanges = entry?.hasChanges === true;
                        const teachingChange = entry?.changes?.teaching;
                        const trainingChange = entry?.changes?.training;

                        dailyTeachingTotal += teachingValue;
                        dailyTrainingTotal += trainingValue;
                        monthlyTeachingTotal += teachingValue;
                        monthlyTrainingTotal += trainingValue;

                        // Track per subject
                        subjectMonthlyTotals[subject.name].teaching += teachingValue;
                        subjectMonthlyTotals[subject.name].training += trainingValue;

                        // Priority: Red for changes after submission > Blue for coordinator edits > Green for regular entries
                        let cellColor = '';
                        if (hasChanges && (teachingChange || trainingChange)) {
                            cellColor = 'rgba(239, 68, 68, 0.15)'; // Red - instructor edited after submission
                        } else if (editedByCoord && (teachingValue > 0 || trainingValue > 0)) {
                            cellColor = 'rgba(59, 130, 246, 0.2)'; // Blue - coordinator edit
                        } else if (teachingValue > 0 || trainingValue > 0) {
                            cellColor = 'rgba(34, 197, 94, 0.1)'; // Green - regular entry
                        }

                        // Build cell content - show changes if exist
                        let cellContent = '<div style="display: flex; gap: 3px; justify-content: center; align-items: center;">';

                        // Teaching hours - show change indicator first (if exists), then select
                        if (teachingChange) {
                            const diff = teachingValue - teachingChange.oldValue;
                            const diffColor = diff > 0 ? '#22c55e' : '#ef4444';
                            const diffSign = diff > 0 ? '+' : '-';
                            const absDiff = Math.abs(diff);
                            cellContent += `<span style="color: ${diffColor}; font-weight: 700; font-size: 12px; margin-left: 2px;">${absDiff}${diffSign}</span>`;
                        }
                        cellContent += `<select onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'teaching')" data-original="${teachingValue}" style="width: 60px; padding: 2px; font-size: 13px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            ${generateHoursOptions(teachingValue)}
                        </select>`;

                        cellContent += '<span style="color: var(--text-secondary); font-size: 11px;">|</span>';

                        // Training hours - show select first, then change indicator (if exists)
                        cellContent += `<select onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'training')" data-original="${trainingValue}" style="width: 60px; padding: 2px; font-size: 13px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            ${generateHoursOptions(trainingValue)}
                        </select>`;
                        if (trainingChange) {
                            const diff = trainingValue - trainingChange.oldValue;
                            const diffColor = diff > 0 ? '#22c55e' : '#ef4444';
                            const diffSign = diff > 0 ? '+' : '-';
                            const absDiff = Math.abs(diff);
                            cellContent += `<span style="color: ${diffColor}; font-weight: 700; font-size: 12px; margin-right: 2px;">${absDiff}${diffSign}</span>`;
                        }

                        cellContent += '</div>';

                        tableHTML += `<td style="padding: 3px; text-align: center; background: ${cellColor}; border-left: 1px solid var(--border-color);">
                            ${cellContent}
                        </td>`;
                    });
                }

                // Get substitutions for this date - show ALL substitutions when in full view
                if (showAllSubjects) {
                    let substitutionDisplay = 'â€”';
                    const substitutions = [];

                    // Find all substitution entries for this date (format: date_substitution_0, date_substitution_1, etc.)
                    Object.keys(timesheetData).forEach(key => {
                        if (key.startsWith(`${date}_substitution_`)) {
                            const substData = timesheetData[key];
                            if (substData && substData.department) {
                                substitutions.push(substData);
                                // Add to monthly totals
                                monthlySubstitutionTeaching += substData.hours.teaching || 0;
                                monthlySubstitutionTraining += substData.hours.training || 0;
                            }
                        }
                    });

                    if (substitutions.length > 0) {
                        console.log(`Found ${substitutions.length} substitutions for ${date}:`, substitutions);
                        substitutionDisplay = substitutions.map(sub =>
                            `<div style="font-size: 11px; margin: 2px 0;">
                                <span style="font-weight: 600; color: var(--text-primary);">${sub.department}</span><br>
                                <span style="color: #f97316;">${sub.hours.teaching || 0}</span> |
                                <span style="color: #34ebbd;">${sub.hours.training || 0}</span>
                            </div>`
                        ).join('');
                    }

                    tableHTML += `
                        <td style="padding: 5px 8px; text-align: center; font-size: 12px; background: rgba(139, 92, 246, 0.08); border-left: 1px solid var(--border-color);">
                            ${substitutionDisplay}
                        </td>`;
                }

                // Get notes for this date
                const notesKey = `${date}_notes`;
                const notesEntry = timesheetData[notesKey];
                const notesValue = notesEntry?.notes || '';

                tableHTML += `
                    <td style="padding: 3px 4px; text-align: right; font-size: 12px; border-left: 1px solid var(--border-color); position: relative;">
                        <div style="display: flex; align-items: center; gap: 4px; flex-direction: row-reverse;">
                            <button onclick="editCoordinatorNotes('${instructorEmail}', '${date}', '${year}', '${month}', this)"
                                style="flex-shrink: 0; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'"
                                onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'"
                                title="×¢×¨×•×š ×”×¢×¨×•×ª">âœï¸</button>
                            <span style="flex: 1; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis;" data-notes-text="${date}">${notesValue || 'â€”'}</span>
                        </div>
                    </td>
                    <td style="padding: 5px 8px; text-align: center; font-size: 13px; font-weight: 600; background: rgba(99, 102, 241, 0.08); border-left: 1px solid var(--border-color);"><span style="color: #f97316; font-weight: 700;">${dailyTeachingTotal}</span></td>
                    <td style="padding: 5px 8px; text-align: center; font-size: 13px; font-weight: 600; background: rgba(99, 102, 241, 0.08); border-left: 1px solid var(--border-color);"><span style="color: #34ebbd; font-weight: 700;">${dailyTrainingTotal}</span></td>
                </tr>`;
            }

            // Monthly total row
            tableHTML += `<tr style="background: rgba(99, 102, 241, 0.2); font-weight: 700; border-top: 2px solid var(--border-color);">
                <td colspan="2" style="padding: 8px 10px; font-size: 14px; text-align: center; border-left: 1px solid var(--border-color);">×¡×”"×› ×—×•×“×©×™</td>`;

            // Morning shift column
            if (morningSubjects.length > 0) {
                tableHTML += '<td style="padding: 8px 10px; text-align: center; background: rgba(59, 130, 246, 0.15); border-left: 1px solid var(--border-color);"></td>';

                morningSubjects.forEach(subject => {
                    const subjectTotal = subjectMonthlyTotals[subject.name];
                    tableHTML += `<td style="padding: 8px 10px; text-align: center; font-size: 13px; background: rgba(59, 130, 246, 0.1); border-left: 1px solid var(--border-color);"><span style="color: #f97316; font-weight: 700;">${subjectTotal.teaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${subjectTotal.training}</span></td>`;
                });
            }

            // Afternoon shift column
            if (afternoonSubjects.length > 0) {
                tableHTML += '<td style="padding: 8px 10px; text-align: center; background: rgba(245, 158, 11, 0.15); border-left: 1px solid var(--border-color);"></td>';

                afternoonSubjects.forEach(subject => {
                    const subjectTotal = subjectMonthlyTotals[subject.name];
                    tableHTML += `<td style="padding: 8px 10px; text-align: center; font-size: 13px; background: rgba(245, 158, 11, 0.1); border-left: 1px solid var(--border-color);"><span style="color: #f97316; font-weight: 700;">${subjectTotal.teaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${subjectTotal.training}</span></td>`;
                });
            }

            if (showAllSubjects) {
                tableHTML += `<td style="padding: 8px 10px; text-align: center; font-size: 13px; border-left: 1px solid var(--border-color); background: rgba(139, 92, 246, 0.08);"><span style="color: #f97316; font-weight: 700;">${monthlySubstitutionTeaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${monthlySubstitutionTraining}</span></td>`;
            }

            tableHTML += `
                <td style="padding: 8px 10px; text-align: center; font-size: 13px; border-left: 1px solid var(--border-color); color: var(--text-secondary);">â€”</td>
                <td style="padding: 8px 10px; text-align: center; font-size: 14px; border-left: 1px solid var(--border-color);"><span style="color: #f97316; font-weight: 700;">${monthlyTeachingTotal}</span></td>
                <td style="padding: 8px 10px; text-align: center; font-size: 14px; border-left: 1px solid var(--border-color);"><span style="color: #34ebbd; font-weight: 700;">${monthlyTrainingTotal}</span></td>
            </tr>`;

            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function generateCompactSummary(timesheetData, subjects) {
            const subjectSummary = {};
            let totalTeaching = 0;
            let totalTraining = 0;

            Object.values(timesheetData).forEach(entry => {
                const subject = entry.subject;
                if (subjects.find(s => s.name === subject)) {
                    if (!subjectSummary[subject]) {
                        subjectSummary[subject] = { teaching: 0, training: 0 };
                    }
                    subjectSummary[subject].teaching += entry.hours?.teaching || 0;
                    subjectSummary[subject].training += entry.hours?.training || 0;
                    totalTeaching += entry.hours?.teaching || 0;
                    totalTraining += entry.hours?.training || 0;
                }
            });

            let summaryHTML = '<div style="font-size: 12px; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 4px;"><strong>×¡×™×›×•×:</strong> ';

            Object.entries(subjectSummary).forEach(([subject, hours]) => {
                summaryHTML += `${subject}: <span style="color: #f97316; font-weight: 700;">${hours.teaching}</span>×”×“ + <span style="color: #34ebbd; font-weight: 700;">${hours.training}</span>×”×©×ª = ${hours.teaching + hours.training} | `;
            });

            summaryHTML += `<strong>×¡×”"×›: <span style="color: #f97316; font-weight: 700;">${totalTeaching}</span>×”×“ + <span style="color: #34ebbd; font-weight: 700;">${totalTraining}</span>×”×©×ª = ${totalTeaching + totalTraining}</strong></div>`;
            return summaryHTML;
        }

        function setupLiteRealtimeListener(instructorEmail, container, subjects, year, month, showAllSubjects = false) {
            const sanitizedEmail = sanitizeEmail(instructorEmail);
            const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries`);

            onValue(entriesRef, (snapshot) => {
                const timesheetData = snapshot.exists() ? snapshot.val() : {};

                const tableHTML = generateLiteTimesheetTable(timesheetData, subjects, instructorEmail, year, month, showAllSubjects);
                const summaryHTML = generateCompactSummary(timesheetData, subjects);
                container.innerHTML = tableHTML + summaryHTML;
            });
        }

        function generateMonthlySummary(timesheetData, subjects) {
            const subjectSummary = {};
            let totalTeaching = 0;
            let totalTraining = 0;

            Object.values(timesheetData).forEach(entry => {
                const subject = entry.subject;
                // Only include subjects in the list
                if (subjects.find(s => s.name === subject)) {
                    if (!subjectSummary[subject]) {
                        subjectSummary[subject] = { teaching: 0, training: 0 };
                    }
                    subjectSummary[subject].teaching += entry.hours?.teaching || 0;
                    subjectSummary[subject].training += entry.hours?.training || 0;
                    totalTeaching += entry.hours?.teaching || 0;
                    totalTraining += entry.hours?.training || 0;
                }
            });

            return `
                <div style="background: var(--card-bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color);">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                        ğŸ“ˆ ×¡×™×›×•× ×—×•×“×©×™
                    </h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(15, 23, 42, 0.6); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">××§×¦×•×¢</th>
                                <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×”×“×¨×›×”</th>
                                <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×”×©×ª×œ××•×ª</th>
                                <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×¡×”"×›</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(subjectSummary).map(([subject, hours]) => `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px; color: var(--text-primary);">${subject}</td>
                                    <td style="padding: 12px; text-align: center;"><span style="color: #f97316; font-weight: 700;">${hours.teaching}</span></td>
                                    <td style="padding: 12px; text-align: center;"><span style="color: #34ebbd; font-weight: 700;">${hours.training}</span></td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">${hours.teaching + hours.training}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background: rgba(59, 130, 246, 0.1); font-weight: 700; border-top: 2px solid var(--border-color);">
                                <td style="padding: 14px; color: var(--text-primary);">×¡×”"×›</td>
                                <td style="padding: 14px; text-align: center;"><span style="color: #f97316; font-weight: 700;">${totalTeaching}</span></td>
                                <td style="padding: 14px; text-align: center;"><span style="color: #34ebbd; font-weight: 700;">${totalTraining}</span></td>
                                <td style="padding: 14px; text-align: center; color: var(--text-primary);">${totalTeaching + totalTraining}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function generateCoordinatorEditableTimesheetTable(timesheetData, subjects, instructorEmail, year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const morningSubjects = subjects.filter(s => s.period === 'morning');
            const afternoonSubjects = subjects.filter(s => s.period === 'afternoon');

            let headerHTML = '<th class="sticky-col">×ª××¨×™×š</th><th class="sticky-col">×™×•×</th>';

            // Morning subjects
            if (morningSubjects.length > 0) {
                headerHTML += '<th class="subject-header morning-section">××©××¨×ª</th>';
                morningSubjects.forEach(subject => {
                    headerHTML += `<th class="subject-header morning-section"><div class="subject-name">${subject.name}</div><div class="subject-types"><span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span></div></th>`;
                });
            }

            // Afternoon subjects
            if (afternoonSubjects.length > 0) {
                headerHTML += '<th class="subject-header afternoon-section">××©××¨×ª</th>';
                afternoonSubjects.forEach(subject => {
                    headerHTML += `<th class="subject-header afternoon-section"><div class="subject-name">${subject.name}</div><div class="subject-types"><span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span></div></th>`;
                });
            }

            headerHTML += '<th class="total-col">×¡×”"×› ×”×“×¨×›×”</th><th class="total-col">×¡×”"×› ×”×©×ª×œ××•×ª</th>';

            let tableHTML = `
                <table class="timesheet-table" id="coordTimesheetTable" style="position: relative;">
                    <thead>
                        <tr>${headerHTML}</tr>
                    </thead>
                    <tbody>
            `;

            let monthlyTeachingTotal = 0;
            let monthlyTrainingTotal = 0;

            // Generate rows for each day
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayName = getHebrewDayName(year, month, day);

                tableHTML += `<tr><td class="sticky-col">${day}.${month}</td><td class="sticky-col">${dayName}</td>`;

                let dailyTeachingTotal = 0;
                let dailyTrainingTotal = 0;

                // Morning subjects
                if (morningSubjects.length > 0) {
                    tableHTML += '<td class="shift-label morning morning-section">×‘×•×§×¨</td>';

                    morningSubjects.forEach(subject => {
                        const entryKey = `${date}_morning_${subject.name}`;
                        const entry = timesheetData[entryKey];
                        const teachingValue = entry?.hours?.teaching || 0;
                        const trainingValue = entry?.hours?.training || 0;
                        const editedByCoord = entry?.editedBy === 'coordinator';

                        dailyTeachingTotal += teachingValue;
                        dailyTrainingTotal += trainingValue;

                        const teachingClass = teachingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';
                        const trainingClass = trainingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';

                        tableHTML += `
                            <td class="morning-section">
                                <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                    <select class="${teachingClass}" onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'teaching')" data-original="${teachingValue}">
                                        ${generateHoursOptions(teachingValue)}
                                    </select>
                                    <span style="font-size: 11px;">|</span>
                                    <select class="${trainingClass}" onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'training')" data-original="${trainingValue}">
                                        ${generateHoursOptions(trainingValue)}
                                    </select>
                                </div>
                            </td>
                        `;
                    });
                }

                // Afternoon subjects
                if (afternoonSubjects.length > 0) {
                    tableHTML += '<td class="shift-label afternoon afternoon-section">××—×”"×¦</td>';

                    afternoonSubjects.forEach(subject => {
                        const entryKey = `${date}_afternoon_${subject.name}`;
                        const entry = timesheetData[entryKey];
                        const teachingValue = entry?.hours?.teaching || 0;
                        const trainingValue = entry?.hours?.training || 0;
                        const editedByCoord = entry?.editedBy === 'coordinator';

                        dailyTeachingTotal += teachingValue;
                        dailyTrainingTotal += trainingValue;

                        const teachingClass = teachingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';
                        const trainingClass = trainingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';

                        tableHTML += `
                            <td class="afternoon-section">
                                <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                    <select class="${teachingClass}" onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'teaching')" data-original="${teachingValue}">
                                        ${generateHoursOptions(teachingValue)}
                                    </select>
                                    <span style="font-size: 11px;">|</span>
                                    <select class="${trainingClass}" onchange="handleCoordinatorEdit(this, '${instructorEmail}', '${entryKey}', 'training')" data-original="${trainingValue}">
                                        ${generateHoursOptions(trainingValue)}
                                    </select>
                                </div>
                            </td>
                        `;
                    });
                }

                monthlyTeachingTotal += dailyTeachingTotal;
                monthlyTrainingTotal += dailyTrainingTotal;

                tableHTML += `
                    <td class="total-col"><span style="color: #f97316; font-weight: 700;">${dailyTeachingTotal}</span></td>
                    <td class="total-col"><span style="color: #34ebbd; font-weight: 700;">${dailyTrainingTotal}</span></td>
                </tr>`;
            }

            // Add monthly total row
            tableHTML += `<tr class="monthly-total-row" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); font-weight: 700;">
                <td class="sticky-col" colspan="2" style="text-align: center; padding: 16px; font-size: 15px; color: var(--text-primary);">
                    ğŸ“Š ×¡×”"×› ×—×•×“×©×™
                </td>`;

            // Empty cells for morning shift label
            if (morningSubjects.length > 0) {
                tableHTML += '<td class="morning-section"></td>';
                morningSubjects.forEach(() => {
                    tableHTML += '<td class="morning-section"></td>';
                });
            }

            // Empty cells for afternoon shift label
            if (afternoonSubjects.length > 0) {
                tableHTML += '<td class="afternoon-section"></td>';
                afternoonSubjects.forEach(() => {
                    tableHTML += '<td class="afternoon-section"></td>';
                });
            }

            tableHTML += `
                <td class="total-col" style="font-size: 16px;"><span style="color: #f97316; font-weight: 700;">${monthlyTeachingTotal}</span></td>
                <td class="total-col" style="font-size: 16px;"><span style="color: #34ebbd; font-weight: 700;">${monthlyTrainingTotal}</span></td>
            </tr>`;

            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        window.handleCoordinatorEdit = async function(selectElement, instructorEmail, entryKey, type) {
            const newValue = parseFloat(selectElement.value);
            const originalValue = parseFloat(selectElement.dataset.original);

            if (newValue === originalValue) return;

            try {
                // Use the coordinator's currently selected month
                const reportYear = coordReportYear;
                const reportMonth = coordReportMonth;
                const sanitizedEmail = sanitizeEmail(instructorEmail);

                // Parse entryKey to get date, period, subject
                const parts = entryKey.split('_');
                const date = parts[0];
                const period = parts[1];
                const subject = parts.slice(2).join('_');

                // Load existing entry or create new
                const entryRef = ref(database, `timesheets/${sanitizedEmail}/${reportYear}/${reportMonth}/entries/${entryKey}`);
                const snapshot = await get(entryRef);

                let entry = snapshot.exists() ? snapshot.val() : {
                    date, period, subject,
                    hours: { teaching: 0, training: 0 }
                };

                // Save current state for undo - save instructor's timesheet state
                await saveCoordinatorEditStateToUndoStack(instructorEmail, reportYear, reportMonth);

                entry.hours[type] = newValue;
                entry.editedBy = 'coordinator';
                entry.editedAt = Date.now();

                await set(entryRef, entry);

                // Update UI - add blue color
                selectElement.classList.remove('has-hours-select');
                selectElement.classList.add('coord-edited-select');
                selectElement.dataset.original = newValue;

                showSuccess('×”×©×™× ×•×™ × ×©××¨ ×‘×”×¦×œ×—×”');
            } catch (error) {
                console.error('Error saving coordinator edit:', error);
                showError('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™');
                selectElement.value = originalValue;
            }
        };

        // Edit notes by coordinator
        window.editCoordinatorNotes = async function(instructorEmail, date, year, month, buttonElement) {
            const notesKey = `${date}_notes`;
            const sanitizedEmail = sanitizeEmail(instructorEmail);

            // Get current notes value
            const entryRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries/${notesKey}`);
            const snapshot = await get(entryRef);
            const currentNotes = snapshot.exists() ? snapshot.val().notes || '' : '';

            // Create inline edit modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; border: 2px solid rgba(59, 130, 246, 0.5);';

            modalContent.innerHTML = `
                <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">âœï¸ ×¢×¨×™×›×ª ×”×¢×¨×•×ª - ${date}</h3>
                <textarea id="notesEditTextarea"
                    style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Bricolage Grotesque', sans-serif; resize: vertical;"
                    placeholder="×”×§×œ×“ ×”×¢×¨×•×ª ×›××Ÿ...">${currentNotes}</textarea>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button id="cancelNotesBtn" class="btn" style="padding: 10px 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">×‘×™×˜×•×œ</button>
                    <button id="saveNotesBtn" class="btn btn-primary" style="padding: 10px 20px;">×©××•×¨</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Focus on textarea
            const textarea = document.getElementById('notesEditTextarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Cancel button
            document.getElementById('cancelNotesBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Save button
            document.getElementById('saveNotesBtn').addEventListener('click', async () => {
                const newNotes = textarea.value.trim();

                try {
                    showLoading(true);

                    // Create/update notes entry
                    const notesEntry = {
                        date: date,
                        notes: newNotes,
                        updatedAt: Date.now(),
                        editedBy: 'coordinator'
                    };

                    await set(entryRef, notesEntry);

                    // Update UI - find the span element and update its text
                    const spanElement = buttonElement.parentElement.querySelector(`[data-notes-text="${date}"]`);
                    if (spanElement) {
                        spanElement.textContent = newNotes || 'â€”';
                    }

                    document.body.removeChild(modal);
                    showSuccess('×”×”×¢×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”');
                    showLoading(false);
                } catch (error) {
                    console.error('Error saving notes:', error);
                    showError('×©×’×™××” ×‘×©××™×¨×ª ×”×”×¢×¨×•×ª');
                    showLoading(false);
                }
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        };

        window.viewInstructorReport = async function(instructorEmail, year, month) {
            try {
                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                if (!instructorData) {
                    showError('××“×¨×™×š ×œ× × ××¦×');
                    showLoading(false);
                    return;
                }

                // Load timesheet for this instructor
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}`);
                const snapshot = await get(timesheetRef);

                let timesheetData = {};
                let isSubmitted = false;

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    timesheetData = data.entries || {};

                    // Check if submitted to THIS coordinator specifically
                    const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
                    isSubmitted = data.submissions?.[sanitizedCoordEmail]?.status === 'submitted';
                }

                // Load substitutions from finance submissions
                const substitutionsData = {};
                const financeSubstRef = ref(database, `finance_submissions/substitutions/${year}/${month}`);
                const substSnapshot = await get(financeSubstRef);

                if (substSnapshot.exists()) {
                    const allSubstitutions = substSnapshot.val();
                    // Filter substitutions for this instructor
                    Object.entries(allSubstitutions).forEach(([key, submission]) => {
                        if (submission.instructorEmail === instructorEmail) {
                            // Group substitutions by date
                            submission.substitutions.forEach(subst => {
                                if (!substitutionsData[subst.date]) {
                                    substitutionsData[subst.date] = [];
                                }
                                substitutionsData[subst.date].push(subst);
                            });
                        }
                    });
                }

                showLoading(false);

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;';

                // Get instructor's subjects that THIS coordinator is responsible for
                const instructorSubjects = [];
                const currentCoordAssignment = currentUserData.assignedInstructors?.find(
                    assignment => (typeof assignment === 'string' ? assignment : assignment.email) === instructorEmail
                );

                if (currentCoordAssignment && typeof currentCoordAssignment === 'object' && currentCoordAssignment.subjects) {
                    currentCoordAssignment.subjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        instructorSubjects.push({ name: subj, period });
                    });
                }

                const morningSubjects = instructorSubjects.filter(s => s.period === 'morning');
                const afternoonSubjects = instructorSubjects.filter(s => s.period === 'afternoon');

                // Build summary - only for subjects this coordinator is responsible for
                const coordinatorSubjects = instructorSubjects.map(s => s.name);
                const summary = {};
                Object.values(timesheetData).forEach(entry => {
                    const subject = entry.subject;
                    // Only include subjects that this coordinator is responsible for
                    if (coordinatorSubjects.includes(subject)) {
                        if (!summary[subject]) {
                            summary[subject] = { teaching: 0, training: 0 };
                        }
                        summary[subject].teaching += entry.hours?.teaching || 0;
                        summary[subject].training += entry.hours?.training || 0;
                    }
                });

                let totalTeaching = 0;
                let totalTraining = 0;
                Object.values(summary).forEach(hours => {
                    totalTeaching += hours.teaching;
                    totalTraining += hours.training;
                });

                // Check if there's any data to display
                const hasData = Object.keys(summary).length > 0;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin: 0;">
                            ğŸ“Š ×“×•×— ×©×¢×•×ª - ${instructorData.fullName}
                        </h2>
                        <button id="closeReportModal" class="btn" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                            âœ• ×¡×’×•×¨
                        </button>
                    </div>

                    <div style="margin-bottom: 20px; padding: 16px; background: ${isSubmitted ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 12px; border: 1px solid ${isSubmitted ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                ğŸ“… ${getMonthName(month)} ${year}
                            </span>
                            <span style="font-size: 20px;">â€¢</span>
                            <span style="font-size: 15px; font-weight: 600; color: ${isSubmitted ? '#22c55e' : '#ef4444'};">
                                ${isSubmitted ? 'âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–' : 'âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–'}
                            </span>
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                            ğŸ“ˆ ×¡×™×›×•× ×—×•×“×©×™
                        </h3>
                        ${hasData ? `
                        <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;">
                            <thead>
                                <tr style="background: rgba(15, 23, 42, 0.8);">
                                    <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">××§×¦×•×¢</th>
                                    <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×”×“×¨×›×”</th>
                                    <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×”×©×ª×œ××•×ª</th>
                                    <th style="padding: 12px; text-align: center; color: var(--text-primary); font-weight: 600;">×¡×”"×›</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(summary).map(([subject, hours]) => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px; color: var(--text-primary);">${subject}</td>
                                        <td style="padding: 12px; text-align: center;"><span style="color: #f97316; font-weight: 700;">${hours.teaching}</span></td>
                                        <td style="padding: 12px; text-align: center;"><span style="color: #34ebbd; font-weight: 700;">${hours.training}</span></td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">${hours.teaching + hours.training}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: rgba(59, 130, 246, 0.1); font-weight: 700;">
                                    <td style="padding: 14px; color: var(--text-primary);">×¡×”"×›</td>
                                    <td style="padding: 14px; text-align: center;"><span style="color: #f97316; font-weight: 700;">${totalTeaching}</span></td>
                                    <td style="padding: 14px; text-align: center;"><span style="color: #34ebbd; font-weight: 700;">${totalTraining}</span></td>
                                    <td style="padding: 14px; text-align: center; color: var(--text-primary);">${totalTeaching + totalTraining}</td>
                                </tr>
                            </tfoot>
                        </table>
                        ` : `
                        <div style="text-align: center; padding: 40px; background: rgba(239, 68, 68, 0.05); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <p style="font-size: 16px; color: var(--text-secondary); margin: 0;">
                                â„¹ï¸ ××™×Ÿ × ×ª×•× ×™ ×©×¢×•×ª ×¢×‘×•×¨ ×”××§×¦×•×¢×•×ª ×©××ª×” ××—×¨××™ ×¢×œ×™×”×
                            </p>
                        </div>
                        `}
                    </div>

                    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border-right: 4px solid #3b82f6;">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            ğŸ’¡ <strong>×”×¢×¨×”:</strong> ×”×“×•×— ××¦×™×’ ×¨×§ ××ª ×”××§×¦×•×¢×•×ª ×©××ª×” ××—×¨××™ ×¢×œ×™×”× ×¢×‘×•×¨ ${getMonthName(month)} ${year}.
                            ${coordinatorSubjects.length > 0 ? `×”××§×¦×•×¢×•×ª: ${coordinatorSubjects.join(', ')}` : '××™×Ÿ ××§×¦×•×¢×•×ª ××©×•×™×›×™×'}
                        </p>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Close button handler
                document.getElementById('closeReportModal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

            } catch (error) {
                console.error('Error viewing report:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        };

        // LITE version with editable table and per-subject summary
        window.viewInstructorReportWithEdit = async function(instructorEmail, year, month) {
            try {
                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                if (!instructorData) {
                    showError('××“×¨×™×š ×œ× × ××¦×');
                    showLoading(false);
                    return;
                }

                // Load timesheet for this instructor
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}`);
                const snapshot = await get(timesheetRef);

                let timesheetData = {};
                let isSubmitted = false;

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    timesheetData = data.entries || {};

                    // Check if submitted to THIS coordinator specifically
                    const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
                    isSubmitted = data.submissions?.[sanitizedCoordEmail]?.status === 'submitted';
                }

                showLoading(false);

                // Get instructor's subjects that THIS coordinator is responsible for
                const instructorSubjects = [];
                const currentCoordAssignment = currentUserData.assignedInstructors?.find(
                    assignment => (typeof assignment === 'string' ? assignment : assignment.email) === instructorEmail
                );

                if (currentCoordAssignment && typeof currentCoordAssignment === 'object' && currentCoordAssignment.subjects) {
                    currentCoordAssignment.subjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        instructorSubjects.push({ name: subj, period });
                    });
                }

                const coordinatorSubjects = instructorSubjects.map(s => s.name);

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
                modal.id = 'editReportModal';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 1400px; width: 100%; max-height: 90vh; overflow-y: auto;';

                // Build the table and summary
                const tableHTML = generateCoordinatorEditableTimesheetTable(timesheetData, instructorSubjects, instructorEmail, year, month);
                const summaryHTML = generateMonthlySummary(timesheetData, instructorSubjects);

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin: 0;">
                            ğŸ“Š ×“×•×— ×•×¢×¨×•×š - ${instructorData.fullName}
                        </h2>
                        <button id="closeEditModal" class="btn" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                            âœ• ×¡×’×•×¨
                        </button>
                    </div>

                    <div style="margin-bottom: 20px; padding: 16px; background: ${isSubmitted ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 12px; border: 1px solid ${isSubmitted ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                ğŸ“… ${getMonthName(month)} ${year}
                            </span>
                            <span style="font-size: 20px;">â€¢</span>
                            <span style="font-size: 15px; font-weight: 600; color: ${isSubmitted ? '#22c55e' : '#ef4444'};">
                                ${isSubmitted ? 'âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–' : 'âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–'}
                            </span>
                        </div>
                    </div>

                    <div id="editableTableContainer">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                ğŸ“Š ×˜×‘×œ×ª ×“×™×•×•×— ×©×¢×•×ª
                            </h3>
                            ${tableHTML}
                        </div>
                        ${summaryHTML}
                    </div>

                    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border-right: 4px solid #3b82f6;">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            ğŸ’¡ <strong>×”×¢×¨×”:</strong> × ×™×ª×Ÿ ×œ×¢×¨×•×š ××ª ×”×©×¢×•×ª ×™×©×™×¨×•×ª ×‘×˜×‘×œ×”. ×”×©×™× ×•×™×™× × ×©××¨×™× ××•×˜×•××˜×™×ª.
                            ${coordinatorSubjects.length > 0 ? `×”××§×¦×•×¢×•×ª ×©×œ×š: ${coordinatorSubjects.join(', ')}` : ''}
                        </p>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Setup realtime listener for dynamic updates
                setupEditModalRealtimeListener(instructorEmail, year, month, instructorSubjects);

                // Close button handler
                document.getElementById('closeEditModal').addEventListener('click', () => {
                    // Clean up listener
                    if (window.editModalListener) {
                        window.editModalListener();
                        window.editModalListener = null;
                    }
                    document.body.removeChild(modal);
                });

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        // Clean up listener
                        if (window.editModalListener) {
                            window.editModalListener();
                            window.editModalListener = null;
                        }
                        document.body.removeChild(modal);
                    }
                });

            } catch (error) {
                console.error('Error viewing report with edit:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        };

        // Setup realtime listener for edit modal
        function setupEditModalRealtimeListener(instructorEmail, year, month, subjects) {
            const sanitizedEmail = sanitizeEmail(instructorEmail);
            const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries`);

            window.editModalListener = onValue(entriesRef, (snapshot) => {
                const timesheetData = snapshot.exists() ? snapshot.val() : {};

                // Get the container
                const container = document.getElementById('editableTableContainer');
                if (!container) return; // Modal was closed

                // Rebuild the table and summary
                const tableHTML = generateCoordinatorEditableTimesheetTable(timesheetData, subjects, instructorEmail, year, month);
                const summaryHTML = generateMonthlySummary(timesheetData, subjects);

                container.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                            ğŸ“Š ×˜×‘×œ×ª ×“×™×•×•×— ×©×¢×•×ª
                        </h3>
                        ${tableHTML}
                    </div>
                    ${summaryHTML}
                `;
            });
        }

        window.unassignInstructor = async function(instructorEmail) {
            if (!confirm(`×”×× ×œ×”×¡×™×¨ ××ª ${userRoles[instructorEmail]?.fullName} ××”××“×¨×™×›×™× ×©×œ×š?`)) return;

            try {
                // Remove from coordinator's list (support both old and new format)
                const index = currentUserData.assignedInstructors.findIndex(
                    instructor => (typeof instructor === 'string' ? instructor : instructor.email) === instructorEmail
                );

                if (index > -1) {
                    currentUserData.assignedInstructors.splice(index, 1);
                }

                // Update in userRoles
                userRoles[currentUser.email].assignedInstructors = currentUserData.assignedInstructors;

                // Set flag to skip the next listener update
                skipNextCoordinatorUpdate = true;

                // Save to Firebase using the correct hierarchical path
                const userPath = getUserPath(currentUser.email);
                const userRef = ref(database, `${userPath}/assignedInstructors`);
                await set(userRef, currentUserData.assignedInstructors);

                await loadMyInstructors();
                await loadInstructorReports();  // Refresh the reports list dynamically
                showSuccess('×”××“×¨×™×š ×”×•×¡×¨ ×‘×”×¦×œ×—×”');
            } catch (error) {
                console.error('Error unassigning instructor:', error);
                showError('×©×’×™××” ×‘×”×¡×¨×ª ×”××“×¨×™×š');
            }
        };

        window.editInstructorAssignment = async function(instructorEmail) {
            try {
                // Find current assignment
                const assignment = currentUserData.assignedInstructors.find(
                    instructor => (typeof instructor === 'string' ? instructor : instructor.email) === instructorEmail
                );

                if (!assignment) {
                    showError('×œ× × ××¦× ×©×™×•×š ×œ××“×¨×™×š ×–×”');
                    return;
                }

                const currentSubjects = typeof assignment === 'object' ? assignment.subjects : [];
                const instructorData = userRoles[instructorEmail];

                // Create modal for editing
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;';

                modalContent.innerHTML = `
                    <h3 style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                        ×¢×¨×•×š ×©×™×•×š: ${instructorData.fullName}
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">×‘×—×¨ ××§×¦×•×¢×•×ª ×œ×©×™×•×š:</p>
                    <div id="editSubjectCheckboxes" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px;"></div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelEditBtn" class="btn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                            ×‘×™×˜×•×œ
                        </button>
                        <button id="saveEditBtn" class="btn btn-primary" style="padding: 12px 24px;">
                            ×©××•×¨ ×©×™× ×•×™×™×
                        </button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Populate checkboxes with color coding
                const checkboxContainer = document.getElementById('editSubjectCheckboxes');
                const coordSubjects = getAllUserSubjects(currentUserData);

                // Separate morning and afternoon subjects - get directly from coordinator's subjects structure
                const morningSubjs = currentUserData.subjects?.morning || [];
                const afternoonSubjs = currentUserData.subjects?.afternoon || [];

                // Add morning subjects with blue styling
                if (morningSubjs.length > 0) {
                    const morningSection = document.createElement('div');
                    morningSection.innerHTML = '<div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-right: 4px solid #3b82f6;">ğŸ“… ××©××¨×ª ×‘×•×§×¨</div>';
                    checkboxContainer.appendChild(morningSection);

                    morningSubjs.forEach(subject => {
                        const wrapper = document.createElement('label');
                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; margin-right: 16px;';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = subject;
                        checkbox.checked = currentSubjects.includes(subject);
                        checkbox.className = 'edit-subject-checkbox';
                        checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';

                        const label = document.createElement('span');
                        label.textContent = subject;
                        label.style.cssText = 'color: var(--text-primary); font-size: 15px; font-weight: 500;';

                        wrapper.appendChild(checkbox);
                        wrapper.appendChild(label);
                        checkboxContainer.appendChild(wrapper);
                    });
                }

                // Add afternoon subjects with yellow styling
                if (afternoonSubjs.length > 0) {
                    const afternoonSection = document.createElement('div');
                    afternoonSection.innerHTML = '<div style="font-weight: 600; color: #f59e0b; margin: 16px 0 8px 0; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-right: 4px solid #f59e0b;">ğŸŒ… ××©××¨×ª ××—×¨ ×”×¦×”×¨×™×™×</div>';
                    checkboxContainer.appendChild(afternoonSection);

                    afternoonSubjs.forEach(subject => {
                        const wrapper = document.createElement('label');
                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; margin-right: 16px;';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = subject;
                        checkbox.checked = currentSubjects.includes(subject);
                        checkbox.className = 'edit-subject-checkbox';
                        checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';

                        const label = document.createElement('span');
                        label.textContent = subject;
                        label.style.cssText = 'color: var(--text-primary); font-size: 15px; font-weight: 500;';

                        wrapper.appendChild(checkbox);
                        wrapper.appendChild(label);
                        checkboxContainer.appendChild(wrapper);
                    });
                }

                // Handle cancel
                document.getElementById('cancelEditBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Handle save
                document.getElementById('saveEditBtn').addEventListener('click', async () => {
                    const checkboxes = document.querySelectorAll('.edit-subject-checkbox:checked');
                    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);

                    if (selectedSubjects.length === 0) {
                        showError('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××§×¦×•×¢ ××—×“');
                        return;
                    }

                    try {
                        // Find and update the assignment
                        const assignmentIndex = currentUserData.assignedInstructors.findIndex(
                            instructor => (typeof instructor === 'string' ? instructor : instructor.email) === instructorEmail
                        );

                        if (assignmentIndex > -1) {
                            currentUserData.assignedInstructors[assignmentIndex] = {
                                email: instructorEmail,
                                subjects: selectedSubjects
                            };
                        }

                        // Update in userRoles
                        userRoles[currentUser.email].assignedInstructors = currentUserData.assignedInstructors;

                        // Set flag to skip the next listener update
                        skipNextCoordinatorUpdate = true;

                        // Save to Firebase using the correct hierarchical path
                        const userPath = getUserPath(currentUser.email);
                        const userRef = ref(database, `${userPath}/assignedInstructors`);
                        await set(userRef, currentUserData.assignedInstructors);

                        document.body.removeChild(modal);
                        await loadMyInstructors();
                        await loadInstructorReports();  // Refresh the reports list dynamically
                        showSuccess(`×”×©×™×•×š ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! ${selectedSubjects.join(', ')}`);
                    } catch (error) {
                        console.error('Error updating assignment:', error);
                        showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×™×•×š');
                    }
                });

            } catch (error) {
                console.error('Error editing instructor:', error);
                showError('×©×’×™××” ×‘×¢×¨×™×›×ª ×”×©×™×•×š');
            }
        };

        // Delete instructor completely from the system
        window.deleteInstructorCompletely = async function(instructorEmail) {
            const instructorName = userRoles[instructorEmail]?.fullName || instructorEmail;

            if (!confirm(`âš ï¸ ××–×”×¨×”! ×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×—×œ×•×˜×™×Ÿ ××ª ${instructorName} ××”××¢×¨×›×ª!\n\n×™×™××—×§×•:\nâœ“ ×›×œ ×“×¤×™ ×”×©×¢×•×ª\nâœ“ ×›×œ ×”×’×™×‘×•×™×™×\nâœ“ ×›×œ ×”×©×™×’×•×¨×™× ×œ×¨×›×–×™×\nâœ“ ×›×œ ×”×©×™×’×•×¨×™× ×œ×× ×”×œ×ª ×›×¡×¤×™×\nâœ“ ×”×©×™×•×›×™× ×œ×¨×›×–×™×\nâœ“ ×”××©×ª××© ×¢×¦××•\n\n×”×× ××ª×” ×‘×˜×•×—?`)) {
                return;
            }

            if (!confirm(`â— ×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!`)) {
                return;
            }

            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(instructorEmail);

                // 1. Delete from users/instructors
                const instructorRef = ref(database, `users/instructors/${sanitizedEmail}`);
                await remove(instructorRef);
                console.log('âœ“ Deleted from users/instructors');

                // 2. Delete all timesheets
                const timesheetsRef = ref(database, `timesheets/${sanitizedEmail}`);
                await remove(timesheetsRef);
                console.log('âœ“ Deleted all timesheets');

                // 3. Delete all backups
                const backupsRef = ref(database, `backups/${sanitizedEmail}`);
                await remove(backupsRef);
                console.log('âœ“ Deleted all backups');

                // 4. Delete all coordinator submissions (instructor -> coordinator)
                // Find all coordinators
                const coordinatorsSnapshot = await get(ref(database, 'users/coordinators'));
                if (coordinatorsSnapshot.exists()) {
                    const coordinators = coordinatorsSnapshot.val();
                    for (const coordEmail of Object.keys(coordinators)) {
                        const unSanitizedCoordEmail = unsanitizeEmail(coordEmail);

                        // Delete coordinatorSubmissions for this instructor
                        const coordSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/coordinatorSubmissions/${coordEmail}`);
                        await remove(coordSubmissionsRef);
                        console.log(`âœ“ Deleted coordinator submissions to ${unSanitizedCoordEmail}`);

                        // Remove instructor from coordinator's assignedInstructors list
                        const coordData = coordinators[coordEmail];
                        if (coordData.assignedInstructors && Array.isArray(coordData.assignedInstructors)) {
                            const updatedInstructors = coordData.assignedInstructors.filter(
                                instructor => {
                                    const email = typeof instructor === 'string' ? instructor : instructor.email;
                                    return email !== instructorEmail;
                                }
                            );

                            if (updatedInstructors.length !== coordData.assignedInstructors.length) {
                                const coordAssignedRef = ref(database, `users/coordinators/${coordEmail}/assignedInstructors`);
                                await set(coordAssignedRef, updatedInstructors);
                                console.log(`âœ“ Removed from coordinator ${unSanitizedCoordEmail} assignedInstructors`);
                            }
                        }
                    }
                }

                // 5. Delete all finance submissions (coordinator -> finance about this instructor)
                const financeSnapshot = await get(ref(database, 'users/finance'));
                if (financeSnapshot.exists()) {
                    const financeUsers = financeSnapshot.val();
                    for (const financeEmail of Object.keys(financeUsers)) {
                        const unSanitizedFinanceEmail = unsanitizeEmail(financeEmail);

                        // Check all years and months for this instructor's finance submissions
                        const instructorTimesheetsSnapshot = await get(ref(database, `timesheets/${sanitizedEmail}`));
                        if (instructorTimesheetsSnapshot.exists()) {
                            const yearsData = instructorTimesheetsSnapshot.val();
                            for (const year of Object.keys(yearsData)) {
                                const monthsData = yearsData[year];
                                if (monthsData && typeof monthsData === 'object') {
                                    for (const month of Object.keys(monthsData)) {
                                        const financeSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/financeSubmissions`);
                                        await remove(financeSubmissionsRef);
                                        console.log(`âœ“ Deleted finance submissions for ${year}/${month}`);
                                    }
                                }
                            }
                        }
                    }
                }

                // 6. Remove from userRoles in memory
                delete userRoles[instructorEmail];
                console.log('âœ“ Removed from userRoles');

                // Reload the current view based on role
                if (currentUserData.role === 'coordinator') {
                    await loadMyInstructors();
                    await loadInstructorReports();
                } else if (currentUserData.role === 'admin') {
                    await loadAdminInstructorsList();
                }

                showLoading(false);
                showSuccess(`âœ… ${instructorName} × ××—×§ ×œ×—×œ×•×˜×™×Ÿ ××”××¢×¨×›×ª!`);
            } catch (error) {
                console.error('Error deleting instructor:', error);
                showLoading(false);
                showError('×©×’×™××” ×‘××—×™×§×ª ×”××“×¨×™×š: ' + error.message);
            }
        };

        // Assign Instructor Button
        document.getElementById('assignInstructorBtn')?.addEventListener('click', async () => {
            const dropdown = document.getElementById('selectInstructorToAssign');
            const selectedEmail = dropdown?.value;

            if (!selectedEmail) {
                showError('×‘×—×¨ ××“×¨×™×š ×œ×©×™×•×š');
                return;
            }

            // Get selected subjects from checkboxes
            const subjectCheckboxes = document.querySelectorAll('#subjectCheckboxes input[type="checkbox"]:checked');
            const selectedSubjects = Array.from(subjectCheckboxes).map(cb => cb.value);

            if (selectedSubjects.length === 0) {
                showError('×‘×—×¨ ×œ×¤×—×•×ª ××§×¦×•×¢ ××—×“ ×œ×©×™×•×š');
                return;
            }

            try {
                // Check if already assigned
                const existingAssignment = currentUserData.assignedInstructors?.find(
                    instructor => (typeof instructor === 'string' ? instructor : instructor.email) === selectedEmail
                );

                if (existingAssignment) {
                    showError('×”××“×¨×™×š ×›×‘×¨ ××©×•×™×š ××œ×™×š');
                    return;
                }

                // Initialize array if needed
                if (!currentUserData.assignedInstructors) {
                    currentUserData.assignedInstructors = [];
                }

                // Add instructor with selected subjects
                const instructorAssignment = {
                    email: selectedEmail,
                    subjects: selectedSubjects  // Changed from assignedSubjects to subjects for consistency
                };

                currentUserData.assignedInstructors.push(instructorAssignment);

                // Update in userRoles
                userRoles[currentUser.email].assignedInstructors = currentUserData.assignedInstructors;

                // Set flag to skip the next listener update
                skipNextCoordinatorUpdate = true;

                // Save to Firebase using the correct hierarchical path
                const userPath = getUserPath(currentUser.email);
                const userRef = ref(database, `${userPath}/assignedInstructors`);
                await set(userRef, currentUserData.assignedInstructors);

                // Reset UI
                await loadMyInstructors();
                await loadInstructorReports();  // Refresh the reports list dynamically
                dropdown.value = '';
                document.getElementById('subjectSelectionArea').style.display = 'none';

                showSuccess(`${userRoles[selectedEmail].fullName} ×©×•×™×š ×‘×”×¦×œ×—×” ×œ-${selectedSubjects.join(', ')}`);
            } catch (error) {
                console.error('Error assigning instructor:', error);
                showError('×©×’×™××” ×‘×©×™×•×š ×”××“×¨×™×š');
            }
        });

        // ============================================
        // END COORDINATOR FUNCTIONS
        // ============================================

        // Admin: Load all instructors for management
        async function loadAdminInstructorsList() {
            try {
                showLoading(true);
                const listContainer = document.getElementById('adminInstructorsList');
                listContainer.innerHTML = '';

                // Get all instructors + hourly coordinators (sorted alphabetically)
                const instructors = Object.entries(userRoles)
                    .filter(([email, userData]) => {
                        // Include regular instructors
                        if (userData.role === 'instructor') return true;
                        // Include hourly coordinators
                        if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                        return false;
                    })
                    .map(([email, userData]) => ({
                        email: email,
                        name: userData.fullName || email,
                        subjects: userData.subjects || { morning: [], afternoon: [] },
                        role: userData.role,
                        employmentType: userData.employmentType
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                if (instructors.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ×‘××¢×¨×›×ª</p>';
                    showLoading(false);
                    return;
                }

                // Display instructors as cards
                instructors.forEach(instructor => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;';

                    // Find all coordinators that have this instructor assigned
                    const assignments = [];
                    Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                        if (coordData.role !== 'coordinator') return;
                        if (!coordData.assignedInstructors) return;

                        const assignment = coordData.assignedInstructors.find(
                            inst => (typeof inst === 'string' ? inst : inst.email) === instructor.email
                        );

                        if (assignment) {
                            const subjects = typeof assignment === 'string' ? [] : (assignment.subjects || []);
                            assignments.push({
                                coordName: coordData.fullName || coordEmail,
                                subjects: subjects
                            });
                        }
                    });

                    // Build assignments display
                    let assignmentsHTML = '';
                    if (assignments.length === 0) {
                        assignmentsHTML = '<div style="font-size: 12px; color: var(--text-secondary); font-style: italic;">××™×Ÿ ×©×™×•×›×™× ×œ×¨×›×–×™×</div>';
                    } else {
                        assignmentsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">';
                        assignmentsHTML += '<div style="font-weight: 600; margin-bottom: 4px;">×©×™×•×›×™×:</div>';
                        assignments.forEach(({ coordName, subjects }) => {
                            const subjectsText = subjects.length > 0 ? subjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª';
                            assignmentsHTML += `<div style="padding: 4px 8px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-weight: 600;">${coordName}:</span> <span style="color: var(--text-primary);">${subjectsText}</span>
                            </div>`;
                        });
                        assignmentsHTML += '</div>';
                    }

                    // Role badge
                    const roleBadge = instructor.role === 'coordinator'
                        ? '<span style="display: inline-block; padding: 2px 8px; background: rgba(251, 191, 36, 0.2); color: #f59e0b; border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 8px;">×¨×›×– ×©×¢×ª×™</span>'
                        : '';

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center;">
                                    <span>ğŸ‘¤ ${instructor.name}</span>
                                    ${roleBadge}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${instructor.email}
                                </div>
                                ${assignmentsHTML}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn" onclick="openAssignInstructorToCoordModal('${instructor.email}')" style="padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; font-weight: 600; white-space: nowrap;">
                                    ğŸ”— ×©×™×•×š ×œ×¨×›×–
                                </button>
                                <button class="btn" onclick="deleteInstructorCompletely('${instructor.email}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                                    ğŸ’€ ××—×§ ×œ×—×œ×•×˜×™×Ÿ
                                </button>
                            </div>
                        </div>
                    `;

                    listContainer.appendChild(card);
                });

                // Setup search functionality
                setupAdminSearch(instructors);

                showLoading(false);
            } catch (error) {
                console.error('Error loading admin instructors:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”××“×¨×™×›×™×');
                showLoading(false);
            }
        }

        // Admin search functionality
        function setupAdminSearch(instructors) {
            const searchInput = document.getElementById('adminSearchInput');
            const listContainer = document.getElementById('adminInstructorsList');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();

                if (query.length === 0) {
                    // Show all
                    loadAdminInstructorsList();
                    return;
                }

                // Filter instructors
                const matches = instructors.filter(instructor =>
                    instructor.name.includes(query) || instructor.email.toLowerCase().includes(query)
                );

                // Update display
                listContainer.innerHTML = '';

                if (matches.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">×œ× × ××¦××• ×ª×•×¦××•×ª</p>';
                    return;
                }

                matches.forEach(instructor => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;';

                    const allSubjects = [...(instructor.subjects.morning || []), ...(instructor.subjects.afternoon || [])];
                    const subjectsText = allSubjects.length > 0 ? allSubjects.join(', ') : '××™×Ÿ ××§×¦×•×¢×•×ª';

                    card.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                ğŸ‘¤ ${instructor.name}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                ${instructor.email}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                ğŸ“š ${subjectsText}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn" onclick="openAssignInstructorToCoordModal('${instructor.email}')" style="padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; font-weight: 600; white-space: nowrap;">
                                ğŸ”— ×©×™×•×š ×œ×¨×›×–
                            </button>
                            <button class="btn" onclick="deleteInstructorCompletely('${instructor.email}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                                ğŸ’€ ××—×§ ×œ×—×œ×•×˜×™×Ÿ
                            </button>
                        </div>
                    `;

                    listContainer.appendChild(card);
                });
            });
        }

        // ===== ADMIN: COORDINATORS MANAGEMENT =====
        async function loadAdminCoordinatorsList() {
            try {
                showLoading(true);
                const listContainer = document.getElementById('adminCoordinatorsList');
                listContainer.innerHTML = '';

                // Get all coordinators (sorted alphabetically)
                const coordinators = Object.entries(userRoles)
                    .filter(([email, userData]) => userData.role === 'coordinator')
                    .map(([normalEmail, userData]) => {
                        // Extract subjects from the subjects object
                        let subjectsArray = [];
                        if (userData.subjects) {
                            if (Array.isArray(userData.subjects)) {
                                subjectsArray = userData.subjects;
                            } else if (typeof userData.subjects === 'object') {
                                // Handle {morning: [...], afternoon: [...]} structure
                                const allSubjects = new Set();
                                if (userData.subjects.morning) {
                                    userData.subjects.morning.forEach(s => allSubjects.add(s));
                                }
                                if (userData.subjects.afternoon) {
                                    userData.subjects.afternoon.forEach(s => allSubjects.add(s));
                                }
                                subjectsArray = Array.from(allSubjects);
                            }
                        }

                        return {
                            email: normalEmail,  // Now this is the real email with dots
                            displayEmail: userData.email || normalEmail,  // Display email
                            name: userData.fullName || (userData.email || normalEmail),
                            subjects: subjectsArray,
                            assignedInstructors: userData.assignedInstructors || []
                        };
                    })
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                if (coordinators.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ×¨×›×–×™× ×‘××¢×¨×›×ª</p>';
                    showLoading(false);
                    return;
                }

                // Display coordinators as cards
                coordinators.forEach(coordinator => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;';

                    // Build subjects display
                    let subjectsHTML = '';
                    if (coordinator.subjects.length === 0) {
                        subjectsHTML = '<div style="font-size: 12px; color: var(--text-secondary); font-style: italic;">××™×Ÿ ××§×¦×•×¢×•×ª ××©×•×™×›×™×</div>';
                    } else {
                        subjectsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">';
                        subjectsHTML += '<div style="font-weight: 600; margin-bottom: 4px;">××§×¦×•×¢×•×ª:</div>';
                        subjectsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
                        coordinator.subjects.forEach(subject => {
                            subjectsHTML += `<span style="padding: 4px 8px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 4px; color: var(--text-primary);">${subject}</span>`;
                        });
                        subjectsHTML += '</div></div>';
                    }

                    // Build assigned instructors list with names
                    let instructorsHTML = '';
                    if (coordinator.assignedInstructors.length === 0) {
                        instructorsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; font-style: italic;">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™×</div>';
                    } else {
                        instructorsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">';
                        instructorsHTML += '<div style="font-weight: 600; margin-bottom: 4px;">ğŸ‘¥ ××“×¨×™×›×™× ××©×•×™×›×™×:</div>';
                        instructorsHTML += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                        coordinator.assignedInstructors.forEach(inst => {
                            const instructorEmail = typeof inst === 'string' ? inst : inst.email;
                            const instructorData = userRoles[instructorEmail];
                            const instructorName = instructorData?.fullName || instructorEmail;
                            const subjects = typeof inst === 'string' ? [] : (inst.subjects || []);
                            const subjectsText = subjects.length > 0 ? subjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª';
                            instructorsHTML += `<div style="padding: 4px 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${instructorName}</span>
                                <span style="color: var(--text-secondary); font-size: 11px;"> (${subjectsText})</span>
                            </div>`;
                        });
                        instructorsHTML += '</div></div>';
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ğŸ‘” ${coordinator.name}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${coordinator.displayEmail}
                                </div>
                                ${subjectsHTML}
                                ${instructorsHTML}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn" onclick="openAssignSubjectsModal('${coordinator.email}')" style="padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; font-weight: 600; white-space: nowrap;">
                                    ğŸ“š ×©×™×•×š ××§×¦×•×¢×•×ª
                                </button>
                                <button class="btn" onclick="deleteCoordinator('${coordinator.email}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                                    ğŸ—‘ï¸ ××—×§ ×¨×›×–
                                </button>
                            </div>
                        </div>
                    `;

                    listContainer.appendChild(card);
                });

                // Setup search functionality
                setupCoordinatorSearch(coordinators);

                showLoading(false);
            } catch (error) {
                console.error('Error loading coordinators:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×¨×›×–×™×');
                showLoading(false);
            }
        }

        // Coordinator search functionality
        function setupCoordinatorSearch(coordinators) {
            const searchInput = document.getElementById('coordinatorSearchInput');
            const listContainer = document.getElementById('adminCoordinatorsList');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();

                if (query.length === 0) {
                    loadAdminCoordinatorsList();
                    return;
                }

                const matches = coordinators.filter(coordinator =>
                    coordinator.name.includes(query) || coordinator.email.toLowerCase().includes(query)
                );

                listContainer.innerHTML = '';

                if (matches.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">×œ× × ××¦××• ×ª×•×¦××•×ª</p>';
                    return;
                }

                matches.forEach(coordinator => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;';

                    const subjectsText = coordinator.subjects.length > 0 ? coordinator.subjects.join(', ') : '××™×Ÿ ××§×¦×•×¢×•×ª';

                    // Build assigned instructors list
                    let instructorsHTML = '';
                    if (coordinator.assignedInstructors.length === 0) {
                        instructorsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; font-style: italic;">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™×</div>';
                    } else {
                        instructorsHTML = '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">';
                        instructorsHTML += '<div style="font-weight: 600; margin-bottom: 4px;">ğŸ‘¥ ××“×¨×™×›×™× ××©×•×™×›×™×:</div>';
                        instructorsHTML += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                        coordinator.assignedInstructors.forEach(inst => {
                            const instructorEmail = typeof inst === 'string' ? inst : inst.email;
                            const instructorData = userRoles[instructorEmail];
                            const instructorName = instructorData?.fullName || instructorEmail;
                            const subjects = typeof inst === 'string' ? [] : (inst.subjects || []);
                            const subjectsText = subjects.length > 0 ? subjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª';
                            instructorsHTML += `<div style="padding: 4px 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${instructorName}</span>
                                <span style="color: var(--text-secondary); font-size: 11px;"> (${subjectsText})</span>
                            </div>`;
                        });
                        instructorsHTML += '</div></div>';
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ğŸ‘” ${coordinator.name}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${coordinator.displayEmail}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ğŸ“š ${subjectsText}
                                </div>
                                ${instructorsHTML}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn" onclick="openAssignSubjectsModal('${coordinator.email}')" style="padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; font-weight: 600; white-space: nowrap;">
                                    ğŸ“š ×©×™×•×š ××§×¦×•×¢×•×ª
                                </button>
                                <button class="btn" onclick="deleteCoordinator('${coordinator.email}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                                    ğŸ—‘ï¸ ××—×§ ×¨×›×–
                                </button>
                            </div>
                        </div>
                    `;

                    listContainer.appendChild(card);
                });
            });
        }

        // ===== ADMIN: FINANCE MANAGERS MANAGEMENT =====

        async function loadAdminFinanceManagersList() {
            try {
                showLoading(true);
                const listContainer = document.getElementById('adminFinanceManagersList');
                listContainer.innerHTML = '';

                // Get all finance managers (sorted alphabetically)
                const financeManagers = Object.entries(userRoles)
                    .filter(([email, userData]) => userData.role === 'finance')
                    .map(([normalEmail, userData]) => ({
                        email: normalEmail,
                        displayEmail: userData.email || normalEmail,
                        name: userData.fullName || (userData.email || normalEmail),
                        profileImage: userData.profileImage || null
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                if (financeManagers.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ×× ×”×œ×•×ª ×›×¡×¤×™× ×‘××¢×¨×›×ª</p>';
                    showLoading(false);
                    return;
                }

                // Display finance managers as cards
                financeManagers.forEach(manager => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;';

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%); display: flex; align-items: center; justify-content: center;">
                                    ${manager.profileImage ?
                                        `<img src="${manager.profileImage}" alt="${manager.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                        `<div style="font-size: 24px;">ğŸ’°</div>`
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${manager.name}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${manager.displayEmail}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn" onclick="editFinanceManager('${manager.email}')" style="padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; font-weight: 600; white-space: nowrap;">
                                    âœï¸ ×¢×¨×•×š
                                </button>
                                <button class="btn" onclick="deleteFinanceManager('${manager.email}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                                    ğŸ—‘ï¸ ××—×§
                                </button>
                            </div>
                        </div>
                    `;

                    listContainer.appendChild(card);
                });

                showLoading(false);
            } catch (error) {
                console.error('Error loading finance managers:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×”×œ×•×ª ×›×¡×¤×™×');
                showLoading(false);
            }
        }

        // Add Finance Manager button handler
        document.getElementById('addFinanceManagerBtn')?.addEventListener('click', () => {
            document.getElementById('addFinanceManagerModal').style.display = 'flex';
        });

        // Finance Manager Search functionality
        document.getElementById('financeManagerSearchInput')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('#adminFinanceManagersList > div');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Edit Finance Manager function
        window.editFinanceManager = async function(email) {
            const managerData = userRoles[email];
            if (!managerData) {
                showError('×× ×”×œ×ª ×›×¡×¤×™× ×œ× × ××¦××”');
                return;
            }

            document.getElementById('editFinanceManagerEmail').value = email;
            document.getElementById('editFinanceManagerName').value = managerData.fullName || '';
            document.getElementById('editFinanceManagerModal').style.display = 'flex';
        };

        // Delete Finance Manager function
        window.deleteFinanceManager = async function(email) {
            const managerData = userRoles[email];
            if (!managerData) {
                showError('×× ×”×œ×ª ×›×¡×¤×™× ×œ× × ××¦××”');
                return;
            }

            const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ${managerData.fullName || email}?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!`);

            if (!confirmDelete) return;

            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(email);

                // Delete from users/finance in Firebase
                await set(ref(database, `users/finance/${sanitizedEmail}`), null);

                // Update local userRoles
                delete userRoles[email];

                showSuccess(`×× ×”×œ×ª ×”×›×¡×¤×™× ${managerData.fullName || email} × ××—×§×” ×‘×”×¦×œ×—×”`);
                loadAdminFinanceManagersList();
            } catch (error) {
                console.error('Error deleting finance manager:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ×× ×”×œ×ª ×›×¡×¤×™×');
                showLoading(false);
            }
        };

        // ===== ADMIN: DEPARTMENTS MANAGEMENT =====
        let departmentsList = []; // Global store for departments

        async function loadAdminDepartmentsList() {
            try {
                showLoading(true);
                const morningContainer = document.getElementById('morningDepartmentsList');
                const afternoonContainer = document.getElementById('afternoonDepartmentsList');
                morningContainer.innerHTML = '';
                afternoonContainer.innerHTML = '';

                // Load departments from Firebase (new structure: departments/morning and departments/afternoon)
                const morningRef = ref(database, 'departments/morning');
                const afternoonRef = ref(database, 'departments/afternoon');

                const [morningSnapshot, afternoonSnapshot] = await Promise.all([
                    get(morningRef),
                    get(afternoonRef)
                ]);

                const morningDepts = [];
                const afternoonDepts = [];
                const subjectCoordinators = {}; // { subject: [coordinators] }

                // Extract morning departments
                if (morningSnapshot.exists()) {
                    Object.keys(morningSnapshot.val()).forEach(name => {
                        morningDepts.push({ name: name, timeOfDay: 'morning' });
                    });
                }

                // Extract afternoon departments
                if (afternoonSnapshot.exists()) {
                    Object.keys(afternoonSnapshot.val()).forEach(name => {
                        afternoonDepts.push({ name: name, timeOfDay: 'afternoon' });
                    });
                }

                // Collect coordinators assigned to each subject
                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role !== 'coordinator') return;

                    const coordName = userData.fullName || userData.name || userData.email || email;

                    if (userData.subjects?.morning) {
                        userData.subjects.morning.forEach(subject => {
                            if (!subjectCoordinators[subject]) subjectCoordinators[subject] = [];
                            if (!subjectCoordinators[subject].includes(coordName)) {
                                subjectCoordinators[subject].push(coordName);
                            }
                        });
                    }

                    if (userData.subjects?.afternoon) {
                        userData.subjects.afternoon.forEach(subject => {
                            if (!subjectCoordinators[subject]) subjectCoordinators[subject] = [];
                            if (!subjectCoordinators[subject].includes(coordName)) {
                                subjectCoordinators[subject].push(coordName);
                            }
                        });
                    }
                });

                // Sort departments alphabetically
                morningDepts.sort((a, b) => a.name.localeCompare(b.name, 'he'));
                afternoonDepts.sort((a, b) => a.name.localeCompare(b.name, 'he'));

                // Display morning departments
                if (morningDepts.length === 0) {
                    morningContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary); font-style: italic;">××™×Ÿ ××§×¦×•×¢×•×ª ×‘×•×§×¨</p>';
                } else {
                    morningDepts.forEach(dept => {
                        const card = createDepartmentCard(dept, subjectCoordinators[dept.name] || []);
                        morningContainer.appendChild(card);
                    });
                }

                // Display afternoon departments
                if (afternoonDepts.length === 0) {
                    afternoonContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary); font-style: italic;">××™×Ÿ ××§×¦×•×¢×•×ª ××—×¨ ×”×¦×”×¨×™×™×</p>';
                } else {
                    afternoonDepts.forEach(dept => {
                        const card = createDepartmentCard(dept, subjectCoordinators[dept.name] || []);
                        afternoonContainer.appendChild(card);
                    });
                }

                showLoading(false);
            } catch (error) {
                console.error('Error loading departments:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”××§×¦×•×¢×•×ª');
                showLoading(false);
            }
        }

        function createDepartmentCard(dept, coordinators) {
            const card = document.createElement('div');
            card.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; position: relative;';

            const icon = dept.timeOfDay === 'morning' ? 'ğŸŒ…' : 'ğŸŒ†';
            const coordText = coordinators.length > 0 ? coordinators.join(', ') : '××™×Ÿ ×¨×›×– ××©×•×™×š';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                            ${icon} ${dept.name}
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                            ğŸ“‹ ${dept.timeOfDay === 'morning' ? '×‘×•×§×¨' : '××—×¨ ×”×¦×”×¨×™×™×'}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            ğŸ‘” ×¨×›×–×™×: <span style="color: var(--text-primary); font-weight: 600;">${coordText}</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="deleteDepartment('${dept.timeOfDay}', '${dept.name}')" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: 600; white-space: nowrap;">
                            ğŸ—‘ï¸ ××—×§
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                showLoading(true);
                await signOut(auth);
                showLogin();
                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showLoading(false);
            }
        });

        // Version button - Show changelog modal
        document.getElementById('versionBtn').addEventListener('click', () => {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid var(--border-color); padding-bottom: 16px;">
                    <h2 style="font-size: 28px; font-weight: 700; color: var(--accent-color); margin: 0;">
                        ğŸ“‹ ×¢×“×›×•× ×™ ×’×¨×¡××•×ª
                    </h2>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: var(--text-secondary); line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='var(--accent-color)'" onmouseout="this.style.color='var(--text-secondary)'">Ã—</button>
                </div>

                <div style="color: var(--text-primary); line-height: 1.8;">
                    <!-- ×’×¨×¡×” 2.2 -->
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 12px; border-right: 4px solid var(--accent-color); margin-bottom: 24px;">
                        <h3 style="font-size: 20px; font-weight: 600; color: var(--accent-color); margin: 0 0 8px 0;">×’×¨×¡×” 2.2 - ${new Date().toLocaleDateString('he-IL')}</h3>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color);">â±ï¸</span> ×ª××™×›×” ×‘×—×¦××™ ×©×¢×•×ª
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary);">
                            <li style="margin-bottom: 8px;"><strong>×“×™×•×•×— ××“×•×™×§ ×™×•×ª×¨:</strong> ×›×¢×ª × ×™×ª×Ÿ ×œ×“×•×•×— ×‘×¦×¢×“×™× ×©×œ ×—×¦×™ ×©×¢×” (0.5, 1.5, 2.5 ×•×›×•')</li>
                            <li style="margin-bottom: 8px;"><strong>×˜×•×•×— ××•×¨×—×‘:</strong> ××¤×©×¨×•×ª ×œ×‘×—×™×¨×” ×-0 ×¢×“ 12.5 ×©×¢×•×ª ×‘×¦×¢×“×™× ×©×œ 0.5</li>
                            <li style="margin-bottom: 8px;"><strong>×ª×¦×•×’×” ××©×•×¤×¨×ª:</strong> ×¢×¨×›×™× ×©×œ××™× ××•×¦×’×™× ×œ×œ× × ×§×•×“×” ×¢×©×¨×•× ×™×ª, ×—×¦××™ ×©×¢×•×ª ×¢× ×¢×©×¨×•× ×™×ª ××—×ª</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color);">ğŸ‘¥</span> ×©×“×¨×•×’ ×™×›×•×œ×•×ª ×¨×›×–×™×
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary);">
                            <li style="margin-bottom: 8px;"><strong>×ª×¦×•×’×ª ×“×•×— ××œ×:</strong> ×›×¤×ª×•×¨ ×—×“×© "×›×œ ×”××§×¦×•×¢×•×ª" ×××¤×©×¨ ×œ×¨×›×–×™× ×œ×¨××•×ª ××ª ×›×œ ×”××§×¦×•×¢×•×ª ×©×œ ×”××“×¨×™×š ××›×œ ×”×¨×›×–×™×</li>
                            <li style="margin-bottom: 8px;"><strong>××¢×§×‘ ×¨×—×‘:</strong> ××¤×©×¨×•×ª ×œ×¦×¤×•×ª ×‘××§×¦×•×¢×•×ª ×©××©×•×™×™×›×™× ×œ××“×¨×™×š ×“×¨×š ×¨×›×–×™× ××—×¨×™×</li>
                            <li style="margin-bottom: 8px;"><strong>××¢×‘×¨ ×—×œ×§:</strong> ×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨ ××—×œ×™×¤×” ×‘×™×Ÿ ×ª×¦×•×’×ª ×”××§×¦×•×¢×•×ª ×”××©×•×™×™×›×™× ×œ×ª×¦×•×’×” ×”××œ××”</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color);">ğŸ“¤</span> ×¨×›×– ×™×›×•×œ ×œ×©×’×¨ ×‘××§×•× ×”××“×¨×™×š
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary);">
                            <li style="margin-bottom: 8px;"><strong>×©×œ×™×—×” ××˜×¢× ×”××“×¨×™×š:</strong> ×¨×›×–×™× ×™×›×•×œ×™× ×›×¢×ª ×œ×©×œ×•×— ×“×•×— ×©×¢×•×ª ×‘××§×•× ×”××“×¨×™×š</li>
                            <li style="margin-bottom: 8px;"><strong>××™×©×•×¨ ××•×˜×•××˜×™:</strong> ×›××©×¨ ×¨×›×– ×©×•×œ×— ×“×•×—, ×”×•× ×××•×©×¨ ××•×˜×•××˜×™×ª ×œ×œ× ×¦×•×¨×š ×‘××™×©×•×¨ × ×•×¡×£</li>
                            <li style="margin-bottom: 8px;"><strong>××¢×§×‘ ×©×™× ×•×™×™×:</strong> ××¢×¨×›×ª ××¢×§×‘ ×”×©×™× ×•×™×™× ×¤×•×¢×œ×ª ×’× ×œ×“×•×—×•×ª ×©× ×©×œ×—×• ×¢×œ ×™×“×™ ×¨×›×–</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color);">ğŸ”§</span> ×ª×™×§×•× ×™ ×‘××’×™×
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary);">
                            <li style="margin-bottom: 8px;"><strong>××¢×§×‘ ×©×™× ×•×™×™×:</strong> ×ª×•×§× ×” ×‘×¢×™×” ×‘××¢×§×‘ ×©×™× ×•×™×™× ×¢× ×¢×¨×›×™ ×—×¦××™ ×©×¢×•×ª - ×›×¢×ª ×”×©×•×•××ª ×¢×¨×›×™× ××©×ª××©×ª ×‘-parseFloat</li>
                            <li style="margin-bottom: 8px;"><strong>×ª×¦×•×’×ª ×©×™× ×•×™×™×:</strong> ×¡×™×× ×™ +/- ××•×¦×’×™× ×›×¢×ª × ×›×•×Ÿ ×¢× ×¢×¨×š ××•×—×œ×˜ ×©×œ ×”×”×¤×¨×©</li>
                            <li style="margin-bottom: 8px;"><strong>×¢×“×›×•× ×™× ×‘×–××Ÿ ×××ª:</strong> ×©×™×¤×•×¨×™× ×‘×¡× ×›×¨×•×Ÿ × ×ª×•× ×™× ×‘×™×Ÿ ××“×¨×™×›×™× ×œ×¨×›×–×™×</li>
                        </ul>
                    </div>

                    <div style="background: rgba(34, 197, 94, 0.1); padding: 12px 16px; border-radius: 8px; margin-top: 24px; border-right: 3px solid #22c55e;">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                            <strong style="color: #22c55e;">âœ“</strong> ×›×œ ×”×“×•×—×•×ª ×•×”× ×ª×•× ×™× ×”×§×™×™××™× ×××©×™×›×™× ×œ×¢×‘×•×“ ×œ×œ× ×©×™× ×•×™
                        </p>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 32px 0;">

                    <!-- ×’×¨×¡×” 1.1 - ××¨×›×™×•×Ÿ -->
                    <div style="background: rgba(100, 116, 139, 0.1); padding: 16px; border-radius: 12px; border-right: 4px solid var(--text-secondary); margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-secondary); margin: 0 0 8px 0;">×’×¨×¡×” 1.1</h3>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“Š</span> ×©×™×¤×•×¨×™ ×™×¦×•× Excel ×œ××“×¨×™×›×™ ×”×—×œ×¤×•×ª
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary); font-size: 14px;">
                            <li style="margin-bottom: 6px;">×¢××•×“×ª ×”×¢×¨×•×ª ×œ×˜×‘×œ××•×ª ×©×œ ××“×¨×™×›×™ ×”×—×œ×¤×•×ª</li>
                            <li style="margin-bottom: 6px;">×›×•×ª×¨×ª ××•×ª×××ª ×œ×“×•×—×•×ª ××“×¨×™×›×™ ×”×—×œ×¤×•×ª</li>
                            <li style="margin-bottom: 6px;">×¤×•×¨××˜ ××œ× ×¢× ×›×œ ×”×©×“×•×ª ×”×¨×œ×•×•× ×˜×™×™×</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“Œ</span> ×ª×¦×•×’×ª ×˜×‘×œ×” ××©×•×¤×¨×ª
                        </h4>
                        <ul style="margin: 0; padding-right: 24px; color: var(--text-secondary); font-size: 14px;">
                            <li style="margin-bottom: 6px;">×©×•×¨×ª ×›×•×ª×¨×ª ×§×¤×•××” ×‘×¢×ª ×’×œ×™×œ×”</li>
                            <li style="margin-bottom: 6px;">× ×™×•×•×˜ ××©×•×¤×¨ ×‘×˜×‘×œ××•×ª ××¨×•×›×•×ª</li>
                        </ul>
                    </div>
                </div>
            `;

            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        });

        // Global flag to prevent duplicate loads after manual operations
        let skipNextCoordinatorUpdate = false;

        // Setup Realtime Listeners for Dynamic Updates
        function setupRealtimeListeners() {
            if (!currentUser || !currentUserData) return;

            console.log('ğŸ”” Setting up realtime listeners for:', currentUser.email);

            // For instructors: Listen to all coordinators' assignedInstructors changes
            if (currentUserData.role === 'instructor') {
                // Get all coordinators
                Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                    if (coordData.role === 'coordinator') {
                        const coordPath = getUserPath(coordEmail);
                        const coordAssignmentsRef = ref(database, `${coordPath}/assignedInstructors`);

                        console.log(`ğŸ“¡ Listening to coordinator: ${coordEmail}`);

                        onValue(coordAssignmentsRef, (snapshot) => {
                            // Update userRoles with new data (even if empty)
                            if (snapshot.exists()) {
                                const assignments = snapshot.val();
                                console.log(`ğŸ”„ Coordinator ${coordEmail} assignments updated:`, assignments);
                                userRoles[coordEmail].assignedInstructors = assignments;
                            } else {
                                // No assignments at all
                                console.log(`ğŸ”„ Coordinator ${coordEmail} has no assignments`);
                                userRoles[coordEmail].assignedInstructors = [];
                            }

                            // Always reload subjects to reflect changes (addition or removal)
                            console.log('ğŸ”„ Reloading subjects due to coordinator update...');
                            reloadInstructorSubjects();
                        });
                    }
                });
            }

            // For coordinators: Listen to their own assignedInstructors for UI updates
            if (currentUserData.role === 'coordinator') {
                const userPath = getUserPath(currentUser.email);
                const myAssignmentsRef = ref(database, `${userPath}/assignedInstructors`);

                console.log('ğŸ“¡ Listening to my own assignments (coordinator)');

                let isFirstLoad = true; // Skip first trigger to avoid duplicates

                onValue(myAssignmentsRef, (snapshot) => {
                    if (isFirstLoad) {
                        // Skip the immediate trigger on listener setup
                        isFirstLoad = false;
                        console.log('â­ï¸ Skipping initial listener trigger (coordinator)');
                        return;
                    }

                    // Check if we should skip this update (after manual operation)
                    if (skipNextCoordinatorUpdate) {
                        skipNextCoordinatorUpdate = false;
                        console.log('â­ï¸ Skipping listener update after manual operation');
                        return;
                    }

                    if (snapshot.exists()) {
                        const assignments = snapshot.val();
                        console.log('ğŸ”„ My assignments updated:', assignments);

                        // Update local data
                        currentUserData.assignedInstructors = assignments;
                        userRoles[currentUser.email].assignedInstructors = assignments;

                        // Reload the instructors list and reports
                        loadMyInstructors();
                        loadInstructorReports();
                    }
                });

                // Listen to each instructor's submission status for real-time updates
                setupSubmissionListeners();
            }
        }

        // Setup listeners for instructor submission status (for coordinators)
        function setupSubmissionListeners() {
            if (currentUserData.role !== 'coordinator') return;

            const myInstructors = currentUserData.assignedInstructors || [];
            const { year: reportYear, month: reportMonth } = getCurrentReportMonth();

            console.log('ğŸ“¡ Setting up submission listeners for instructors...');

            myInstructors.forEach(instructorAssignment => {
                const instructorEmail = typeof instructorAssignment === 'string' ? instructorAssignment : instructorAssignment.email;
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                // Listen to this instructor's submission to this coordinator
                const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${reportYear}/${reportMonth}/submissions/${sanitizedCoordEmail}`);

                console.log(`ğŸ“¡ Listening to submissions from: ${instructorEmail}`);

                onValue(submissionRef, (snapshot) => {
                    console.log(`ğŸ”„ Submission status changed for ${instructorEmail}:`, snapshot.exists());

                    // Update the status badge in the UI
                    updateInstructorStatusBadge(instructorEmail, snapshot.exists());
                });
            });
        }

        // Update instructor status badge dynamically
        function updateInstructorStatusBadge(instructorEmail, isSubmitted) {
            const { year: reportYear, month: reportMonth } = getCurrentReportMonth();

            // Find the card for this instructor
            const cards = document.querySelectorAll('#myInstructorsList > div');
            cards.forEach(card => {
                const cardEmail = card.querySelector('p')?.textContent.replace('ğŸ“§ ', '').trim();
                if (cardEmail === instructorEmail) {
                    // Find the status div
                    const statusDiv = card.querySelector('div[style*="margin-top: 12px"]');
                    if (statusDiv) {
                        const badgeHtml = isSubmitted ?
                            '<span style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 6px 12px; border-radius: 6px; display: inline-block; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.3);">âœ… ×”××“×¨×™×š/×” ×©×™×’×¨/×” ×œ×¨×›×–</span>' :
                            '<span style="background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 6px 12px; border-radius: 6px; display: inline-block; font-weight: 600; border: 1px solid rgba(239, 68, 68, 0.3);">âŒ ×”××“×¨×™×š/×” ×¢×“×™×™×Ÿ ×œ× ×©×™×’×¨/×” ×œ×¨×›×–</span>';

                        // Update only the badge part
                        const badgeContainer = statusDiv.querySelector('div[style*="margin-top: 6px"]');
                        if (badgeContainer) {
                            badgeContainer.innerHTML = badgeHtml;
                            console.log(`âœ… Updated status badge for ${instructorEmail}: ${isSubmitted ? 'submitted' : 'not submitted'}`);
                        }
                    }
                }
            });
        }

        // Reload instructor subjects dynamically (for instructors only)
        function reloadInstructorSubjects() {
            if (currentUserData.role !== 'instructor') return;

            console.log('ğŸ”„ Reloading instructor subjects...');

            const assignedSubjects = new Set();

            // Go through all coordinators and collect assigned subjects
            Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                    coordData.assignedInstructors.forEach(assignment => {
                        const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;

                        if (instructorEmail === currentUser.email) {
                            if (typeof assignment === 'object' && assignment.subjects) {
                                assignment.subjects.forEach(subj => assignedSubjects.add(subj));
                            } else {
                                getAllUserSubjects(coordData).forEach(subj => assignedSubjects.add(subj));
                            }
                        }
                    });
                }
            });

            // Check if subjects actually changed
            const oldSubjectsStr = JSON.stringify(userSubjects.map(s => s.name).sort());
            const newSubjectsArr = Array.from(assignedSubjects).sort();
            const newSubjectsStr = JSON.stringify(newSubjectsArr);

            if (oldSubjectsStr === newSubjectsStr) {
                console.log('â­ï¸ No changes detected, skipping update');
                return;
            }

            console.log('ğŸ“ Subjects changed:');
            console.log('  Old:', userSubjects.map(s => s.name));
            console.log('  New:', newSubjectsArr);

            // Update userSubjects
            userSubjects = [];
            assignedSubjects.forEach(subj => {
                const period = getSubjectPeriod(subj);
                userSubjects.push({name: subj, period: period});
            });

            console.log('âœ… Updated subjects:', userSubjects);

            // Regenerate the timesheet table and submit buttons with new subjects
            generateTimesheetTable();
            generateSubmitButtons();  // Update submit buttons dynamically

            // Show appropriate notification
            if (assignedSubjects.size === 0) {
                showError('×›×œ ×”××§×¦×•×¢×•×ª ×©×œ×š ×”×•×¡×¨×•! ğŸš«');
            } else {
                showInfo('×”××§×¦×•×¢×•×ª ×©×œ×š ×¢×•×“×›× ×•! ğŸ‰');
            }
        }

        // Finance manager: Load instructors list and search
        // Calculate default month: if before the 5th of the month, default to previous month
        const financeToday = new Date();
        const financeDayOfMonth = financeToday.getDate();
        let financeReportYear = financeToday.getFullYear();
        let financeReportMonth = financeToday.getMonth() + 1;

        if (financeDayOfMonth < 5) {
            // Before the 5th - use previous month
            financeReportMonth--;
            if (financeReportMonth === 0) {
                financeReportMonth = 12;
                financeReportYear--;
            }
        }
        let allInstructors = [];
        let currentlyOpenInstructor = null; // Track which instructor's report is currently open

        async function loadFinanceReports() {
            await loadInstructorsList();
            setupFinanceSearch();
        }

        // ===== NOTIFICATIONS (Finance Manager) =====
        let currentNotifications = []; // Store current notifications for bulk actions

        let notificationsData = {}; // Store notifications with read status

        async function loadNotifications() {
            try {
                const notificationsList = document.getElementById('notificationsList');
                const emptyState = document.getElementById('notificationsEmptyState');
                const badge = document.getElementById('notificationBadge');

                notificationsList.innerHTML = '';

                // Get all finance submissions for all instructors
                const financeEmail = currentUser.email;
                const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

                // Load read status from Firebase
                const readStatusRef = ref(database, `users/finance/${sanitizedFinanceEmail}/notificationReadStatus`);
                const readStatusSnapshot = await get(readStatusRef);
                notificationsData = readStatusSnapshot.exists() ? readStatusSnapshot.val() : {};

                const notifications = [];

                // Load special notifications (report updates, etc.)
                const specialNotificationsRef = ref(database, `notifications/${sanitizedFinanceEmail}`);
                const specialNotificationsSnapshot = await get(specialNotificationsRef);

                if (specialNotificationsSnapshot.exists()) {
                    const specialNotifs = specialNotificationsSnapshot.val();
                    for (const notifKey in specialNotifs) {
                        const notif = specialNotifs[notifKey];

                        // Create notification object
                        notifications.push({
                            id: notifKey,
                            type: notif.type,
                            instructorEmail: notif.instructorEmail,
                            instructorName: notif.instructorName,
                            coordinatorEmail: notif.coordinatorEmail,
                            coordinatorName: notif.coordinatorName,
                            year: notif.year,
                            month: notif.month,
                            timestamp: notif.timestamp,
                            message: notif.message,
                            isResubmission: true,
                            isRead: notificationsData[notifKey] || false
                        });
                    }
                }

                const allInstructorEmails = Object.entries(userRoles)
                    .filter(([email, userData]) => {
                        // Include regular instructors
                        if (userData.role === 'instructor') return true;
                        // Include hourly coordinators
                        if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                        return false;
                    })
                    .map(([email]) => email);

                for (const instructorEmail of allInstructorEmails) {
                    const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                    // Get all submissions for this instructor
                    const submissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}`);
                    const submissionsSnapshot = await get(submissionsRef);

                    if (submissionsSnapshot.exists()) {
                        const yearsData = submissionsSnapshot.val();
                        for (const year in yearsData) {
                            for (const month in yearsData[year]) {
                                const financeSubmissions = yearsData[year][month].financeSubmissions;
                                if (financeSubmissions && financeSubmissions[sanitizedFinanceEmail]) {
                                    // This instructor has submissions to current finance manager
                                    for (const coordEmail in financeSubmissions[sanitizedFinanceEmail]) {
                                        const submission = financeSubmissions[sanitizedFinanceEmail][coordEmail];

                                        // Unsanitize coordinator email to get original email
                                        const originalCoordEmail = coordEmail.replace(/_/g, '.').replace(/,/g, '@');
                                        const coordData = userRoles[originalCoordEmail];
                                        const instructorData = userRoles[instructorEmail];

                                        // Create sanitized ID for Firebase (no dots, #, $, [, ])
                                        const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                                        const notificationId = `${sanitizedInstructorEmail}-${year}-${month}-${coordEmail}`;

                                        notifications.push({
                                            id: notificationId,
                                            instructorEmail,
                                            instructorName: instructorData?.fullName || instructorEmail,
                                            coordinatorEmail: originalCoordEmail,
                                            coordinatorName: coordData?.fullName || originalCoordEmail,
                                            year,
                                            month,
                                            timestamp: submission.submittedAt || submission.timestamp || Date.now(),
                                            isResubmission: submission.isResubmission || false,
                                            isRead: notificationsData[notificationId] || false
                                        });
                                    }
                                }
                            }
                        }
                    }
                }

                // Sort by timestamp (newest first)
                notifications.sort((a, b) => b.timestamp - a.timestamp);

                // Store notifications globally for bulk actions
                currentNotifications = notifications;

                // Update last count for realtime detection
                if (lastNotificationCount === 0) {
                    lastNotificationCount = notifications.length;
                }

                // Count unread
                const unreadCount = notifications.filter(n => !n.isRead).length;

                // Update badge
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

                // Show/hide action buttons
                const markAllReadBtn = document.getElementById('markAllReadBtn');
                const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');

                if (notifications.length > 0) {
                    markAllReadBtn.style.display = 'block';
                    clearNotificationsBtn.style.display = 'block';
                } else {
                    markAllReadBtn.style.display = 'none';
                    clearNotificationsBtn.style.display = 'none';
                }

                // Display notifications using the render function
                renderNotifications();

            } catch (error) {
                console.error('Error loading notifications:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×ª×¨××•×ª');
            }
        }

        // Setup realtime listener for new notifications
        let notificationListeners = []; // Track all listeners to avoid duplicates

        function setupNotificationsRealtimeListener() {
            console.log('ğŸ”§ Setting up notifications realtime listener...');
            if (currentUserData?.role !== 'finance') {
                console.log('âš ï¸ Not finance role, skipping');
                return;
            }

            const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);

            // Clear existing listeners
            notificationListeners.forEach(unsubscribe => unsubscribe());
            notificationListeners = [];

            // Listen to special notifications (report updates, etc.)
            const notificationsRef = ref(database, `notifications/${sanitizedFinanceEmail}`);
            const unsubscribe1 = onValue(notificationsRef, (snapshot) => {
                console.log('ğŸ”” Special notifications updated, reloading...');
                loadNotifications();
            });
            notificationListeners.push(unsubscribe1);

            // Listen to all instructors' financeSubmissions
            const allInstructorEmails = Object.entries(userRoles)
                .filter(([email, userData]) => {
                    if (userData.role === 'instructor') return true;
                    if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                    return false;
                })
                .map(([email]) => email);

            allInstructorEmails.forEach(instructorEmail => {
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}`);

                const unsubscribe = onValue(financeSubmissionsRef, (snapshot) => {
                    console.log(`ğŸ”” Finance submission updated for ${instructorEmail}, reloading notifications...`);
                    loadNotifications();
                });

                notificationListeners.push(unsubscribe);
            });

            console.log(`âœ… Setup ${notificationListeners.length} notification listeners`);
        }

        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const emptyState = document.getElementById('notificationsEmptyState');
            const badge = document.getElementById('notificationBadge');

            // Clear existing notifications
            notificationsList.innerHTML = '';

            // Count unread
            const unreadCount = currentNotifications.filter(n => !n.isRead).length;

            // Update badge
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Display notifications
            if (currentNotifications.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';

                // Group notifications by time periods
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const twoDaysAgo = new Date(today);
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                const threeDaysAgo = new Date(today);
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const groups = {
                    today: { label: '×”×™×•×', color: '#10b981', notifications: [] },
                    yesterday: { label: '××ª××•×œ', color: '#3b82f6', notifications: [] },
                    twoDays: { label: '×©×œ×©×•×', color: '#8b5cf6', notifications: [] },
                    threeDays: { label: '×œ×¤× ×™ 3 ×™××™×', color: '#ec4899', notifications: [] },
                    week: { label: '×œ×¤× ×™ 4-7 ×™××™×', color: '#f59e0b', notifications: [] },
                    older: { label: '×™×©×Ÿ ×™×•×ª×¨', color: '#6b7280', notifications: [] }
                };

                // Group notifications
                currentNotifications.forEach(notif => {
                    const notifDate = new Date(notif.timestamp);
                    const notifDay = new Date(notifDate.getFullYear(), notifDate.getMonth(), notifDate.getDate());

                    if (notifDay.getTime() === today.getTime()) {
                        groups.today.notifications.push(notif);
                    } else if (notifDay.getTime() === yesterday.getTime()) {
                        groups.yesterday.notifications.push(notif);
                    } else if (notifDay.getTime() === twoDaysAgo.getTime()) {
                        groups.twoDays.notifications.push(notif);
                    } else if (notifDay.getTime() === threeDaysAgo.getTime()) {
                        groups.threeDays.notifications.push(notif);
                    } else if (notifDay.getTime() > sevenDaysAgo.getTime()) {
                        groups.week.notifications.push(notif);
                    } else {
                        groups.older.notifications.push(notif);
                    }
                });

                // Render each group
                Object.entries(groups).forEach(([key, group]) => {
                    if (group.notifications.length === 0) return;

                    // Group header
                    const groupHeader = document.createElement('div');
                    groupHeader.style.cssText = `
                        padding: 8px 12px;
                        background: linear-gradient(90deg, ${group.color}15 0%, transparent 100%);
                        border-right: 4px solid ${group.color};
                        border-radius: 8px;
                        margin-bottom: 12px;
                        margin-top: ${key !== 'today' ? '20px' : '0'};
                    `;
                    groupHeader.innerHTML = `
                        <div style="font-size: 14px; font-weight: 700; color: ${group.color};">
                            ${group.label} (${group.notifications.length})
                        </div>
                    `;
                    notificationsList.appendChild(groupHeader);

                    // Render notifications in this group
                    group.notifications.forEach(notif => {
                        const notifCard = document.createElement('div');
                        notifCard.style.cssText = `
                            padding: 16px 20px;
                            background: ${notif.isRead ? 'var(--card-bg)' : 'rgba(99, 102, 241, 0.05)'};
                            border: 2px solid ${notif.isRead ? 'var(--border-color)' : 'rgba(99, 102, 241, 0.3)'};
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                            border-right: 4px solid ${notif.isRead ? 'var(--border-color)' : '#6366f1'};
                            margin-bottom: 12px;
                        `;

                        const monthName = getMonthName(parseInt(notif.month));
                        const date = new Date(notif.timestamp);
                        const timeStr = date.toLocaleString('he-IL');

                        // Check if this is a resubmission notification
                        const isUpdateNotif = notif.isResubmission || notif.type === 'report_updated';
                        const notifIcon = isUpdateNotif ? 'ğŸ”„' : 'ğŸ“‹';
                        const notifText = isUpdateNotif
                            ? `<span style="color: #f59e0b;">${notif.coordinatorName}</span> ×¢×“×›×Ÿ/×” ×•×©×™×’×¨/×” ×©×•×‘ ××ª ×“×•×— ×”×©×¢×•×ª ×©×œ <span style="color: #10b981;">${notif.instructorName}</span>`
                            : `<span style="color: #6366f1;">${notif.coordinatorName}</span> ×©×™×’×¨/×” ×“×•×— ×©×œ <span style="color: #10b981;">${notif.instructorName}</span>`;

                        notifCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${notif.isRead ? '' : 'ğŸ”” '}${isUpdateNotif ? notifIcon + ' ' : ''}${notifText}
                                    </div>
                                    ${isUpdateNotif ? `<div style="font-size: 13px; color: #f59e0b; font-weight: 600; margin-bottom: 4px;">âš ï¸ ×“×•×— ×¢×•×“×›×Ÿ ×œ××—×¨ ×©×œ×™×—×” ×¨××©×•× ×™×ª</div>` : ''}
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        ${monthName} ${notif.year} â€¢ ${timeStr}
                                    </div>
                                </div>
                                ${!notif.isRead ? '<div style="width: 10px; height: 10px; background: #ef4444; border-radius: 50%; flex-shrink: 0;"></div>' : ''}
                            </div>
                        `;

                        notifCard.addEventListener('click', () => markNotificationAsRead(notif.id));
                        notifCard.addEventListener('mouseover', () => {
                            notifCard.style.background = 'rgba(99, 102, 241, 0.1)';
                            notifCard.style.borderColor = 'rgba(99, 102, 241, 0.5)';
                        });
                        notifCard.addEventListener('mouseout', () => {
                            notifCard.style.background = notif.isRead ? 'var(--card-bg)' : 'rgba(99, 102, 241, 0.05)';
                            notifCard.style.borderColor = notif.isRead ? 'var(--border-color)' : 'rgba(99, 102, 241, 0.3)';
                        });

                        notificationsList.appendChild(notifCard);
                    });
                });
            }
        }

        function updateNotificationUI() {
            // Just re-render with existing data (no Firebase reload needed)
            renderNotifications();
        }

        async function markNotificationAsRead(notificationId) {
            // Update local data immediately
            notificationsData[notificationId] = true;

            // Find the notification in current list and update it
            const notification = currentNotifications.find(n => n.id === notificationId);
            if (notification) {
                notification.isRead = true;
            }

            // Update UI immediately
            updateNotificationUI();

            // Save to Firebase in background (no await to make it instant)
            const financeEmail = currentUser.email;
            const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
            const readStatusRef = ref(database, `users/finance/${sanitizedFinanceEmail}/notificationReadStatus/${notificationId}`);
            set(readStatusRef, true).catch(error => {
                console.error('Error saving notification status:', error);
            });
        }

        async function markAllNotificationsAsRead() {
            // Mark all current notifications as read
            const financeEmail = currentUser.email;
            const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

            // Update all notifications in Firebase
            const updates = {};
            currentNotifications.forEach(notif => {
                notificationsData[notif.id] = true;
                updates[`users/finance/${sanitizedFinanceEmail}/notificationReadStatus/${notif.id}`] = true;
            });

            // Save to Firebase using batch update
            await update(ref(database), updates);

            // Reload notifications
            await loadNotifications();
            showInfo('×›×œ ×”×”×ª×¨××•×ª ×¡×•×× ×• ×›× ×§×¨××• âœ“');
        }

        async function clearAllNotifications() {
            // Create custom dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            dialog.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 2px solid var(--border-color);">
                    <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; color: var(--text-primary); text-align: center;">
                        ğŸ—‘ï¸ ××—×™×§×ª ×”×ª×¨××•×ª
                    </h3>
                    <p style="margin: 0 0 24px 0; color: var(--text-secondary); text-align: center; font-size: 14px; line-height: 1.6;">
                        ×‘×—×¨ ×›××” ×™××™× ×œ×©××•×¨.<br>
                        ×”×ª×¨××•×ª ×™×©× ×•×ª ×™×•×ª×¨ ×™×™××—×§×• ×œ×¦××™×ª×•×ª.
                    </p>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                            ×©××•×¨ ×”×ª×¨××•×ª ×:
                        </label>
                        <select id="daysToKeepSelect" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer; outline: none; transition: all 0.2s;">
                            <option value="1">×™×•× ××—×“ ××—×•×¨×”</option>
                            <option value="2">×™×•××™×™× ××—×•×¨×”</option>
                            <option value="3">3 ×™××™× ××—×•×¨×”</option>
                            <option value="4">4 ×™××™× ××—×•×¨×”</option>
                            <option value="5">5 ×™××™× ××—×•×¨×”</option>
                            <option value="6">6 ×™××™× ××—×•×¨×”</option>
                            <option value="7" selected>7 ×™××™× ××—×•×¨×” (×©×‘×•×¢)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button id="cancelDeleteBtn" style="flex: 1; padding: 12px; background: var(--border-color); color: var(--text-primary); border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            ×‘×™×˜×•×œ
                        </button>
                        <button id="confirmDeleteBtn" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            ××—×§
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // Add hover effects
            const confirmBtn = dialog.querySelector('#confirmDeleteBtn');
            const cancelBtn = dialog.querySelector('#cancelDeleteBtn');
            const selectEl = dialog.querySelector('#daysToKeepSelect');

            confirmBtn.addEventListener('mouseover', () => confirmBtn.style.background = '#dc2626');
            confirmBtn.addEventListener('mouseout', () => confirmBtn.style.background = '#ef4444');
            cancelBtn.addEventListener('mouseover', () => cancelBtn.style.background = 'rgba(0,0,0,0.1)');
            cancelBtn.addEventListener('mouseout', () => cancelBtn.style.background = 'var(--border-color)');
            selectEl.addEventListener('focus', () => selectEl.style.borderColor = '#6366f1');
            selectEl.addEventListener('blur', () => selectEl.style.borderColor = 'var(--border-color)');

            // Wait for user choice
            const result = await new Promise((resolve) => {
                confirmBtn.addEventListener('click', () => {
                    const daysToKeep = parseInt(selectEl.value);
                    dialog.remove();
                    resolve(daysToKeep);
                });
                cancelBtn.addEventListener('click', () => {
                    dialog.remove();
                    resolve(null);
                });
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.remove();
                        resolve(null);
                    }
                });
            });

            if (result === null) {
                return; // User cancelled
            }

            const daysToKeep = result;

            // Calculate cutoff date
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
            cutoffDate.setHours(0, 0, 0, 0);

            // Filter notifications to delete
            const notificationsToDelete = currentNotifications.filter(notif => {
                const notifDate = new Date(notif.timestamp);
                return notifDate < cutoffDate;
            });

            if (notificationsToDelete.length === 0) {
                showInfo(`××™×Ÿ ×”×ª×¨××•×ª ×™×©× ×•×ª ×-${daysToKeep} ×™××™× ×œ××—×•×§`);
                return;
            }

            // Show confirmation
            if (!confirm(`×”×× ×œ××—×•×§ ${notificationsToDelete.length} ×”×ª×¨××•×ª ×™×©× ×•×ª ×-${daysToKeep} ×™××™×?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.`)) {
                return;
            }

            try {
                const financeEmail = currentUser.email;
                const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

                // Delete each old notification from Firebase
                const deletePromises = notificationsToDelete.map(async (notif) => {
                    const sanitizedInstructorEmail = sanitizeEmail(notif.instructorEmail);
                    const sanitizedCoordEmail = sanitizeEmail(notif.coordinatorEmail);

                    // Delete the actual submission
                    const submissionPath = `timesheets/${sanitizedInstructorEmail}/${notif.year}/${notif.month}/financeSubmissions/${sanitizedFinanceEmail}/${sanitizedCoordEmail}`;
                    const submissionRef = ref(database, submissionPath);
                    await remove(submissionRef);

                    // Delete read status
                    const readStatusPath = `users/finance/${sanitizedFinanceEmail}/notificationReadStatus/${notif.id}`;
                    const readStatusRef = ref(database, readStatusPath);
                    await remove(readStatusRef);
                });

                await Promise.all(deletePromises);

                // Reload notifications
                await loadNotifications();
                showInfo(`${notificationsToDelete.length} ×”×ª×¨××•×ª × ××—×§×• ×‘×”×¦×œ×—×” ğŸ—‘ï¸`);
            } catch (error) {
                console.error('Error deleting notifications:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×”×ª×¨××•×ª');
            }
        }

        let notificationLoadTimeout = null;

        function setupNotificationsListener() {
            // Note: Read statuses are now loaded from Firebase in loadNotifications()

            // Setup button event listeners
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');

            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
                // Add hover effects
                markAllReadBtn.addEventListener('mouseover', () => {
                    markAllReadBtn.style.background = '#4f46e5';
                    markAllReadBtn.style.transform = 'translateY(-2px)';
                });
                markAllReadBtn.addEventListener('mouseout', () => {
                    markAllReadBtn.style.background = '#6366f1';
                    markAllReadBtn.style.transform = 'translateY(0)';
                });
            }

            if (clearNotificationsBtn) {
                clearNotificationsBtn.addEventListener('click', clearAllNotifications);
                // Add hover effects
                clearNotificationsBtn.addEventListener('mouseover', () => {
                    clearNotificationsBtn.style.background = '#dc2626';
                    clearNotificationsBtn.style.transform = 'translateY(-2px)';
                });
                clearNotificationsBtn.addEventListener('mouseout', () => {
                    clearNotificationsBtn.style.background = '#ef4444';
                    clearNotificationsBtn.style.transform = 'translateY(0)';
                });
            }

            // Setup realtime listeners for dynamic notifications
            setupRealtimeNotifications();
        }

        // Debounced notification loader
        let lastNotificationCount = 0;
        function scheduleNotificationLoad() {
            if (notificationLoadTimeout) {
                clearTimeout(notificationLoadTimeout);
            }
            notificationLoadTimeout = setTimeout(async () => {
                const previousCount = lastNotificationCount;
                await loadNotifications();

                // Show notification popup if new notifications arrived
                if (currentNotifications.length > previousCount) {
                    const newCount = currentNotifications.length - previousCount;
                    showInfo(`×”×ª×§×‘×œ×• ${newCount} ×”×ª×¨××•×ª ×—×“×©×•×ª! ğŸ””`);
                }
                lastNotificationCount = currentNotifications.length;
            }, 500);
        }

        function setupRealtimeNotifications() {
            // Clean up existing listeners
            notificationListeners.forEach(unsubscribe => unsubscribe());
            notificationListeners = [];

            const financeEmail = currentUser.email;
            const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

            // Get all instructors
            const allInstructorEmails = Object.entries(userRoles)
                .filter(([email, userData]) => userData.role === 'instructor')
                .map(([email]) => email);

            // Setup listener for each instructor's submissions
            allInstructorEmails.forEach(instructorEmail => {
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const submissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}`);

                const unsubscribe = onValue(submissionsRef, (snapshot) => {
                    // Debounced reload when data changes
                    scheduleNotificationLoad();
                });

                notificationListeners.push(unsubscribe);
            });
        }

        async function loadInstructorsList() {
            try {
                showLoading(true);

                const monthName = getMonthName(financeReportMonth);
                document.getElementById('financeMonthTitle').textContent = `${monthName} ${financeReportYear}`;

                const notSentByCoordContainer = document.getElementById('instructorsListNotSentByCoord');
                const notReportedContainer = document.getElementById('instructorsListNotReported');
                const reportedContainer = document.getElementById('instructorsListReported');

                // Clear all containers
                if (notSentByCoordContainer) notSentByCoordContainer.innerHTML = '';
                notReportedContainer.innerHTML = '';
                reportedContainer.innerHTML = '';

                // Load departments from Firebase to categorize subjects
                const morningRef = ref(database, 'departments/morning');
                const afternoonRef = ref(database, 'departments/afternoon');
                const [morningSnapshot, afternoonSnapshot] = await Promise.all([
                    get(morningRef),
                    get(afternoonRef)
                ]);

                const morningDepartments = [];
                const afternoonDepartments = [];

                if (morningSnapshot.exists()) {
                    morningDepartments.push(...Object.keys(morningSnapshot.val()));
                }
                if (afternoonSnapshot.exists()) {
                    afternoonDepartments.push(...Object.keys(afternoonSnapshot.val()));
                }

                console.log('ğŸŒ… Morning departments:', morningDepartments);
                console.log('ğŸŒ™ Afternoon departments:', afternoonDepartments);

                // Get all instructors + hourly coordinators (sorted alphabetically)
                allInstructors = Object.entries(userRoles)
                    .filter(([email, userData]) => {
                        // Include regular instructors
                        if (userData.role === 'instructor') return true;
                        // Include hourly coordinators
                        if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                        return false;
                    })
                    .map(([email, userData]) => ({
                        email: email,
                        name: userData.fullName || email,
                        role: userData.role
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                console.log('ğŸ“‹ Finance manager - All instructors (including hourly coordinators):', allInstructors.length);

                if (allInstructors.length === 0) {
                    notReportedContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ×‘××¢×¨×›×ª</p>';
                    showLoading(false);
                    return;
                }

                // Check salary status for each instructor and display in appropriate zone
                for (const instructor of allInstructors) {
                    // Check salary reported status from Firebase
                    const sanitizedEmail = sanitizeEmail(instructor.email);
                    const salaryStatusRef = ref(database, `timesheets/${sanitizedEmail}/${financeReportYear}/${financeReportMonth}/salaryReported`);
                    const salarySnapshot = await get(salaryStatusRef);
                    const isSalaryReported = salarySnapshot.exists() ? salarySnapshot.val() : false;

                    // Check if coordinator sent this instructor's report to finance
                    const financeSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/${financeReportYear}/${financeReportMonth}/financeSubmissions/${sanitizeEmail(currentUser.email)}`);
                    const financeSnapshot = await get(financeSubmissionsRef);
                    const isSentToFinance = financeSnapshot.exists();

                    // Determine which container to use:
                    // 1. If salary reported -> green (reported)
                    // 2. If sent to finance but not reported -> orange (notReported)
                    // 3. If not sent to finance -> red (notSentByCoord)
                    let listContainer;
                    if (isSalaryReported) {
                        listContainer = reportedContainer;
                    } else if (isSentToFinance) {
                        listContainer = notReportedContainer;
                    } else {
                        listContainer = notSentByCoordContainer;
                    }
                    const card = document.createElement('button');
                    card.className = 'instructor-card';
                    card.id = `finance-card-${sanitizeEmail(instructor.email).replace(/[@.]/g, '_')}`;
                    card.style.cssText = 'padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-family: inherit; position: relative;';

                    // Get instructor data to check for profile image
                    const instructorData = userRoles[instructor.email];
                    const profileImage = instructorData?.profileImage || instructorData?.photoURL;

                    // Find which coordinator(s) this instructor is assigned to and get their programs
                    let morningPrograms = [];
                    let afternoonPrograms = [];
                    let coordinatorName = '';
                    let coordinatorEmail = '';

                    // Get coordinator info and subjects from assignedInstructors - collect from ALL coordinators
                    for (const [coordEmail, coordData] of Object.entries(userRoles)) {
                        if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                            console.log(`ğŸ” Checking coordinator ${coordData.fullName}:`, coordData.assignedInstructors);

                            const assignedInstructor = coordData.assignedInstructors.find(assigned => {
                                const assignedEmail = typeof assigned === 'string' ? assigned : assigned.email;
                                return assignedEmail === instructor.email;
                            });

                            if (assignedInstructor) {
                                // Don't override - just use first coordinator name if not set yet
                                if (!coordinatorName) {
                                    coordinatorName = coordData.fullName || coordEmail;
                                    coordinatorEmail = coordEmail;
                                }

                                console.log(`âœ… Found ${instructor.name} under ${coordData.fullName}:`, assignedInstructor);

                                // Extract subjects from the assigned instructor object
                                console.log(`ğŸ” Full assignedInstructor object for ${instructor.name}:`, assignedInstructor);

                                if (typeof assignedInstructor === 'object' && assignedInstructor.subjects) {
                                    console.log(`ğŸ“š Subjects field for ${instructor.name}:`, assignedInstructor.subjects);

                                    // Check if subjects has morning/afternoon structure
                                    if (assignedInstructor.subjects.morning || assignedInstructor.subjects.afternoon) {
                                        // New structure: {morning: [...], afternoon: [...]}
                                        if (Array.isArray(assignedInstructor.subjects.morning)) {
                                            // Add subjects from this coordinator (avoid duplicates)
                                            assignedInstructor.subjects.morning.forEach(subj => {
                                                if (!morningPrograms.includes(subj)) {
                                                    morningPrograms.push(subj);
                                                }
                                            });
                                        }
                                        if (Array.isArray(assignedInstructor.subjects.afternoon)) {
                                            // Add subjects from this coordinator (avoid duplicates)
                                            assignedInstructor.subjects.afternoon.forEach(subj => {
                                                if (!afternoonPrograms.includes(subj)) {
                                                    afternoonPrograms.push(subj);
                                                }
                                            });
                                        }
                                        console.log(`ğŸ“š Found structured subjects for ${instructor.name} under ${coordData.fullName}:`, {morning: morningPrograms, afternoon: afternoonPrograms});
                                    } else if (Array.isArray(assignedInstructor.subjects)) {
                                        // Old structure: array - could be strings or objects
                                        const instructorUserData = userRoles[instructor.email];
                                        console.log(`ğŸ‘¤ Instructor userData for ${instructor.name}:`, instructorUserData);

                                        // Check each subject
                                        assignedInstructor.subjects.forEach(subject => {
                                            console.log(`ğŸ” Checking subject for ${instructor.name}:`, subject);

                                            // Check if subject is an object with period info
                                            if (typeof subject === 'object' && subject.period) {
                                                const subjectName = subject.name || subject.subject || JSON.stringify(subject);
                                                console.log(`  ğŸ“¦ Object format with period: ${subject.period}`);
                                                if (subject.period === 'morning' || subject.period === '×‘×•×§×¨') {
                                                    morningPrograms.push(subjectName);
                                                } else if (subject.period === 'afternoon' || subject.period === '××—×”"×¦' || subject.period === '××—×¨ ×”×¦×”×¨×™×™×') {
                                                    afternoonPrograms.push(subjectName);
                                                } else {
                                                    morningPrograms.push(subjectName);
                                                }
                                            } else if (typeof subject === 'string') {
                                                // String format - try multiple methods to categorize
                                                console.log(`  ğŸ“ String format: "${subject}"`);

                                                let categorized = false;

                                                // Method 1: Check in userData.subjects
                                                if (instructorUserData && instructorUserData.subjects) {
                                                    console.log(`  ğŸ“š Checking in userData.subjects`);
                                                    if (instructorUserData.subjects.morning && instructorUserData.subjects.morning.includes(subject)) {
                                                        console.log(`    âœ… Found in userData morning`);
                                                        morningPrograms.push(subject);
                                                        categorized = true;
                                                    } else if (instructorUserData.subjects.afternoon && instructorUserData.subjects.afternoon.includes(subject)) {
                                                        console.log(`    âœ… Found in userData afternoon`);
                                                        afternoonPrograms.push(subject);
                                                        categorized = true;
                                                    }
                                                }

                                                // Method 2: Check in global departments (from Firebase departments/morning and departments/afternoon)
                                                if (!categorized) {
                                                    console.log(`  ğŸ” Checking in Firebase departments`);
                                                    if (morningDepartments.includes(subject)) {
                                                        console.log(`    âœ… Found in Firebase morning departments`);
                                                        morningPrograms.push(subject);
                                                        categorized = true;
                                                    } else if (afternoonDepartments.includes(subject)) {
                                                        console.log(`    âœ… Found in Firebase afternoon departments`);
                                                        afternoonPrograms.push(subject);
                                                        categorized = true;
                                                    }
                                                }

                                                // Method 3: Try to guess from subject name
                                                if (!categorized) {
                                                    console.log(`    âš ï¸ Not found in any source, checking name patterns`);
                                                    if (subject.includes('××—×¨') || subject.includes('××—×”"×¦') || subject.includes('×¢×¨×‘') || subject.includes('×—×•×’')) {
                                                        console.log(`    ğŸŒ™ Detected afternoon keyword in name`);
                                                        afternoonPrograms.push(subject);
                                                    } else {
                                                        console.log(`    ğŸŒ… Defaulting to morning`);
                                                        morningPrograms.push(subject);
                                                    }
                                                }
                                            }
                                        });
                                    }
                                } else {
                                    console.log(`âš ï¸ No subjects field found for ${instructor.name} under ${coordData.fullName}`);
                                }

                                // Don't break - continue checking other coordinators for more subjects
                            }
                        }
                    }

                    console.log(`ğŸ“‹ Final data for ${instructor.name}:`, {
                        coordinator: coordinatorName,
                        morning: morningPrograms,
                        afternoon: afternoonPrograms
                    });

                    // Store data in card attributes for filtering
                    card.setAttribute('data-coordinator-email', coordinatorEmail);
                    card.setAttribute('data-morning-programs', JSON.stringify(morningPrograms));
                    card.setAttribute('data-afternoon-programs', JSON.stringify(afternoonPrograms));

                    card.innerHTML = `
                        <!-- Three-dot menu button - only show if sent to finance -->
                        ${isSentToFinance || isSalaryReported ? `
                        <button class="salary-menu-btn" data-email="${instructor.email}"
                            title="${isSalaryReported ? '×”×—×–×¨ ×œ×œ× ×“×™×•×•×— ×©×›×¨' : '××©×¨ ×“×™×•×•×— ×©×›×¨'}"
                            style="position: absolute; top: 8px; left: 8px; background: ${isSalaryReported ? 'rgba(234, 179, 8, 0.2)' : 'rgba(34, 197, 94, 0.2)'}; border: 1px solid ${isSalaryReported ? 'rgba(234, 179, 8, 0.4)' : 'rgba(34, 197, 94, 0.4)'}; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: 600; z-index: 10; transition: all 0.2s; color: ${isSalaryReported ? '#ca8a04' : '#16a34a'};">
                            ${isSalaryReported ? 'â†©ï¸' : 'âœ“'}
                        </button>
                        ` : ''}

                        <!-- All in one horizontal line: Morning - Profile/Name - Afternoon -->
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 8px;">
                            <!-- Morning Programs (Right side) -->
                            <div style="flex: 1; text-align: right; min-width: 0;">
                                ${morningPrograms.length > 0 ? `
                                    <div style="color: #f59e0b; font-weight: 700; font-size: 10px; margin-bottom: 3px;">ğŸŒ… ×‘×•×§×¨</div>
                                    ${morningPrograms.map(prog => `<div style="color: var(--text-secondary); line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 10px;">${prog}</div>`).join('')}
                                ` : ''}
                            </div>

                            <!-- Profile Image and Name (Center) -->
                            <div style="display: flex; flex-direction: column; align-items: center; flex-shrink: 0;">
                                ${profileImage ?
                                    `<div style="width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color); margin-bottom: 6px;">
                                        <img src="${profileImage}" alt="${instructor.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>` :
                                    `<div style="font-size: 32px; margin-bottom: 6px;">ğŸ‘¤</div>`
                                }
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px; text-align: center; white-space: nowrap;">${instructor.name}</div>
                            </div>

                            <!-- Afternoon Programs (Left side) -->
                            <div style="flex: 1; text-align: left; min-width: 0;">
                                ${afternoonPrograms.length > 0 ? `
                                    <div style="color: #6366f1; font-weight: 700; font-size: 10px; margin-bottom: 3px;">ğŸŒ™ ××—×”"×¦</div>
                                    ${afternoonPrograms.map(prog => `<div style="color: var(--text-secondary); line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 10px;">${prog}</div>`).join('')}
                                ` : ''}
                            </div>
                        </div>

                        <div id="finance-badge-${sanitizeEmail(instructor.email).replace(/[@.]/g, '_')}" style="position: absolute; top: 8px; right: 8px; display: none;">
                            <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.4);">ğŸ“¨ ×“×•×— ×—×“×©</span>
                        </div>
                    `;

                    // Add menu button event listener (only if button exists)
                    const menuBtn = card.querySelector('.salary-menu-btn');
                    if (menuBtn) {
                        menuBtn.addEventListener('click', async (e) => {
                            e.stopPropagation(); // Prevent card click
                            await toggleSalaryStatus(instructor.email, !isSalaryReported);
                        });
                        menuBtn.addEventListener('mouseover', () => {
                            menuBtn.style.transform = 'scale(1.1)';
                        });
                        menuBtn.addEventListener('mouseout', () => {
                            menuBtn.style.transform = 'scale(1)';
                        });
                    }

                    card.addEventListener('click', () => selectInstructor(instructor.email));
                    card.addEventListener('mouseover', () => {
                        card.style.background = 'rgba(99, 102, 241, 0.1)';
                        card.style.borderColor = 'rgba(99, 102, 241, 0.5)';
                    });
                    card.addEventListener('mouseout', () => {
                        card.style.background = 'var(--card-bg)';
                        card.style.borderColor = 'var(--border-color)';
                    });
                    listContainer.appendChild(card);

                    // Setup realtime listener for this instructor's submissions to finance
                    setupFinanceRealtimeListener(instructor.email, financeReportYear, financeReportMonth);
                }

                // Setup realtime listener to watch for coordinator changes (assign/unassign)
                setupCoordinatorAssignmentListener();

                // Populate filters
                populateFinanceFilters();

                // Setup realtime listener for notifications
                setupNotificationsRealtimeListener();

                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”××“×¨×™×›×™×');
                showLoading(false);
            }
        }

        // Populate coordinator and program filters
        function populateFinanceFilters() {
            const coordinatorFilter = document.getElementById('coordinatorFilter');
            const programFilter = document.getElementById('programFilter');

            if (!coordinatorFilter || !programFilter) return;

            // Get all coordinators
            const coordinators = Object.entries(userRoles)
                .filter(([email, userData]) => userData.role === 'coordinator')
                .map(([email, userData]) => ({
                    email: email,
                    name: userData.fullName || email
                }))
                .sort((a, b) => a.name.localeCompare(b.name, 'he'));

            // Populate coordinator filter
            coordinatorFilter.innerHTML = '<option value="">×›×œ ×”×¨×›×–×™×</option>';
            coordinators.forEach(coord => {
                const option = document.createElement('option');
                option.value = coord.email;
                option.textContent = coord.name;
                coordinatorFilter.appendChild(option);
            });

            // Get all unique programs from all instructor cards
            const allPrograms = new Set();
            const allCards = document.querySelectorAll('.instructor-card');

            allCards.forEach(card => {
                try {
                    const morningPrograms = JSON.parse(card.getAttribute('data-morning-programs') || '[]');
                    const afternoonPrograms = JSON.parse(card.getAttribute('data-afternoon-programs') || '[]');

                    morningPrograms.forEach(prog => allPrograms.add(prog));
                    afternoonPrograms.forEach(prog => allPrograms.add(prog));
                } catch (e) {
                    console.error('Error parsing programs:', e);
                }
            });

            // Populate program filter
            programFilter.innerHTML = '<option value="">×›×œ ×”×ª×›× ×™×•×ª</option>';
            const sortedPrograms = [...allPrograms].sort((a, b) => a.localeCompare(b, 'he'));
            sortedPrograms.forEach(prog => {
                const option = document.createElement('option');
                option.value = prog;
                option.textContent = prog;
                programFilter.appendChild(option);
            });

            // Add event listeners for filters
            coordinatorFilter.addEventListener('change', applyFinanceFilters);
            programFilter.addEventListener('change', applyFinanceFilters);

            // Clear filters button
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    coordinatorFilter.value = '';
                    programFilter.value = '';
                    applyFinanceFilters();
                });
            }
        }

        // Apply filters to instructor cards
        function applyFinanceFilters() {
            const coordinatorFilter = document.getElementById('coordinatorFilter').value;
            const programFilter = document.getElementById('programFilter').value;

            // Get all instructor cards
            const allCards = document.querySelectorAll('.instructor-card');

            allCards.forEach(card => {
                let shouldShow = true;

                // Get coordinator from card data attribute
                const instructorCoordinator = card.getAttribute('data-coordinator-email');

                // Apply coordinator filter
                if (coordinatorFilter && instructorCoordinator !== coordinatorFilter) {
                    shouldShow = false;
                }

                // Apply program filter
                if (programFilter) {
                    try {
                        const morningPrograms = JSON.parse(card.getAttribute('data-morning-programs') || '[]');
                        const afternoonPrograms = JSON.parse(card.getAttribute('data-afternoon-programs') || '[]');
                        const allPrograms = [...morningPrograms, ...afternoonPrograms];

                        // Check if instructor has this program
                        if (!allPrograms.includes(programFilter)) {
                            shouldShow = false;
                        }
                    } catch (e) {
                        console.error('Error parsing programs for filter:', e);
                        shouldShow = false;
                    }
                }

                // Show/hide card
                card.style.display = shouldShow ? '' : 'none';
            });
        }

        // Toggle salary reported status
        async function toggleSalaryStatus(instructorEmail, newStatus) {
            try {
                showLoading(true);

                const sanitizedEmail = sanitizeEmail(instructorEmail);
                const salaryStatusRef = ref(database, `timesheets/${sanitizedEmail}/${financeReportYear}/${financeReportMonth}/salaryReported`);

                // Update status in Firebase
                await set(salaryStatusRef, newStatus);

                // Show confirmation message
                const statusText = newStatus ? '×“×•×•×— ×©×›×¨' : '×œ× ×“×•×•×— ×©×›×¨';
                showSuccess(`×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ: ${statusText}`);

                // Reload the list to reflect changes
                await loadInstructorsList();

                showLoading(false);
            } catch (error) {
                console.error('Error updating salary status:', error);
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×“×™×•×•×— ×”×©×›×¨');
                showLoading(false);
            }
        }

        // Setup realtime listener for finance submissions
        function setupFinanceRealtimeListener(instructorEmail, year, month) {
            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
            const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);

            // Listen to financeSubmissions path
            const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/financeSubmissions/${sanitizedFinanceEmail}`);

            onValue(financeSubmissionsRef, async (snapshot) => {
                console.log(`ğŸ”„ Finance listener triggered for ${instructorEmail}`);
                const cardId = `finance-card-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;
                const badgeId = `finance-badge-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;
                const card = document.getElementById(cardId);
                const badge = document.getElementById(badgeId);

                if (!card || !badge) {
                    console.log(`âš ï¸ Card or badge not found for ${instructorEmail}`);
                    return;
                }

                if (snapshot.exists()) {
                    // Has submissions - coordinator sent report to finance
                    const submissions = snapshot.val();
                    const submissionCount = Object.keys(submissions).length;

                    if (submissionCount > 0) {
                        // Check if salary was already reported
                        const salaryStatusRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/salaryReported`);
                        const salarySnapshot = await get(salaryStatusRef);
                        const isSalaryReported = salarySnapshot.exists() ? salarySnapshot.val() : false;

                        // Move card from red (notSentByCoord) to orange (notReported) if not salary reported
                        const notSentByCoordContainer = document.getElementById('instructorsListNotSentByCoord');
                        const notReportedContainer = document.getElementById('instructorsListNotReported');
                        const reportedContainer = document.getElementById('instructorsListReported');

                        // Determine target container
                        const targetContainer = isSalaryReported ? reportedContainer : notReportedContainer;

                        // Move card if in wrong container
                        if (card.parentElement !== targetContainer) {
                            targetContainer.appendChild(card);

                            // Add/update the salary button if moving to orange or green
                            if (!card.querySelector('.salary-menu-btn')) {
                                const instructorData = Object.entries(userRoles).find(([email]) => sanitizeEmail(email).replace(/[@.]/g, '_') === sanitizedInstructorEmail.replace(/[@.]/g, '_'));
                                if (instructorData) {
                                    const [email] = instructorData;
                                    const menuBtn = document.createElement('button');
                                    menuBtn.className = 'salary-menu-btn';
                                    menuBtn.setAttribute('data-email', email);
                                    menuBtn.title = isSalaryReported ? '×”×—×–×¨ ×œ×œ× ×“×™×•×•×— ×©×›×¨' : '××©×¨ ×“×™×•×•×— ×©×›×¨';
                                    menuBtn.style.cssText = `position: absolute; top: 8px; left: 8px; background: ${isSalaryReported ? 'rgba(234, 179, 8, 0.2)' : 'rgba(34, 197, 94, 0.2)'}; border: 1px solid ${isSalaryReported ? 'rgba(234, 179, 8, 0.4)' : 'rgba(34, 197, 94, 0.4)'}; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 14px; font-weight: 600; z-index: 10; transition: all 0.2s; color: ${isSalaryReported ? '#ca8a04' : '#16a34a'};`;
                                    menuBtn.textContent = isSalaryReported ? 'â†©ï¸' : 'âœ“';

                                    menuBtn.addEventListener('click', async (e) => {
                                        e.stopPropagation();
                                        await toggleSalaryStatus(email, !isSalaryReported);
                                    });
                                    menuBtn.addEventListener('mouseover', () => {
                                        menuBtn.style.transform = 'scale(1.1)';
                                    });
                                    menuBtn.addEventListener('mouseout', () => {
                                        menuBtn.style.transform = 'scale(1)';
                                    });

                                    card.insertBefore(menuBtn, card.firstChild);
                                }
                            }
                        }

                        // Check if this is a resubmission
                        let isResubmission = false;
                        for (const coordEmail in submissions) {
                            const submission = submissions[coordEmail];
                            console.log(`   Checking submission from ${coordEmail}:`, submission);
                            if (submission.isResubmission) {
                                isResubmission = true;
                                console.log(`   ğŸ”„ RESUBMISSION DETECTED!`);
                                break;
                            }
                        }
                        console.log(`   Final isResubmission status: ${isResubmission}`);

                        // Check if this report was already viewed
                        const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);
                        const viewedRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/viewedByFinance/${sanitizedFinanceEmail}`);
                        const viewedSnapshot = await get(viewedRef);

                        // Update badge content based on resubmission status
                        if (isResubmission) {
                            console.log(`   ğŸ¨ Updating badge to ORANGE (×©×•×’×¨ ××—×“×©)`);
                            badge.innerHTML = '<span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(245, 158, 11, 0.4);">ğŸ”„ ×©×•×’×¨ ××—×“×©</span>';
                        } else {
                            console.log(`   ğŸ¨ Updating badge to GREEN (×“×•×— ×—×“×©)`);
                            badge.innerHTML = '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.4);">ğŸ“¨ ×“×•×— ×—×“×©</span>';
                        }

                        // Show badge if NOT viewed yet OR if it's a resubmission (always show for updates)
                        const wasViewed = viewedSnapshot.exists();
                        console.log(`   ğŸ‘ï¸ Was viewed: ${wasViewed}`);
                        if (!wasViewed || isResubmission) {
                            console.log(`   âœ… Showing badge (${!wasViewed ? 'not viewed yet' : 'resubmission - force show'})`);
                            badge.style.display = 'block';
                            card.style.borderColor = isResubmission ? 'rgba(245, 158, 11, 0.5)' : 'rgba(34, 197, 94, 0.5)';
                            card.style.borderWidth = '2px';
                        } else {
                            console.log(`   âŒ Hiding badge (already viewed and not resubmission)`);
                            badge.style.display = 'none';
                            card.style.borderColor = 'var(--border-color)';
                            card.style.borderWidth = '1px';
                        }
                    }
                } else {
                    // No submissions - hide badge
                    badge.style.display = 'none';
                    card.style.borderColor = 'var(--border-color)';
                    card.style.borderWidth = '1px';
                }
            });
        }

        // Setup realtime listener for coordinator assignment changes
        function setupCoordinatorAssignmentListener() {
            console.log('ğŸ” Setting up coordinator assignment listener for finance manager');

            // Get all coordinators
            const coordinators = Object.entries(userRoles)
                .filter(([email, userData]) => userData.role === 'coordinator');

            // Listen to each coordinator's assignedInstructors
            coordinators.forEach(([coordEmail, coordData]) => {
                const sanitizedCoordEmail = sanitizeEmail(coordEmail);
                const assignedInstructorsRef = ref(database, `users/coordinators/${sanitizedCoordEmail}/assignedInstructors`);

                let isFirstLoad = true;

                onValue(assignedInstructorsRef, async (snapshot) => {
                    // Skip first load to avoid immediate processing
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        return;
                    }

                    console.log('ğŸ”„ Coordinator assignment changed:', coordEmail);

                    // Reload the instructors list to reflect changes
                    const listContainer = document.getElementById('instructorsList');
                    if (!listContainer) return;

                    // Update userRoles from the snapshot
                    if (snapshot.exists()) {
                        userRoles[coordEmail].assignedInstructors = snapshot.val();
                    } else {
                        userRoles[coordEmail].assignedInstructors = [];
                    }

                    // Get all coordinators to find currently assigned instructors
                    const allCoordinators = Object.entries(userRoles)
                        .filter(([email, userData]) => userData.role === 'coordinator');

                    // Collect all assigned instructors from all coordinators
                    const assignedInstructorsSet = new Set();
                    allCoordinators.forEach(([email, data]) => {
                        if (data.assignedInstructors && Array.isArray(data.assignedInstructors)) {
                            data.assignedInstructors.forEach(instructorEmail => {
                                assignedInstructorsSet.add(instructorEmail);
                            });
                        }
                    });

                    // Update the list: remove cards for unassigned instructors
                    const currentCards = listContainer.querySelectorAll('.instructor-card');
                    currentCards.forEach(card => {
                        const cardId = card.id;
                        const instructorEmailFromId = cardId.replace('finance-card-', '').replace(/_/g, '@');

                        // Check if this instructor is still assigned to any coordinator
                        let isStillAssigned = false;
                        for (const instructorEmail of assignedInstructorsSet) {
                            if (sanitizeEmail(instructorEmail).replace(/[@.]/g, '_') === cardId.replace('finance-card-', '')) {
                                isStillAssigned = true;
                                break;
                            }
                        }

                        if (!isStillAssigned) {
                            console.log('ğŸ—‘ï¸ Removing instructor card:', instructorEmailFromId);

                            // Close the report if it's currently open for this instructor
                            const reportContainer = document.getElementById('selectedInstructorReport');
                            if (reportContainer && reportContainer.style.display !== 'none') {
                                // Check if the current report is for this instructor
                                const reportEmailElement = reportContainer.querySelector('[data-instructor-email]');
                                if (reportEmailElement) {
                                    const currentReportEmail = reportEmailElement.getAttribute('data-instructor-email');
                                    // Match the instructor email by sanitizing both
                                    const sanitizedCurrentEmail = sanitizeEmail(currentReportEmail).replace(/[@.]/g, '_');
                                    const sanitizedCardEmail = cardId.replace('finance-card-', '');

                                    if (sanitizedCurrentEmail === sanitizedCardEmail) {
                                        console.log('ğŸ”’ Closing report for unassigned instructor');
                                        closeFinanceReport();
                                    }
                                }
                            }

                            card.remove();
                        }
                    });

                    // Add new cards for newly assigned instructors
                    assignedInstructorsSet.forEach(instructorEmail => {
                        const cardId = `finance-card-${sanitizeEmail(instructorEmail).replace(/[@.]/g, '_')}`;
                        const existingCard = document.getElementById(cardId);

                        if (!existingCard && userRoles[instructorEmail]) {
                            console.log('â• Adding new instructor card:', instructorEmail);
                            const instructor = {
                                email: instructorEmail,
                                name: userRoles[instructorEmail].fullName || instructorEmail
                            };

                            const instructorData = userRoles[instructorEmail];
                            const profileImage = instructorData?.profileImage || instructorData?.photoURL;

                            const card = document.createElement('button');
                            card.className = 'instructor-card';
                            card.id = cardId;
                            card.style.cssText = 'padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-family: inherit; position: relative;';
                            card.innerHTML = `
                                ${profileImage ?
                                    `<div style="width: 60px; height: 60px; margin: 0 auto 8px auto; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color);">
                                        <img src="${profileImage}" alt="${instructor.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>` :
                                    `<div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¤</div>`
                                }
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${instructor.name}</div>
                                <div id="finance-badge-${sanitizeEmail(instructor.email).replace(/[@.]/g, '_')}" style="position: absolute; top: 8px; right: 8px; display: none;">
                                    <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.4);">ğŸ“¨ ×“×•×— ×—×“×©</span>
                                </div>
                            `;
                            card.addEventListener('click', () => selectInstructor(instructor.email));
                            card.addEventListener('mouseover', () => {
                                card.style.background = 'rgba(99, 102, 241, 0.1)';
                                card.style.borderColor = 'rgba(99, 102, 241, 0.5)';
                            });
                            card.addEventListener('mouseout', () => {
                                card.style.background = 'var(--card-bg)';
                                card.style.borderColor = 'var(--border-color)';
                            });
                            listContainer.appendChild(card);

                            // Setup realtime listener for this instructor's submissions to finance
                            setupFinanceRealtimeListener(instructor.email, financeReportYear, financeReportMonth);
                        }
                    });

                    // Update allInstructors array
                    allInstructors = Array.from(assignedInstructorsSet)
                        .filter(email => userRoles[email] && userRoles[email].role === 'instructor')
                        .map(email => ({
                            email: email,
                            name: userRoles[email].fullName || email
                        }))
                        .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                    // Check if list is empty
                    if (assignedInstructorsSet.size === 0) {
                        listContainer.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™× ×œ×¨×›×–×™×</p>';
                    }
                });
            });
        }

        // Search functionality with autocomplete
        function setupFinanceSearch() {
            const searchInput = document.getElementById('instructorSearchInput');
            const suggestionsDiv = document.getElementById('searchSuggestions');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                if (query.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                // Filter instructors
                const matches = allInstructors.filter(instructor =>
                    instructor.name.includes(query)
                );

                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-secondary);">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
                    suggestionsDiv.style.display = 'block';
                    return;
                }

                // Build suggestions
                suggestionsDiv.innerHTML = '';
                matches.slice(0, 10).forEach(instructor => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;';
                    item.innerHTML = `
                        <div style="font-weight: 600; color: var(--text-primary);">ğŸ‘¤ ${instructor.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${instructor.email}</div>
                    `;
                    item.addEventListener('click', () => {
                        selectInstructor(instructor.email);
                        searchInput.value = '';
                        suggestionsDiv.style.display = 'none';
                    });
                    item.addEventListener('mouseover', () => {
                        item.style.background = 'rgba(99, 102, 241, 0.1)';
                    });
                    item.addEventListener('mouseout', () => {
                        item.style.background = '';
                    });
                    suggestionsDiv.appendChild(item);
                });

                suggestionsDiv.style.display = 'block';
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // Select instructor and show full report
        async function selectInstructor(instructorEmail) {
            try {
                // Check if clicking on the same instructor - toggle close
                if (currentlyOpenInstructor === instructorEmail) {
                    closeFinanceReport();
                    currentlyOpenInstructor = null;
                    return;
                }

                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const financeEmail = currentUser.email;
                const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

                // Mark this report as viewed by finance manager
                const viewedRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/viewedByFinance/${sanitizedFinanceEmail}`);
                await set(viewedRef, {
                    viewedAt: Date.now(),
                    viewedBy: financeEmail
                });

                // Reset isResubmission flag for all coordinators after viewing
                const resetSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/financeSubmissions/${sanitizedFinanceEmail}`);
                const resetSnapshot = await get(resetSubmissionsRef);

                if (resetSnapshot.exists()) {
                    const resetSubmissions = resetSnapshot.val();
                    for (const coordEmail in resetSubmissions) {
                        const submission = resetSubmissions[coordEmail];
                        if (submission.isResubmission) {
                            // Reset the resubmission flag
                            const coordSubmissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/financeSubmissions/${sanitizedFinanceEmail}/${coordEmail}`);
                            await set(coordSubmissionRef, {
                                ...submission,
                                isResubmission: false,
                                resubmittedAt: null
                            });
                            console.log(`âœ… Reset isResubmission flag for ${coordEmail}`);
                        }
                    }
                }

                // Hide the "new report" badge when opening the report
                const badgeId = `finance-badge-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;
                const badge = document.getElementById(badgeId);
                if (badge) {
                    badge.style.display = 'none';
                }

                // Also remove the green border from the card
                const cardId = `finance-card-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;
                const card = document.getElementById(cardId);
                if (card) {
                    card.style.borderColor = 'var(--border-color)';
                    card.style.borderWidth = '1px';
                }

                // Get coordinator submissions (who approved)
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/financeSubmissions/${sanitizedFinanceEmail}`);
                const submissionsSnapshot = await get(financeSubmissionsRef);

                const approvedCoordinators = new Set();
                if (submissionsSnapshot.exists()) {
                    console.log('ğŸ“‹ Finance submissions found:', submissionsSnapshot.val());
                    Object.entries(submissionsSnapshot.val()).forEach(([coordEmail, data]) => {
                        const unSanitized = unsanitizeEmail(coordEmail);
                        console.log('âœ… Approved coordinator:', unSanitized);
                        approvedCoordinators.add(unSanitized);
                    });
                } else {
                    console.log('âŒ No finance submissions found at:', financeSubmissionsRef.toString());
                }
                console.log('ğŸ“Š Total approved coordinators:', Array.from(approvedCoordinators));

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Collect all subjects for this instructor from all assigned coordinators
                const allSubjects = { morning: [], afternoon: [] };
                const subjectToCoordinator = {}; // Maps subject to coordinator email

                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        const assignment = userData.assignedInstructors.find(assign => {
                            const assignmentEmail = typeof assign === 'string' ? assign : assign.email;
                            return assignmentEmail === instructorEmail;
                        });

                        if (assignment) {
                            // Get the assigned subjects for this specific instructor
                            let assignedSubjects = [];
                            if (typeof assignment === 'object' && assignment.subjects) {
                                // New format: use only the subjects assigned to this instructor
                                assignedSubjects = assignment.subjects;
                            } else {
                                // Old format: use all coordinator's subjects
                                assignedSubjects = getAllUserSubjects(userData);
                            }

                            // Add subjects to appropriate period
                            assignedSubjects.forEach(subject => {
                                // Determine period for this subject
                                let period = null;
                                if (userData.subjects?.morning?.includes(subject)) {
                                    period = 'morning';
                                } else if (userData.subjects?.afternoon?.includes(subject)) {
                                    period = 'afternoon';
                                }

                                if (period) {
                                    if (!allSubjects[period].includes(subject)) {
                                        allSubjects[period].push(subject);
                                    }
                                    subjectToCoordinator[`${period}_${subject}`] = email;
                                }
                            });
                        }
                    }
                });

                // Load substitutions from timesheet entries (stored as {date}_substitution_{index})
                const substitutionsByDate = {}; // Map date to array of {department, period, teaching, training}

                Object.entries(timesheetData).forEach(([key, entry]) => {
                    if (key.includes('_substitution_')) {
                        const date = key.split('_substitution_')[0];
                        if (!substitutionsByDate[date]) {
                            substitutionsByDate[date] = [];
                        }

                        const department = entry.department || '×œ× ×¦×•×™×Ÿ';
                        const period = entry.period || 'morning'; // Default to morning if not specified
                        const coordKey = `${period}_${department}`;
                        const coordEmail = subjectToCoordinator[coordKey];
                        const isApproved = approvedCoordinators.has(coordEmail);

                        substitutionsByDate[date].push({
                            department: department,
                            period: period,
                            coordEmail: coordEmail,
                            isApproved: isApproved,
                            teaching: entry.hours?.teaching || 0,
                            training: entry.hours?.training || 0
                        });
                    }
                });

                console.log('ğŸ“Š Loaded substitutions for finance:', substitutionsByDate);

                // Build report HTML
                const reportContainer = document.getElementById('selectedInstructorReport');
                reportContainer.innerHTML = '';

                // Build unified table (like coordinator/instructor sees)
                let reportHTML = `
                    <div data-instructor-email="${instructorEmail}" style="background: var(--card-bg); border-radius: 16px; padding: 24px; border: 2px solid rgba(99, 102, 241, 0.3); margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                                ğŸ“Š ×“×•×— ×©×¢×•×ª - ${instructorData?.fullName || instructorEmail}
                            </h3>
                            <button onclick="closeFinanceReport()" class="btn" style="padding: 8px 16px;">
                                âœ• ×¡×’×•×¨
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: rgba(99, 102, 241, 0.1);">
                                        <th style="padding: 6px; border: 1px solid var(--border-color); position: sticky; right: 0; background: rgba(99, 102, 241, 0.15); z-index: 3;">×ª××¨×™×š</th>
                                        <th style="padding: 6px; border: 1px solid var(--border-color); position: sticky; right: 0; background: rgba(99, 102, 241, 0.15); z-index: 3;">×™×•×</th>`;

                // Morning subjects header
                if (allSubjects.morning.length > 0) {
                    reportHTML += '<th style="padding: 6px; border: 1px solid var(--border-color); background: rgba(52, 211, 153, 0.1);">××©××¨×ª</th>';
                    allSubjects.morning.forEach(subject => {
                        const coordEmail = subjectToCoordinator[`morning_${subject}`];
                        const isApproved = approvedCoordinators.has(coordEmail);
                        reportHTML += `<th style="padding: 6px; border: 1px solid var(--border-color); background: ${isApproved ? 'rgba(52, 211, 153, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; ${isApproved ? '' : 'opacity: 0.5;'}">
                            <div style="font-weight: 600; margin-bottom: 3px;">${subject}</div>
                            <div style="font-size: 10px; display: flex; justify-content: space-around; color: var(--text-secondary);">
                                <span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span>
                            </div>
                        </th>`;
                    });
                }

                // Afternoon subjects header
                if (allSubjects.afternoon.length > 0) {
                    reportHTML += '<th style="padding: 6px; border: 1px solid var(--border-color); background: rgba(251, 191, 36, 0.1);">××©××¨×ª</th>';
                    allSubjects.afternoon.forEach(subject => {
                        const coordEmail = subjectToCoordinator[`afternoon_${subject}`];
                        const isApproved = approvedCoordinators.has(coordEmail);
                        reportHTML += `<th style="padding: 6px; border: 1px solid var(--border-color); background: ${isApproved ? 'rgba(251, 191, 36, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; ${isApproved ? '' : 'opacity: 0.5;'}">
                            <div style="font-weight: 600; margin-bottom: 3px;">${subject}</div>
                            <div style="font-size: 10px; display: flex; justify-content: space-around; color: var(--text-secondary);">
                                <span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span>
                            </div>
                        </th>`;
                    });
                }

                // Add single substitutions column header
                reportHTML += `<th style="padding: 6px; border: 1px solid var(--border-color); background: rgba(139, 92, 246, 0.1);">
                    <div style="font-weight: 600; margin-bottom: 3px;">×”×—×œ×¤×•×ª</div>
                    <div style="font-size: 10px; display: flex; justify-content: space-around; color: var(--text-secondary);">
                        <span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span>
                    </div>
                </th>`;

                reportHTML += `
                                        <th style="padding: 6px; border: 1px solid var(--border-color); min-width: 150px; max-width: 200px;">×”×¢×¨×•×ª</th>
                                        <th style="padding: 6px; border: 1px solid var(--border-color); background: rgba(99, 102, 241, 0.15); font-weight: 700;">×¡×”"×› ×”×“×¨×›×”</th>
                                        <th style="padding: 6px; border: 1px solid var(--border-color); background: rgba(99, 102, 241, 0.15); font-weight: 700;">×¡×”"×› ×”×©×ª×œ××•×ª</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                // Generate rows for each day
                const daysInMonth = new Date(financeReportYear, financeReportMonth, 0).getDate();
                const monthlyTotals = { teaching: 0, training: 0 };
                const subjectTotals = {}; // Track totals for each subject

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${financeReportYear}-${String(financeReportMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(financeReportYear, financeReportMonth - 1, day);
                    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                    const dayName = dayNames[dayDate.getDay()];

                    let dailyTeachingTotal = 0;
                    let dailyTrainingTotal = 0;

                    reportHTML += `<tr>
                        <td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; position: sticky; right: 0; background: var(--card-bg); z-index: 2;">${day}.${financeReportMonth}</td>
                        <td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; position: sticky; right: 0; background: var(--card-bg); z-index: 2;">${dayName}</td>`;

                    // Morning subjects data
                    if (allSubjects.morning.length > 0) {
                        reportHTML += '<td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; background: rgba(52, 211, 153, 0.05); font-weight: 600;">×‘×•×§×¨</td>';
                        allSubjects.morning.forEach(subject => {
                            const entryKey = `${dateStr}_morning_${subject}`;
                            const entry = timesheetData[entryKey];
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;

                            const coordEmail = subjectToCoordinator[`morning_${subject}`];
                            const isApproved = approvedCoordinators.has(coordEmail);
                            const coordName = userRoles[coordEmail]?.fullName || '×¨×›×–';

                            // Only add to totals if approved
                            if (isApproved) {
                                dailyTeachingTotal += teaching;
                                dailyTrainingTotal += training;
                            }

                            // Track subject totals
                            const subjectKey = `morning_${subject}`;
                            if (!subjectTotals[subjectKey]) {
                                subjectTotals[subjectKey] = { teaching: 0, training: 0, approved: isApproved };
                            }
                            subjectTotals[subjectKey].teaching += teaching;
                            subjectTotals[subjectKey].training += training;
                            subjectTotals[subjectKey].approved = isApproved;

                            reportHTML += `<td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; position: relative; ${isApproved ? '' : 'opacity: 0.4; background: rgba(128, 128, 128, 0.1); filter: grayscale(80%);'}">
                                ${teaching > 0 || training > 0 ? `${teaching} | ${training}` : '-'}
                                ${!isApproved ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×œ× ××•×©×¨ ×¢"×™ ${coordName}</div>` : ''}
                            </td>`;
                        });
                    }

                    // Afternoon subjects data
                    if (allSubjects.afternoon.length > 0) {
                        reportHTML += '<td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; background: rgba(251, 191, 36, 0.05); font-weight: 600;">××—×”"×¦</td>';
                        allSubjects.afternoon.forEach(subject => {
                            const entryKey = `${dateStr}_afternoon_${subject}`;
                            const entry = timesheetData[entryKey];
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;

                            const coordEmail = subjectToCoordinator[`afternoon_${subject}`];
                            const isApproved = approvedCoordinators.has(coordEmail);
                            const coordName = userRoles[coordEmail]?.fullName || '×¨×›×–';

                            // Only add to totals if approved
                            if (isApproved) {
                                dailyTeachingTotal += teaching;
                                dailyTrainingTotal += training;
                            }

                            // Track subject totals
                            const subjectKey = `afternoon_${subject}`;
                            if (!subjectTotals[subjectKey]) {
                                subjectTotals[subjectKey] = { teaching: 0, training: 0, approved: isApproved };
                            }
                            subjectTotals[subjectKey].teaching += teaching;
                            subjectTotals[subjectKey].training += training;
                            subjectTotals[subjectKey].approved = isApproved;

                            reportHTML += `<td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; position: relative; ${isApproved ? '' : 'opacity: 0.4; background: rgba(128, 128, 128, 0.1); filter: grayscale(80%);'}">
                                ${teaching > 0 || training > 0 ? `${teaching} | ${training}` : '-'}
                                ${!isApproved ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×œ× ××•×©×¨ ×¢"×™ ${coordName}</div>` : ''}
                            </td>`;
                        });
                    }

                    // Add single substitution column data with department name
                    const substData = substitutionsByDate[dateStr] || [];

                    // Calculate totals for this date
                    let totalTeaching = 0;
                    let totalTraining = 0;
                    substData.forEach(subst => {
                        totalTeaching += subst.teaching;
                        totalTraining += subst.training;
                    });

                    // Add to daily totals
                    if (totalTeaching > 0 || totalTraining > 0) {
                        dailyTeachingTotal += totalTeaching;
                        dailyTrainingTotal += totalTraining;
                    }

                    // Track substitution totals and approval status
                    if (!subjectTotals['substitutions']) {
                        subjectTotals['substitutions'] = { teaching: 0, training: 0, approved: true };
                    }
                    subjectTotals['substitutions'].teaching += totalTeaching;
                    subjectTotals['substitutions'].training += totalTraining;

                    // If any substitution is not approved, mark the total as not approved
                    substData.forEach(subst => {
                        if (!subst.isApproved) {
                            subjectTotals['substitutions'].approved = false;
                        }
                    });

                    // Build cell content showing department name and hours with blur effect if not approved
                    let substContent = '-';
                    if (substData.length > 0) {
                        substContent = substData.map(subst => {
                            const coordName = userRoles[subst.coordEmail]?.fullName || '×¨×›×–';
                            const hours = `<span style="color: #f97316;">${subst.teaching}</span> | <span style="color: #34ebbd;">${subst.training}</span>`;

                            if (subst.isApproved) {
                                return `${subst.department} ${hours}`;
                            } else {
                                // Not approved - show with blur and overlay message
                                return `<div style="position: relative; display: inline-block; width: 100%; ${!subst.isApproved ? 'opacity: 0.4; filter: grayscale(80%);' : ''}">
                                    ${subst.department} ${hours}
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×œ× ××•×©×¨ ×¢"×™ ${coordName}</div>
                                </div>`;
                            }
                        }).join('<br>');
                    }

                    reportHTML += `<td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; background: rgba(139, 92, 246, 0.05); font-size: 12px; position: relative;">
                        ${substContent}
                    </td>`;

                    monthlyTotals.teaching += dailyTeachingTotal;
                    monthlyTotals.training += dailyTrainingTotal;

                    // Get notes for this date
                    const notesKey = `${dateStr}_notes`;
                    const notesEntry = timesheetData[notesKey];
                    const notesValue = notesEntry?.notes || '';

                    reportHTML += `
                        <td style="padding: 5px; border: 1px solid var(--border-color); text-align: right; font-size: 12px; color: var(--text-secondary);">${notesValue}</td>
                        <td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; font-weight: 600; background: rgba(99, 102, 241, 0.1);"><span style="color: #f97316; font-weight: 700;">${dailyTeachingTotal}</span></td>
                        <td style="padding: 5px; border: 1px solid var(--border-color); text-align: center; font-weight: 600; background: rgba(99, 102, 241, 0.1);"><span style="color: #34ebbd; font-weight: 700;">${dailyTrainingTotal}</span></td>
                    </tr>`;
                }

                // Monthly totals row
                reportHTML += `
                    <tr style="background: rgba(99, 102, 241, 0.15); font-weight: 700;">
                        <td colspan="2" style="padding: 8px; border: 1px solid var(--border-color); text-align: right; font-size: 14px; position: sticky; right: 0; background: rgba(99, 102, 241, 0.2); z-index: 2;">×¡×”"×› ×—×•×“×©×™</td>`;

                // Morning subjects totals
                if (allSubjects.morning.length > 0) {
                    reportHTML += '<td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 13px; background: rgba(52, 211, 153, 0.15);"></td>';
                    allSubjects.morning.forEach(subject => {
                        const subjectKey = `morning_${subject}`;
                        const totals = subjectTotals[subjectKey] || { teaching: 0, training: 0, approved: true };
                        const coordEmail = subjectToCoordinator[`morning_${subject}`];
                        const coordName = userRoles[coordEmail]?.fullName || '×¨×›×–';
                        const isApproved = totals.approved !== false;

                        reportHTML += `<td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 14px; background: rgba(52, 211, 153, 0.15); position: relative; ${isApproved ? '' : 'opacity: 0.4; background: rgba(128, 128, 128, 0.1); filter: grayscale(80%);'}">
                            <span style="color: #f97316; font-weight: 700;">${totals.teaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${totals.training}</span>
                            ${!isApproved ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×œ× ××•×©×¨ ×¢"×™ ${coordName}</div>` : ''}
                        </td>`;
                    });
                }

                // Afternoon subjects totals
                if (allSubjects.afternoon.length > 0) {
                    reportHTML += '<td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 13px; background: rgba(251, 191, 36, 0.15);"></td>';
                    allSubjects.afternoon.forEach(subject => {
                        const subjectKey = `afternoon_${subject}`;
                        const totals = subjectTotals[subjectKey] || { teaching: 0, training: 0, approved: true };
                        const coordEmail = subjectToCoordinator[`afternoon_${subject}`];
                        const coordName = userRoles[coordEmail]?.fullName || '×¨×›×–';
                        const isApproved = totals.approved !== false;

                        reportHTML += `<td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 14px; background: rgba(251, 191, 36, 0.15); position: relative; ${isApproved ? '' : 'opacity: 0.4; background: rgba(128, 128, 128, 0.1); filter: grayscale(80%);'}">
                            <span style="color: #f97316; font-weight: 700;">${totals.teaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${totals.training}</span>
                            ${!isApproved ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×œ× ××•×©×¨ ×¢"×™ ${coordName}</div>` : ''}
                        </td>`;
                    });
                }

                // Substitution totals - single column with blur if not all approved
                const substTotals = subjectTotals['substitutions'] || { teaching: 0, training: 0, approved: true };
                const allSubstApproved = substTotals.approved;

                reportHTML += `<td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 14px; background: rgba(139, 92, 246, 0.15); position: relative; ${allSubstApproved ? '' : 'opacity: 0.4; background: rgba(128, 128, 128, 0.1); filter: grayscale(80%);'}">
                    <span style="color: #f97316; font-weight: 700;">${substTotals.teaching}</span> | <span style="color: #34ebbd; font-weight: 700;">${substTotals.training}</span>
                    ${!allSubstApproved ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: rgba(239, 68, 68, 1); font-weight: 800; white-space: nowrap; pointer-events: none; text-shadow: 0 0 4px rgba(255,255,255,1), 0 0 4px rgba(255,255,255,1); letter-spacing: 0.3px;">×××ª×™×Ÿ ×œ××™×©×•×¨</div>` : ''}
                </td>`;

                reportHTML += `
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 13px; color: var(--text-secondary);">â€”</td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 16px; background: rgba(99, 102, 241, 0.2);"><span style="color: #f97316; font-weight: 700;">${monthlyTotals.teaching}</span></td>
                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-size: 16px; background: rgba(99, 102, 241, 0.2);"><span style="color: #34ebbd; font-weight: 700;">${monthlyTotals.training}</span></td>
                    </tr>
                `;

                reportHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                reportContainer.innerHTML = reportHTML;
                reportContainer.style.display = 'block';

                // Scroll to report
                reportContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Setup realtime listeners for this report
                setupFinanceReportListeners(instructorEmail, sanitizedInstructorEmail, financeReportYear, financeReportMonth);

                // Mark this instructor as currently open
                currentlyOpenInstructor = instructorEmail;

                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        }

        // Close finance report and clean up listeners
        window.closeFinanceReport = function() {
            // Hide report
            document.getElementById('selectedInstructorReport').style.display = 'none';

            // Clear currently open instructor
            currentlyOpenInstructor = null;

            // Clean up listeners
            if (window.financeReportListeners) {
                window.financeReportListeners.forEach(unsubscribe => unsubscribe());
                window.financeReportListeners = [];
            }

            console.log('ğŸ”’ Finance report closed, listeners cleaned up');
        };

        // Finance Status: Track reporting status by coordinators
        // Calculate default month: if before the 5th of the month, default to previous month
        const statusToday = new Date();
        const statusDayOfMonth = statusToday.getDate();
        let statusReportYear = statusToday.getFullYear();
        let statusReportMonth = statusToday.getMonth() + 1;

        if (statusDayOfMonth < 5) {
            // Before the 5th - use previous month
            statusReportMonth--;
            if (statusReportMonth === 0) {
                statusReportMonth = 12;
                statusReportYear--;
            }
        }
        let statusReportingListeners = []; // Store listeners for cleanup

        // Function to update a specific coordinator's status display
        function updateCoordinatorStatusDisplay(coordinatorEmail, reportedCount, totalInstructors) {
            const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);
            const coordCardId = `coord-status-${sanitizedCoordEmail.replace(/[@.]/g, '_')}`;
            const statusElement = document.querySelector(`#${coordCardId} [data-status-info]`);

            if (statusElement) {
                const percentage = totalInstructors > 0 ? Math.round((reportedCount / totalInstructors) * 100) : 0;
                const statusColor = percentage === 100 ? '#22c55e' : percentage >= 50 ? '#f59e0b' : '#ef4444';
                statusElement.style.color = statusColor;
                statusElement.textContent = `×“×™×•×•×—×• ${reportedCount}/${totalInstructors} (${percentage}%)`;
            }
        }

        // Function to update a specific instructor's status display
        function updateInstructorStatusDisplay(coordinatorEmail, instructorEmail, hasReported) {
            const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);
            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
            const coordCardId = `coord-status-${sanitizedCoordEmail.replace(/[@.]/g, '_')}`;
            const instructorRowId = `instructor-${coordCardId}-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;
            const instructorRow = document.getElementById(instructorRowId);

            if (instructorRow) {
                // Update background and border colors
                instructorRow.style.background = hasReported ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                instructorRow.style.borderColor = hasReported ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';

                // Update status icon
                const statusIcon = instructorRow.querySelector('[data-status-icon]');
                if (statusIcon) {
                    statusIcon.textContent = hasReported ? 'âœ…' : 'âŒ';
                }
            }
        }

        // Setup realtime listeners for a coordinator's instructors
        function setupCoordinatorListeners(coordinator) {
            const sanitizedCoordEmail = sanitizeEmail(coordinator.email);

            coordinator.assignedInstructors.forEach(assignment => {
                const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                // Listen to submission status changes
                const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${statusReportYear}/${statusReportMonth}/submissions/${sanitizedCoordEmail}`);

                const unsubscribe = onValue(submissionRef, (snapshot) => {
                    const hasReported = snapshot.exists() && snapshot.val().status === 'submitted';

                    // Update individual instructor display
                    updateInstructorStatusDisplay(coordinator.email, instructorEmail, hasReported);

                    // Recalculate and update coordinator's total count
                    let reportedCount = 0;
                    coordinator.assignedInstructors.forEach(assign => {
                        const email = typeof assign === 'string' ? assign : assign.email;
                        const sanitizedEmail = sanitizeEmail(email);
                        const coordCardId = `coord-status-${sanitizedCoordEmail.replace(/[@.]/g, '_')}`;
                        const instructorRowId = `instructor-${coordCardId}-${sanitizedEmail.replace(/[@.]/g, '_')}`;
                        const row = document.getElementById(instructorRowId);
                        if (row) {
                            const icon = row.querySelector('[data-status-icon]');
                            if (icon && icon.textContent === 'âœ…') {
                                reportedCount++;
                            }
                        }
                    });

                    updateCoordinatorStatusDisplay(coordinator.email, reportedCount, coordinator.assignedInstructors.length);
                });

                statusReportingListeners.push(unsubscribe);
            });
        }

        async function loadReportingStatus() {
            try {
                showLoading(true);

                // Clean up existing listeners
                statusReportingListeners.forEach(unsubscribe => unsubscribe());
                statusReportingListeners = [];

                // Update month title
                const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
                document.getElementById('statusMonthTitle').textContent = `${monthNames[statusReportMonth - 1]} ${statusReportYear}`;

                const coordinatorsList = document.getElementById('coordinatorsStatusList');
                coordinatorsList.innerHTML = '';

                // Get all coordinators
                const coordinators = Object.entries(userRoles)
                    .filter(([email, userData]) => userData.role === 'coordinator')
                    .map(([email, userData]) => ({
                        email: email,
                        name: userData.fullName || email,
                        subjects: userData.subjects || { morning: [], afternoon: [] },
                        assignedInstructors: userData.assignedInstructors || [],
                        profileImage: userData.profileImage || null
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                // For each coordinator, check reporting status of their instructors
                for (const coordinator of coordinators) {
                    const instructorsStatus = [];

                    // Get all instructors assigned to this coordinator
                    for (const assignment of coordinator.assignedInstructors) {
                        const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                        const instructorData = userRoles[instructorEmail];
                        if (!instructorData) continue;

                        // Check if instructor submitted to this coordinator for this month
                        const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                        const sanitizedCoordEmail = sanitizeEmail(coordinator.email);

                        const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${statusReportYear}/${statusReportMonth}/submissions/${sanitizedCoordEmail}`);
                        const submissionSnapshot = await get(submissionRef);

                        const hasReported = submissionSnapshot.exists() && submissionSnapshot.val().status === 'submitted';

                        instructorsStatus.push({
                            email: instructorEmail,
                            name: instructorData.fullName || instructorEmail,
                            hasReported: hasReported,
                            profileImage: instructorData.profileImage || null
                        });
                    }

                    // Count reported vs total
                    const totalInstructors = instructorsStatus.length;
                    const reportedCount = instructorsStatus.filter(i => i.hasReported).length;

                    // Create coordinator card
                    const coordCard = document.createElement('div');
                    coordCard.style.cssText = 'background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; transition: all 0.3s;';

                    const sanitizedCoordEmail = sanitizeEmail(coordinator.email);
                    const coordCardId = `coord-status-${sanitizedCoordEmail.replace(/[@.]/g, '_')}`;
                    coordCard.id = coordCardId;

                    // Coordinator header (clickable)
                    const coordHeader = document.createElement('div');
                    coordHeader.style.cssText = 'padding: 16px 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: background 0.2s;';
                    coordHeader.onmouseover = () => coordHeader.style.background = 'rgba(99, 102, 241, 0.05)';
                    coordHeader.onmouseout = () => coordHeader.style.background = 'transparent';

                    const percentage = totalInstructors > 0 ? Math.round((reportedCount / totalInstructors) * 100) : 0;
                    const statusColor = percentage === 100 ? '#22c55e' : percentage >= 50 ? '#f59e0b' : '#ef4444';

                    // Get coordinator's subjects with colored badges
                    const morningSubjects = coordinator.subjects.morning || [];
                    const afternoonSubjects = coordinator.subjects.afternoon || [];

                    let subjectsBadgesHTML = '';

                    // Morning subjects - green badges
                    morningSubjects.forEach(subject => {
                        subjectsBadgesHTML += `<span style="display: inline-block; padding: 4px 12px; margin: 2px 4px 2px 0; background: rgba(52, 211, 153, 0.2); color: #10b981; border: 1px solid rgba(52, 211, 153, 0.4); border-radius: 12px; font-size: 12px; font-weight: 600;">${subject}</span>`;
                    });

                    // Afternoon subjects - orange badges
                    afternoonSubjects.forEach(subject => {
                        subjectsBadgesHTML += `<span style="display: inline-block; padding: 4px 12px; margin: 2px 4px 2px 0; background: rgba(251, 191, 36, 0.2); color: #f59e0b; border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; font-size: 12px; font-weight: 600;">${subject}</span>`;
                    });

                    if (!subjectsBadgesHTML) {
                        subjectsBadgesHTML = '<span style="color: var(--text-secondary); font-size: 12px;">××™×Ÿ ××§×¦×•×¢×•×ª</span>';
                    }

                    coordHeader.innerHTML = `
                        <div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%); display: flex; align-items: center; justify-content: center;">
                            ${coordinator.profileImage ?
                                `<img src="${coordinator.profileImage}" alt="${coordinator.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<div style="font-size: 28px;">ğŸ‘¤</div>`
                            }
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <span>${coordinator.name} -</span>
                                ${subjectsBadgesHTML}
                            </div>
                            <div data-status-info style="font-size: 14px; color: ${statusColor}; font-weight: 600;">×“×™×•×•×—×• ${reportedCount}/${totalInstructors} (${percentage}%)</div>
                        </div>
                        <div id="toggle-icon-${coordCardId}" style="font-size: 20px; color: var(--text-secondary); transition: transform 0.3s;">â–¼</div>
                    `;

                    // Instructors list (initially hidden)
                    const instructorsList = document.createElement('div');
                    instructorsList.id = `instructors-list-${coordCardId}`;
                    instructorsList.style.cssText = 'display: none; border-top: 1px solid var(--border-color); padding: 12px 20px; background: rgba(15, 23, 42, 0.3);';

                    if (instructorsStatus.length === 0) {
                        instructorsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">××™×Ÿ ××“×¨×™×›×™× ××©×•×™×›×™×</div>';
                    } else {
                        instructorsStatus.forEach(instructor => {
                            const sanitizedInstructorEmail = sanitizeEmail(instructor.email);
                            const instructorRowId = `instructor-${coordCardId}-${sanitizedInstructorEmail.replace(/[@.]/g, '_')}`;

                            const instructorRow = document.createElement('div');
                            instructorRow.id = instructorRowId;
                            instructorRow.style.cssText = `
                                padding: 12px 16px;
                                margin-bottom: 8px;
                                border-radius: 8px;
                                background: ${instructor.hasReported ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
                                border: 1px solid ${instructor.hasReported ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                transition: all 0.3s;
                            `;

                            instructorRow.innerHTML = `
                                <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%); display: flex; align-items: center; justify-content: center;">
                                    ${instructor.profileImage ?
                                        `<img src="${instructor.profileImage}" alt="${instructor.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                        `<div style="font-size: 20px;">ğŸ‘¤</div>`
                                    }
                                </div>
                                <div style="flex: 1; font-size: 15px; font-weight: 500; color: var(--text-primary);">${instructor.name}</div>
                                <div data-status-icon style="font-size: 24px;">${instructor.hasReported ? 'âœ…' : 'âŒ'}</div>
                            `;

                            instructorsList.appendChild(instructorRow);
                        });
                    }

                    // Toggle function
                    coordHeader.addEventListener('click', () => {
                        const isHidden = instructorsList.style.display === 'none';
                        instructorsList.style.display = isHidden ? 'block' : 'none';
                        const toggleIcon = document.getElementById(`toggle-icon-${coordCardId}`);
                        toggleIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                    });

                    coordCard.appendChild(coordHeader);
                    coordCard.appendChild(instructorsList);
                    coordinatorsList.appendChild(coordCard);

                    // Setup realtime listeners for this coordinator after DOM is ready
                    setupCoordinatorListeners(coordinator);
                }

                showLoading(false);
                console.log('âœ… Status reporting loaded with realtime listeners');

            } catch (error) {
                console.error('Error loading reporting status:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×”×“×™×•×•×—×™×');
                showLoading(false);
            }
        }

        // Month navigation for status
        document.getElementById('prevStatusMonth')?.addEventListener('click', () => {
            statusReportMonth--;
            if (statusReportMonth === 0) {
                statusReportMonth = 12;
                statusReportYear--;
            }
            loadReportingStatus();
        });

        document.getElementById('nextStatusMonth')?.addEventListener('click', () => {
            statusReportMonth++;
            if (statusReportMonth === 13) {
                statusReportMonth = 1;
                statusReportYear++;
            }
            loadReportingStatus();
        });

        // Setup realtime listeners for finance report to update dynamically
        let financeReportUpdateTimeout = null;
        function setupFinanceReportListeners(instructorEmail, sanitizedInstructorEmail, year, month) {
            const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);

            // Remove any existing listeners first to prevent duplicates
            if (window.financeReportListeners) {
                window.financeReportListeners.forEach(unsubscribe => unsubscribe());
            }
            window.financeReportListeners = [];

            let isFirstEntriesLoad = true;
            let isFirstFinanceLoad = true;

            // Listener 1: Watch for changes in timesheet entries (when instructor updates hours)
            const entriesRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/entries`);
            const entriesUnsubscribe = onValue(entriesRef, (snapshot) => {
                // Skip first load to avoid immediate reload
                if (isFirstEntriesLoad) {
                    isFirstEntriesLoad = false;
                    return;
                }

                // Only reload if report is still visible
                const reportContainer = document.getElementById('selectedInstructorReport');
                if (reportContainer && reportContainer.style.display !== 'none') {
                    console.log('ğŸ”„ Timesheet entries changed, reloading report...');
                    // Debounce to avoid multiple rapid reloads
                    clearTimeout(financeReportUpdateTimeout);
                    financeReportUpdateTimeout = setTimeout(() => {
                        selectInstructor(instructorEmail);
                    }, 500);
                }
            });
            window.financeReportListeners.push(entriesUnsubscribe);

            // Listener 2: Watch for changes in finance submissions (when coordinator approves/submits)
            const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/financeSubmissions/${sanitizedFinanceEmail}`);
            const financeUnsubscribe = onValue(financeSubmissionsRef, (snapshot) => {
                // Skip first load to avoid immediate reload
                if (isFirstFinanceLoad) {
                    isFirstFinanceLoad = false;
                    return;
                }

                // Only reload if report is still visible
                const reportContainer = document.getElementById('selectedInstructorReport');
                if (reportContainer && reportContainer.style.display !== 'none') {
                    console.log('ğŸ”„ Finance submissions changed, reloading report...');
                    // Debounce to avoid multiple rapid reloads
                    clearTimeout(financeReportUpdateTimeout);
                    financeReportUpdateTimeout = setTimeout(() => {
                        selectInstructor(instructorEmail);
                    }, 500);
                }
            });
            window.financeReportListeners.push(financeUnsubscribe);
        }

        window.viewFinanceReport = async function(instructorEmail) {
            try {
                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const financeEmail = currentUser.email;
                const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

                // Get coordinator submissions
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/financeSubmissions/${sanitizedFinanceEmail}`);
                const snapshot = await get(financeSubmissionsRef);

                if (!snapshot.exists()) {
                    showError('×œ× × ××¦× ×“×•×—');
                    showLoading(false);
                    return;
                }

                const coordinatorSubmissions = snapshot.val();

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${financeReportYear}/${financeReportMonth}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 1000px; width: 100%; max-height: 85vh; overflow-y: auto;';

                let coordinatorSections = '';
                for (const [coordEmail, submissionData] of Object.entries(coordinatorSubmissions)) {
                    const coordData = userRoles[unsanitizeEmail(coordEmail)];
                    const coordSubjects = getAllUserSubjects(coordData);

                    let coordTableHTML = '<table style="width:100%;border-collapse:collapse;margin-top:12px;"><thead><tr style="background:rgba(99,102,241,0.1);"><th style="padding:8px;border:1px solid var(--border-color);">×ª××¨×™×š</th><th style="padding:8px;border:1px solid var(--border-color);">××§×¦×•×¢</th><th style="padding:8px;border:1px solid var(--border-color);">×”×“×¨×›×”</th><th style="padding:8px;border:1px solid var(--border-color);">×”×©×ª×œ××•×ª</th></tr></thead><tbody>';

                    let coordTotal = {teaching:0, training:0};
                    let hasEntries = false;

                    Object.values(timesheetData).forEach(entry => {
                        if (coordSubjects.includes(entry.subject)) {
                            hasEntries = true;
                            coordTotal.teaching += entry.hours?.teaching || 0;
                            coordTotal.training += entry.hours?.training || 0;
                            coordTableHTML += `<tr><td style="padding:8px;border:1px solid var(--border-color);">${entry.date}</td><td style="padding:8px;border:1px solid var(--border-color);">${entry.subject}</td><td style="padding:8px;border:1px solid var(--border-color);">${entry.hours?.teaching||0}</td><td style="padding:8px;border:1px solid var(--border-color);">${entry.hours?.training||0}</td></tr>`;
                        }
                    });

                    if (!hasEntries) coordTableHTML += '<tr><td colspan="4" style="padding:16px;text-align:center;color:var(--text-secondary);">××™×Ÿ ×¨×™×©×•××™×</td></tr>';
                    coordTableHTML += `<tr style="background:rgba(99,102,241,0.1);font-weight:600;"><td colspan="2" style="padding:8px;border:1px solid var(--border-color);">×¡×”"×›</td><td style="padding:8px;border:1px solid var(--border-color);">${coordTotal.teaching}</td><td style="padding:8px;border:1px solid var(--border-color);">${coordTotal.training}</td></tr></tbody></table>`;

                    const coordDate = new Date(submissionData.submittedAt).toLocaleDateString('he-IL');
                    coordinatorSections += `<div style="margin-bottom:24px;padding:16px;background:rgba(16,185,129,0.05);border-radius:12px;border:1px solid rgba(16,185,129,0.3);"><h4 style="font-size:16px;font-weight:600;margin-bottom:8px;">âœ… ${submissionData.coordinatorName}</h4><p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">××•×©×¨ ×‘-${coordDate}</p>${coordTableHTML}</div>`;
                }

                modalContent.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:24px;"><h2 style="font-size:24px;font-weight:700;">ğŸ“Š ${instructorData?.fullName||instructorEmail}</h2><button onclick="this.closest('div[style*=fixed]').remove()" class="btn" style="padding:8px 16px;">âœ•</button></div>${coordinatorSections}`;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => { if(e.target===modal) document.body.removeChild(modal); });
                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        };

        // Submit all approved reports to finance manager
        async function submitToFinance() {
            try {
                showLoading(true);

                console.log('ğŸ” Checking submissions for year:', coordReportYear, 'month:', coordReportMonth);
                console.log('ğŸ‘¥ My instructors:', currentUserData.assignedInstructors);

                // Check if coordinator has any assigned instructors
                if (!currentUserData.assignedInstructors || currentUserData.assignedInstructors.length === 0) {
                    showError('××™×Ÿ ×œ×š ××“×¨×™×›×™× ××©×•×™×›×™×. × × ×œ×©×™×™×š ××“×¨×™×›×™× ×ª×—×™×œ×”.');
                    showLoading(false);
                    return;
                }

                // Get all assigned instructors who submitted reports
                const submittedInstructors = [];

                for (const assignment of currentUserData.assignedInstructors) {
                    const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                    const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                    const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                    // Check if this instructor submitted to this coordinator
                    const submissionPath = `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/submissions/${sanitizedCoordEmail}`;
                    console.log(`ğŸ“‹ Checking submission path: ${submissionPath}`);
                    const submissionRef = ref(database, submissionPath);
                    const snapshot = await get(submissionRef);

                    if (snapshot.exists()) {
                        const submissionData = snapshot.val();

                        // Check if report is in pending_review status (edited after submission)
                        const isPendingReview = submissionData.status === 'pending_review' && submissionData.needsCoordinatorReview === true;

                        if (isPendingReview) {
                            console.log(`âš ï¸ ${instructorEmail} has pending review - cannot send to finance yet`);
                        } else {
                            console.log(`âœ… ${instructorEmail} submitted at:`, submissionData.submittedAt);
                            const instructorData = userRoles[instructorEmail];
                            submittedInstructors.push({
                                email: instructorEmail,
                                name: instructorData?.fullName || instructorEmail,
                                submittedAt: submissionData.submittedAt
                            });
                        }
                    } else {
                        console.log(`âŒ ${instructorEmail} has NOT submitted`);
                    }
                }

                console.log(`ğŸ“Š Total submitted instructors: ${submittedInstructors.length}`);

                if (submittedInstructors.length === 0) {
                    showError('××™×Ÿ ××“×¨×™×›×™× ×©×©×™×’×¨×• ×“×•×—×•×ª ×”×—×•×“×©. ×•×“× ×©×”××“×¨×™×›×™× ×©×™×’×¨×• ××ª ×”×“×•×—×•×ª ××œ×™×š ×§×•×“×.');
                    showLoading(false);
                    return;
                }

                // Show popup with list of instructors
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; border: 2px solid #10b981;';

                // Check which instructors were already sent to finance
                const financeEmail = Object.keys(userRoles).find(email => userRoles[email].role === 'finance');
                const alreadySentToFinance = [];

                if (financeEmail) {
                    const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                    for (const instructor of submittedInstructors) {
                        const sanitizedInstructorEmail = sanitizeEmail(instructor.email);
                        const financeSubmissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/financeSubmissions/${sanitizedFinanceEmail}/${sanitizeEmail(currentUser.email)}`);
                        const snapshot = await get(financeSubmissionRef);
                        if (snapshot.exists()) {
                            alreadySentToFinance.push(instructor.email);
                        }
                    }
                }

                let instructorsList = '';
                submittedInstructors.forEach(instructor => {
                    const date = new Date(instructor.submittedAt);
                    const dateStr = date.toLocaleDateString('he-IL');
                    const timeStr = date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                    const alreadySent = alreadySentToFinance.includes(instructor.email);

                    instructorsList += `
                        <div style="padding: 12px; background: ${alreadySent ? 'rgba(99, 102, 241, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 8px; margin-bottom: 8px; border: 1px solid ${alreadySent ? 'rgba(99, 102, 241, 0.3)' : 'rgba(16, 185, 129, 0.3)'};">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="checkbox" class="instructor-checkbox" data-email="${instructor.email}"
                                    ${alreadySent ? '' : 'checked'}
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${alreadySent ? 'ğŸ“¤' : 'âœ…'} ${instructor.name}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        ×©×•×’×¨ ×œ×š ×‘-${dateStr} ×‘×©×¢×” ${timeStr}
                                        ${alreadySent ? '<br><span style="color: #6366f1; font-weight: 600;">âœ“ ×›×‘×¨ × ×©×œ×— ×œ×× ×”×œ×ª ×›×¡×¤×™×</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                modalContent.innerHTML = `
                    <div style="font-size: 48px; text-align: center; margin-bottom: 16px;">ğŸ’°</div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; text-align: center;">
                        ×©×œ×™×—×” ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                    </h2>
                    <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; text-align: center;">
                        ${submittedInstructors.length} ××“×¨×™×›×™× ×©×™×’×¨×• ×“×•×—×•×ª ×”×—×•×“×©:
                    </p>
                    <div style="margin-bottom: 24px; max-height: 300px; overflow-y: auto;">
                        ${instructorsList}
                    </div>
                    <p style="font-size: 14px; color: #10b981; margin-bottom: 24px; text-align: center;">
                        âœ… ×”×“×•×—×•×ª ×™×•×¢×‘×¨×• ×œ×× ×”×œ×ª ×”×›×¡×¤×™× ×œ××™×©×•×¨ ×¡×•×¤×™
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="cancelFinanceSubmitBtn" class="btn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                            ×‘×™×˜×•×œ
                        </button>
                        <button id="confirmFinanceSubmitBtn" class="btn btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            âœ… ××™×©×•×¨ ×•×©×œ×™×—×”
                        </button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                showLoading(false);

                // Cancel button
                document.getElementById('cancelFinanceSubmitBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Confirm button
                document.getElementById('confirmFinanceSubmitBtn').addEventListener('click', async () => {
                    try {
                        showLoading(true);

                        // Get selected instructors from checkboxes
                        const checkboxes = document.querySelectorAll('.instructor-checkbox:checked');
                        const selectedInstructorEmails = Array.from(checkboxes).map(cb => cb.dataset.email);

                        if (selectedInstructorEmails.length === 0) {
                            showError('× × ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××“×¨×™×š ××—×“');
                            showLoading(false);
                            return;
                        }

                        // Find finance manager
                        const financeEmail = Object.keys(userRoles).find(email => userRoles[email].role === 'finance');

                        if (!financeEmail) {
                            showError('×œ× × ××¦××” ×× ×”×œ×ª ×›×¡×¤×™× ×‘××¢×¨×›×ª');
                            showLoading(false);
                            return;
                        }

                        // Submit only selected instructors' reports to finance
                        const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                        const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                        // Get finance manager data for email
                        const financeManagerData = userRoles[financeEmail];
                        const financeNotificationEmail = financeManagerData?.notificationEmail || financeEmail;
                        const financeManagerName = financeManagerData?.fullName || financeEmail;

                        for (const instructorEmail of selectedInstructorEmails) {
                            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                            // Store with coordinator email as sub-key so we know which coordinator approved which subjects
                            const financeSubmissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/financeSubmissions/${sanitizedFinanceEmail}/${sanitizedCoordEmail}`);

                            // Check if report was already sent before (resubmission)
                            const existingSubmissionSnapshot = await get(financeSubmissionRef);
                            const isResubmission = existingSubmissionSnapshot.exists();

                            await set(financeSubmissionRef, {
                                status: 'submitted',
                                submittedAt: Date.now(),
                                submittedBy: currentUser.email,
                                coordinatorName: currentUserData.fullName,
                                isResubmission: isResubmission,
                                resubmittedAt: isResubmission ? Date.now() : null
                            });

                            // If this is a resubmission, reset the "viewed" status so badge shows again
                            if (isResubmission) {
                                const viewedRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/viewedByFinance/${sanitizedFinanceEmail}`);
                                await remove(viewedRef); // Delete the viewed status
                                console.log(`ğŸ”„ Reset viewed status for ${instructorEmail}`);
                            }

                            // If this is a resubmission, send email and notification to finance manager
                            if (isResubmission) {
                                console.log(`ğŸ”„ Resubmission detected for ${instructorEmail} - sending notification to finance`);

                                // Get instructor data
                                const instructorData = userRoles[instructorEmail];
                                const instructorName = instructorData?.fullName || instructorEmail;

                                // Send email to finance manager
                                try {
                                    const monthName = getMonthName(coordReportMonth);
                                    const updateDate = new Date().toLocaleDateString('he-IL', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });

                                    const templateParams = {
                                        finance_email: financeNotificationEmail,
                                        finance_name: financeManagerName,
                                        coordinator_name: currentUserData.fullName || currentUser.email,
                                        instructor_name: instructorName,
                                        instructor_email: instructorEmail,
                                        month_name: monthName,
                                        year: coordReportYear,
                                        update_date: updateDate
                                    };

                                    await emailjs.send(
                                        EMAILJS_CONFIG.serviceId,
                                        EMAILJS_CONFIG.financeUpdateTemplateId,
                                        templateParams
                                    );

                                    console.log(`âœ… Email sent to finance manager about report update`);
                                } catch (emailError) {
                                    console.error('Error sending email to finance manager:', emailError);
                                }

                                // Add notification for finance manager
                                try {
                                    const notificationRef = ref(database, `notifications/${sanitizedFinanceEmail}/${Date.now()}`);
                                    await set(notificationRef, {
                                        type: 'report_updated',
                                        instructorEmail: instructorEmail,
                                        instructorName: instructorName,
                                        coordinatorEmail: currentUser.email,
                                        coordinatorName: currentUserData.fullName || currentUser.email,
                                        month: coordReportMonth,
                                        year: coordReportYear,
                                        timestamp: Date.now(),
                                        read: false,
                                        message: `×”×¨×›×–/×ª ${currentUserData.fullName} ×©×™×’×¨/×” ×©×•×‘ ××ª ×“×•×— ×”×©×¢×•×ª ×©×œ ${instructorName} ×¢×‘×•×¨ ${getMonthName(coordReportMonth)} ${coordReportYear}`
                                    });

                                    console.log(`âœ… Notification added for finance manager`);
                                } catch (notifError) {
                                    console.error('Error adding notification for finance manager:', notifError);
                                }
                            }
                        }

                        document.body.removeChild(modal);
                        showSuccess(`${selectedInstructorEmails.length} ×“×•×—×•×ª × ×©×œ×—×• ×œ×× ×”×œ×ª ×”×›×¡×¤×™× ×‘×”×¦×œ×—×”!`);

                    } catch (error) {
                        console.error('Error submitting to finance:', error);
                        showError('×©×’×™××” ×‘×©×œ×™×—×” ×œ×× ×”×œ×ª ×”×›×¡×¤×™×');
                    } finally {
                        showLoading(false);
                    }
                });

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—×•×ª');
                showLoading(false);
            }
        }

        // Submit all substitutions to finance manager
        async function submitAllSubstitutionsToFinance() {
            try {
                showLoading(true);

                // Load substitutions from all instructors' timesheets
                const timesheetsRef = ref(database, 'timesheets');
                const timesheetsSnapshot = await get(timesheetsRef);

                if (!timesheetsSnapshot.exists()) {
                    showError('××™×Ÿ × ×ª×•× ×™×');
                    showLoading(false);
                    return;
                }

                const allTimesheets = timesheetsSnapshot.val();

                // Group by instructor
                const substByInstructor = {};

                for (const [sanitizedEmail, instructorData] of Object.entries(allTimesheets)) {
                    const yearData = instructorData[coordReportYear];
                    if (!yearData) continue;

                    const monthData = yearData[coordReportMonth];
                    if (!monthData || !monthData.entries) continue;

                    const entries = monthData.entries;
                    const instructorEmail = Object.keys(userRoles).find(email => sanitizeEmail(email) === sanitizedEmail);
                    if (!instructorEmail) continue;

                    // Look for substitution entries for this coordinator's departments
                    Object.entries(entries).forEach(([key, entry]) => {
                        if (key.includes('_substitution_')) {
                            // Check if this substitution is for one of this coordinator's departments
                            const coordDepartments = getAllUserSubjects(currentUserData);
                            if (!coordDepartments.includes(entry.department)) {
                                return; // Skip if not this coordinator's department
                            }

                            const date = key.split('_substitution_')[0];

                            if (!substByInstructor[instructorEmail]) {
                                const userData = userRoles[instructorEmail];
                                substByInstructor[instructorEmail] = {
                                    name: userData?.fullName || instructorEmail,
                                    substitutions: []
                                };
                            }

                            substByInstructor[instructorEmail].substitutions.push({
                                date: date,
                                department: entry.department,
                                period: entry.period,
                                hours: entry.hours
                            });
                        }
                    });
                }

                if (Object.keys(substByInstructor).length === 0) {
                    showError('××™×Ÿ ×”×—×œ×¤×•×ª ×œ×©×œ×™×—×” ×”×—×•×“×©');
                    showLoading(false);
                    return;
                }

                // Create modal to select which instructors to send
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; border: 2px solid rgba(139, 92, 246, 0.5);';

                const instructorsList = Object.entries(substByInstructor).map(([email, data]) => {
                    const totalTeaching = data.substitutions.reduce((sum, s) => sum + (s.hours?.teaching || 0), 0);
                    const totalTraining = data.substitutions.reduce((sum, s) => sum + (s.hours?.training || 0), 0);

                    return `
                        <div style="padding: 16px; background: rgba(139, 92, 246, 0.05); border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" class="instructor-checkbox" data-email="${email}" checked style="width: 18px; height: 18px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${data.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${data.substitutions.length} ×”×—×œ×¤×•×ª |
                                        <span style="color: #f97316;">ğŸ“ ${totalTeaching} ×”×“×¨×›×”</span> |
                                        <span style="color: #34ebbd;">ğŸ“š ${totalTraining} ×”×©×ª×œ××•×ª</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');

                modalContent.innerHTML = `
                    <h2 style="font-size: 24px; font-weight: 700; color: rgba(139, 92, 246, 1); margin-bottom: 8px; text-align: center;">
                        ğŸ’° ×©×’×¨ ×”×—×œ×¤×•×ª ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                    </h2>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; text-align: center;">
                        ${getMonthName(coordReportMonth)} ${coordReportYear}
                    </p>
                    <div style="margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; cursor: pointer; margin-bottom: 16px;">
                            <input type="checkbox" id="selectAllSubstitutionInstructors" checked style="width: 18px; height: 18px;">
                            <span style="font-weight: 600; color: var(--text-primary);">×‘×—×¨ ×”×›×œ</span>
                        </label>
                        ${instructorsList}
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="cancelSubstToFinanceBtn" style="padding: 12px 24px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 600;">
                            ×‘×™×˜×•×œ
                        </button>
                        <button id="confirmSubstToFinanceBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ×©×’×¨ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                        </button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Select all functionality
                const selectAllCheckbox = document.getElementById('selectAllSubstitutionInstructors');
                selectAllCheckbox.addEventListener('change', (e) => {
                    const checkboxes = modal.querySelectorAll('.instructor-checkbox');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                });

                // Cancel button
                document.getElementById('cancelSubstToFinanceBtn').onclick = () => {
                    document.body.removeChild(modal);
                    showLoading(false);
                };

                // Confirm button
                document.getElementById('confirmSubstToFinanceBtn').onclick = async () => {
                    console.log('ğŸš€ Starting substitution submission to finance...');
                    try {
                        showLoading(true);
                        const selectedCheckboxes = modal.querySelectorAll('.instructor-checkbox:checked');
                        const selectedEmails = Array.from(selectedCheckboxes).map(cb => cb.dataset.email);
                        console.log('ğŸ“‹ Selected emails:', selectedEmails);

                        if (selectedEmails.length === 0) {
                            showError('×œ× × ×‘×—×¨×• ××“×¨×™×›×™× ×œ×©×œ×™×—×”');
                            showLoading(false);
                            return;
                        }

                        // Find finance manager
                        const financeEmail = Object.keys(userRoles).find(email => userRoles[email].role === 'finance');
                        console.log('ğŸ’° Finance email:', financeEmail);
                        if (!financeEmail) {
                            showError('×œ× × ××¦××” ×× ×”×œ×ª ×›×¡×¤×™× ×‘××¢×¨×›×ª');
                            showLoading(false);
                            return;
                        }

                        const sanitizedFinanceEmail = sanitizeEmail(financeEmail);
                        const sanitizedCoordEmail = sanitizeEmail(currentUser.email);
                        console.log('ğŸ“§ Sanitized emails - Finance:', sanitizedFinanceEmail, 'Coord:', sanitizedCoordEmail);

                        // Submit each instructor's substitutions
                        for (const instructorEmail of selectedEmails) {
                            console.log('ğŸ“¤ Submitting substitutions for:', instructorEmail);
                            const instructorSubstitutions = substByInstructor[instructorEmail].substitutions;
                            const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                            // Save to finance submissions
                            const financeSubmissionRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${coordReportYear}/${coordReportMonth}/${sanitizedInstructorEmail}_${sanitizedCoordEmail}`);
                            console.log('ğŸ’¾ Saving to Firebase path:', `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${coordReportYear}/${coordReportMonth}/${sanitizedInstructorEmail}_${sanitizedCoordEmail}`);
                            await set(financeSubmissionRef, {
                                instructorEmail: instructorEmail,
                                instructorName: substByInstructor[instructorEmail].name,
                                coordinatorEmail: currentUser.email,
                                coordinatorName: currentUserData.fullName || currentUser.email,
                                substitutions: instructorSubstitutions,
                                submittedAt: Date.now(),
                                year: coordReportYear,
                                month: coordReportMonth
                            });
                            console.log('âœ… Saved to finance submissions');

                            // Add notification for finance manager
                            const notificationRef = ref(database, `notifications/${sanitizedFinanceEmail}/${Date.now()}`);
                            await set(notificationRef, {
                                type: 'substitutions_submitted',
                                instructorEmail: instructorEmail,
                                instructorName: substByInstructor[instructorEmail].name,
                                coordinatorEmail: currentUser.email,
                                coordinatorName: currentUserData.fullName || currentUser.email,
                                month: coordReportMonth,
                                year: coordReportYear,
                                timestamp: Date.now(),
                                read: false,
                                message: `×”×¨×›×–/×ª ${currentUserData.fullName} ×©×™×’×¨/×” ×”×—×œ×¤×•×ª ×©×œ ${substByInstructor[instructorEmail].name} ×¢×‘×•×¨ ${getMonthName(coordReportMonth)} ${coordReportYear}`
                            });
                            console.log('ğŸ”” Notification sent');
                        }

                        console.log('âœ… All substitutions submitted successfully');
                        document.body.removeChild(modal);
                        showLoading(false);

                        // Reload substitution instructors to show updated status
                        await loadSubstitutionInstructors();

                        showSuccess(`${selectedEmails.length} ××“×¨×™×›×™ ×”×—×œ×¤×•×ª × ×©×œ×—×• ×œ×× ×”×œ×ª ×”×›×¡×¤×™× ×‘×”×¦×œ×—×”!`);

                    } catch (error) {
                        console.error('Error submitting substitutions to finance:', error);
                        showLoading(false);
                        showError('×©×’×™××” ×‘×©×œ×™×—×” ×œ×× ×”×œ×ª ×”×›×¡×¤×™×');
                    }
                };

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        showLoading(false);
                    }
                });

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×—×œ×¤×•×ª');
                showLoading(false);
            }
        }

        // ===== FINANCE SUBSTITUTIONS =====

        // Calculate default month: if before the 5th of the month, default to previous month
        const substFinanceToday = new Date();
        const substFinanceDayOfMonth = substFinanceToday.getDate();
        let substFinanceReportYear = substFinanceToday.getFullYear();
        let substFinanceReportMonth = substFinanceToday.getMonth() + 1;

        if (substFinanceDayOfMonth < 5) {
            // Before the 5th - use previous month
            substFinanceReportMonth--;
            if (substFinanceReportMonth === 0) {
                substFinanceReportMonth = 12;
                substFinanceReportYear--;
            }
        }

        async function loadFinanceSubstitutions() {
            const container = document.getElementById('financeSubstitutionsList');
            if (!container) return;

            try {
                showLoading(true);

                // Update month title
                const monthTitle = document.getElementById('substFinanceMonthTitle');
                if (monthTitle) {
                    monthTitle.textContent = `${getMonthName(substFinanceReportMonth)} ${substFinanceReportYear}`;
                }

                const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);
                const substRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${substFinanceReportYear}/${substFinanceReportMonth}`);

                const snapshot = await get(substRef);

                if (!snapshot.exists()) {
                    container.innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-secondary); font-size: 16px;">××™×Ÿ ×”×—×œ×¤×•×ª ×©×”×•×’×©×• ×”×—×•×“×©</div>';
                    showLoading(false);
                    return;
                }

                const submissions = snapshot.val();
                container.innerHTML = '';

                // Group by instructor
                const byInstructor = {};
                Object.entries(submissions).forEach(([key, submission]) => {
                    const instructorEmail = submission.instructorEmail;
                    if (!byInstructor[instructorEmail]) {
                        byInstructor[instructorEmail] = {
                            name: submission.instructorName,
                            coordinatorName: submission.coordinatorName,
                            coordinatorEmail: submission.coordinatorEmail,
                            substitutions: []
                        };
                    }
                    byInstructor[instructorEmail].substitutions.push(...submission.substitutions);
                });

                // Create cards for each instructor
                Object.entries(byInstructor).forEach(([instructorEmail, data]) => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 24px; border: 1px solid rgba(139, 92, 246, 0.3); margin-bottom: 16px;';

                    // Calculate totals
                    let totalTeaching = 0;
                    let totalTraining = 0;
                    data.substitutions.forEach(s => {
                        totalTeaching += s.hours?.teaching || 0;
                        totalTraining += s.hours?.training || 0;
                    });

                    const substitutionsList = data.substitutions.map(s => {
                        // Format date to dd/mm/yy
                        const [year, month, day] = s.date.split('-');
                        const formattedDate = `${day}/${month}/${year.slice(-2)}`;

                        return `
                        <div style="padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(139, 92, 246, 0.15);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">ğŸ“… ${formattedDate}</span>
                                <span style="font-size: 12px; color: var(--text-secondary);">${s.department} (${s.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})</span>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px;">
                                <span style="color: #f97316;">ğŸ“ ×”×“×¨×›×”: ${s.hours?.teaching || 0}</span>
                                <span style="color: #34ebbd;">ğŸ“š ×”×©×ª×œ××•×ª: ${s.hours?.training || 0}</span>
                            </div>
                        </div>
                    `;
                    }).join('');

                    card.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                ğŸ‘¤ ${data.name}
                            </h3>
                            <p style="font-size: 14px; color: var(--text-secondary);">
                                ×¨×›×–/×ª: ${data.coordinatorName}
                            </p>
                        </div>

                        <div style="margin-bottom: 16px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <strong style="color: var(--text-primary);">×¡×”"×› ×©×¢×•×ª:</strong>
                            <div style="display: flex; gap: 16px; margin-top: 8px; font-size: 16px; font-weight: 600;">
                                <span style="color: #f97316;">ğŸ“ ${totalTeaching} ×”×“×¨×›×”</span>
                                <span style="color: #34ebbd;">ğŸ“š ${totalTraining} ×”×©×ª×œ××•×ª</span>
                            </div>
                        </div>

                        <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px;">
                            <strong>×”×—×œ×¤×•×ª (${data.substitutions.length}):</strong>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${substitutionsList}
                        </div>
                    `;

                    container.appendChild(card);
                });

                showLoading(false);

            } catch (error) {
                console.error('Error loading finance substitutions:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×—×œ×¤×•×ª</div>';
                showLoading(false);
            }
        }

        // ===== DEPARTMENT REPORTS (Finance Manager) =====

        async function loadDepartmentReports() {
            try {
                showLoading(true);

                const monthName = getMonthName(departmentReportMonth);
                document.getElementById('departmentMonthTitle').textContent = `${monthName} ${departmentReportYear}`;

                const container = document.getElementById('departmentsList');
                container.innerHTML = '';

                // Collect all subjects with their coordinators and instructors
                const departmentsMap = {}; // { subject: { coordinatorName, coordinatorEmail, instructors: [{email, name}] } }

                // Go through all coordinators
                Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                    if (coordData.role !== 'coordinator') return;

                    // Get all subjects from this coordinator (both morning and afternoon)
                    const allCoordSubjects = [];
                    if (coordData.subjects?.morning) allCoordSubjects.push(...coordData.subjects.morning);
                    if (coordData.subjects?.afternoon) allCoordSubjects.push(...coordData.subjects.afternoon);

                    // For each subject, collect assigned instructors
                    allCoordSubjects.forEach(subject => {
                        if (!departmentsMap[subject]) {
                            departmentsMap[subject] = {
                                coordinatorName: coordData.fullName || coordData.name,
                                coordinatorEmail: coordEmail,
                                instructors: []
                            };
                        }

                        // If coordinator is hourly, add them as an instructor to this subject
                        if (coordData.employmentType === 'hourly') {
                            const coordName = coordData.fullName || coordData.name;
                            const coordProfileImage = coordData.profileImage || coordData.photoURL;

                            console.log(`ğŸ‘” Adding hourly coordinator to ${subject}:`);
                            console.log(`   Email: ${coordEmail}`);
                            console.log(`   Name: ${coordName}`);
                            console.log(`   ProfileImage: ${coordProfileImage}`);

                            departmentsMap[subject].instructors.push({
                                email: coordEmail,
                                name: coordName,
                                profileImage: coordProfileImage
                            });
                        }

                        // Find instructors assigned to this coordinator who teach this subject
                        if (coordData.assignedInstructors && Array.isArray(coordData.assignedInstructors)) {
                            coordData.assignedInstructors.forEach(assignment => {
                                const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                                const instructorData = userRoles[instructorEmail];

                                if (instructorData && instructorData.role === 'instructor') {
                                    // Check if instructor teaches this subject
                                    let instructorSubjects = [];
                                    if (typeof assignment === 'object' && assignment.subjects) {
                                        // New format: use assigned subjects
                                        instructorSubjects = assignment.subjects;
                                    } else {
                                        // Old format: use all instructor's subjects
                                        instructorSubjects = getAllUserSubjects(instructorData);
                                    }

                                    if (instructorSubjects.includes(subject)) {
                                        // Add instructor if not already added
                                        const exists = departmentsMap[subject].instructors.some(i => i.email === instructorEmail);
                                        if (!exists) {
                                            const instructorName = instructorData.fullName || instructorData.name;
                                            const instructorProfileImage = instructorData.profileImage || instructorData.photoURL;

                                            console.log(`ğŸ“ Adding instructor to ${subject}:`);
                                            console.log(`   Email: ${instructorEmail}`);
                                            console.log(`   Name: ${instructorName}`);
                                            console.log(`   ProfileImage: ${instructorProfileImage}`);
                                            console.log(`   Full instructorData:`, instructorData);
                                            console.log(`   instructorData.profileImage:`, instructorData.profileImage);
                                            console.log(`   instructorData.photoURL:`, instructorData.photoURL);

                                            departmentsMap[subject].instructors.push({
                                                email: instructorEmail,
                                                name: instructorName,
                                                profileImage: instructorProfileImage
                                            });
                                        }
                                    }
                                }
                            });
                        }
                    });
                });

                // Add substitution instructors to departments
                const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);
                const substRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${departmentReportYear}/${departmentReportMonth}`);
                const substSnapshot = await get(substRef);

                if (substSnapshot.exists()) {
                    const allSubstitutions = substSnapshot.val();

                    Object.entries(allSubstitutions).forEach(([key, submission]) => {
                        if (submission.substitutions) {
                            submission.substitutions.forEach(subst => {
                                const subject = subst.department;

                                // Add to department if exists
                                if (departmentsMap[subject]) {
                                    const instructorEmail = submission.instructorEmail;
                                    const instructorName = submission.instructorName;

                                    // Check if instructor already exists in this department
                                    const exists = departmentsMap[subject].instructors.some(i => i.email === instructorEmail);
                                    if (!exists) {
                                        const instructorData = userRoles[instructorEmail];
                                        departmentsMap[subject].instructors.push({
                                            email: instructorEmail,
                                            name: instructorName,
                                            profileImage: instructorData?.profileImage || instructorData?.photoURL,
                                            isSubstitution: true // Mark as substitution instructor
                                        });
                                    }
                                }
                            });
                        }
                    });
                }

                // Sort subjects alphabetically
                const sortedSubjects = Object.keys(departmentsMap).sort((a, b) => a.localeCompare(b, 'he'));

                if (sortedSubjects.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 48px; color: var(--text-secondary);">××™×Ÿ ××—×œ×§×•×ª ×‘××¢×¨×›×ª</p>';
                    showLoading(false);
                    return;
                }

                // Create collapsible departments
                for (const subject of sortedSubjects) {
                    const dept = departmentsMap[subject];
                    const deptId = `dept-${sanitizeEmail(subject).replace(/[@.]/g, '_')}`;

                    const deptCard = document.createElement('div');
                    deptCard.style.cssText = 'background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 16px; overflow: hidden;';

                    // Department header (clickable)
                    const header = document.createElement('div');
                    header.style.cssText = 'padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;';
                    header.innerHTML = `
                        <div>
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                ğŸ“š ${subject}
                            </h3>
                            <p style="font-size: 14px; color: var(--text-secondary);">
                                ×¨×›×–/×ª: ${dept.coordinatorName} | ${dept.instructors.length} ××“×¨×™×›×™×
                            </p>
                        </div>
                        <div id="${deptId}-arrow" style="font-size: 24px; transition: transform 0.3s; transform: rotate(0deg);">
                            â–¼
                        </div>
                    `;

                    // Instructors list (collapsed by default) - SPLIT BY COORDINATOR SUBMISSION
                    const instructorsList = document.createElement('div');
                    instructorsList.id = deptId;
                    instructorsList.style.cssText = 'display: none; padding: 0 20px 20px 20px; border-top: 1px solid var(--border-color);';

                    if (dept.instructors.length === 0) {
                        instructorsList.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--text-secondary);">××™×Ÿ ××“×¨×™×›×™× ×‘××—×œ×§×” ×–×•</p>';
                    } else {
                        // Check coordinator submission status for each instructor
                        const notReportedInstructors = [];
                        const reportedInstructors = [];

                        // Get finance manager email (current user should be finance)
                        const financeEmail = currentUser.email;
                        const sanitizedFinanceEmail = sanitizeEmail(financeEmail);

                        for (const instructor of dept.instructors) {
                            const sanitizedInstructorEmail = sanitizeEmail(instructor.email);

                            // Check if ANY coordinator submitted for this instructor to finance
                            // Path: timesheets/{instructorEmail}/{year}/{month}/financeSubmissions/{financeEmail}
                            const financeSubmissionsPath = `timesheets/${sanitizedInstructorEmail}/${departmentReportYear}/${departmentReportMonth}/financeSubmissions/${sanitizedFinanceEmail}`;
                            console.log(`ğŸ” Checking ALL coordinator submissions for ${instructor.name} (${instructor.email}) in ${subject}:`, financeSubmissionsPath);

                            const financeSubmissionsRef = ref(database, financeSubmissionsPath);
                            const financeSnapshot = await get(financeSubmissionsRef);

                            // If there are ANY submissions from ANY coordinator to this finance manager, consider it reported
                            const isReported = financeSnapshot.exists() && Object.keys(financeSnapshot.val()).length > 0;

                            console.log(`   Result: ${isReported ? 'âœ… REPORTED' : 'âŒ NOT REPORTED'}`, financeSnapshot.val());

                            if (isReported) {
                                reportedInstructors.push(instructor);
                            } else {
                                notReportedInstructors.push(instructor);
                            }
                        }

                        // Create container for both zones
                        const zonesContainer = document.createElement('div');
                        zonesContainer.style.cssText = 'margin-top: 16px;';

                        // NOT REPORTED ZONE (RED)
                        if (notReportedInstructors.length > 0) {
                            const notReportedZone = document.createElement('div');
                            notReportedZone.style.cssText = 'background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;';
                            notReportedZone.innerHTML = `
                                <h4 style="font-size: 16px; font-weight: 600; color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ğŸ”´ ×œ× ×“×•×•×— ×¢"×™ ×”×¨×›×–
                                </h4>
                            `;

                            const notReportedGrid = document.createElement('div');
                            notReportedGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;';

                            notReportedInstructors.forEach(instructor => {
                                const card = document.createElement('button');
                                card.style.cssText = 'padding: 16px; background: var(--card-bg); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-family: inherit;';

                                // Debug: log instructor object
                                console.log(`ğŸ–¼ï¸ NOT REPORTED - Instructor object for ${instructor.name}:`, instructor);

                                // Use profile image from instructor object
                                const profileImage = instructor.profileImage;
                                console.log(`  ğŸ“¸ Profile image:`, profileImage);

                                card.innerHTML = `
                                    ${profileImage ?
                                        `<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color); margin: 0 auto 8px;">
                                            <img src="${profileImage}" alt="${instructor.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>` :
                                        `<div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¤</div>`
                                    }
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${instructor.name}</div>
                                    ${instructor.isSubstitution ? '<div style="font-size: 11px; color: rgba(139, 92, 246, 1); font-weight: 600; margin-top: 4px;">ğŸ”„ ×”×—×œ×¤×”</div>' : ''}
                                `;
                                card.addEventListener('click', () => selectDepartmentInstructor(instructor.email, subject, dept.coordinatorEmail));
                                card.addEventListener('mouseover', () => {
                                    card.style.background = 'rgba(239, 68, 68, 0.1)';
                                    card.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                                });
                                card.addEventListener('mouseout', () => {
                                    card.style.background = 'var(--card-bg)';
                                    card.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                                });
                                notReportedGrid.appendChild(card);
                            });

                            notReportedZone.appendChild(notReportedGrid);
                            zonesContainer.appendChild(notReportedZone);
                        }

                        // REPORTED ZONE (GREEN)
                        if (reportedInstructors.length > 0) {
                            const reportedZone = document.createElement('div');
                            reportedZone.style.cssText = 'background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px;';
                            reportedZone.innerHTML = `
                                <h4 style="font-size: 16px; font-weight: 600; color: #16a34a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ğŸŸ¢ ×“×•×•×— ×¢"×™ ×”×¨×›×–
                                </h4>
                            `;

                            const reportedGrid = document.createElement('div');
                            reportedGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;';

                            reportedInstructors.forEach(instructor => {
                                const card = document.createElement('button');
                                card.style.cssText = 'padding: 16px; background: var(--card-bg); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-family: inherit;';

                                // Debug: log instructor object
                                console.log(`ğŸ–¼ï¸ REPORTED - Instructor object for ${instructor.name}:`, instructor);

                                // Use profile image from instructor object
                                const profileImage = instructor.profileImage;
                                console.log(`  ğŸ“¸ Profile image:`, profileImage);

                                card.innerHTML = `
                                    ${profileImage ?
                                        `<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color); margin: 0 auto 8px;">
                                            <img src="${profileImage}" alt="${instructor.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>` :
                                        `<div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¤</div>`
                                    }
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${instructor.name}</div>
                                    ${instructor.isSubstitution ? '<div style="font-size: 11px; color: rgba(139, 92, 246, 1); font-weight: 600; margin-top: 4px;">ğŸ”„ ×”×—×œ×¤×”</div>' : ''}
                                `;
                                card.addEventListener('click', () => selectDepartmentInstructor(instructor.email, subject, dept.coordinatorEmail));
                                card.addEventListener('mouseover', () => {
                                    card.style.background = 'rgba(34, 197, 94, 0.1)';
                                    card.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                                });
                                card.addEventListener('mouseout', () => {
                                    card.style.background = 'var(--card-bg)';
                                    card.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                                });
                                reportedGrid.appendChild(card);
                            });

                            reportedZone.appendChild(reportedGrid);
                            zonesContainer.appendChild(reportedZone);
                        }

                        instructorsList.appendChild(zonesContainer);
                    }

                    // Toggle collapse on header click
                    header.addEventListener('click', () => {
                        const isVisible = instructorsList.style.display !== 'none';
                        instructorsList.style.display = isVisible ? 'none' : 'block';
                        document.getElementById(`${deptId}-arrow`).style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
                    });

                    header.addEventListener('mouseover', () => {
                        header.style.background = 'rgba(99, 102, 241, 0.05)';
                    });
                    header.addEventListener('mouseout', () => {
                        header.style.background = '';
                    });

                    deptCard.appendChild(header);
                    deptCard.appendChild(instructorsList);
                    container.appendChild(deptCard);
                }

                showLoading(false);
            } catch (error) {
                console.error('Error loading department reports:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×“×™×•×•×—×™× ×œ×¤×™ ××—×œ×§×”');
                showLoading(false);
            }
        }

        async function selectDepartmentInstructor(instructorEmail, subject, coordinatorEmail) {
            try {
                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                const coordData = userRoles[coordinatorEmail];
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);

                // Check if ANY coordinator submitted to finance
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${departmentReportYear}/${departmentReportMonth}/financeSubmissions/${sanitizedFinanceEmail}`);
                const submissionsSnapshot = await get(financeSubmissionsRef);
                const isApproved = submissionsSnapshot.exists() && Object.keys(submissionsSnapshot.val()).length > 0;

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${departmentReportYear}/${departmentReportMonth}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Filter only entries for this specific subject
                const subjectEntries = Object.values(timesheetData).filter(entry => entry.subject === subject);

                // Load substitutions for this instructor in this department
                const substRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${departmentReportYear}/${departmentReportMonth}`);
                const substSnapshot = await get(substRef);
                const substitutionEntries = [];

                if (substSnapshot.exists()) {
                    const allSubstitutions = substSnapshot.val();

                    Object.entries(allSubstitutions).forEach(([key, submission]) => {
                        if (submission.instructorEmail === instructorEmail && submission.substitutions) {
                            submission.substitutions.forEach(subst => {
                                if (subst.department === subject) {
                                    substitutionEntries.push({
                                        date: subst.date,
                                        period: subst.period,
                                        subject: subject,
                                        hours: subst.hours,
                                        isSubstitution: true
                                    });
                                }
                            });
                        }
                    });
                }

                // Create modal popup
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);';

                let reportHTML = `
                    <div data-instructor-email="${instructorEmail}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                                    ğŸ“Š ${instructorData?.fullName || instructorEmail}
                                </h3>
                                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">
                                    ××—×œ×§×”: <strong>${subject}</strong> | ×¨×›×–/×ª: ${coordData?.fullName || coordData?.name}
                                </p>
                            </div>
                            <button class="btn" style="padding: 8px 16px;">
                                âœ• ×¡×’×•×¨
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: ${isApproved ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">×ª××¨×™×š</th>
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">×™×•×</th>
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">××©××¨×ª</th>
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">××§×¦×•×¢</th>
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">×”×“×¨×›×”</th>
                                        <th style="padding: 8px; border: 1px solid var(--border-color);">×”×©×ª×œ××•×ª</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                const daysInMonth = new Date(departmentReportYear, departmentReportMonth, 0).getDate();
                let totalTeaching = 0;
                let totalTraining = 0;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${departmentReportYear}-${String(departmentReportMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(departmentReportYear, departmentReportMonth - 1, day);
                    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                    const dayName = dayNames[dayDate.getDay()];

                    // Check both regular entries and substitutions
                    const entry = subjectEntries.find(e => e.date === dateStr);
                    const substEntry = substitutionEntries.find(e => e.date === dateStr);

                    if (entry || substEntry) {
                        const regularTeaching = entry?.hours?.teaching || 0;
                        const regularTraining = entry?.hours?.training || 0;
                        const substTeaching = substEntry?.hours?.teaching || 0;
                        const substTraining = substEntry?.hours?.training || 0;

                        const totalDayTeaching = regularTeaching + substTeaching;
                        const totalDayTraining = regularTraining + substTraining;

                        totalTeaching += totalDayTeaching;
                        totalTraining += totalDayTraining;

                        const period = entry?.period || substEntry?.period;
                        const isSubst = !entry && substEntry;

                        reportHTML += `<tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${day}.${departmentReportMonth}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${dayName}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${period === 'morning' ? 'ğŸŒ… ×‘×•×§×¨' : 'ğŸŒ† ××—×”"×¦'}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center; font-weight: 600;">${subject}${isSubst ? ' ğŸ”„' : ''}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${totalDayTeaching}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${totalDayTraining}</td>
                        </tr>`;
                    }
                }

                if (subjectEntries.length === 0 && substitutionEntries.length === 0) {
                    reportHTML += `<tr><td colspan="6" style="padding: 24px; text-align: center; color: var(--text-secondary);">××™×Ÿ ×¨×™×©×•××™× ×œ××§×¦×•×¢ ×–×”</td></tr>`;
                }

                reportHTML += `
                                    <tr style="background: rgba(99, 102, 241, 0.1); font-weight: 700;">
                                        <td colspan="4" style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">×¡×”"×›</td>
                                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${totalTeaching}</td>
                                        <td style="padding: 8px; border: 1px solid var(--border-color); text-align: center;">${totalTraining}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: ${isApproved ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px; text-align: center;">
                            <span style="font-weight: 600; color: ${isApproved ? '#22c55e' : '#ef4444'};">
                                ${isApproved ? 'âœ… ××•×©×¨ ×¢×œ ×™×“×™ ×”×¨×›×–/×ª ×•× ×©×œ×— ×œ×× ×”×œ×ª ×›×¡×¤×™×' : 'â³ ×××ª×™×Ÿ ×œ××™×©×•×¨ ×”×¨×›×–/×ª'}
                            </span>
                        </div>
                    </div>
                `;

                modalContent.innerHTML = reportHTML;

                // Close button handler
                const closeBtn = modalContent.querySelector('button');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        }

        window.closeDepartmentReport = function() {
            // No longer needed - using modal popup instead
        };

        // ===== EXCEL EXPORT (Finance Manager) =====

        async function loadExportOptions() {
            try {
                const monthName = getMonthName(exportReportMonth);
                document.getElementById('exportMonthTitle').textContent = `${monthName} ${exportReportYear}`;

                // Load instructors list for selection
                const instructorsList = document.getElementById('exportInstructorsList');
                instructorsList.innerHTML = '';

                const allInstructors = Object.entries(userRoles)
                    .filter(([email, userData]) => {
                        if (userData.role === 'instructor') return true;
                        if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                        return false;
                    })
                    .map(([email, userData]) => ({
                        email: email,
                        name: userData.fullName || email,
                        role: userData.role
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                allInstructors.forEach(instructor => {
                    const checkbox = document.createElement('label');
                    checkbox.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(99, 102, 241, 0.05); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;';
                    checkbox.innerHTML = `
                        <input type="checkbox" class="export-instructor-checkbox" value="${instructor.email}" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--text-primary); font-size: 14px;">${instructor.name}</span>
                    `;
                    checkbox.addEventListener('mouseover', () => {
                        checkbox.style.background = 'rgba(99, 102, 241, 0.15)';
                    });
                    checkbox.addEventListener('mouseout', () => {
                        checkbox.style.background = 'rgba(99, 102, 241, 0.05)';
                    });
                    instructorsList.appendChild(checkbox);
                });

                // Setup search
                const searchInput = document.getElementById('exportInstructorSearch');
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim().toLowerCase();
                    Array.from(instructorsList.children).forEach(label => {
                        const name = label.querySelector('span').textContent.toLowerCase();
                        label.style.display = name.includes(query) ? 'flex' : 'none';
                    });
                });

                // Load departments for dropdown
                const departmentSelect = document.getElementById('exportDepartmentSelect');
                departmentSelect.innerHTML = '<option value="">×‘×—×¨ ××—×œ×§×”...</option>';

                const departments = new Set();
                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator') {
                        if (userData.subjects?.morning) userData.subjects.morning.forEach(s => departments.add(s));
                        if (userData.subjects?.afternoon) userData.subjects.afternoon.forEach(s => departments.add(s));
                    }
                });

                Array.from(departments).sort((a, b) => a.localeCompare(b, 'he')).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });

                // Setup layout selection interactivity
                const layoutRadios = document.querySelectorAll('input[name="exportLayout"]');
                layoutRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        // Update all labels styling
                        layoutRadios.forEach(r => {
                            const label = r.closest('label');
                            if (r.checked) {
                                label.style.borderColor = 'rgba(99, 102, 241, 0.5)';
                                label.style.background = 'rgba(99, 102, 241, 0.1)';
                            } else {
                                label.style.borderColor = 'var(--border-color)';
                                label.style.background = 'transparent';
                            }
                        });
                    });
                });

            } catch (error) {
                console.error('Error loading export options:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×”×™×™×¦×•×');
            }
        }

        // Export by selected instructors
        document.getElementById('exportByInstructorBtn')?.addEventListener('click', async () => {
            try {
                showLoading(true);

                const selectedCheckboxes = document.querySelectorAll('.export-instructor-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showError('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××“×¨×™×š ××—×“');
                    showLoading(false);
                    return;
                }

                const selectedEmails = Array.from(selectedCheckboxes).map(cb => cb.value);

                // Get selected layout type
                const layoutType = document.querySelector('input[name="exportLayout"]:checked')?.value || 'sheets';

                await exportInstructorsToExcel(selectedEmails, exportReportYear, exportReportMonth, null, layoutType);

                showLoading(false);
            } catch (error) {
                console.error('Error exporting:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥');
                showLoading(false);
            }
        });

        // Select all instructors
        document.getElementById('selectAllInstructorsBtn')?.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.export-instructor-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        });

        // Deselect all instructors
        document.getElementById('deselectAllInstructorsBtn')?.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.export-instructor-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        });

        // Export by department
        document.getElementById('exportByDepartmentBtn')?.addEventListener('click', async () => {
            try {
                showLoading(true);

                const departmentSelect = document.getElementById('exportDepartmentSelect');
                const selectedDept = departmentSelect.value;

                if (!selectedDept) {
                    showError('×™×© ×œ×‘×—×•×¨ ××—×œ×§×”');
                    showLoading(false);
                    return;
                }

                // Find all instructors in this department
                const instructorsInDept = [];
                Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                    if (coordData.role === 'coordinator') {
                        const coordSubjects = [];
                        if (coordData.subjects?.morning) coordSubjects.push(...coordData.subjects.morning);
                        if (coordData.subjects?.afternoon) coordSubjects.push(...coordData.subjects.afternoon);

                        if (coordSubjects.includes(selectedDept) && coordData.assignedInstructors) {
                            coordData.assignedInstructors.forEach(assignment => {
                                const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                                const instructorData = userRoles[instructorEmail];

                                if (instructorData && (instructorData.role === 'instructor' || (instructorData.role === 'coordinator' && instructorData.employmentType === 'hourly'))) {
                                    let instructorSubjects = [];
                                    if (typeof assignment === 'object' && assignment.subjects) {
                                        instructorSubjects = assignment.subjects;
                                    } else {
                                        instructorSubjects = getAllUserSubjects(instructorData);
                                    }

                                    if (instructorSubjects.includes(selectedDept) && !instructorsInDept.includes(instructorEmail)) {
                                        instructorsInDept.push(instructorEmail);
                                    }
                                }
                            });
                        }
                    }
                });

                // Add substitution instructors for this department
                const sanitizedFinanceEmail = sanitizeEmail(currentUser.email);
                const substRef = ref(database, `substitutionFinanceSubmissions/${sanitizedFinanceEmail}/${exportReportYear}/${exportReportMonth}`);
                const substSnapshot = await get(substRef);

                if (substSnapshot.exists()) {
                    const allSubstitutions = substSnapshot.val();

                    Object.entries(allSubstitutions).forEach(([key, submission]) => {
                        if (submission.substitutions) {
                            submission.substitutions.forEach(subst => {
                                if (subst.department === selectedDept) {
                                    const instructorEmail = submission.instructorEmail;
                                    if (!instructorsInDept.includes(instructorEmail)) {
                                        instructorsInDept.push(instructorEmail);
                                    }
                                }
                            });
                        }
                    });
                }

                if (instructorsInDept.length === 0) {
                    showError('××™×Ÿ ××“×¨×™×›×™× ×‘××—×œ×§×” ×–×•');
                    showLoading(false);
                    return;
                }

                // Get selected layout type
                const layoutType = document.querySelector('input[name="exportLayout"]:checked')?.value || 'sheets';

                await exportInstructorsToExcel(instructorsInDept, exportReportYear, exportReportMonth, selectedDept, layoutType);

                showLoading(false);
            } catch (error) {
                console.error('Error exporting:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥');
                showLoading(false);
            }
        });

        // Export by salary status
        document.getElementById('exportBySalaryStatusBtn')?.addEventListener('click', async () => {
            try {
                showLoading(true);

                const salaryStatusSelect = document.getElementById('exportSalaryStatusSelect');
                const selectedStatus = salaryStatusSelect.value;

                if (!selectedStatus) {
                    showError('×™×© ×œ×‘×—×•×¨ ×¡×˜×˜×•×¡ ×“×™×•×•×— ×©×›×¨');
                    showLoading(false);
                    return;
                }

                const wantReported = selectedStatus === 'reported';

                // Find all instructors with matching salary status (including hourly coordinators)
                const instructorsWithStatus = [];
                const allInstructorEmails = Object.entries(userRoles)
                    .filter(([email, userData]) => {
                        if (userData.role === 'instructor') return true;
                        if (userData.role === 'coordinator' && userData.employmentType === 'hourly') return true;
                        return false;
                    })
                    .map(([email]) => email);

                for (const instructorEmail of allInstructorEmails) {
                    const sanitizedEmail = sanitizeEmail(instructorEmail);
                    const salaryStatusRef = ref(database, `timesheets/${sanitizedEmail}/${exportReportYear}/${exportReportMonth}/salaryReported`);
                    const salarySnapshot = await get(salaryStatusRef);
                    const isSalaryReported = salarySnapshot.exists() ? salarySnapshot.val() : false;

                    if (wantReported && isSalaryReported) {
                        instructorsWithStatus.push(instructorEmail);
                    } else if (!wantReported && !isSalaryReported) {
                        instructorsWithStatus.push(instructorEmail);
                    }
                }

                if (instructorsWithStatus.length === 0) {
                    const statusText = wantReported ? '×“×•×•×— ×©×›×¨' : '×œ× ×“×•×•×— ×©×›×¨';
                    showError(`××™×Ÿ ××“×¨×™×›×™× ×¢× ×¡×˜×˜×•×¡: ${statusText}`);
                    showLoading(false);
                    return;
                }

                // Get selected layout type
                const layoutType = document.querySelector('input[name="exportLayout"]:checked')?.value || 'sheets';

                const statusLabel = wantReported ? '×“×•×•×—_×©×›×¨' : '×œ×_×“×•×•×—_×©×›×¨';
                await exportInstructorsToExcel(instructorsWithStatus, exportReportYear, exportReportMonth, statusLabel, layoutType);

                showLoading(false);
            } catch (error) {
                console.error('Error exporting:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥');
                showLoading(false);
            }
        });

        async function exportInstructorsToExcel(instructorEmails, year, month, departmentName = null, layoutType = 'sheets', coordDepartmentsFilter = null) {
            if (layoutType === 'single') {
                return await exportInstructorsToSingleSheet(instructorEmails, year, month, departmentName, coordDepartmentsFilter);
            }
            return await exportInstructorsToMultipleSheets(instructorEmails, year, month, departmentName, coordDepartmentsFilter);
        }

        async function exportInstructorsToMultipleSheets(instructorEmails, year, month, departmentName = null, coordDepartmentsFilter = null) {
            const workbook = XLSX.utils.book_new();
            workbook.Workbook = workbook.Workbook || {};
            workbook.Workbook.Views = [{ RTL: true }];

            for (const instructorEmail of instructorEmails) {
                const instructorData = userRoles[instructorEmail];
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Load substitutions from timesheet entries (stored as {date}_substitution_{index})
                const substitutionsByDate = {}; // Map date to array of substitutions with department info

                Object.entries(timesheetData).forEach(([key, entry]) => {
                    if (key.includes('_substitution_')) {
                        const date = key.split('_substitution_')[0];

                        // If filtering by department, only include substitutions for that department
                        if (departmentName && entry.department !== departmentName) return;

                        // If coordinator filter exists, only include their departments
                        if (coordDepartmentsFilter && !coordDepartmentsFilter.includes(entry.department)) return;

                        if (!substitutionsByDate[date]) {
                            substitutionsByDate[date] = [];
                        }
                        substitutionsByDate[date].push({
                            department: entry.department || '×œ× ×¦×•×™×Ÿ',
                            period: entry.period || 'morning',
                            teaching: entry.hours?.teaching || 0,
                            training: entry.hours?.training || 0
                        });
                    }
                });

                // Collect all subjects for this instructor
                const allSubjects = { morning: [], afternoon: [] };

                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        // If coordinator filter exists, only load subjects from coordinators with those departments
                        if (coordDepartmentsFilter) {
                            const coordDepts = getAllUserSubjects(userData);
                            const hasOverlap = coordDepts.some(dept => coordDepartmentsFilter.includes(dept));
                            if (!hasOverlap) return; // Skip coordinators without relevant departments
                        }

                        const assignment = userData.assignedInstructors.find(assign => {
                            const assignmentEmail = typeof assign === 'string' ? assign : assign.email;
                            return assignmentEmail === instructorEmail;
                        });

                        if (assignment) {
                            let assignedSubjects = [];
                            if (typeof assignment === 'object' && assignment.subjects) {
                                assignedSubjects = assignment.subjects;
                            } else {
                                assignedSubjects = getAllUserSubjects(userData);
                            }

                            assignedSubjects.forEach(subject => {
                                // If filtering by department, only include that department
                                if (departmentName && subject !== departmentName) return;

                                // If coordinator filter exists, only include filtered departments
                                if (coordDepartmentsFilter && !coordDepartmentsFilter.includes(subject)) return;

                                let period = null;
                                if (userData.subjects?.morning?.includes(subject)) {
                                    period = 'morning';
                                } else if (userData.subjects?.afternoon?.includes(subject)) {
                                    period = 'afternoon';
                                }

                                if (period && !allSubjects[period].includes(subject)) {
                                    allSubjects[period].push(subject);
                                }
                            });
                        }
                    }
                });

                // Build table data
                const daysInMonth = new Date(year, month, 0).getDate();
                const tableData = [];

                // Title row - merged cells
                const instructorName = instructorData?.fullName || instructorEmail;

                // Check if instructor only has substitutions (no regular subjects)
                const hasOnlySubstitutions = allSubjects.morning.length === 0 && allSubjects.afternoon.length === 0 && Object.keys(substitutionsByDate).length > 0;

                if (hasOnlySubstitutions) {
                    tableData.push([`×“×™×•×•×— ×©×¢×•×ª ××—×œ×™×£/×”: ${instructorName}`]);

                    // Simple table for substitution-only instructors: Date, Day, Subject, Teaching, Training, Notes
                    const headerRow = ['×ª××¨×™×š', '×™×•×', '× ×•×©×', '×”×“×¨×›×”', '×”×©×ª×œ××•×ª', '×”×¢×¨×•×ª'];
                    const columnTypes = ['date', 'day', 'subject', 'teaching', 'training', 'notes'];
                    tableData.push(headerRow);

                    let monthlyTeaching = 0;
                    let monthlyTraining = 0;

                    // Create rows for each substitution
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayDate = new Date(year, month - 1, day);
                        const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                        const dayName = dayNames[dayDate.getDay()];

                        const substData = substitutionsByDate[dateStr];
                        if (substData && substData.length > 0) {
                            substData.forEach((subst, index) => {
                                // Get notes for this specific substitution entry
                                const notesKey = `${dateStr}_substitution_${index}_notes`;
                                const notesEntry = timesheetData[notesKey];
                                const notesValue = notesEntry?.notes || '';

                                const row = [
                                    `${day}.${month}`,
                                    dayName,
                                    subst.department,
                                    subst.teaching,
                                    subst.training,
                                    notesValue
                                ];
                                tableData.push(row);
                                monthlyTeaching += subst.teaching;
                                monthlyTraining += subst.training;
                            });
                        }
                    }

                    // Total row
                    tableData.push(['×¡×”"×›', '', '', monthlyTeaching, monthlyTraining, '']);

                    // Create worksheet for simple table
                    const worksheet = XLSX.utils.aoa_to_sheet(tableData);

                    // Set RTL
                    if (!worksheet['!views']) worksheet['!views'] = [];
                    worksheet['!views'][0] = { rtl: true };

                    // Merge title row (6 columns for simple table with notes)
                    const titleMerge = { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } };
                    if (!worksheet['!merges']) worksheet['!merges'] = [];
                    worksheet['!merges'].push(titleMerge);

                    // Style title
                    const titleCell = 'A1';
                    if (worksheet[titleCell]) {
                        worksheet[titleCell].s = {
                            font: { bold: true, sz: 24, color: { rgb: "FFFFFF" }, name: "Arial" },
                            fill: { fgColor: { rgb: "203764" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }

                    // Style header (6 columns)
                    for (let col = 0; col < 6; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 1, c: col });
                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                font: { bold: true, sz: 12, color: { rgb: "FFFFFF" }, name: "Arial" },
                                fill: { fgColor: { rgb: "5B9BD5" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: {
                                    top: { style: "thin", color: { rgb: "000000" } },
                                    bottom: { style: "thin", color: { rgb: "000000" } },
                                    left: { style: "thin", color: { rgb: "000000" } },
                                    right: { style: "thin", color: { rgb: "000000" } }
                                }
                            };
                        }
                    }

                    // Add to workbook
                    const sheetName = (instructorName.substring(0, 28) + (instructorName.length > 28 ? '...' : '')).replace(/[:\\\/\?\*\[\]]/g, '_');
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    continue; // Skip to next instructor
                } else {
                    tableData.push([`×“×™×•×•×— ×©×¢×•×ª: ${instructorName}`]);
                }

                // Regular table for instructors with subjects
                // Header row
                const headerRow = ['×ª××¨×™×š', '×™×•×'];
                const subjectTotals = {}; // Track totals per subject
                const columnTypes = ['date', 'day']; // Track column types for styling

                if (allSubjects.morning.length > 0) {
                    headerRow.push('×‘×•×§×¨');
                    columnTypes.push('shift-morning');
                    allSubjects.morning.forEach(subject => {
                        headerRow.push(`${subject} - ×”×“×¨×›×”`);
                        headerRow.push(`${subject} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`morning_${subject}`] = { teaching: 0, training: 0 };
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    headerRow.push('××—×”"×¦');
                    columnTypes.push('shift-afternoon');
                    allSubjects.afternoon.forEach(subject => {
                        headerRow.push(`${subject} - ×”×“×¨×›×”`);
                        headerRow.push(`${subject} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`afternoon_${subject}`] = { teaching: 0, training: 0 };
                    });
                }

                // Add single substitution column
                headerRow.push('×”×—×œ×¤×•×ª');
                columnTypes.push('substitutions');
                subjectTotals['substitutions'] = { teaching: 0, training: 0 };

                headerRow.push('×”×¢×¨×•×ª');
                columnTypes.push('notes');
                headerRow.push('×¡×”"×› ×”×“×¨×›×”', '×¡×”"×› ×”×©×ª×œ××•×ª');
                columnTypes.push('total-teaching', 'total-training');
                tableData.push(headerRow);

                // Data rows
                const monthlyTotals = { teaching: 0, training: 0 };

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(year, month - 1, day);
                    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                    const dayName = dayNames[dayDate.getDay()];

                    const row = [`${day}.${month}`, dayName];
                    let dailyTeachingTotal = 0;
                    let dailyTrainingTotal = 0;

                    // Morning subjects
                    if (allSubjects.morning.length > 0) {
                        // Only add "×‘×•×§×¨" text in first row, empty for others (will be merged)
                        row.push(day === 1 ? '×‘×•×§×¨' : '');
                        allSubjects.morning.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'morning'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`morning_${subject}`].teaching += teaching;
                            subjectTotals[`morning_${subject}`].training += training;
                        });
                    }

                    // Afternoon subjects
                    if (allSubjects.afternoon.length > 0) {
                        // Only add "××—×”\"×¦" text in first row, empty for others (will be merged)
                        row.push(day === 1 ? '××—×”"×¦' : '');
                        allSubjects.afternoon.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'afternoon'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`afternoon_${subject}`].teaching += teaching;
                            subjectTotals[`afternoon_${subject}`].training += training;
                        });
                    }

                    // Substitutions - single column with department name and hours
                    const substData = substitutionsByDate[dateStr] || [];
                    let substText = '';
                    let totalSubstTeaching = 0;
                    let totalSubstTraining = 0;

                    if (substData.length > 0) {
                        substText = substData.map(subst => {
                            totalSubstTeaching += subst.teaching;
                            totalSubstTraining += subst.training;
                            return `${subst.department} ${subst.teaching}|${subst.training}`;
                        }).join('\n');

                        dailyTeachingTotal += totalSubstTeaching;
                        dailyTrainingTotal += totalSubstTraining;
                        subjectTotals['substitutions'].teaching += totalSubstTeaching;
                        subjectTotals['substitutions'].training += totalSubstTraining;
                    }

                    row.push(substText || '-');

                    // Get notes for this date
                    const notesKey = `${dateStr}_notes`;
                    const notesEntry = timesheetData[notesKey];
                    const notesValue = notesEntry?.notes || '';

                    row.push(notesValue);
                    row.push(dailyTeachingTotal, dailyTrainingTotal);
                    monthlyTotals.teaching += dailyTeachingTotal;
                    monthlyTotals.training += dailyTrainingTotal;

                    tableData.push(row);
                }

                // Total row
                const totalRow = ['×¡×”"×›', ''];

                if (allSubjects.morning.length > 0) {
                    totalRow.push('');
                    allSubjects.morning.forEach(subject => {
                        totalRow.push(subjectTotals[`morning_${subject}`].teaching);
                        totalRow.push(subjectTotals[`morning_${subject}`].training);
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    totalRow.push('');
                    allSubjects.afternoon.forEach(subject => {
                        totalRow.push(subjectTotals[`afternoon_${subject}`].teaching);
                        totalRow.push(subjectTotals[`afternoon_${subject}`].training);
                    });
                }

                // Substitution totals - single column
                const substTotals = subjectTotals['substitutions'] || { teaching: 0, training: 0 };
                totalRow.push(`${substTotals.teaching}|${substTotals.training}`);

                totalRow.push('â€”'); // Notes column empty in total row
                totalRow.push(monthlyTotals.teaching, monthlyTotals.training);
                tableData.push(totalRow);

                // Create worksheet
                const worksheet = XLSX.utils.aoa_to_sheet(tableData);

                // Set RTL for the worksheet
                if (!worksheet['!views']) worksheet['!views'] = [];
                worksheet['!views'][0] = { rtl: true };

                // Merge title row cells
                const titleMerge = { s: { r: 0, c: 0 }, e: { r: 0, c: headerRow.length - 1 } };
                if (!worksheet['!merges']) worksheet['!merges'] = [];
                worksheet['!merges'].push(titleMerge);

                // Merge shift column cells (×‘×•×§×¨ and ××—×”"×¦) vertically for all data rows
                let currentCol = 2; // Start after ×ª××¨×™×š and ×™×•×
                const lastDataRowIndex = tableData.length - 2; // Last data row before total

                // Merge morning shift column vertically (from row 2 to row before total)
                if (allSubjects.morning.length > 0) {
                    const morningShiftCol = currentCol;
                    worksheet['!merges'].push({
                        s: { r: 2, c: morningShiftCol },
                        e: { r: lastDataRowIndex, c: morningShiftCol }
                    });
                    currentCol += 1 + (allSubjects.morning.length * 2); // shift column + all subject columns
                }

                // Merge afternoon shift column vertically (from row 2 to row before total)
                if (allSubjects.afternoon.length > 0) {
                    const afternoonShiftCol = currentCol;
                    worksheet['!merges'].push({
                        s: { r: 2, c: afternoonShiftCol },
                        e: { r: lastDataRowIndex, c: afternoonShiftCol }
                    });
                }

                // Style the title cell
                const titleCell = 'A1';
                if (worksheet[titleCell]) {
                    worksheet[titleCell].s = {
                        font: { bold: true, sz: 24, color: { rgb: "FFFFFF" }, name: "Arial" },
                        fill: { fgColor: { rgb: "203764" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style header row with colors based on column type
                for (let col = 0; col < headerRow.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 1, c: col });
                    const colType = columnTypes[col];
                    let headerBgColor = "5B9BD5"; // Default blue
                    let leftBorderStyle = "thin";
                    let rightBorderStyle = "thin";
                    let topBorderStyle = "thin";
                    let bottomBorderStyle = "thin";

                    if (colType === 'teaching') {
                        headerBgColor = "ED7D31"; // Orange for teaching
                    } else if (colType === 'training') {
                        headerBgColor = "4BACC6"; // Turquoise for training
                    } else if (colType === 'total-teaching') {
                        headerBgColor = "C65911"; // Dark orange for total teaching
                        leftBorderStyle = "medium"; // Bold left border for separation
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    } else if (colType === 'total-training') {
                        headerBgColor = "1F7A8C"; // Dark turquoise for total training
                        rightBorderStyle = "medium"; // Bold right border to close the summary section
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    } else if (colType === 'shift-morning') {
                        headerBgColor = "2E5090"; // Dark blue for morning shift
                    } else if (colType === 'shift-afternoon') {
                        headerBgColor = "70AD47"; // Green for afternoon shift
                    }

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11, name: "Arial" },
                            fill: { fgColor: { rgb: headerBgColor } },
                            alignment: { horizontal: "center", vertical: "center", wrapText: true },
                            border: {
                                top: { style: topBorderStyle, color: { rgb: "000000" } },
                                bottom: { style: bottomBorderStyle, color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style total row
                const totalRowIndex = tableData.length - 1;
                for (let col = 0; col < headerRow.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: totalRowIndex, c: col });
                    const colType = columnTypes[col];
                    let totalBgColor = "70AD47"; // Default green
                    let fontColor = "000000";
                    let leftBorderStyle = "thin";
                    let rightBorderStyle = "thin";

                    if (colType === 'teaching' || colType === 'total-teaching') {
                        totalBgColor = "F4B183"; // Light orange
                        if (colType === 'total-teaching') {
                            leftBorderStyle = "medium"; // Bold left border for separation
                        }
                    } else if (colType === 'training' || colType === 'total-training') {
                        totalBgColor = "9DC3E6"; // Light turquoise
                        if (colType === 'total-training') {
                            rightBorderStyle = "medium"; // Bold right border to close the summary section
                        }
                    } else if (colType === 'shift-morning') {
                        totalBgColor = "2E5090"; // Dark blue for morning shift
                        fontColor = "FFFFFF"; // White text
                    } else if (colType === 'shift-afternoon') {
                        totalBgColor = "70AD47"; // Green for afternoon shift
                        fontColor = "FFFFFF"; // White text
                    }

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 11, name: "Arial", color: { rgb: fontColor } },
                            fill: { fgColor: { rgb: totalBgColor } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "medium", color: { rgb: "000000" } },
                                bottom: { style: "medium", color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style data cells with colors based on column type
                for (let row = 2; row < totalRowIndex; row++) {
                    for (let col = 0; col < headerRow.length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        const colType = columnTypes[col];
                        let bgColor = "FFFFFF";
                        let alignment = "center";
                        let fontColor = "000000";
                        let fontBold = false;
                        let leftBorderStyle = "thin";
                        let rightBorderStyle = "thin";
                        let leftBorderColor = "D0D0D0";
                        let rightBorderColor = "D0D0D0";

                        // Set background color based on column type
                        if (colType === 'teaching' || colType === 'total-teaching') {
                            bgColor = "FCE4D6"; // Very light orange
                            if (colType === 'total-teaching') {
                                leftBorderStyle = "medium"; // Bold left border for separation
                                leftBorderColor = "000000"; // Black border for emphasis
                            }
                        } else if (colType === 'training' || colType === 'total-training') {
                            bgColor = "DDEBF7"; // Very light turquoise
                            if (colType === 'total-training') {
                                rightBorderStyle = "medium"; // Bold right border to close the summary section
                                rightBorderColor = "000000"; // Black border for emphasis
                            }
                        } else if (colType === 'shift-morning') {
                            bgColor = "2E5090"; // Dark blue for morning shift columns
                            fontColor = "FFFFFF"; // White text
                            fontBold = true;
                        } else if (colType === 'shift-afternoon') {
                            bgColor = "70AD47"; // Green for afternoon shift columns
                            fontColor = "FFFFFF"; // White text
                            fontBold = true;
                        }

                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                fill: { fgColor: { rgb: bgColor } },
                                alignment: { horizontal: alignment, vertical: "center" },
                                border: {
                                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                    left: { style: leftBorderStyle, color: { rgb: leftBorderColor } },
                                    right: { style: rightBorderStyle, color: { rgb: rightBorderColor } }
                                },
                                font: { name: "Arial", sz: 10, color: { rgb: fontColor }, bold: fontBold }
                            };
                        }
                    }
                }

                // Set column widths
                const colWidths = headerRow.map(() => ({ wch: 11 }));
                worksheet['!cols'] = colWidths;

                // Add worksheet with instructor name
                const sheetName = (instructorData?.fullName || instructorEmail).substring(0, 31);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
            }

            // Generate filename
            const monthName = getMonthName(month);
            let filename = departmentName
                ? `×“×•×—_${departmentName}_${monthName}_${year}.xlsx`
                : `×“×•×—_××“×¨×™×›×™×_${monthName}_${year}.xlsx`;

            // Write and download
            XLSX.writeFile(workbook, filename);

            showSuccess(`×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”! ${instructorEmails.length} ××“×¨×™×›×™×`);
        }

        async function exportInstructorsToSingleSheet(instructorEmails, year, month, departmentName = null, coordDepartmentsFilter = null) {
            const workbook = XLSX.utils.book_new();
            workbook.Workbook = workbook.Workbook || {};
            workbook.Workbook.Views = [{ RTL: true }];

            const INSTRUCTORS_PER_ROW = 2;
            const SEPARATOR_COL_INDEX = 12; // Column M (0-based index 12)
            const instructorTables = []; // Store all instructor tables with metadata

            // First, collect all instructor tables
            for (let i = 0; i < instructorEmails.length; i++) {
                const instructorEmail = instructorEmails[i];
                const instructorData = userRoles[instructorEmail];
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Load substitutions from timesheet entries (stored as {date}_substitution_{index})
                const substitutionsByDate = {}; // Map date to array of substitutions with department info

                Object.entries(timesheetData).forEach(([key, entry]) => {
                    if (key.includes('_substitution_')) {
                        const date = key.split('_substitution_')[0];

                        // If filtering by department, only include substitutions for that department
                        if (departmentName && entry.department !== departmentName) return;

                        // If coordinator filter exists, only include their departments
                        if (coordDepartmentsFilter && !coordDepartmentsFilter.includes(entry.department)) return;

                        if (!substitutionsByDate[date]) {
                            substitutionsByDate[date] = [];
                        }
                        substitutionsByDate[date].push({
                            department: entry.department || '×œ× ×¦×•×™×Ÿ',
                            period: entry.period || 'morning',
                            teaching: entry.hours?.teaching || 0,
                            training: entry.hours?.training || 0
                        });
                    }
                });

                // Collect subjects
                const allSubjects = { morning: [], afternoon: [] };
                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        // If coordinator filter exists, only load subjects from coordinators with those departments
                        if (coordDepartmentsFilter) {
                            const coordDepts = getAllUserSubjects(userData);
                            const hasOverlap = coordDepts.some(dept => coordDepartmentsFilter.includes(dept));
                            if (!hasOverlap) return; // Skip coordinators without relevant departments
                        }

                        const assignment = userData.assignedInstructors.find(assign => {
                            const assignmentEmail = typeof assign === 'string' ? assign : assign.email;
                            return assignmentEmail === instructorEmail;
                        });

                        if (assignment) {
                            let assignedSubjects = [];
                            if (typeof assignment === 'object' && assignment.subjects) {
                                assignedSubjects = assignment.subjects;
                            } else {
                                assignedSubjects = getAllUserSubjects(userData);
                            }

                            assignedSubjects.forEach(subject => {
                                if (departmentName && subject !== departmentName) return;

                                // If coordinator filter exists, only include filtered departments
                                if (coordDepartmentsFilter && !coordDepartmentsFilter.includes(subject)) return;

                                let period = null;
                                if (userData.subjects?.morning?.includes(subject)) period = 'morning';
                                else if (userData.subjects?.afternoon?.includes(subject)) period = 'afternoon';
                                if (period && !allSubjects[period].includes(subject)) {
                                    allSubjects[period].push(subject);
                                }
                            });
                        }
                    }
                });

                // Build table for this instructor
                const instructorTable = [];
                const daysInMonth = new Date(year, month, 0).getDate();

                // Check if instructor only has substitutions (no regular subjects)
                const hasOnlySubstitutions = allSubjects.morning.length === 0 && allSubjects.afternoon.length === 0 && Object.keys(substitutionsByDate).length > 0;

                // Title
                const instructorName = instructorData?.fullName || instructorEmail;
                const titleText = hasOnlySubstitutions ? `×“×™×•×•×— ×©×¢×•×ª ××—×œ×™×£/×”: ${instructorName}` : `×“×™×•×•×— ×©×¢×•×ª: ${instructorName}`;
                instructorTable.push([titleText]);

                if (hasOnlySubstitutions) {
                    // Simple table for substitution-only instructors: Date, Day, Subject, Teaching, Training, Notes
                    const headerRow = ['×ª××¨×™×š', '×™×•×', '× ×•×©×', '×”×“×¨×›×”', '×”×©×ª×œ××•×ª', '×”×¢×¨×•×ª'];
                    instructorTable.push(headerRow);

                    let monthlyTeaching = 0;
                    let monthlyTraining = 0;

                    // Create rows for each substitution
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayDate = new Date(year, month - 1, day);
                        const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                        const dayName = dayNames[dayDate.getDay()];

                        const substData = substitutionsByDate[dateStr];
                        if (substData && substData.length > 0) {
                            substData.forEach((subst, index) => {
                                // Get notes for this specific substitution entry
                                const notesKey = `${dateStr}_substitution_${index}_notes`;
                                const notesEntry = timesheetData[notesKey];
                                const notesValue = notesEntry?.notes || '';

                                const row = [
                                    `${day}.${month}`,
                                    dayName,
                                    subst.department,
                                    subst.teaching,
                                    subst.training,
                                    notesValue
                                ];
                                instructorTable.push(row);
                                monthlyTeaching += subst.teaching;
                                monthlyTraining += subst.training;
                            });
                        }
                    }

                    // Total row
                    instructorTable.push(['×¡×”"×›', '', '', monthlyTeaching, monthlyTraining, '']);

                    // Store this simple table
                    instructorTables.push({
                        name: instructorName,
                        data: instructorTable,
                        numCols: 6,
                        isSubstitutionOnly: true
                    });

                    continue; // Skip to next instructor
                }

                const subjectTotals = {};
                const columnTypes = ['date', 'day'];

                // Header
                const headerRow = ['×ª××¨×™×š', '×™×•×'];
                if (allSubjects.morning.length > 0) {
                    headerRow.push('×‘×•×§×¨');
                    columnTypes.push('shift-morning');
                    allSubjects.morning.forEach(s => {
                        headerRow.push(`${s} - ×”×“×¨×›×”`, `${s} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`morning_${s}`] = { teaching: 0, training: 0 };
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    headerRow.push('××—×”"×¦');
                    columnTypes.push('shift-afternoon');
                    allSubjects.afternoon.forEach(s => {
                        headerRow.push(`${s} - ×”×“×¨×›×”`, `${s} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`afternoon_${s}`] = { teaching: 0, training: 0 };
                    });
                }

                // Add single substitution column
                headerRow.push('×”×—×œ×¤×•×ª');
                columnTypes.push('substitutions');
                subjectTotals['substitutions'] = { teaching: 0, training: 0 };

                headerRow.push('×”×¢×¨×•×ª');
                columnTypes.push('notes');
                headerRow.push('×¡×”"×› ×”×“×¨×›×”', '×¡×”"×› ×”×©×ª×œ××•×ª');
                columnTypes.push('total-teaching', 'total-training');
                instructorTable.push(headerRow);

                // Data rows
                const monthlyTotals = { teaching: 0, training: 0 };
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(year, month - 1, day);
                    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                    const dayName = dayNames[dayDate.getDay()];

                    const row = [`${day}.${month}`, dayName];
                    let dailyTeachingTotal = 0;
                    let dailyTrainingTotal = 0;

                    if (allSubjects.morning.length > 0) {
                        row.push(day === 1 ? '×‘×•×§×¨' : '');
                        allSubjects.morning.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'morning'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`morning_${subject}`].teaching += teaching;
                            subjectTotals[`morning_${subject}`].training += training;
                        });
                    }

                    if (allSubjects.afternoon.length > 0) {
                        row.push(day === 1 ? '××—×”"×¦' : '');
                        allSubjects.afternoon.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'afternoon'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`afternoon_${subject}`].teaching += teaching;
                            subjectTotals[`afternoon_${subject}`].training += training;
                        });
                    }

                    // Substitutions - single column with department name and hours
                    const substData = substitutionsByDate[dateStr] || [];
                    let substText = '';
                    let totalSubstTeaching = 0;
                    let totalSubstTraining = 0;

                    if (substData.length > 0) {
                        substText = substData.map(subst => {
                            totalSubstTeaching += subst.teaching;
                            totalSubstTraining += subst.training;
                            return `${subst.department} ${subst.teaching}|${subst.training}`;
                        }).join('\n');

                        dailyTeachingTotal += totalSubstTeaching;
                        dailyTrainingTotal += totalSubstTraining;
                        subjectTotals['substitutions'].teaching += totalSubstTeaching;
                        subjectTotals['substitutions'].training += totalSubstTraining;
                    }

                    row.push(substText || '-');

                    // Get notes for this date
                    const notesKey = `${dateStr}_notes`;
                    const notesEntry = timesheetData[notesKey];
                    const notesValue = notesEntry?.notes || '';

                    row.push(notesValue);
                    row.push(dailyTeachingTotal, dailyTrainingTotal);
                    monthlyTotals.teaching += dailyTeachingTotal;
                    monthlyTotals.training += dailyTrainingTotal;
                    instructorTable.push(row);
                }

                // Total row
                const totalRow = ['×¡×”"×›', ''];
                if (allSubjects.morning.length > 0) {
                    totalRow.push('');
                    allSubjects.morning.forEach(subject => {
                        totalRow.push(subjectTotals[`morning_${subject}`].teaching);
                        totalRow.push(subjectTotals[`morning_${subject}`].training);
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    totalRow.push('');
                    allSubjects.afternoon.forEach(subject => {
                        totalRow.push(subjectTotals[`afternoon_${subject}`].teaching);
                        totalRow.push(subjectTotals[`afternoon_${subject}`].training);
                    });
                }

                // Substitution totals - single column
                const substTotals = subjectTotals['substitutions'] || { teaching: 0, training: 0 };
                totalRow.push(`${substTotals.teaching}|${substTotals.training}`);

                totalRow.push('â€”'); // Notes column empty in total row
                totalRow.push(monthlyTotals.teaching, monthlyTotals.training);
                instructorTable.push(totalRow);

                // Store table info with all metadata
                instructorTables.push({
                    table: instructorTable,
                    headerRow: headerRow,
                    columnTypes: columnTypes,
                    name: instructorName,
                    daysInMonth: daysInMonth
                });
            }

            // Now build the worksheet with horizontal layout (2 tables per row)
            const allData = [];
            let currentRow = 0;
            const pairLayouts = []; // Store layout info for each pair

            for (let i = 0; i < instructorTables.length; i += INSTRUCTORS_PER_ROW) {
                // Get tables for this row (max 2)
                const table1 = instructorTables[i];
                const table2 = i + 1 < instructorTables.length ? instructorTables[i + 1] : null;

                // Calculate separator position for this pair (after table1 width)
                const table1Width = table1.numCols || table1.headerRow.length;
                const separatorCol = table1Width;
                const table2StartCol = separatorCol + 1;

                // Add black separator row before each pair (except first)
                if (i > 0) {
                    const separatorRow = [];
                    const table2Width = table2 ? (table2.numCols || table2.headerRow.length) : 0;
                    const rowWidth = table1Width + 1 + table2Width;
                    // Fill entire row with empty cells (will be styled black)
                    for (let col = 0; col < rowWidth; col++) {
                        separatorRow.push('');
                    }
                    allData.push(separatorRow);
                    currentRow++;
                }

                // Store layout info AFTER potentially adding separator row
                pairLayouts.push({
                    table1,
                    table2,
                    separatorCol,
                    table2StartCol,
                    startRow: currentRow
                });

                const table1Data = table1.data || table1.table;
                const table2Data = table2 ? (table2.data || table2.table) : null;
                const maxRows = Math.max(table1Data.length, table2Data ? table2Data.length : 0);

                // Add each row of the tables side by side
                for (let rowIdx = 0; rowIdx < maxRows; rowIdx++) {
                    const combinedRow = [];

                    // Add table1 data
                    if (rowIdx < table1Data.length) {
                        combinedRow.push(...table1Data[rowIdx]);
                        // Pad to table1 width if needed
                        while (combinedRow.length < table1Width) {
                            combinedRow.push('');
                        }
                    } else {
                        // Empty cells for entire table1 width
                        for (let j = 0; j < table1Width; j++) {
                            combinedRow.push('');
                        }
                    }

                    // Add separator column ONLY if there's a table2
                    if (table2) {
                        combinedRow.push('');
                    }

                    // Add table2 data
                    if (table2) {
                        if (rowIdx < table2Data.length) {
                            combinedRow.push(...table2Data[rowIdx]);
                        } else {
                            // Empty cells if table2 is shorter
                            const table2Width = table2.numCols || table2.headerRow.length;
                            for (let j = 0; j < table2Width; j++) {
                                combinedRow.push('');
                            }
                        }
                    }

                    allData.push(combinedRow);
                }

                currentRow += maxRows;
            }

            // Create worksheet
            const worksheet = XLSX.utils.aoa_to_sheet(allData);

            // Debug: log first few rows
            console.log('=== DEBUG: First few rows of allData ===');
            for (let i = 0; i < Math.min(5, allData.length); i++) {
                console.log(`Row ${i}:`, allData[i].length, 'columns');
                console.log(`  First cell:`, allData[i][0]);
                console.log(`  Cell at index 12 (M):`, allData[i][12]);
                console.log(`  Cell at index 13 (N):`, allData[i][13]);
            }

            // Set RTL
            if (!worksheet['!views']) worksheet['!views'] = [];
            worksheet['!views'][0] = { rtl: true };

            // Apply merges and styles
            if (!worksheet['!merges']) worksheet['!merges'] = [];

            // Helper function to style a single instructor table
            const styleInstructorTable = (worksheet, tableInfo, startRow, startCol) => {
                // Handle both simple substitution tables and regular tables
                const isSimpleTable = tableInfo.isSubstitutionOnly;
                const tableData = tableInfo.data || tableInfo.table;
                const numCols = tableInfo.numCols || tableInfo.headerRow.length;
                const headerRow = isSimpleTable ? tableData[1] : tableInfo.headerRow; // For simple tables, header is row 1
                const columnTypes = tableInfo.columnTypes || [];

                // Title merge
                const titleMerge = {
                    s: { r: startRow, c: startCol },
                    e: { r: startRow, c: startCol + numCols - 1 }
                };
                worksheet['!merges'].push(titleMerge);

                // Style title
                const titleCell = XLSX.utils.encode_cell({ r: startRow, c: startCol });
                if (worksheet[titleCell]) {
                    worksheet[titleCell].s = {
                        font: { bold: true, sz: 24, color: { rgb: "FFFFFF" }, name: "Arial" },
                        fill: { fgColor: { rgb: "203764" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                const headerRowIdx = startRow + 1;
                const lastDataRowIdx = startRow + tableData.length - 2;
                const totalRowIdx = startRow + tableData.length - 1;

                // Merge shift columns
                let currentCol = startCol + 2; // Date and Day columns
                let morningCount = 0, afternoonCount = 0;

                columnTypes.forEach((type, idx) => {
                    if (type === 'shift-morning') morningCount = 1;
                    if (type === 'shift-afternoon') afternoonCount = 1;
                });

                if (morningCount > 0) {
                    worksheet['!merges'].push({
                        s: { r: headerRowIdx + 1, c: currentCol },
                        e: { r: lastDataRowIdx, c: currentCol }
                    });
                    let subjectCount = columnTypes.filter((t, i) => i > 2 && i < columnTypes.indexOf('shift-afternoon') && columnTypes[i] !== 'shift-morning').length;
                    currentCol += 1 + subjectCount;
                }

                if (afternoonCount > 0) {
                    worksheet['!merges'].push({
                        s: { r: headerRowIdx + 1, c: currentCol },
                        e: { r: lastDataRowIdx, c: currentCol }
                    });
                }

                // Style header row
                for (let col = 0; col < numCols; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: headerRowIdx, c: startCol + col });
                    const colType = columnTypes[col] || 'default';
                    let headerBgColor = "5B9BD5";
                    let leftBorderStyle = "thin", rightBorderStyle = "thin", topBorderStyle = "thin", bottomBorderStyle = "thin";

                    if (colType === 'teaching') headerBgColor = "ED7D31";
                    else if (colType === 'training') headerBgColor = "4BACC6";
                    else if (colType === 'total-teaching') {
                        headerBgColor = "C65911";
                        leftBorderStyle = "medium";
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    }
                    else if (colType === 'total-training') {
                        headerBgColor = "1F7A8C";
                        rightBorderStyle = "medium";
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    }
                    else if (colType === 'shift-morning') headerBgColor = "2E5090";
                    else if (colType === 'shift-afternoon') headerBgColor = "70AD47";

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11, name: "Arial" },
                            fill: { fgColor: { rgb: headerBgColor } },
                            alignment: { horizontal: "center", vertical: "center", wrapText: true },
                            border: {
                                top: { style: topBorderStyle, color: { rgb: "000000" } },
                                bottom: { style: bottomBorderStyle, color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style data rows
                for (let row = headerRowIdx + 1; row < totalRowIdx; row++) {
                    for (let col = 0; col < numCols; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: startCol + col });
                        const colType = columnTypes[col] || 'default';
                        let bgColor = "FFFFFF", fontColor = "000000", fontBold = false;
                        let leftBorderStyle = "thin", rightBorderStyle = "thin";
                        let leftBorderColor = "D0D0D0", rightBorderColor = "D0D0D0";

                        if (colType === 'teaching' || colType === 'total-teaching') {
                            bgColor = "FCE4D6";
                            if (colType === 'total-teaching') {
                                leftBorderStyle = "medium";
                                leftBorderColor = "000000";
                            }
                        } else if (colType === 'training' || colType === 'total-training') {
                            bgColor = "DDEBF7";
                            if (colType === 'total-training') {
                                rightBorderStyle = "medium";
                                rightBorderColor = "000000";
                            }
                        } else if (colType === 'shift-morning') {
                            bgColor = "2E5090";
                            fontColor = "FFFFFF";
                            fontBold = true;
                        } else if (colType === 'shift-afternoon') {
                            bgColor = "70AD47";
                            fontColor = "FFFFFF";
                            fontBold = true;
                        }

                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                fill: { fgColor: { rgb: bgColor } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: {
                                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                    left: { style: leftBorderStyle, color: { rgb: leftBorderColor } },
                                    right: { style: rightBorderStyle, color: { rgb: rightBorderColor } }
                                },
                                font: { name: "Arial", sz: 10, color: { rgb: fontColor }, bold: fontBold }
                            };
                        }
                    }
                }

                // Style total row
                for (let col = 0; col < numCols; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: totalRowIdx, c: startCol + col });
                    const colType = columnTypes[col] || 'default';
                    let totalBgColor = "70AD47", fontColor = "000000";
                    let leftBorderStyle = "thin", rightBorderStyle = "thin";

                    if (colType === 'teaching' || colType === 'total-teaching') {
                        totalBgColor = "F4B183";
                        if (colType === 'total-teaching') leftBorderStyle = "medium";
                    } else if (colType === 'training' || colType === 'total-training') {
                        totalBgColor = "9DC3E6";
                        if (colType === 'total-training') rightBorderStyle = "medium";
                    } else if (colType === 'shift-morning') {
                        totalBgColor = "2E5090";
                        fontColor = "FFFFFF";
                    } else if (colType === 'shift-afternoon') {
                        totalBgColor = "70AD47";
                        fontColor = "FFFFFF";
                    }

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 11, name: "Arial", color: { rgb: fontColor } },
                            fill: { fgColor: { rgb: totalBgColor } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "medium", color: { rgb: "000000" } },
                                bottom: { style: "medium", color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }
            };

            // Process each pair of tables and apply styling
            for (let pairIdx = 0; pairIdx < pairLayouts.length; pairIdx++) {
                const layout = pairLayouts[pairIdx];
                const { table1, table2, separatorCol, table2StartCol, startRow } = layout;

                // Style black separator row before this pair (if exists)
                if (pairIdx > 0) {
                    const separatorRowIdx = startRow - 1;
                    const table2Width = table2 ? (table2.numCols || table2.headerRow.length) : 0;
                    const rowWidth = separatorCol + 1 + table2Width;
                    for (let col = 0; col < rowWidth; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: separatorRowIdx, c: col });
                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                fill: { fgColor: { rgb: "000000" } },
                                font: { color: { rgb: "000000" } }
                            };
                        }
                    }
                }

                // Style table1 (starts at column 0)
                const table1StartCol = 0;
                styleInstructorTable(worksheet, table1, startRow, table1StartCol);

                // Style separator column (at separatorCol position) ONLY if table2 exists
                if (table2) {
                    const table1Data = table1.data || table1.table;
                    const table2Data = table2.data || table2.table;
                    const maxRows = Math.max(table1Data.length, table2Data.length);
                    for (let rowOffset = 0; rowOffset < maxRows; rowOffset++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: startRow + rowOffset, c: separatorCol });
                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                fill: { fgColor: { rgb: "000000" } },
                                font: { color: { rgb: "000000" } }
                            };
                        }
                    }

                    // Style table2 (starts at table2StartCol)
                    styleInstructorTable(worksheet, table2, startRow, table2StartCol);
                }
            }

            // Set column widths
            const maxCols = Math.max(...allData.map(row => row.length));
            worksheet['!cols'] = new Array(maxCols).fill({ wch: 11 });

            // Add worksheet
            const monthName = getMonthName(month);
            const sheetName = departmentName ? `${departmentName} - ${monthName}` : `×“×•×— ×××•×—×“ - ${monthName}`;
            XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

            // Generate filename
            let filename = departmentName
                ? `×“×•×—_${departmentName}_${monthName}_${year}.xlsx`
                : `×“×•×—_×××•×—×“_${monthName}_${year}.xlsx`;

            // Write and download
            XLSX.writeFile(workbook, filename);

            showSuccess(`×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”! ${instructorEmails.length} ××“×¨×™×›×™×`);
        }

        // Export single instructor's own timesheet
        async function exportOwnTimesheet() {
            try {
                showLoading(true);

                const instructorEmail = currentUser.email;
                const sanitizedEmail = sanitizeEmail(instructorEmail);

                // Check if submitted to coordinator
                const submissionsRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions`);
                const submissionsSnapshot = await get(submissionsRef);

                if (!submissionsSnapshot.exists()) {
                    showError('×œ× × ×™×ª×Ÿ ×œ×™×™×¦× ×“×•×— ×©×œ× ×©×•×’×¨ ×œ×¨×›×–');
                    showLoading(false);
                    return;
                }

                // Get timesheet data
                const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries`);
                const timesheetSnapshot = await get(timesheetRef);
                const timesheetData = timesheetSnapshot.exists() ? timesheetSnapshot.val() : {};

                // Collect all subjects for this instructor
                const allSubjects = { morning: [], afternoon: [] };

                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        const assignment = userData.assignedInstructors.find(assign => {
                            const assignmentEmail = typeof assign === 'string' ? assign : assign.email;
                            return assignmentEmail === instructorEmail;
                        });

                        if (assignment) {
                            let assignedSubjects = [];
                            if (typeof assignment === 'object' && assignment.subjects) {
                                assignedSubjects = assignment.subjects;
                            } else {
                                assignedSubjects = getAllUserSubjects(userData);
                            }

                            assignedSubjects.forEach(subject => {
                                let period = null;
                                if (userData.subjects?.morning?.includes(subject)) {
                                    period = 'morning';
                                } else if (userData.subjects?.afternoon?.includes(subject)) {
                                    period = 'afternoon';
                                }

                                if (period && !allSubjects[period].includes(subject)) {
                                    allSubjects[period].push(subject);
                                }
                            });
                        }
                    }
                });

                // Build table data like coordinator view
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                const tableData = [];

                // Title row - merged cells
                const instructorName = currentUserData?.fullName || instructorEmail;
                tableData.push([`×“×™×•×•×— ×©×¢×•×ª: ${instructorName}`]);

                // Header row
                const headerRow = ['×ª××¨×™×š', '×™×•×'];
                const subjectTotals = {}; // Track totals per subject
                const columnTypes = ['date', 'day']; // Track column types for styling

                if (allSubjects.morning.length > 0) {
                    headerRow.push('×‘×•×§×¨');
                    columnTypes.push('shift-morning');
                    allSubjects.morning.forEach(subject => {
                        headerRow.push(`${subject} - ×”×“×¨×›×”`);
                        headerRow.push(`${subject} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`morning_${subject}`] = { teaching: 0, training: 0 };
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    headerRow.push('××—×”"×¦');
                    columnTypes.push('shift-afternoon');
                    allSubjects.afternoon.forEach(subject => {
                        headerRow.push(`${subject} - ×”×“×¨×›×”`);
                        headerRow.push(`${subject} - ×”×©×ª×œ××•×ª`);
                        columnTypes.push('teaching', 'training');
                        subjectTotals[`afternoon_${subject}`] = { teaching: 0, training: 0 };
                    });
                }

                // Add single substitution column
                headerRow.push('×”×—×œ×¤×•×ª');
                columnTypes.push('substitutions');
                subjectTotals['substitutions'] = { teaching: 0, training: 0 };

                headerRow.push('×”×¢×¨×•×ª');
                columnTypes.push('notes');
                headerRow.push('×¡×”"×› ×”×“×¨×›×”', '×¡×”"×› ×”×©×ª×œ××•×ª');
                columnTypes.push('total-teaching', 'total-training');
                tableData.push(headerRow);

                // Data rows
                const monthlyTotals = { teaching: 0, training: 0 };

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(currentYear, currentMonth - 1, day);
                    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                    const dayName = dayNames[dayDate.getDay()];

                    const row = [`${day}.${currentMonth}`, dayName];
                    let dailyTeachingTotal = 0;
                    let dailyTrainingTotal = 0;

                    // Morning subjects
                    if (allSubjects.morning.length > 0) {
                        // Only add "×‘×•×§×¨" text in first row, empty for others (will be merged)
                        row.push(day === 1 ? '×‘×•×§×¨' : '');
                        allSubjects.morning.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'morning'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`morning_${subject}`].teaching += teaching;
                            subjectTotals[`morning_${subject}`].training += training;
                        });
                    }

                    // Afternoon subjects
                    if (allSubjects.afternoon.length > 0) {
                        // Only add "××—×”"×¦" text in first row, empty for others (will be merged)
                        row.push(day === 1 ? '××—×”"×¦' : '');
                        allSubjects.afternoon.forEach(subject => {
                            const entry = Object.values(timesheetData).find(e =>
                                e.date === dateStr && e.subject === subject && e.period === 'afternoon'
                            );
                            const teaching = entry?.hours?.teaching || 0;
                            const training = entry?.hours?.training || 0;
                            row.push(teaching, training);
                            dailyTeachingTotal += teaching;
                            dailyTrainingTotal += training;
                            subjectTotals[`afternoon_${subject}`].teaching += teaching;
                            subjectTotals[`afternoon_${subject}`].training += training;
                        });
                    }

                    // Substitutions - single column with department name and hours
                    const substData = substitutionsByDate[dateStr] || [];
                    let substText = '';
                    let totalSubstTeaching = 0;
                    let totalSubstTraining = 0;

                    if (substData.length > 0) {
                        substText = substData.map(subst => {
                            totalSubstTeaching += subst.teaching;
                            totalSubstTraining += subst.training;
                            return `${subst.department} ${subst.teaching}|${subst.training}`;
                        }).join('\n');

                        dailyTeachingTotal += totalSubstTeaching;
                        dailyTrainingTotal += totalSubstTraining;
                        subjectTotals['substitutions'].teaching += totalSubstTeaching;
                        subjectTotals['substitutions'].training += totalSubstTraining;
                    }

                    row.push(substText || '-');

                    // Get notes for this date
                    const notesKey = `${dateStr}_notes`;
                    const notesEntry = timesheetData[notesKey];
                    const notesValue = notesEntry?.notes || '';

                    row.push(notesValue);
                    row.push(dailyTeachingTotal, dailyTrainingTotal);
                    monthlyTotals.teaching += dailyTeachingTotal;
                    monthlyTotals.training += dailyTrainingTotal;

                    tableData.push(row);
                }

                // Total row
                const totalRow = ['×¡×”"×›', ''];

                if (allSubjects.morning.length > 0) {
                    totalRow.push('');
                    allSubjects.morning.forEach(subject => {
                        totalRow.push(subjectTotals[`morning_${subject}`].teaching);
                        totalRow.push(subjectTotals[`morning_${subject}`].training);
                    });
                }
                if (allSubjects.afternoon.length > 0) {
                    totalRow.push('');
                    allSubjects.afternoon.forEach(subject => {
                        totalRow.push(subjectTotals[`afternoon_${subject}`].teaching);
                        totalRow.push(subjectTotals[`afternoon_${subject}`].training);
                    });
                }

                // Substitution totals - single column
                const substTotals = subjectTotals['substitutions'] || { teaching: 0, training: 0 };
                totalRow.push(`${substTotals.teaching}|${substTotals.training}`);

                totalRow.push('â€”'); // Notes column empty in total row
                totalRow.push(monthlyTotals.teaching, monthlyTotals.training);
                tableData.push(totalRow);

                // Create worksheet
                const worksheet = XLSX.utils.aoa_to_sheet(tableData);

                // Set RTL for the worksheet
                if (!worksheet['!views']) worksheet['!views'] = [];
                worksheet['!views'][0] = { rtl: true };

                // Merge title row cells
                const titleMerge = { s: { r: 0, c: 0 }, e: { r: 0, c: headerRow.length - 1 } };
                if (!worksheet['!merges']) worksheet['!merges'] = [];
                worksheet['!merges'].push(titleMerge);

                // Merge shift column cells (×‘×•×§×¨ and ××—×”"×¦) vertically for all data rows
                let currentCol = 2; // Start after ×ª××¨×™×š and ×™×•×
                const lastDataRowIndex = tableData.length - 2; // Last data row before total

                // Merge morning shift column vertically (from row 2 to row before total)
                if (allSubjects.morning.length > 0) {
                    const morningShiftCol = currentCol;
                    worksheet['!merges'].push({
                        s: { r: 2, c: morningShiftCol },
                        e: { r: lastDataRowIndex, c: morningShiftCol }
                    });
                    currentCol += 1 + (allSubjects.morning.length * 2); // shift column + all subject columns
                }

                // Merge afternoon shift column vertically (from row 2 to row before total)
                if (allSubjects.afternoon.length > 0) {
                    const afternoonShiftCol = currentCol;
                    worksheet['!merges'].push({
                        s: { r: 2, c: afternoonShiftCol },
                        e: { r: lastDataRowIndex, c: afternoonShiftCol }
                    });
                }

                // Style the title cell
                const titleCell = 'A1';
                if (worksheet[titleCell]) {
                    worksheet[titleCell].s = {
                        font: { bold: true, sz: 24, color: { rgb: "FFFFFF" }, name: "Arial" },
                        fill: { fgColor: { rgb: "203764" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style header row with colors based on column type
                for (let col = 0; col < headerRow.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 1, c: col });
                    const colType = columnTypes[col];
                    let headerBgColor = "5B9BD5"; // Default blue
                    let leftBorderStyle = "thin";
                    let rightBorderStyle = "thin";
                    let topBorderStyle = "thin";
                    let bottomBorderStyle = "thin";

                    if (colType === 'teaching') {
                        headerBgColor = "ED7D31"; // Orange for teaching
                    } else if (colType === 'training') {
                        headerBgColor = "4BACC6"; // Turquoise for training
                    } else if (colType === 'total-teaching') {
                        headerBgColor = "C65911"; // Dark orange for total teaching
                        leftBorderStyle = "medium"; // Bold left border for separation
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    } else if (colType === 'total-training') {
                        headerBgColor = "1F7A8C"; // Dark turquoise for total training
                        rightBorderStyle = "medium"; // Bold right border to close the summary section
                        topBorderStyle = "medium";
                        bottomBorderStyle = "medium";
                    } else if (colType === 'shift-morning') {
                        headerBgColor = "2E5090"; // Dark blue for morning shift
                    } else if (colType === 'shift-afternoon') {
                        headerBgColor = "70AD47"; // Green for afternoon shift
                    }

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11, name: "Arial" },
                            fill: { fgColor: { rgb: headerBgColor } },
                            alignment: { horizontal: "center", vertical: "center", wrapText: true },
                            border: {
                                top: { style: topBorderStyle, color: { rgb: "000000" } },
                                bottom: { style: bottomBorderStyle, color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style total row
                const totalRowIndex = tableData.length - 1;
                for (let col = 0; col < headerRow.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: totalRowIndex, c: col });
                    const colType = columnTypes[col];
                    let totalBgColor = "70AD47"; // Default green
                    let fontColor = "000000";
                    let leftBorderStyle = "thin";
                    let rightBorderStyle = "thin";

                    if (colType === 'teaching' || colType === 'total-teaching') {
                        totalBgColor = "F4B183"; // Light orange
                        if (colType === 'total-teaching') {
                            leftBorderStyle = "medium"; // Bold left border for separation
                        }
                    } else if (colType === 'training' || colType === 'total-training') {
                        totalBgColor = "9DC3E6"; // Light turquoise
                        if (colType === 'total-training') {
                            rightBorderStyle = "medium"; // Bold right border to close the summary section
                        }
                    } else if (colType === 'shift-morning') {
                        totalBgColor = "2E5090"; // Dark blue for morning shift
                        fontColor = "FFFFFF"; // White text
                    } else if (colType === 'shift-afternoon') {
                        totalBgColor = "70AD47"; // Green for afternoon shift
                        fontColor = "FFFFFF"; // White text
                    }

                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 11, name: "Arial", color: { rgb: fontColor } },
                            fill: { fgColor: { rgb: totalBgColor } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "medium", color: { rgb: "000000" } },
                                bottom: { style: "medium", color: { rgb: "000000" } },
                                left: { style: leftBorderStyle, color: { rgb: "000000" } },
                                right: { style: rightBorderStyle, color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style data cells with colors based on column type
                for (let row = 2; row < totalRowIndex; row++) {
                    for (let col = 0; col < headerRow.length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        const colType = columnTypes[col];
                        let bgColor = "FFFFFF";
                        let alignment = "center";
                        let fontColor = "000000";
                        let fontBold = false;
                        let leftBorderStyle = "thin";
                        let rightBorderStyle = "thin";
                        let leftBorderColor = "D0D0D0";
                        let rightBorderColor = "D0D0D0";

                        // Set background color based on column type
                        if (colType === 'teaching' || colType === 'total-teaching') {
                            bgColor = "FCE4D6"; // Very light orange
                            if (colType === 'total-teaching') {
                                leftBorderStyle = "medium"; // Bold left border for separation
                                leftBorderColor = "000000"; // Black border for emphasis
                            }
                        } else if (colType === 'training' || colType === 'total-training') {
                            bgColor = "DDEBF7"; // Very light turquoise
                            if (colType === 'total-training') {
                                rightBorderStyle = "medium"; // Bold right border to close the summary section
                                rightBorderColor = "000000"; // Black border for emphasis
                            }
                        } else if (colType === 'shift-morning') {
                            bgColor = "2E5090"; // Dark blue for morning shift columns
                            fontColor = "FFFFFF"; // White text
                            fontBold = true;
                        } else if (colType === 'shift-afternoon') {
                            bgColor = "70AD47"; // Green for afternoon shift columns
                            fontColor = "FFFFFF"; // White text
                            fontBold = true;
                        }

                        if (worksheet[cellAddress]) {
                            worksheet[cellAddress].s = {
                                fill: { fgColor: { rgb: bgColor } },
                                alignment: { horizontal: alignment, vertical: "center" },
                                border: {
                                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                    left: { style: leftBorderStyle, color: { rgb: leftBorderColor } },
                                    right: { style: rightBorderStyle, color: { rgb: rightBorderColor } }
                                },
                                font: { name: "Arial", sz: 10, color: { rgb: fontColor }, bold: fontBold }
                            };
                        }
                    }
                }

                // Set column widths
                const colWidths = headerRow.map(() => ({ wch: 11 }));
                worksheet['!cols'] = colWidths;

                // Create workbook
                const workbook = XLSX.utils.book_new();
                workbook.Workbook = workbook.Workbook || {};
                workbook.Workbook.Views = [{ RTL: true }];

                // Add worksheet with instructor name
                const sheetName = instructorName.substring(0, 31);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

                // Generate filename
                const monthName = getMonthName(currentMonth);
                const filename = `×“×•×—_×©×¢×•×ª_${instructorName}_${monthName}_${currentYear}.xlsx`;

                // Write and download
                XLSX.writeFile(workbook, filename);

                showSuccess('×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”! âœ…');
                showLoading(false);
            } catch (error) {
                console.error('Error exporting timesheet:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥');
                showLoading(false);
            }
        }

        // Update export button state based on submission status
        async function updateExportButtonState() {
            const exportBtn = document.getElementById('exportInstructorTimesheetBtn');
            if (!exportBtn) return;

            const instructorEmail = currentUser?.email;
            if (!instructorEmail) return;

            const sanitizedEmail = sanitizeEmail(instructorEmail);

            // Check if submitted to coordinator
            const submissionsRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions`);
            const submissionsSnapshot = await get(submissionsRef);

            if (submissionsSnapshot.exists()) {
                // Enable export button
                exportBtn.disabled = false;
                exportBtn.style.opacity = '1';
                exportBtn.style.cursor = 'pointer';
                exportBtn.title = '×™×™×¦×•× ×œ××§×¡×œ';
                exportBtn.classList.add('export-enabled');
            } else {
                // Disable export button
                exportBtn.disabled = true;
                exportBtn.style.opacity = '0.5';
                exportBtn.style.cursor = 'not-allowed';
                exportBtn.title = '×™×™×¦×•× ×œ××§×¡×œ ××ª×‘×¦×¢ ×¨×§ ×¢× ×©×™×’×•×¨ ×œ×¨×›×–';
                exportBtn.classList.remove('export-enabled');
            }
        }

        // Initialize App
        async function initializeApp() {
            try {
                showLoading(true);

                // Load all users from Firebase first
                await loadUsersFromFirebase();

                document.getElementById('userName').textContent = currentUserData.fullName;

                // Get subjects
                userSubjects = [];

                // For instructors, get subjects from coordinator assignments
                if (currentUserData.role === 'instructor') {
                    const assignedSubjects = new Set();

                    console.log('=== INSTRUCTOR SUBJECT LOADING ===');
                    console.log('Instructor email:', currentUser.email);

                    // Go through all coordinators and check if they assigned this instructor
                    Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                        if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                            console.log(`Checking coordinator: ${coordEmail}`);
                            console.log('Coordinator assigned instructors:', coordData.assignedInstructors);

                            coordData.assignedInstructors.forEach(assignment => {
                                const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                                console.log(`  Checking assignment for: ${instructorEmail}`);

                                if (instructorEmail === currentUser.email) {
                                    console.log('  âœ“ Match found!');
                                    // This coordinator assigned this instructor
                                    if (typeof assignment === 'object' && assignment.subjects) {
                                        // New format: use assigned subjects
                                        console.log('  Using assigned subjects:', assignment.subjects);
                                        assignment.subjects.forEach(subj => assignedSubjects.add(subj));
                                    } else {
                                        // Old format: use all coordinator's subjects
                                        const coordSubjects = getAllUserSubjects(coordData);
                                        console.log('  Using all coordinator subjects:', coordSubjects);
                                        coordSubjects.forEach(subj => assignedSubjects.add(subj));
                                    }
                                }
                            });
                        }
                    });

                    // Convert assigned subjects to periods (morning/afternoon) using dynamic detection
                    assignedSubjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        userSubjects.push({name: subj, period: period});
                    });

                    console.log('Instructor assigned subjects:', Array.from(assignedSubjects));
                    console.log('User subjects with periods:', userSubjects);
                } else if (currentUserData.role === 'coordinator' && currentUserData.employmentType === 'hourly') {
                    // For hourly coordinators, load subjects from their assignments (like instructors)
                    const assignedSubjects = new Set();

                    console.log('=== HOURLY COORDINATOR SUBJECT LOADING ===');
                    console.log('Hourly coordinator email:', currentUser.email);

                    // Go through all coordinators and check if they assigned this hourly coordinator
                    Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                        if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                            console.log(`Checking coordinator: ${coordEmail}`);

                            coordData.assignedInstructors.forEach(assignment => {
                                const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;

                                if (instructorEmail === currentUser.email) {
                                    console.log('  âœ“ Match found for hourly coordinator!');
                                    // This coordinator assigned this hourly coordinator
                                    if (typeof assignment === 'object' && assignment.subjects) {
                                        // Use assigned subjects
                                        console.log('  Using assigned subjects:', assignment.subjects);
                                        assignment.subjects.forEach(subj => assignedSubjects.add(subj));
                                    }
                                }
                            });
                        }
                    });

                    // Convert assigned subjects to periods
                    assignedSubjects.forEach(subj => {
                        const period = getSubjectPeriod(subj);
                        userSubjects.push({name: subj, period: period});
                    });

                    console.log('Hourly coordinator assigned subjects:', Array.from(assignedSubjects));
                    console.log('User subjects with periods:', userSubjects);
                } else {
                    // For regular coordinators and others, use their own subjects
                    if (currentUserData.subjects) {
                        if (currentUserData.subjects.morning) {
                            currentUserData.subjects.morning.forEach(s => userSubjects.push({name: s, period: 'morning'}));
                        }
                        if (currentUserData.subjects.afternoon) {
                            currentUserData.subjects.afternoon.forEach(s => userSubjects.push({name: s, period: 'afternoon'}));
                        }
                    }
                }

                // Load substitution departments for instructors
                if (currentUserData.role === 'instructor' || (currentUserData.role === 'coordinator' && currentUserData.employmentType === 'hourly')) {
                    await loadSubstitutionDepartments();
                }

                await loadMonthlyTimesheet(currentYear, currentMonth);
                updatePersonalDataTab();
                await loadBackups();
                loadSavedTheme();
                loadProfileImage();
                loadNotificationEmail();

                // Update export button state for instructors
                if (currentUserData.role === 'instructor' || (currentUserData.role === 'coordinator' && currentUserData.employmentType === 'hourly')) {
                    await updateExportButtonState();
                }

                // Setup realtime listeners for dynamic updates
                setupRealtimeListeners();

                // Setup keyboard shortcuts for Undo/Redo (Ctrl+Z / Ctrl+Y)
                setupUndoRedoKeyboardShortcuts();

                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
                showLoading(false);
            }
        }

        // Load available departments for substitutions (all departments minus user's departments)
        async function loadSubstitutionDepartments() {
            console.log('ğŸ”„ Loading substitution departments...');

            try {
                // Load all departments from Firebase
                const morningRef = ref(database, 'departments/morning');
                const afternoonRef = ref(database, 'departments/afternoon');

                const [morningSnapshot, afternoonSnapshot] = await Promise.all([
                    get(morningRef),
                    get(afternoonRef)
                ]);

                const allDepartments = [];

                // Extract morning departments
                if (morningSnapshot.exists()) {
                    Object.keys(morningSnapshot.val()).forEach(name => {
                        allDepartments.push({ name: name, period: 'morning' });
                    });
                }

                // Extract afternoon departments
                if (afternoonSnapshot.exists()) {
                    Object.keys(afternoonSnapshot.val()).forEach(name => {
                        allDepartments.push({ name: name, period: 'afternoon' });
                    });
                }

                console.log('All departments:', allDepartments);
                console.log('User subjects:', userSubjects);

                // Filter out user's own departments
                availableSubstitutionDepartments = allDepartments.filter(dept => {
                    // Check if this department is in user's subjects
                    const isUserDept = userSubjects.some(userSubj =>
                        userSubj.name === dept.name && userSubj.period === dept.period
                    );
                    return !isUserDept;
                });

                console.log('âœ… Available substitution departments:', availableSubstitutionDepartments);

            } catch (error) {
                console.error('Error loading substitution departments:', error);
            }
        }

        // Load Timesheet
        async function loadMonthlyTimesheet(year, month, keepEditState = false) {
            console.log('ğŸ”µ loadMonthlyTimesheet CALLED from:', new Error().stack.split('\n')[2]);
            console.log('ğŸ“Š BEFORE loadMonthlyTimesheet - State:', {
                variables: { isTimesheetLocked, hasBeenSubmitted, hasSeenEditWarning },
                sessionStorage: {
                    hasSeenEditWarning: sessionStorage.getItem('hasSeenEditWarning')
                }
            });

            try {
                showLoading(true);

                // Check if we're loading a different month/year
                const isDifferentMonth = (year !== currentYear || month !== currentMonth);
                console.log('ğŸ“… loadMonthlyTimesheet:', { year, month, currentYear, currentMonth, isDifferentMonth, keepEditState });

                // Only reset state if NOT in the middle of editing AND loading a different month
                if (!keepEditState && isDifferentMonth) {
                    console.log('ğŸ§¹ Clearing state because loading different month');
                    isTimesheetLocked = false;
                    hasBeenSubmitted = false;
                    hasSeenEditWarning = false; // Reset warning flag when loading new month
                    sessionStorage.removeItem('hasSeenEditWarning'); // Clear from session storage
                    needsResubmitTo = {};
                    removeLockNotification();
                } else {
                    console.log('âœ… Keeping state:', { isTimesheetLocked, hasBeenSubmitted, hasSeenEditWarning });
                }

                console.log('ğŸ“Š AFTER decision - State:', {
                    variables: { isTimesheetLocked, hasBeenSubmitted, hasSeenEditWarning },
                    sessionStorage: {
                        hasSeenEditWarning: sessionStorage.getItem('hasSeenEditWarning')
                    }
                });

                const monthName = getMonthName(month);
                document.getElementById('currentMonthTitle').textContent = `${monthName} ${year}`;

                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}`);
                const snapshot = await get(timesheetRef);

                currentTimesheet = snapshot.exists() ? snapshot.val() : { entries: {} };

                // Only check and set lock if NOT keeping edit state
                if (!keepEditState) {
                    // Check if any submissions exist for this month
                    const submissions = currentTimesheet.submissions || {};
                    const hasSubmissions = Object.keys(submissions).length > 0;

                    if (hasSubmissions) {
                        // Check if all submissions are submitted (not just pending)
                        const allSubmitted = Object.values(submissions).every(sub => sub.status === 'submitted');
                        if (allSubmitted) {
                            hasBeenSubmitted = true;
                            isTimesheetLocked = true;
                        }
                    }
                }

                generateTimesheetTable();
                updateMonthlySummary();
                generateSubmitButtons();

                // Lock table if submitted
                if (isTimesheetLocked) {
                    lockTimesheetTable(true);
                    // Show lock notification
                    showLockNotification();
                }

                // Setup realtime listener for instructor's timesheet (to see coordinator edits)
                setupInstructorRealtimeListener(year, month);

                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—');
                showLoading(false);
            }
        }

        let instructorEntriesListener = null;

        function setupInstructorRealtimeListener(year, month) {
            // Remove previous listener if exists
            if (instructorEntriesListener) {
                instructorEntriesListener();
            }

            if (currentUserData.role !== 'instructor') return;

            const sanitizedEmail = sanitizeEmail(currentUser.email);
            const entriesRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries`);

            let isFirstLoad = true;

            instructorEntriesListener = onValue(entriesRef, (snapshot) => {
                if (isFirstLoad) {
                    isFirstLoad = false;
                    console.log('â­ï¸ Skipping initial listener trigger (instructor timesheet)');
                    return;
                }

                console.log('ğŸ”„ Timesheet entries updated for instructor');

                // Update currentTimesheet
                currentTimesheet.entries = snapshot.exists() ? snapshot.val() : {};

                // Regenerate table and summary
                generateTimesheetTable();
                updateMonthlySummary();
            });
        }

        // Get Hebrew day name
        function getHebrewDayName(year, month, day) {
            const date = new Date(year, month - 1, day);
            const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            return days[date.getDay()];
        }

        // Lock/Unlock timesheet table
        function lockTimesheetTable(lock = true) {
            // Don't change visual appearance - just track the state
            isTimesheetLocked = lock;
        }

        // Show lock notification banner
        function showLockNotification() {
            // Remove existing notification if any
            const existing = document.getElementById('lockNotification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'lockNotification';
            notification.style.cssText = 'background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; padding: 12px 20px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; font-weight: 600; border: 2px solid #d97706;';
            notification.innerHTML = `
                <span style="font-size: 20px;">ğŸ”’</span>
                <span>×”×“×•×— ×©×•×’×¨ ×•× ×¢×•×œ ×œ×¢×¨×™×›×”. ×œ×—×¥ ×¢×œ ×ª× ×›×“×™ ×œ×¤×ª×•×— ×œ×¢×¨×™×›×” ××—×“×©.</span>
            `;

            const timesheetSection = document.getElementById('timesheetTable').parentElement;
            timesheetSection.insertBefore(notification, timesheetSection.firstChild);
        }

        // Remove lock notification
        function removeLockNotification() {
            const notification = document.getElementById('lockNotification');
            if (notification) notification.remove();
        }

        // Update submit buttons to show resubmit state
        function updateSubmitButtonsForResubmit() {
            const submitSection = document.querySelector('.submit-section');
            if (submitSection) {
                const buttons = submitSection.querySelectorAll('button.btn-primary');
                buttons.forEach(btn => {
                    // Get the coordinator name from the button text
                    const currentText = btn.textContent.trim();
                    // Replace "×©×’×¨ ×œ" with "×©×’×¨ ××—×“×© ×œ" or "ğŸ“¤ ×©×’×¨ ×œ" with "ğŸ”„ ×©×’×¨ ××—×“×© ×œ"
                    const newText = currentText
                        .replace('ğŸ“¤ ×©×’×¨ ×œ', 'ğŸ”„ ×©×’×¨ ××—×“×© ×œ')
                        .replace('×©×’×¨ ×œ', '×©×’×¨ ××—×“×© ×œ');

                    btn.textContent = newText;
                    btn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    btn.style.borderColor = '#d97706';
                });
            }
        }

        // Send email notification to coordinator
        async function sendResubmitEmail(coordinatorEmail, coordinatorName) {
            try {
                const monthName = getMonthName(currentMonth);

                const templateParams = {
                    to_email: coordinatorEmail,
                    coordinator_name: coordinatorName,
                    instructor_name: currentUserData.fullName,
                    instructor_email: currentUser.email,
                    month_name: monthName,
                    year: currentYear
                };

                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams
                );

                console.log(`Email sent successfully to ${coordinatorEmail}`);
            } catch (error) {
                console.error('Error sending email:', error);
                throw error;
            }
        }

        // Send email to coordinator with resubmit reason (when report was already sent to finance)
        async function sendResubmitWithReasonEmail(coordinatorEmail, coordinatorName, reason) {
            try {
                const monthName = getMonthName(currentMonth);

                const templateParams = {
                    to_email: coordinatorEmail,
                    coordinator_name: coordinatorName,
                    instructor_name: currentUserData.fullName,
                    instructor_email: currentUser.email,
                    month_name: monthName,
                    year: currentYear,
                    resubmit_reason: reason, // Added reason parameter
                    message: `${currentUserData.fullName} ×©×™×’×¨/×” ××—×“×© ××ª ×“×•×— ×”×©×¢×•×ª ×¢×‘×•×¨ ${monthName} ${currentYear}.\n\nâš ï¸ ×©×™× ×œ×‘: ×”×“×•×— ×›×‘×¨ × ×©×œ×— ×œ×× ×”×œ×ª ×”×›×¡×¤×™×!\n\n×¡×™×‘×ª ×”×©×™× ×•×™:\n${reason}\n\n×™×© ×œ×‘×“×•×§ ××ª ×”×©×™× ×•×™×™× ×•×œ××©×¨ ×¦×¤×™×” ×œ×¤× ×™ ×©×œ×™×—×” ××—×“×© ×œ×× ×”×œ×ª ×”×›×¡×¤×™×.`
                };

                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams
                );

                console.log(`Email with reason sent successfully to ${coordinatorEmail}`);
            } catch (error) {
                console.error('Error sending email with reason:', error);
                throw error;
            }
        }

        // Generate Table
        function generateTimesheetTable() {
            const table = document.getElementById('timesheetTable');
            const thead = table.querySelector('thead tr');
            const tbody = document.getElementById('timesheetTableBody');

            // Build header
            let headerHTML = '<th class="sticky-col">×ª××¨×™×š</th><th class="sticky-col">×™×•×</th>';

            // Morning subjects
            const morningSubjects = userSubjects.filter(s => s.period === 'morning');
            if (morningSubjects.length > 0) {
                headerHTML += '<th class="subject-header morning-section">××©××¨×ª</th>';
                morningSubjects.forEach(subject => {
                    headerHTML += `<th class="subject-header morning-section"><div class="subject-name">${subject.name}</div><div class="subject-types"><span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span></div></th>`;
                });
            }

            // Afternoon subjects
            const afternoonSubjects = userSubjects.filter(s => s.period === 'afternoon');
            if (afternoonSubjects.length > 0) {
                headerHTML += '<th class="subject-header afternoon-section">××©××¨×ª</th>';
                afternoonSubjects.forEach(subject => {
                    headerHTML += `<th class="subject-header afternoon-section"><div class="subject-name">${subject.name}</div><div class="subject-types"><span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span></div></th>`;
                });
            }

            headerHTML += '<th class="substitutions-col" style="min-width: 100px; background: rgba(139, 92, 246, 0.1);"><div class="subject-name">×”×—×œ×¤×•×ª</div><div class="subject-types"><span>×”×“×¨×›×”</span><span>|</span><span>×”×©×ª×œ××•×ª</span></div></th>';
            headerHTML += '<th class="notes-col" style="min-width: 150px; max-width: 200px;">×”×¢×¨×•×ª</th>';
            headerHTML += '<th class="total-col">×¡×”"×› ×”×“×¨×›×”</th><th class="total-col">×¡×”"×› ×”×©×ª×œ××•×ª</th>';

            thead.innerHTML = headerHTML;
            tbody.innerHTML = '';

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                tbody.appendChild(generateDayRow(day));
            }

            // Add monthly total row
            tbody.appendChild(generateMonthlyTotalRow());
        }

        function generateDayRow(day) {
            const tr = document.createElement('tr');
            const date = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayName = getHebrewDayName(currentYear, currentMonth, day);

            // Date and Day columns
            tr.innerHTML = `<td class="sticky-col">${day}.${currentMonth}</td><td class="sticky-col">${dayName}</td>`;

            let dailyTeachingTotal = 0;
            let dailyTrainingTotal = 0;

            // Morning subjects
            const morningSubjects = userSubjects.filter(s => s.period === 'morning');
            if (morningSubjects.length > 0) {
                // Add "×‘×•×§×¨" label
                const morningLabelTd = document.createElement('td');
                morningLabelTd.textContent = '×‘×•×§×¨';
                morningLabelTd.className = 'shift-label morning morning-section';
                tr.appendChild(morningLabelTd);

                morningSubjects.forEach(subject => {
                    const td = document.createElement('td');
                    td.className = 'morning-section';
                    const entryKey = `${date}_morning_${subject.name}`;
                    const existingEntry = currentTimesheet.entries?.[entryKey];

                    const teachingValue = existingEntry?.hours?.teaching || 0;
                    const trainingValue = existingEntry?.hours?.training || 0;

                    dailyTeachingTotal += teachingValue;
                    dailyTrainingTotal += trainingValue;

                    // Add class based on which select has hours and who edited it
                    const editedByCoord = existingEntry?.editedBy === 'coordinator';
                    const teachingClass = teachingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';
                    const trainingClass = trainingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';

                    td.innerHTML = `<div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                        <select class="${teachingClass}" data-type="teaching" data-date="${date}" data-period="morning" data-subject="${subject.name}">
                            ${generateHoursOptions(teachingValue)}
                        </select>
                        <span style="font-size: 11px;">|</span>
                        <select class="${trainingClass}" data-type="training" data-date="${date}" data-period="morning" data-subject="${subject.name}">
                            ${generateHoursOptions(trainingValue)}
                        </select>
                    </div>`;

                    if (existingEntry?.editedBy) td.classList.add('edited-cell');
                    tr.appendChild(td);
                });
            }

            // Afternoon subjects
            const afternoonSubjects = userSubjects.filter(s => s.period === 'afternoon');
            if (afternoonSubjects.length > 0) {
                // Add "××—×”"×¦" label
                const afternoonLabelTd = document.createElement('td');
                afternoonLabelTd.textContent = '××—×”"×¦';
                afternoonLabelTd.className = 'shift-label afternoon afternoon-section';
                tr.appendChild(afternoonLabelTd);

                afternoonSubjects.forEach(subject => {
                    const td = document.createElement('td');
                    td.className = 'afternoon-section';
                    const entryKey = `${date}_afternoon_${subject.name}`;
                    const existingEntry = currentTimesheet.entries?.[entryKey];

                    const teachingValue = existingEntry?.hours?.teaching || 0;
                    const trainingValue = existingEntry?.hours?.training || 0;

                    dailyTeachingTotal += teachingValue;
                    dailyTrainingTotal += trainingValue;

                    // Add class based on which select has hours and who edited it
                    const editedByCoord = existingEntry?.editedBy === 'coordinator';
                    const teachingClass = teachingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';
                    const trainingClass = trainingValue > 0 ? (editedByCoord ? 'coord-edited-select' : 'has-hours-select') : '';

                    td.innerHTML = `<div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                        <select class="${teachingClass}" data-type="teaching" data-date="${date}" data-period="afternoon" data-subject="${subject.name}">
                            ${generateHoursOptions(teachingValue)}
                        </select>
                        <span style="font-size: 11px;">|</span>
                        <select class="${trainingClass}" data-type="training" data-date="${date}" data-period="afternoon" data-subject="${subject.name}">
                            ${generateHoursOptions(trainingValue)}
                        </select>
                    </div>`;

                    if (existingEntry?.editedBy) td.classList.add('edited-cell');
                    tr.appendChild(td);
                });
            }

            // Substitutions column - just a + button
            const substitutionsTd = document.createElement('td');
            substitutionsTd.className = 'substitutions-col';
            substitutionsTd.style.padding = '3px 4px';
            substitutionsTd.style.textAlign = 'center';
            substitutionsTd.style.background = 'rgba(139, 92, 246, 0.05)';

            // Create substitutions display with + button
            let substitutionHTML = '';

            if (availableSubstitutionDepartments.length > 0) {
                // Check if there are existing substitutions for this date
                const existingSubstitutions = [];
                if (currentTimesheet.entries) {
                    Object.keys(currentTimesheet.entries).forEach(key => {
                        if (key.startsWith(`${date}_substitution_`)) {
                            const subst = currentTimesheet.entries[key];
                            existingSubstitutions.push(subst);
                        }
                    });
                }

                // Build individual substitution items
                let substitutionItems = '';
                existingSubstitutions.forEach((subst, index) => {
                    substitutionItems += `
                        <div style="display: flex; flex-direction: column; gap: 0px; align-items: center;">
                            <div style="font-size: 9px; color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">
                                ${subst.department}
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); display: flex; gap: 6px; align-items: center;">
                                <span style="color: #f97316; font-weight: 600;">${subst.hours.teaching || 0}</span>
                                <span style="color: var(--text-muted);">|</span>
                                <span style="color: #34ebbd; font-weight: 600;">${subst.hours.training || 0}</span>
                            </div>
                        </div>
                    `;
                });

                substitutionHTML = `
                    <div id="substitutions-${date}" style="display: flex; align-items: center; justify-content: center; width: 100%; padding: 4px 6px; gap: 8px; position: relative;">
                        ${substitutionItems}
                        <button class="open-substitutions-btn" data-date="${date}"
                            style="position: absolute; right: 6px; width: 28px; height: 28px; padding: 0; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 6px; color: rgba(139, 92, 246, 0.9); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"
                            onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'"
                            onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                            +
                        </button>
                    </div>`;
            } else {
                substitutionHTML = `<div id="substitutions-${date}" style="display: flex; flex-direction: column; gap: 4px; align-items: center;">â€”</div>`;
            }

            substitutionsTd.innerHTML = substitutionHTML;
            tr.appendChild(substitutionsTd);

            // Add substitutions hours to daily totals
            if (currentTimesheet.entries) {
                Object.keys(currentTimesheet.entries).forEach(key => {
                    if (key.startsWith(`${date}_substitution_`)) {
                        const subst = currentTimesheet.entries[key];
                        dailyTeachingTotal += subst.hours?.teaching || 0;
                        dailyTrainingTotal += subst.hours?.training || 0;
                    }
                });
            }

            // Notes column
            const notesTd = document.createElement('td');
            notesTd.className = 'notes-col';
            notesTd.style.padding = '2px 4px';
            const notesKey = `${date}_notes`;
            const existingNotes = currentTimesheet.entries?.[notesKey]?.notes || '';
            notesTd.innerHTML = `<input type="text"
                class="notes-input"
                data-date="${date}"
                value="${existingNotes}"
                placeholder="×”×¢×¨×•×ª..."
                style="width: 100%; padding: 4px 8px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px; font-family: 'Bricolage Grotesque', sans-serif;">`;
            tr.appendChild(notesTd);

            // Daily totals
            const teachingTotalTd = document.createElement('td');
            teachingTotalTd.className = 'total-col';
            teachingTotalTd.innerHTML = `<span style="color: #f97316; font-weight: 700;">${dailyTeachingTotal}</span>`;
            tr.appendChild(teachingTotalTd);

            const trainingTotalTd = document.createElement('td');
            trainingTotalTd.className = 'total-col';
            trainingTotalTd.innerHTML = `<span style="color: #34ebbd; font-weight: 700;">${dailyTrainingTotal}</span>`;
            tr.appendChild(trainingTotalTd);

            // Add event listeners
            tr.querySelectorAll('select').forEach(select => {
                // Don't add hours change handler to substitution selects
                if (!select.classList.contains('substitution-dept-select')) {
                    select.addEventListener('change', handleHoursChange);
                }
            });

            // Add event listener for "open substitutions" button
            const openSubstBtn = tr.querySelector('.open-substitutions-btn');
            if (openSubstBtn) {
                openSubstBtn.addEventListener('click', handleOpenSubstitutions);
            }

            // Add event listener for notes input
            const notesInput = tr.querySelector('.notes-input');
            if (notesInput) {
                notesInput.addEventListener('blur', handleNotesChange);
                notesInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur(); // Save on Enter
                    }
                });
            }

            return tr;
        }

        function generateMonthlyTotalRow() {
            const tr = document.createElement('tr');
            tr.style.background = 'rgba(15, 23, 42, 0.8)';
            tr.style.fontWeight = '700';
            tr.style.borderTop = '2px solid var(--border-color)';

            // Calculate totals per subject
            const subjectTotals = {};
            let monthlyTeachingTotal = 0;
            let monthlyTrainingTotal = 0;
            let substitutionsTeachingTotal = 0;
            let substitutionsTrainingTotal = 0;

            // Initialize totals for all subjects
            userSubjects.forEach(subject => {
                const key = `${subject.period}_${subject.name}`;
                subjectTotals[key] = { teaching: 0, training: 0 };
            });

            // Calculate totals
            if (currentTimesheet.entries) {
                Object.entries(currentTimesheet.entries).forEach(([key, entry]) => {
                    // Handle substitution entries
                    if (key.includes('_substitution_')) {
                        substitutionsTeachingTotal += entry.hours?.teaching || 0;
                        substitutionsTrainingTotal += entry.hours?.training || 0;
                        monthlyTeachingTotal += entry.hours?.teaching || 0;
                        monthlyTrainingTotal += entry.hours?.training || 0;
                        return;
                    }

                    // Skip notes entries (they don't have hours/period/subject)
                    if (!entry.hours || !entry.period || !entry.subject) return;

                    const subjectKey = `${entry.period}_${entry.subject}`;
                    if (subjectTotals[subjectKey]) {
                        subjectTotals[subjectKey].teaching += entry.hours.teaching || 0;
                        subjectTotals[subjectKey].training += entry.hours.training || 0;
                    }
                    monthlyTeachingTotal += entry.hours.teaching || 0;
                    monthlyTrainingTotal += entry.hours.training || 0;
                });
            }

            // Date and Day columns
            const dateTd = document.createElement('td');
            dateTd.colSpan = 2;
            dateTd.textContent = '×¡×”"×› ×—×•×“×©×™';
            dateTd.style.textAlign = 'center';
            dateTd.style.fontSize = '14px';
            dateTd.style.color = 'var(--accent-color)';
            tr.appendChild(dateTd);

            // Morning subjects totals
            const morningSubjects = userSubjects.filter(s => s.period === 'morning');
            if (morningSubjects.length > 0) {
                // Empty cell for shift label
                const shiftLabelTd = document.createElement('td');
                shiftLabelTd.className = 'morning-section';
                tr.appendChild(shiftLabelTd);

                morningSubjects.forEach(subject => {
                    const td = document.createElement('td');
                    td.className = 'morning-section';
                    const key = `morning_${subject.name}`;
                    const totals = subjectTotals[key];
                    td.innerHTML = `<div style="display: flex; gap: 6px; justify-content: center; align-items: center; font-size: 13px;">
                        <span style="color: #f97316; font-weight: 700;">${totals.teaching}</span>
                        <span style="font-size: 11px;">|</span>
                        <span style="color: #34ebbd; font-weight: 700;">${totals.training}</span>
                    </div>`;
                    tr.appendChild(td);
                });
            }

            // Afternoon subjects totals
            const afternoonSubjects = userSubjects.filter(s => s.period === 'afternoon');
            if (afternoonSubjects.length > 0) {
                // Empty cell for shift label
                const shiftLabelTd = document.createElement('td');
                shiftLabelTd.className = 'afternoon-section';
                tr.appendChild(shiftLabelTd);

                afternoonSubjects.forEach(subject => {
                    const td = document.createElement('td');
                    td.className = 'afternoon-section';
                    const key = `afternoon_${subject.name}`;
                    const totals = subjectTotals[key];
                    td.innerHTML = `<div style="display: flex; gap: 6px; justify-content: center; align-items: center; font-size: 13px;">
                        <span style="color: #f97316; font-weight: 700;">${totals.teaching}</span>
                        <span style="font-size: 11px;">|</span>
                        <span style="color: #34ebbd; font-weight: 700;">${totals.training}</span>
                    </div>`;
                    tr.appendChild(td);
                });
            }

            // Substitutions column total
            const substitutionsTd = document.createElement('td');
            substitutionsTd.className = 'substitutions-col';
            substitutionsTd.style.background = 'rgba(139, 92, 246, 0.1)';
            substitutionsTd.innerHTML = `<div style="display: flex; gap: 6px; justify-content: center; align-items: center; font-size: 13px;">
                <span style="color: #f97316; font-weight: 700;">${substitutionsTeachingTotal}</span>
                <span style="font-size: 11px;">|</span>
                <span style="color: #34ebbd; font-weight: 700;">${substitutionsTrainingTotal}</span>
            </div>`;
            tr.appendChild(substitutionsTd);

            // Notes column (empty for total row)
            const notesTd = document.createElement('td');
            notesTd.className = 'notes-col';
            notesTd.textContent = 'â€”';
            notesTd.style.textAlign = 'center';
            notesTd.style.color = 'var(--text-secondary)';
            tr.appendChild(notesTd);

            // Monthly teaching total
            const teachingTotalTd = document.createElement('td');
            teachingTotalTd.className = 'total-col';
            teachingTotalTd.textContent = monthlyTeachingTotal;
            teachingTotalTd.style.fontSize = '16px';
            teachingTotalTd.style.color = '#f97316';
            teachingTotalTd.style.fontWeight = '700';
            tr.appendChild(teachingTotalTd);

            // Monthly training total
            const trainingTotalTd = document.createElement('td');
            trainingTotalTd.className = 'total-col';
            trainingTotalTd.textContent = monthlyTrainingTotal;
            trainingTotalTd.style.fontSize = '16px';
            trainingTotalTd.style.color = '#34ebbd';
            trainingTotalTd.style.fontWeight = '700';
            tr.appendChild(trainingTotalTd);

            return tr;
        }

        // Show special modal when trying to edit after report was sent to finance
        function showEditAfterFinanceModal(select, type, date, period, subject, newValue, entryKey) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%;';

            modalContent.innerHTML = `
                <div style="font-size: 48px; text-align: center; margin-bottom: 16px;">ğŸ”’</div>
                <h2 style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 16px; text-align: center;">
                    ×”×“×•×— ×›×‘×¨ × ×©×œ×— ×œ×× ×”×œ×ª ×”×›×¡×¤×™×!
                </h2>
                <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">
                    ×“×•×— ×–×” ×›×‘×¨ ×©×•×’×¨ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×. <strong>×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ××ª ×”×“×•×— ×‘××¢×¨×›×ª.</strong>
                </p>
                <p style="font-size: 15px; color: #f59e0b; margin-bottom: 24px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-right: 3px solid #f59e0b;">
                    ğŸ’¡ × ×™×ª×Ÿ ×œ×©×œ×•×— ××™×™×œ ×œ×¨×›×– ×¢× ×”×¡×‘×¨ ×¢×œ ×”×©×™× ×•×™ ×”× ×“×¨×©, ×•×”×¨×›×– ×™×•×›×œ ×œ××©×¨ ××ª ×”××©×š ×”×ª×”×œ×™×š.
                </p>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        ×¤×¨×˜ ××ª ×”×©×™× ×•×™ ×”× ×“×¨×©: <span style="color: #ef4444;">*</span>
                    </label>
                    <textarea id="editReasonText" rows="4"
                        style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
                        background: var(--bg-primary); color: var(--text-primary); font-size: 14px; resize: vertical;"
                        placeholder="×œ××©×œ: ×©×›×—×ª×™ ×œ×”×•×¡×™×£ 2 ×©×¢×•×ª ×”×“×¨×›×” ×‘×ª××¨×™×š ${date} ×‘××§×¦×•×¢ ${subject}"></textarea>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                        ×”×”×¡×‘×¨ ×™×©×œ×— ×œ××™×™×œ ×”×¨×›×–. ×œ××—×¨ ××›×Ÿ ×ª×¦×˜×¨×š ×œ×©×œ×•×— ××—×“×© ××ª ×”×“×•×— (×›×¤×ª×•×¨ "×©×’×¨ ××—×“×© ×œ×¨×›×–").
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancelEditFinanceBtn" class="btn"
                        style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                        ×‘×™×˜×•×œ
                    </button>
                    <button id="confirmEditFinanceBtn" class="btn"
                        style="padding: 12px 24px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-color: #ea580c; color: white;">
                        ×©×œ×— ×”×¡×‘×¨ ×œ×¨×›×–
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelEditFinanceBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                // Reload to reset the select
                loadMonthlyTimesheet(currentYear, currentMonth);
            });

            // Confirm button
            document.getElementById('confirmEditFinanceBtn').addEventListener('click', async () => {
                const reason = document.getElementById('editReasonText').value.trim();
                if (!reason) {
                    showError('×™×© ×œ×¤×¨×˜ ××ª ×¡×™×‘×ª ×”×©×™× ×•×™');
                    return;
                }

                document.body.removeChild(modal);

                // DON'T edit anything! Just store the reason and inform user to resubmit
                sessionStorage.setItem(`editReason_${currentYear}_${currentMonth}`, reason); // Store reason for resubmission

                // Show message to user - they need to resubmit with the reason
                showInfo(`×”×¡×™×‘×” × ×©××¨×”. ×›×¢×ª ×©×œ×— ××—×“×© ××ª ×”×“×•×— ×œ×¨×›×– - ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ××ª ×”×“×•×— ×œ××—×¨ ×©× ×©×œ×— ×œ×× ×”×œ×ª ×”×›×¡×¤×™×`);
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    loadMonthlyTimesheet(currentYear, currentMonth);
                }
            });
        }

        // Open substitutions modal
        function handleOpenSubstitutions(event) {
            const button = event.target;
            const date = button.dataset.date;

            console.log('ğŸ”„ Opening substitutions modal for date:', date);

            // Create modal backdrop
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);';

            // Modal header
            const header = document.createElement('div');
            header.style.cssText = 'margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px;';
            header.innerHTML = `
                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">
                    ğŸ”„ ×”×—×œ×¤×•×ª ×œ×™×•× ${date}
                </h3>
                <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 13px;">
                    ×”×•×¡×£ ×”×—×œ×¤×•×ª ×œ××—×œ×§×•×ª ×©×•× ×•×ª
                </p>`;

            // Container for substitution entries
            const entriesContainer = document.createElement('div');
            entriesContainer.className = 'modal-substitutions-container';
            entriesContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;';

            // Load existing substitutions from currentTimesheet for this date
            const existingSubstitutions = [];
            if (currentTimesheet.entries) {
                Object.keys(currentTimesheet.entries).forEach(key => {
                    if (key.startsWith(`${date}_substitution_`)) {
                        existingSubstitutions.push(currentTimesheet.entries[key]);
                    }
                });
            }

            console.log('ğŸ“‹ Found existing substitutions:', existingSubstitutions);

            // Add entries - either existing ones or one empty entry
            if (existingSubstitutions.length > 0) {
                existingSubstitutions.forEach((subst, index) => {
                    addSubstitutionEntryToModal(entriesContainer, date, index, subst);
                });
            } else {
                addSubstitutionEntryToModal(entriesContainer, date, 0, null);
            }

            // Add button
            const addMoreBtn = document.createElement('button');
            addMoreBtn.textContent = '+ ×”×•×¡×£ ×”×—×œ×¤×” × ×•×¡×¤×ª';
            addMoreBtn.style.cssText = 'width: 100%; padding: 8px; background: rgba(139, 92, 246, 0.15); border: 1px dashed rgba(139, 92, 246, 0.4); border-radius: 6px; color: rgba(139, 92, 246, 0.9); font-size: 13px; cursor: pointer; font-family: "Bricolage Grotesque", sans-serif; transition: all 0.2s; margin-bottom: 20px;';
            addMoreBtn.onmouseover = () => addMoreBtn.style.background = 'rgba(139, 92, 246, 0.25)';
            addMoreBtn.onmouseout = () => addMoreBtn.style.background = 'rgba(139, 92, 246, 0.15)';
            addMoreBtn.onclick = () => {
                const currentEntries = entriesContainer.querySelectorAll('.modal-substitution-entry');
                addSubstitutionEntryToModal(entriesContainer, date, currentEntries.length);
            };

            // Buttons container
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '×¡×’×•×¨';
            cancelBtn.style.cssText = 'padding: 8px 20px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: rgba(239, 68, 68, 0.9); cursor: pointer; font-family: "Bricolage Grotesque", sans-serif;';
            cancelBtn.onclick = () => document.body.removeChild(modal);

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '×©××•×¨';
            saveBtn.style.cssText = 'padding: 8px 20px; background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; color: rgba(34, 197, 94, 0.9); cursor: pointer; font-family: "Bricolage Grotesque", sans-serif;';
            saveBtn.onclick = async () => {
                // Save all substitutions
                await saveAllSubstitutionsFromModal(entriesContainer, date);
                document.body.removeChild(modal);
                // Reload table to show updated data
                generateTimesheetTable();
                // Update submit buttons to show substitutions button
                generateSubmitButtons();
            };

            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(saveBtn);

            modalContent.appendChild(header);
            modalContent.appendChild(entriesContainer);
            modalContent.appendChild(addMoreBtn);
            modalContent.appendChild(buttonsDiv);
            modal.appendChild(modalContent);

            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };

            document.body.appendChild(modal);
        }

        // Add substitution entry to modal
        function addSubstitutionEntryToModal(container, date, index, existingData = null) {
            const entry = document.createElement('div');
            entry.className = 'modal-substitution-entry';
            entry.dataset.index = index;
            entry.style.cssText = 'padding: 16px; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; position: relative;';

            // Prepare existing values
            const existingDeptValue = existingData ? `${existingData.period}_${existingData.department}` : '';
            const existingTeaching = existingData?.hours?.teaching || 0;
            const existingTraining = existingData?.hours?.training || 0;

            entry.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 13px; color: var(--text-primary); font-weight: 500;">×‘×—×¨ ××—×œ×§×”:</label>
                        <button class="remove-modal-entry" data-index="${index}" style="padding: 4px 8px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; color: rgba(239, 68, 68, 0.9); font-size: 11px; cursor: pointer;">×”×¡×¨</button>
                    </div>
                    <select class="modal-dept-select" data-index="${index}" style="width: 100%; padding: 8px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px; font-family: 'Bricolage Grotesque', sans-serif;">
                        <option value="">×‘×—×¨ ××—×œ×§×” ×œ×”×—×œ×¤×”...</option>
                        ${availableSubstitutionDepartments.map(dept => {
                            const deptValue = `${dept.period}_${dept.name}`;
                            const selected = deptValue === existingDeptValue ? 'selected' : '';
                            return `<option value="${deptValue}" ${selected}>${dept.name} (${dept.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})</option>`;
                        }).join('')}
                    </select>
                    <div class="modal-hours-container" style="display: ${existingDeptValue ? 'flex' : 'none'}; gap: 16px; margin-top: 8px;">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #f97316; display: block; margin-bottom: 4px;">×©×¢×•×ª ×”×“×¨×›×”</label>
                            <select class="modal-teaching-hours" data-index="${index}" style="width: 100%; padding: 6px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
                                ${generateHoursOptions(existingTeaching)}
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #34ebbd; display: block; margin-bottom: 4px;">×©×¢×•×ª ×”×©×ª×œ××•×ª</label>
                            <select class="modal-training-hours" data-index="${index}" style="width: 100%; padding: 6px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px;">
                                ${generateHoursOptions(existingTraining)}
                            </select>
                        </div>
                    </div>
                </div>`;

            container.appendChild(entry);

            // Add event listener for department selection
            const deptSelect = entry.querySelector('.modal-dept-select');
            const hoursContainer = entry.querySelector('.modal-hours-container');

            deptSelect.onchange = () => {
                if (deptSelect.value) {
                    hoursContainer.style.display = 'flex';
                } else {
                    hoursContainer.style.display = 'none';
                }
            };

            // Add remove button handler
            const removeBtn = entry.querySelector('.remove-modal-entry');
            if (removeBtn) {
                removeBtn.onclick = () => entry.remove();
            }
        }

        // Save all substitutions from modal
        async function saveAllSubstitutionsFromModal(container, date) {
            const entries = container.querySelectorAll('.modal-substitution-entry');
            const sanitizedEmail = sanitizeEmail(currentUser.email);

            console.log('ğŸ’¾ Saving all substitutions from modal...');

            // First, delete all existing substitutions for this date
            const allEntries = currentTimesheet.entries || {};
            for (const key in allEntries) {
                if (key.startsWith(`${date}_substitution_`)) {
                    const substRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${key}`);
                    await remove(substRef);
                    delete currentTimesheet.entries[key];
                }
            }

            // Save new substitutions
            let savedCount = 0;
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const deptSelect = entry.querySelector('.modal-dept-select');
                const teachingSelect = entry.querySelector('.modal-teaching-hours');
                const trainingSelect = entry.querySelector('.modal-training-hours');

                if (deptSelect.value) {
                    const [period, ...nameParts] = deptSelect.value.split('_');
                    const deptName = nameParts.join('_');
                    const teachingHours = parseFloat(teachingSelect.value) || 0;
                    const trainingHours = parseFloat(trainingSelect.value) || 0;

                    await saveSubstitution(date, savedCount, period, deptName, teachingHours, trainingHours);
                    savedCount++;
                }
            }

            console.log(`âœ… Saved ${savedCount} substitutions`);
        }

        // Handle substitution department selection
        async function handleSubstitutionDeptChange(event) {
            const select = event.target;
            const selectedValue = select.value;
            const date = select.dataset.date;
            const container = select.closest('.substitution-entry');
            const entryIndex = container.dataset.index;

            console.log('ğŸ”„ Substitution department selected:', { selectedValue, date, entryIndex });

            if (!selectedValue) {
                // User selected empty option - remove hours inputs and delete from Firebase
                const existingHoursDiv = container.querySelector('.substitution-hours');
                if (existingHoursDiv) {
                    existingHoursDiv.remove();
                }

                // Delete from Firebase
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const substKey = `${date}_substitution_${entryIndex}`;
                const substRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${substKey}`);
                await remove(substRef);

                // Remove from local state
                if (currentTimesheet.entries && currentTimesheet.entries[substKey]) {
                    delete currentTimesheet.entries[substKey];
                }

                console.log('ğŸ—‘ï¸ Deleted substitution from Firebase');
                return;
            }

            // Parse period and department name
            const [period, ...nameParts] = selectedValue.split('_');
            const deptName = nameParts.join('_');

            console.log('Period:', period, 'Department:', deptName);

            // Save department selection with 0 hours initially
            await saveSubstitution(date, entryIndex, period, deptName, 0, 0);

            // Check if hours inputs already exist
            let hoursDiv = container.querySelector('.substitution-hours');

            if (!hoursDiv) {
                // Create hours input fields
                hoursDiv = document.createElement('div');
                hoursDiv.className = 'substitution-hours';
                hoursDiv.style.cssText = 'display: flex; gap: 6px; align-items: center; justify-content: center; margin-top: 3px;';

                hoursDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <label style="font-size: 9px; color: #f97316;">×”×“×¨×›×”</label>
                        <select class="substitution-teaching-hours" data-date="${date}" data-period="${period}" data-dept="${deptName}"
                            style="width: 60px; padding: 2px 4px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 11px;">
                            ${generateHoursOptions(0)}
                        </select>
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);">|</span>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <label style="font-size: 9px; color: #34ebbd;">×”×©×ª×œ××•×ª</label>
                        <select class="substitution-training-hours" data-date="${date}" data-period="${period}" data-dept="${deptName}"
                            style="width: 60px; padding: 2px 4px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 11px;">
                            ${generateHoursOptions(0)}
                        </select>
                    </div>`;

                container.appendChild(hoursDiv);

                // Add event listeners to save changes
                const teachingSelect = hoursDiv.querySelector('.substitution-teaching-hours');
                const trainingSelect = hoursDiv.querySelector('.substitution-training-hours');

                teachingSelect.addEventListener('change', handleSubstitutionHoursChange);
                trainingSelect.addEventListener('change', handleSubstitutionHoursChange);

                console.log('âœ… Added hours inputs for substitution');
            }
        }

        // Handle adding a new substitution entry
        function handleAddSubstitution(event) {
            const button = event.target;
            const date = button.dataset.date;
            const container = button.previousElementSibling; // The substitution-entries-container

            console.log('â• Adding new substitution for date:', date);

            // Count existing entries
            const existingEntries = container.querySelectorAll('.substitution-entry');
            const newIndex = existingEntries.length;

            console.log('Current number of substitutions:', existingEntries.length);

            // Create new substitution entry
            const newEntry = document.createElement('div');
            newEntry.className = 'substitution-entry';
            newEntry.dataset.index = newIndex;
            newEntry.style.cssText = 'display: flex; flex-direction: column; gap: 3px; position: relative; padding: 6px; background: rgba(139, 92, 246, 0.03); border-radius: 4px;';

            newEntry.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 4px;">
                    <select class="substitution-dept-select" data-date="${date}" data-index="${newIndex}"
                        style="flex: 1; padding: 3px 6px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 11px; font-family: 'Bricolage Grotesque', sans-serif;">
                        <option value="">×‘×—×¨ ××—×œ×§×” ×œ×”×—×œ×¤×”...</option>
                        ${availableSubstitutionDepartments.map(dept =>
                            `<option value="${dept.period}_${dept.name}">${dept.name} (${dept.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})</option>`
                        ).join('')}
                    </select>
                    <button class="remove-substitution-btn" data-index="${newIndex}"
                        style="padding: 2px 6px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 3px; color: rgba(239, 68, 68, 0.9); font-size: 10px; cursor: pointer; transition: all 0.2s;">
                        Ã—
                    </button>
                </div>`;

            container.appendChild(newEntry);

            // Add event listener to new dropdown
            const newSelect = newEntry.querySelector('.substitution-dept-select');
            newSelect.addEventListener('change', handleSubstitutionDeptChange);

            // Add event listener to remove button
            const removeBtn = newEntry.querySelector('.remove-substitution-btn');
            removeBtn.addEventListener('click', function() {
                console.log('ğŸ—‘ï¸ Removing substitution entry');
                newEntry.remove();
            });

            console.log('âœ… Added new substitution entry');
        }

        // Handle substitution hours change
        async function handleSubstitutionHoursChange(event) {
            const select = event.target;
            const date = select.dataset.date;
            const period = select.dataset.period;
            const deptName = select.dataset.dept;

            const entry = select.closest('.substitution-entry');
            const entryIndex = entry.dataset.index;

            const teachingSelect = select.closest('.substitution-hours').querySelector('.substitution-teaching-hours');
            const trainingSelect = select.closest('.substitution-hours').querySelector('.substitution-training-hours');

            const teachingHours = parseFloat(teachingSelect.value) || 0;
            const trainingHours = parseFloat(trainingSelect.value) || 0;

            console.log('ğŸ”„ Substitution hours changed:', { date, period, deptName, teachingHours, trainingHours, entryIndex });

            // Save to Firebase
            await saveSubstitution(date, entryIndex, period, deptName, teachingHours, trainingHours);
        }

        // Save substitution to Firebase
        async function saveSubstitution(date, index, period, department, teachingHours, trainingHours) {
            try {
                console.log('ğŸ’¾ Saving substitution to Firebase:', { date, index, period, department, teachingHours, trainingHours });

                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Create substitution object
                const substitution = {
                    period: period,
                    department: department,
                    hours: {
                        teaching: teachingHours,
                        training: trainingHours
                    },
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                // Save to Firebase: timesheets/{email}/{year}/{month}/entries/{date}_substitution_{index}
                const substKey = `${date}_substitution_${index}`;
                const substRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${substKey}`);
                await set(substRef, substitution);

                // Update local state
                if (!currentTimesheet.entries) currentTimesheet.entries = {};
                currentTimesheet.entries[substKey] = substitution;

                console.log('âœ… Substitution saved successfully');

                // TODO: Update totals to include substitution hours

            } catch (error) {
                console.error('âŒ Error saving substitution:', error);
                showError('×©×’×™××” ×‘×©××™×¨×ª ×”×”×—×œ×¤×”');
            }
        }

        async function handleHoursChange(event) {
            const select = event.target;
            const type = select.dataset.type;
            const date = select.dataset.date;
            const period = select.dataset.period;
            const subject = select.dataset.subject;
            const newValue = parseFloat(select.value);
            const entryKey = `${date}_${period}_${subject}`;

            // Check if table is locked after submission - show popup ONLY if user hasn't edited yet after last submission
            console.log('DEBUG handleHoursChange:', { isTimesheetLocked, hasBeenSubmitted, hasSeenEditWarning });

            // First check: Has the user submitted to ANY coordinator?
            if (hasBeenSubmitted) {
                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Check if report was already sent to finance
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/financeSubmissions`);
                const financeSnapshot = await get(financeSubmissionsRef);

                // Check if user has already edited anything after the last submission
                const hasEditedAfterSubmission = sessionStorage.getItem(`hasEditedAfter_${currentYear}_${currentMonth}`);

                if (!hasEditedAfterSubmission) {
                    // This is the FIRST edit attempt after submission
                    if (financeSnapshot.exists()) {
                        // Report was already sent to finance - show special warning with reason requirement
                        showEditAfterFinanceModal(select, type, date, period, subject, newValue, entryKey);
                        return;
                    }

                    // Report was only sent to coordinator (not finance) - show regular warning
                    if (isTimesheetLocked) {
                        // Show regular warning popup
                        showRegularEditWarning(select, type, date, period, subject, newValue, entryKey);
                        return;
                    }
                }
            }

            // Normal processing (not locked or after unlock)
            await processHourChange(select, type, date, period, subject, newValue, entryKey);
        }

        // Show regular edit warning (after submission to coordinator but not to finance)
        function showRegularEditWarning(select, type, date, period, subject, newValue, entryKey) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 500px; text-align: center; border: 2px solid #f59e0b;';

            modalContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                    ×”×“×•×— ×›×‘×¨ ×©×•×’×¨!
                </h2>
                <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px;">
                    ×“×•×— ×”×©×¢×•×ª ×©×œ×š ×›×‘×¨ ×©×•×’×¨ ×œ×¨×›×–×™×.<br>
                    ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¢×¨×•×š ×•×œ×©×’×¨ ××—×“×©?
                </p>
                <p style="font-size: 14px; color: #f59e0b; margin-bottom: 24px;">
                    âš ï¸ ×©×™×’×•×¨ ××—×“×© ×™×©×œ×— ×”×ª×¨××ª ××™×™×œ ×œ×›×œ ×”×¨×›×–×™×
                </p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="cancelEditBtn" class="btn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                        ×‘×™×˜×•×œ
                    </button>
                    <button id="confirmEditBtn" class="btn btn-primary" style="padding: 12px 24px;">
                        ×›×Ÿ, ×× ×™ ×¨×•×¦×” ×œ×¢×¨×•×š
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                loadMonthlyTimesheet(currentYear, currentMonth);
            });

            // Confirm button
            document.getElementById('confirmEditBtn').addEventListener('click', async () => {
                document.body.removeChild(modal);

                // Mark that user has edited after submission - no more popups in this month
                sessionStorage.setItem(`hasEditedAfter_${currentYear}_${currentMonth}`, 'true');
                console.log('âœ… User confirmed edit after coordinator submission');

                // Unlock the table
                isTimesheetLocked = false;
                removeLockNotification();

                // Process this change and continue normally
                await processHourChange(select, type, date, period, subject, newValue, entryKey);
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    loadMonthlyTimesheet(currentYear, currentMonth);
                }
            });
        }

        // Separate function to process the hour change
        async function processHourChange(select, type, date, period, subject, newValue, entryKey) {
            try {
                showLoading(true);

                // Save current state to undo stack BEFORE making changes
                saveStateToUndoStack();

                // Create backup
                await createBackup(`×©×™× ×•×™ ${newValue} ×©×¢×•×ª ${type === 'teaching' ? '×”×“×¨×›×”' : '×”×©×ª×œ××•×ª'} ×‘-${date} ×‘${subject}`, {
                    year: currentYear,
                    month: currentMonth,
                    entries: currentTimesheet.entries || {}
                });

                let entry = currentTimesheet.entries?.[entryKey] || {
                    date, period, subject,
                    hours: { teaching: 0, training: 0 }
                };

                // Store the old value BEFORE changing
                const oldValue = entry.hours[type];

                // Check if this is an edit after submission to coordinator
                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Check all coordinators to see if report was submitted
                let wasSubmittedToCoordinator = false;
                for (const [coordEmail, userData] of Object.entries(userRoles)) {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        const isAssigned = userData.assignedInstructors.some(assignment => {
                            const assignmentEmail = typeof assignment === 'string' ? assignment : assignment.email;
                            return assignmentEmail === currentUser.email;
                        });
                        if (isAssigned) {
                            const sanitizedCoordEmail = sanitizeEmail(coordEmail);
                            const submissionRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions/${sanitizedCoordEmail}`);
                            const snapshot = await get(submissionRef);
                            if (snapshot.exists()) {
                                wasSubmittedToCoordinator = true;
                                break;
                            }
                        }
                    }
                }

                // If this is an edit after submission, track the change
                // Fixed: Use parseFloat for comparison to handle decimal values (0.5, 1.5, etc.)
                if (wasSubmittedToCoordinator && parseFloat(oldValue) !== parseFloat(newValue)) {
                    // Initialize changes tracking if doesn't exist
                    if (!entry.changes) entry.changes = {};

                    // Track this specific change - ensure values are stored as numbers
                    entry.changes[type] = {
                        oldValue: parseFloat(oldValue) || 0,
                        newValue: parseFloat(newValue) || 0,
                        changedAt: Date.now()
                    };

                    entry.hasChanges = true; // Flag that this entry has changes
                }

                // Ensure the new value is stored as a number, not a string
                entry.hours[type] = parseFloat(newValue) || 0;
                entry.updatedAt = Date.now();

                const entryRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${entryKey}`);
                await set(entryRef, entry);

                // Update local state immediately
                if (!currentTimesheet.entries) currentTimesheet.entries = {};
                currentTimesheet.entries[entryKey] = entry;

                // Find which coordinator is responsible for this subject and period
                // and mark them for resubmit if they already have a submission
                for (const [coordEmail, userData] of Object.entries(userRoles)) {
                    if (userData.role === 'coordinator' && userData.assignedInstructors) {
                        // Check if this coordinator has this instructor assigned
                        const isAssigned = userData.assignedInstructors.some(assignment => {
                            const assignmentEmail = typeof assignment === 'string' ? assignment : assignment.email;
                            return assignmentEmail === currentUser.email;
                        });

                        if (isAssigned) {
                            // Check if this coordinator manages this subject in this period
                            const coordSubjectsForPeriod = userData.subjects?.[period] || [];

                            if (coordSubjectsForPeriod.includes(subject)) {
                                // This coordinator manages this subject - check if they have a submission
                                const sanitizedCoordEmail = sanitizeEmail(coordEmail);
                                const submissionRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions/${sanitizedCoordEmail}`);
                                const snapshot = await get(submissionRef);

                                if (snapshot.exists()) {
                                    // Mark this coordinator for resubmit
                                    needsResubmitTo[coordEmail] = true;
                                    console.log(`Marking ${coordEmail} for resubmit (manages ${subject} in ${period})`);
                                }
                            }
                        }
                    }
                }

                // Keep edit state - don't reset lock variables
                // loadMonthlyTimesheet will call generateSubmitButtons automatically
                await loadMonthlyTimesheet(currentYear, currentMonth, true);

                showSuccess('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”');

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×');
            } finally {
                showLoading(false);
            }
        }

        // Handle notes changes
        async function handleNotesChange(event) {
            const input = event.target;
            const date = input.dataset.date;
            const notesValue = input.value.trim();
            const notesKey = `${date}_notes`;

            try {
                // Create entry object for notes
                const notesEntry = {
                    date: date,
                    notes: notesValue,
                    updatedAt: Date.now()
                };

                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const entryRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${notesKey}`);
                await set(entryRef, notesEntry);

                // Update local state immediately
                if (!currentTimesheet.entries) currentTimesheet.entries = {};
                currentTimesheet.entries[notesKey] = notesEntry;

                console.log(`Notes saved for ${date}:`, notesValue);

            } catch (error) {
                console.error('Error saving notes:', error);
                showError('×©×’×™××” ×‘×©××™×¨×ª ×”×”×¢×¨×•×ª');
            }
        }

        function updateMonthlySummary() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';

            const subjectSummary = {};
            let totalTeaching = 0;
            let totalTraining = 0;
            let substitutionsTeaching = 0;
            let substitutionsTraining = 0;

            if (currentTimesheet.entries) {
                Object.entries(currentTimesheet.entries).forEach(([key, entry]) => {
                    // Handle substitution entries separately
                    if (key.includes('_substitution_')) {
                        substitutionsTeaching += entry.hours?.teaching || 0;
                        substitutionsTraining += entry.hours?.training || 0;
                        totalTeaching += entry.hours?.teaching || 0;
                        totalTraining += entry.hours?.training || 0;
                        return;
                    }

                    // Skip notes entries (they don't have hours/subject)
                    if (!entry.hours || !entry.subject) return;

                    const subject = entry.subject;
                    if (!subjectSummary[subject]) {
                        subjectSummary[subject] = { teaching: 0, training: 0 };
                    }
                    subjectSummary[subject].teaching += entry.hours.teaching || 0;
                    subjectSummary[subject].training += entry.hours.training || 0;
                    totalTeaching += entry.hours.teaching || 0;
                    totalTraining += entry.hours.training || 0;
                });
            }

            Object.entries(subjectSummary).forEach(([subject, hours]) => {
                tbody.innerHTML += `<tr>
                    <td>${subject}</td>
                    <td><span style="color: #f97316; font-weight: 700;">${hours.teaching}</span></td>
                    <td><span style="color: #34ebbd; font-weight: 700;">${hours.training}</span></td>
                    <td>${hours.teaching + hours.training}</td>
                </tr>`;
            });

            // Add substitutions row if there are any
            if (substitutionsTeaching > 0 || substitutionsTraining > 0) {
                tbody.innerHTML += `<tr style="background: rgba(139, 92, 246, 0.1);">
                    <td style="font-weight: 600;">×”×—×œ×¤×•×ª</td>
                    <td><span style="color: #f97316; font-weight: 700;">${substitutionsTeaching}</span></td>
                    <td><span style="color: #34ebbd; font-weight: 700;">${substitutionsTraining}</span></td>
                    <td>${substitutionsTeaching + substitutionsTraining}</td>
                </tr>`;
            }

            document.getElementById('totalTeaching').innerHTML = `<span style="color: #f97316; font-weight: 700; font-size: 16px;">${totalTeaching}</span>`;
            document.getElementById('totalTraining').innerHTML = `<span style="color: #34ebbd; font-weight: 700; font-size: 16px;">${totalTraining}</span>`;
            document.getElementById('totalHours').textContent = totalTeaching + totalTraining;
        }

        async function generateSubmitButtons() {
            const container = document.getElementById('submitButtons');
            container.innerHTML = '';

            // Find all coordinators that have this instructor assigned
            const myCoordinators = [];
            Object.entries(userRoles).forEach(([email, userData]) => {
                if (userData.role === 'coordinator' && userData.assignedInstructors) {
                    const isAssigned = userData.assignedInstructors.some(assignment => {
                        const assignmentEmail = typeof assignment === 'string' ? assignment : assignment.email;
                        return assignmentEmail === currentUser.email;
                    });
                    if (isAssigned) {
                        myCoordinators.push(email);
                    }
                }
            });

            if (myCoordinators.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af;">××™×Ÿ ×¨×›×–×™× ××©×•×™×›×™×</p>';
                return;
            }

            for (const coordinatorEmail of myCoordinators) {
                const btn = document.createElement('button');
                btn.className = 'submit-btn';

                // Get coordinator name
                const coordinatorName = userRoles[coordinatorEmail]?.fullName || coordinatorEmail;

                // Check if already submitted
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);
                const submissionRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions/${sanitizedCoordEmail}`);

                try {
                    const snapshot = await get(submissionRef);

                    if (snapshot.exists() && !needsResubmitTo[coordinatorEmail]) {
                        // Already submitted and this coordinator does NOT need resubmit - show as submitted
                        const submissionData = snapshot.val();
                        const submittedAt = new Date(submissionData.submittedAt);
                        const dateStr = submittedAt.toLocaleDateString('he-IL');
                        const timeStr = submittedAt.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

                        btn.textContent = `âœ… ×©×•×’×¨ ×œ${coordinatorName} ×‘-${dateStr} ×‘×©×¢×” ${timeStr}`;
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                        btn.style.background = 'rgba(34, 197, 94, 0.2)';
                        btn.style.color = '#22c55e';
                    } else if (snapshot.exists() && needsResubmitTo[coordinatorEmail]) {
                        // Already submitted BUT this specific coordinator needs resubmit - show as resubmit
                        btn.textContent = `ğŸ”„ ×©×’×¨ ××—×“×© ×œ${coordinatorName}`;
                        btn.className = 'submit-btn btn-primary';
                        btn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                        btn.style.borderColor = '#d97706';
                        btn.addEventListener('click', () => submitToCoordinator(coordinatorEmail));
                    } else {
                        // Not submitted yet - normal submit button
                        btn.textContent = `×©×’×¨ ×œ${coordinatorName}`;
                        btn.addEventListener('click', () => submitToCoordinator(coordinatorEmail));
                    }
                } catch (error) {
                    console.error('Error checking submission status:', error);
                    btn.textContent = `×©×’×¨ ×œ${coordinatorName}`;
                    btn.addEventListener('click', () => submitToCoordinator(coordinatorEmail));
                }

                container.appendChild(btn);
            }

            // Add "×©×’×¨ ×”×—×œ×¤×•×ª" button if there are any substitutions
            const substitutionKeys = currentTimesheet.entries ? Object.keys(currentTimesheet.entries).filter(key => key.includes('_substitution_')) : [];
            const hasSubstitutions = substitutionKeys.length > 0;

            if (hasSubstitutions) {
                // Check if all substitutions are submitted
                const allSubmitted = substitutionKeys.every(key => currentTimesheet.entries[key].submitted === true);

                // Add separator
                const separator = document.createElement('div');
                separator.style.cssText = 'width: 100%; height: 1px; background: var(--border-color); margin: 20px 0;';
                container.appendChild(separator);

                // Add substitutions submit button
                const substBtn = document.createElement('button');
                substBtn.className = 'submit-btn';

                if (allSubmitted) {
                    // All substitutions submitted - show as submitted
                    substBtn.textContent = 'âœ… ×”×—×œ×¤×•×ª ×©×•×’×¨×•';
                    substBtn.disabled = true;
                    substBtn.style.cssText = 'background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.3); color: #22c55e; opacity: 0.6; cursor: not-allowed;';
                } else {
                    // Not all submitted - show submit button
                    substBtn.style.cssText = 'background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%); border-color: rgba(139, 92, 246, 0.5);';
                    substBtn.textContent = 'ğŸ“‹ ×©×’×¨ ×”×—×œ×¤×•×ª';
                    substBtn.addEventListener('click', openSubstitutionsSubmitModal);
                }

                container.appendChild(substBtn);
            }
        }

        // Open modal to select and submit substitutions
        function openSubstitutionsSubmitModal() {
            // Collect all substitutions from current timesheet
            const allSubstitutions = [];
            if (currentTimesheet.entries) {
                Object.entries(currentTimesheet.entries).forEach(([key, entry]) => {
                    if (key.includes('_substitution_')) {
                        const date = key.split('_substitution_')[0];
                        allSubstitutions.push({
                            key: key,
                            date: date,
                            department: entry.department,
                            period: entry.period,
                            hours: entry.hours,
                            alreadySubmitted: entry.submitted || false
                        });
                    }
                });
            }

            if (allSubstitutions.length === 0) {
                showError('×œ× × ××¦××• ×”×—×œ×¤×•×ª ×œ×©×™×’×•×¨');
                return;
            }

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;';

            // Header
            const header = document.createElement('h2');
            header.textContent = '×‘×—×¨ ×”×—×œ×¤×•×ª ×œ×©×™×’×•×¨';
            header.style.cssText = 'font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; text-align: center;';
            modalContent.appendChild(header);

            const subtitle = document.createElement('p');
            subtitle.textContent = '×‘×—×¨ ××ª ×”×”×—×œ×¤×•×ª ×©×‘×¨×¦×•× ×š ×œ×©×’×¨ ×œ×¨×›×–×™ ×”××—×œ×§×•×ª ×”×¨×œ×•×•× ×˜×™×™×';
            subtitle.style.cssText = 'font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; text-align: center;';
            modalContent.appendChild(subtitle);

            // Select all checkbox
            const selectAllContainer = document.createElement('div');
            selectAllContainer.style.cssText = 'margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; display: flex; align-items: center; gap: 8px;';
            selectAllContainer.innerHTML = `
                <input type="checkbox" id="selectAllSubstitutions" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="selectAllSubstitutions" style="font-weight: 600; color: var(--text-primary); cursor: pointer;">×‘×—×¨ ×”×›×œ</label>
            `;
            modalContent.appendChild(selectAllContainer);

            // Substitutions list
            const listContainer = document.createElement('div');
            listContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;';

            allSubstitutions.forEach((subst, index) => {
                const substItem = document.createElement('div');
                substItem.className = 'substitution-item';
                substItem.style.cssText = 'padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; gap: 12px;' + (subst.alreadySubmitted ? ' opacity: 0.6;' : '');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'substitution-checkbox';
                checkbox.dataset.key = subst.key;
                checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                checkbox.checked = !subst.alreadySubmitted;
                checkbox.disabled = subst.alreadySubmitted;

                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'flex: 1;';

                const dateDiv = document.createElement('div');
                dateDiv.textContent = `×ª××¨×™×š: ${subst.date}`;
                dateDiv.style.cssText = 'font-weight: 600; color: var(--text-primary); margin-bottom: 4px;';

                const deptDiv = document.createElement('div');
                deptDiv.textContent = `××—×œ×§×”: ${subst.department} (${subst.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})`;
                deptDiv.style.cssText = 'font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;';

                const hoursDiv = document.createElement('div');
                hoursDiv.innerHTML = `×©×¢×•×ª: <span style="color: #f97316;">${subst.hours.teaching || 0} ×”×“×¨×›×”</span> | <span style="color: #34ebbd;">${subst.hours.training || 0} ×”×©×ª×œ××•×ª</span>`;
                hoursDiv.style.cssText = 'font-size: 13px; color: var(--text-secondary);';

                infoDiv.appendChild(dateDiv);
                infoDiv.appendChild(deptDiv);
                infoDiv.appendChild(hoursDiv);

                if (subst.alreadySubmitted) {
                    const submittedLabel = document.createElement('div');
                    submittedLabel.textContent = 'âœ… ×©×•×’×¨';
                    submittedLabel.style.cssText = 'font-size: 12px; color: #22c55e; font-weight: 600;';
                    infoDiv.appendChild(submittedLabel);
                }

                substItem.appendChild(checkbox);
                substItem.appendChild(infoDiv);
                listContainer.appendChild(substItem);
            });

            modalContent.appendChild(listContainer);

            // Buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.cssText = 'display: flex; gap: 12px; justify-content: center;';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '×‘×™×˜×•×œ';
            cancelBtn.style.cssText = 'padding: 12px 24px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 600;';
            cancelBtn.onclick = () => document.body.removeChild(modal);

            const submitBtn = document.createElement('button');
            submitBtn.textContent = '×©×’×¨ ×”×—×œ×¤×•×ª × ×‘×—×¨×•×ª';
            submitBtn.style.cssText = 'padding: 12px 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;';
            submitBtn.onclick = () => submitSelectedSubstitutions(modal, allSubstitutions);

            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(submitBtn);
            modalContent.appendChild(buttonsDiv);

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle select all
            const selectAllCheckbox = document.getElementById('selectAllSubstitutions');
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = listContainer.querySelectorAll('.substitution-checkbox:not([disabled])');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        // Submit selected substitutions to relevant coordinators
        async function submitSelectedSubstitutions(modal, allSubstitutions) {
            const checkboxes = modal.querySelectorAll('.substitution-checkbox:checked');
            if (checkboxes.length === 0) {
                showError('×œ× × ×‘×—×¨×• ×”×—×œ×¤×•×ª ×œ×©×™×’×•×¨');
                return;
            }

            const selectedKeys = Array.from(checkboxes).map(cb => cb.dataset.key);
            const selectedSubstitutions = allSubstitutions.filter(s => selectedKeys.includes(s.key));

            try {
                // First, check if all substitutions have coordinators
                const substitutionsWithoutCoordinator = [];

                for (const subst of selectedSubstitutions) {
                    let coordinatorEmail = null;

                    Object.entries(userRoles).forEach(([email, userData]) => {
                        if (userData.role === 'coordinator' && userData.subjects) {
                            let hasSubject = false;

                            if (Array.isArray(userData.subjects)) {
                                hasSubject = userData.subjects.some(s =>
                                    s.name === subst.department && s.period === subst.period
                                );
                            } else if (typeof userData.subjects === 'object') {
                                const periodSubjects = userData.subjects[subst.period] || [];
                                hasSubject = periodSubjects.includes(subst.department);
                            }

                            if (hasSubject) {
                                coordinatorEmail = email;
                            }
                        }
                    });

                    if (!coordinatorEmail) {
                        substitutionsWithoutCoordinator.push(subst);
                    }
                }

                // If there are substitutions without coordinator, show warning
                if (substitutionsWithoutCoordinator.length > 0) {
                    const deptList = substitutionsWithoutCoordinator.map(s => `${s.department} (${s.period === 'morning' ? '×‘×•×§×¨' : '××—×”×´×¦'})`).join(', ');
                    const confirmMsg = `âš ï¸ ×œ× × ××¦× ×¨×›×– ×¢×‘×•×¨ ×”××—×œ×§×•×ª ×”×‘××•×ª:\n${deptList}\n\n×”×”×—×œ×¤×•×ª ×”×œ×œ×• ×™×™×©××¨×• ××š ×œ× ×™×™×©×œ×—×• ×œ×¨×›×– ×¡×¤×¦×™×¤×™.\n×”×× ×œ×”××©×™×š?`;

                    if (!confirm(confirmMsg)) {
                        return; // User cancelled
                    }
                }

                // Group substitutions by department coordinator
                const substByCoordinator = {};

                for (const subst of selectedSubstitutions) {
                    // Find coordinator for this department
                    let coordinatorEmail = null;

                    console.log(`ğŸ” Looking for coordinator for: ${subst.department} (${subst.period})`);

                    Object.entries(userRoles).forEach(([email, userData]) => {
                        if (userData.role === 'coordinator' && userData.subjects) {
                            let hasSubject = false;

                            // Handle both array format and object format {morning: [], afternoon: []}
                            if (Array.isArray(userData.subjects)) {
                                console.log(`  Checking coordinator ${email} (array format):`, userData.subjects);
                                hasSubject = userData.subjects.some(s =>
                                    s.name === subst.department && s.period === subst.period
                                );
                            } else if (typeof userData.subjects === 'object') {
                                const periodSubjects = userData.subjects[subst.period] || [];
                                console.log(`  Checking coordinator ${email} (${subst.period}):`, periodSubjects);
                                hasSubject = periodSubjects.includes(subst.department);
                            }

                            if (hasSubject) {
                                console.log(`  âœ… Found coordinator: ${email}`);
                                coordinatorEmail = email;
                            }
                        }
                    });

                    if (!coordinatorEmail) {
                        console.warn(`âŒ No coordinator found for ${subst.department} (${subst.period})`);
                        console.log('Available coordinators:', Object.entries(userRoles).filter(([_, u]) => u.role === 'coordinator').map(([email, u]) => ({email, subjects: u.subjects})));

                        // Save to "unassigned" coordinator for substitutions without a coordinator
                        coordinatorEmail = 'unassigned';
                    }

                    if (!substByCoordinator[coordinatorEmail]) {
                        substByCoordinator[coordinatorEmail] = [];
                    }
                    substByCoordinator[coordinatorEmail].push(subst);
                }

                // Send to Firebase for each coordinator
                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Get instructor's full name from Firebase
                const instructorDataRef = ref(database, `users/${sanitizedEmail}`);
                const instructorSnapshot = await get(instructorDataRef);
                const instructorFullName = instructorSnapshot.exists() && instructorSnapshot.val().fullName
                    ? instructorSnapshot.val().fullName
                    : currentUser.displayName || currentUser.email;

                for (const [coordinatorEmail, substitutions] of Object.entries(substByCoordinator)) {
                    const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);

                    for (const subst of substitutions) {
                        // Create submission entry
                        const submissionData = {
                            instructorEmail: currentUser.email,
                            instructorName: instructorFullName,
                            date: subst.date,
                            department: subst.department,
                            period: subst.period,
                            hours: subst.hours,
                            submittedAt: Date.now(),
                            status: 'pending',
                            year: currentYear,
                            month: currentMonth
                        };

                        // Save to coordinator's substitutions
                        const substRef = ref(database, `substitutions/${sanitizedCoordEmail}/${currentYear}/${currentMonth}/${sanitizedEmail}_${subst.date}_${Date.now()}`);
                        await set(substRef, submissionData);

                        // Mark as submitted in instructor's timesheet
                        const instructorSubstRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries/${subst.key}/submitted`);
                        await set(instructorSubstRef, true);
                    }
                }

                // Update local timesheet data
                selectedSubstitutions.forEach(subst => {
                    if (currentTimesheet.entries[subst.key]) {
                        currentTimesheet.entries[subst.key].submitted = true;
                    }
                });

                showSuccess(`${selectedSubstitutions.length} ×”×—×œ×¤×•×ª ×©×•×’×¨×• ×‘×”×¦×œ×—×”`);
                document.body.removeChild(modal);

                // Reload submit buttons
                await generateSubmitButtons();

            } catch (error) {
                console.error('Error submitting substitutions:', error);
                showError('×©×’×™××” ×‘×©×™×’×•×¨ ×”×”×—×œ×¤×•×ª');
            }
        }

        // Show modal for resubmission when report was already sent to finance
        function showResubmitWithReasonModal(coordinatorEmail) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%;';

            modalContent.innerHTML = `
                <h2 style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 16px;">
                    âš ï¸ ×”×“×•×— ×›×‘×¨ × ×©×œ×— ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                </h2>
                <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px;">
                    ×“×•×— ×–×” ×›×‘×¨ ×©×•×’×¨ ×œ×× ×”×œ×ª ×”×›×¡×¤×™×. ×¢×œ ×× ×ª ×œ×©×’×¨ ××•×ª×• ××—×“×© ×œ×¨×›×–, ×™×© ×œ×¤×¨×˜ ××ª ×¡×™×‘×ª ×”×©×™× ×•×™.
                </p>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        ×¤×¨×˜ ××ª ×¡×™×‘×ª ×”×©×™× ×•×™: <span style="color: #ef4444;">*</span>
                    </label>
                    <textarea id="resubmitReason" rows="4"
                        style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
                        background: var(--bg-primary); color: var(--text-primary); font-size: 14px; resize: vertical;"
                        placeholder="×œ××©×œ: ×ª×™×§× ×ª×™ ×˜×¢×•×ª ×‘×ª××¨×™×š 15.11 - ×©×™× ×™×ª×™ ×-5 ×©×¢×•×ª ×œ-6 ×©×¢×•×ª ×”×“×¨×›×” ×‘××§×¦×•×¢ ××—×•× × ×™×"></textarea>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                        ×”×¡×™×‘×” ×ª×©×œ×— ×œ××™×™×œ ×”×¨×›×– ×•×”××“×¨×™×š ×™×¦×˜×¨×š ×œ××©×¨ ×¦×¤×™×” ×‘×©×™× ×•×™×™× ×œ×¤× ×™ ×©×œ×™×—×” ×œ×× ×”×œ×ª ×”×›×¡×¤×™×
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancelResubmitBtn" class="btn"
                        style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                        ×‘×™×˜×•×œ
                    </button>
                    <button id="confirmResubmitBtn" class="btn"
                        style="padding: 12px 24px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-color: #ea580c; color: white;">
                        ×©×œ×— ××—×“×© ×¢× ×¡×™×‘×”
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelResubmitBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Confirm button
            document.getElementById('confirmResubmitBtn').addEventListener('click', async () => {
                const reason = document.getElementById('resubmitReason').value.trim();
                if (!reason) {
                    showError('×™×© ×œ×¤×¨×˜ ××ª ×¡×™×‘×ª ×”×©×™× ×•×™');
                    return;
                }

                document.body.removeChild(modal);
                await submitToCoordinatorWithReason(coordinatorEmail, reason);
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Submit to coordinator with reason (when report was already sent to finance)
        async function submitToCoordinatorWithReason(coordinatorEmail, reason) {
            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);

                // Get existing submission data
                const submissionRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions/${sanitizedCoordEmail}`);
                const submissionSnapshot = await get(submissionRef);
                const existingSubmission = submissionSnapshot.exists() ? submissionSnapshot.val() : null;
                const resubmissionCount = (existingSubmission?.resubmissionCount || 0) + 1;

                // Update submission with reason and set needsReview flag
                await set(submissionRef, {
                    status: 'pending_review', // Changed from 'submitted' - coordinator needs to review
                    submittedAt: Date.now(),
                    resubmissionCount: resubmissionCount,
                    isResubmit: true,
                    resubmitReason: reason,
                    sentToFinance: true, // Mark that this was already sent to finance
                    needsCoordinatorReview: true // Coordinator must approve before sending to finance again
                });

                // Send email to coordinator with reason
                try {
                    const coordinatorData = userRoles[coordinatorEmail];
                    const coordinatorName = coordinatorData?.fullName || coordinatorEmail;
                    await sendResubmitWithReasonEmail(coordinatorEmail, coordinatorName, reason);
                    showSuccess(`×”×“×•×— × ×©×’×¨ ××—×“×© ×‘×”×¦×œ×—×” ×¢× ×¡×™×‘×ª ×”×©×™× ×•×™. ××™×™×œ × ×©×œ×— ×œ${coordinatorName}`);
                } catch (emailError) {
                    console.error('Email error:', emailError);
                    showSuccess('×”×“×•×— × ×©×’×¨ ××—×“×© ×‘×”×¦×œ×—×” (×©×œ×™×—×ª ×”××™×™×œ × ×›×©×œ×”)');
                }

                // Lock the table after submission
                hasBeenSubmitted = true;
                isTimesheetLocked = true;
                lockTimesheetTable(true);

                // Show lock notification banner
                showLockNotification();

                // Clear resubmit flag for this specific coordinator after successful submission
                needsResubmitTo[coordinatorEmail] = false;

                // Clear the edit flag so popup will show again if user edits after this resubmission
                sessionStorage.removeItem(`hasEditedAfter_${currentYear}_${currentMonth}`);
                sessionStorage.removeItem(`editReason_${currentYear}_${currentMonth}`);

                // Reload the submit buttons to show the new status
                await generateSubmitButtons();

                // Update export button state
                await updateExportButtonState();

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—');
            } finally {
                showLoading(false);
            }
        }

        async function submitToCoordinator(coordinatorEmail) {
            // Check if this specific coordinator needs a resubmission
            const isResubmit = needsResubmitTo[coordinatorEmail] || false;

            // Check if report was already sent to finance manager
            if (isResubmit) {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/financeSubmissions`);
                const financeSnapshot = await get(financeSubmissionsRef);

                if (financeSnapshot.exists()) {
                    // Report was already sent to finance - show special modal with reason input
                    showResubmitWithReasonModal(coordinatorEmail);
                    return;
                }
            }

            const confirmMessage = isResubmit
                ? '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×’×¨ ××—×“×© ××ª ×”×“×•×—?\n××™×™×œ ×™×™×©×œ×— ×œ×¨×›×– ×¢×œ ×”×¢×“×›×•×Ÿ.'
                : '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×’×¨ ××ª ×”×“×•×—?';

            if (!confirm(confirmMessage)) return;

            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const sanitizedCoordEmail = sanitizeEmail(coordinatorEmail);

                // Get existing submission data
                const submissionRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/submissions/${sanitizedCoordEmail}`);
                const submissionSnapshot = await get(submissionRef);
                const existingSubmission = submissionSnapshot.exists() ? submissionSnapshot.val() : null;
                const resubmissionCount = (existingSubmission?.resubmissionCount || 0) + (isResubmit ? 1 : 0);

                // Check if there's an edit reason (means report was sent to finance and instructor couldn't edit)
                const editReason = sessionStorage.getItem(`editReason_${currentYear}_${currentMonth}`);

                // Check if report was sent to finance
                const financeSubmissionsRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/financeSubmissions`);
                const financeSnapshot = await get(financeSubmissionsRef);
                const sentToFinance = financeSnapshot.exists();

                // Update submission - if resubmit, set to pending_review so coordinator can review changes
                const submissionData = {
                    status: isResubmit ? 'pending_review' : 'submitted',
                    submittedAt: Date.now(),
                    resubmissionCount: resubmissionCount,
                    isResubmit: isResubmit || false
                };

                // If this is a resubmit, add needsCoordinatorReview flag
                if (isResubmit) {
                    submissionData.needsCoordinatorReview = true;
                    // If there's a reason (sent to finance case), add it
                    if (editReason) {
                        submissionData.resubmitReason = editReason;
                        submissionData.sentToFinance = true;
                    }
                }

                await set(submissionRef, submissionData);

                // If this is a resubmission, send email to coordinator
                if (isResubmit) {
                    try {
                        const coordinatorData = userRoles[coordinatorEmail];
                        const coordinatorName = coordinatorData?.fullName || coordinatorEmail;
                        await sendResubmitEmail(coordinatorEmail, coordinatorName);
                        showSuccess(`×”×“×•×— × ×©×’×¨ ××—×“×© ×‘×”×¦×œ×—×” ×•××™×™×œ × ×©×œ×— ×œ${coordinatorName}`);
                    } catch (emailError) {
                        console.error('Email error:', emailError);
                        showSuccess('×”×“×•×— × ×©×’×¨ ××—×“×© ×‘×”×¦×œ×—×” (×©×œ×™×—×ª ×”××™×™×œ × ×›×©×œ×”)');
                    }
                } else {
                    showSuccess('×”×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×”');
                }

                // Lock the table after submission
                hasBeenSubmitted = true;
                isTimesheetLocked = true;
                lockTimesheetTable(true);
                console.log('ğŸ”’ Locked timesheet after submission:', { hasBeenSubmitted, isTimesheetLocked, hasSeenEditWarning });

                // Show lock notification banner
                showLockNotification();

                // Clear resubmit flag for this specific coordinator after successful submission
                needsResubmitTo[coordinatorEmail] = false;

                // Clear the edit flags so popup will show again if user edits after this submission
                sessionStorage.removeItem(`hasEditedAfter_${currentYear}_${currentMonth}`);
                sessionStorage.removeItem(`editReason_${currentYear}_${currentMonth}`);

                // Reload the submit buttons to show the new status
                await generateSubmitButtons();

                // Update export button state
                await updateExportButtonState();

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—');
            } finally {
                showLoading(false);
            }
        }

        // Approve changes in report (Coordinator function)
        window.approveChanges = async function(instructorEmail, year, month) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××©×¨ ××ª ×”×©×™× ×•×™×™×?\n\n×”×“×•×— ×™×•×¢×‘×¨ ×œ×¨×©×™××ª "×œ× ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™×" ×•×ª×•×›×œ ×œ×©×œ×•×— ××•×ª×• ×œ×× ×”×œ×ª ×”×›×¡×¤×™×.')) {
                return;
            }

            try {
                showLoading(true);
                const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);
                const sanitizedCoordEmail = sanitizeEmail(currentUser.email);

                // Clear all change tracking from entries
                const entriesRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/entries`);
                const entriesSnapshot = await get(entriesRef);

                if (entriesSnapshot.exists()) {
                    const entries = entriesSnapshot.val();
                    const updates = {};

                    // Remove changes and hasChanges flags from all entries
                    Object.keys(entries).forEach(entryKey => {
                        const entry = entries[entryKey];
                        if (entry.hasChanges || entry.changes) {
                            updates[entryKey] = {
                                ...entry,
                                hasChanges: null, // Delete the flag
                                changes: null // Delete the changes tracking
                            };
                        }
                    });

                    // Update all entries at once
                    if (Object.keys(updates).length > 0) {
                        for (const [entryKey, entryData] of Object.entries(updates)) {
                            const entryRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/entries/${entryKey}`);
                            await set(entryRef, entryData);
                        }
                    }
                }

                // Update submission status back to 'submitted' and clear pending review flags
                const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${year}/${month}/submissions/${sanitizedCoordEmail}`);
                const submissionSnapshot = await get(submissionRef);

                if (submissionSnapshot.exists()) {
                    const submissionData = submissionSnapshot.val();
                    await set(submissionRef, {
                        ...submissionData,
                        status: 'submitted',
                        needsCoordinatorReview: false,
                        reviewedAt: Date.now(),
                        reviewedBy: currentUser.email
                    });

                    showSuccess('×”×©×™× ×•×™×™× ××•×©×¨×• ×‘×”×¦×œ×—×”. ×”×“×•×— ×”×•×¢×‘×¨ ×œ×¨×©×™××ª "×œ× ×©×•×’×¨ ×œ×× ×”×œ×ª ×›×¡×¤×™×".');

                    // Reload the reports to move card to correct list
                    await loadInstructorReports();
                } else {
                    showError('×œ× × ××¦× ×“×•×— ×œ××™×©×•×¨');
                }
            } catch (error) {
                console.error('Error approving changes:', error);
                showError('×©×’×™××” ×‘××™×©×•×¨ ×”×©×™× ×•×™×™×');
            } finally {
                showLoading(false);
            }
        };

        // Personal Data
        function updatePersonalDataTab() {
            document.getElementById('personalName').textContent = currentUserData.fullName;
            document.getElementById('personalEmail').textContent = currentUser.email;

            // Get subjects from coordinators that this instructor is assigned to
            const morningSubjects = new Set();
            const afternoonSubjects = new Set();
            const coordinatorsList = [];

            // Find all coordinators that have this instructor assigned
            Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                if (coordData.role === 'coordinator' && coordData.assignedInstructors) {
                    const assignment = coordData.assignedInstructors.find(
                        inst => (typeof inst === 'string' ? inst : inst.email) === currentUser.email
                    );

                    if (assignment) {
                        const coordName = coordData.fullName || coordEmail;
                        coordinatorsList.push(coordName);

                        // Get the subjects assigned to this instructor from this coordinator
                        const subjects = typeof assignment === 'string' ? [] : (assignment.subjects || []);

                        // Categorize subjects by time of day - check in coordinator's subjects structure
                        subjects.forEach(subject => {
                            if (coordData.subjects?.morning?.includes(subject)) {
                                morningSubjects.add(subject);
                            } else if (coordData.subjects?.afternoon?.includes(subject)) {
                                afternoonSubjects.add(subject);
                            }
                        });
                    }
                }
            });

            const morningList = document.getElementById('morningSubjects');
            morningList.innerHTML = morningSubjects.size > 0
                ? Array.from(morningSubjects).map(s => `<li>${s}</li>`).join('')
                : '<li>×œ× ××•×’×“×¨</li>';

            const afternoonList = document.getElementById('afternoonSubjects');
            afternoonList.innerHTML = afternoonSubjects.size > 0
                ? Array.from(afternoonSubjects).map(s => `<li>${s}</li>`).join('')
                : '<li>×œ× ××•×’×“×¨</li>';

            const coordList = document.getElementById('assignedCoordinators');
            coordList.innerHTML = coordinatorsList.length > 0
                ? coordinatorsList.map(c => `<li>${c}</li>`).join('')
                : '<li>××™×Ÿ ×¨×›×–×™× ××©×•×™×›×™×</li>';
        }

        // Backups
        async function createBackup(action, data) {
            try {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const backupRef = push(ref(database, `backups/${sanitizedEmail}`));
                await set(backupRef, {
                    timestamp: Date.now(),
                    action: action,
                    data: data,
                    automatic: true
                });
                
                const backupsRef = ref(database, `backups/${sanitizedEmail}`);
                const snapshot = await get(backupsRef);
                
                if (snapshot.exists()) {
                    const backups = snapshot.val();
                    const backupsList = Object.entries(backups).sort((a, b) => b[1].timestamp - a[1].timestamp);
                    
                    if (backupsList.length > 10) {
                        for (let i = 10; i < backupsList.length; i++) {
                            await set(ref(database, `backups/${sanitizedEmail}/${backupsList[i][0]}`), null);
                        }
                    }
                }
            } catch (error) {
                console.error('Error creating backup:', error);
            }
        }

        async function loadBackups() {
            try {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const backupsRef = ref(database, `backups/${sanitizedEmail}`);
                const snapshot = await get(backupsRef);
                
                const container = document.getElementById('backupsList');
                container.innerHTML = '';
                
                if (snapshot.exists()) {
                    const backups = snapshot.val();
                    const backupsArray = Object.entries(backups).sort((a, b) => b[1].timestamp - a[1].timestamp).slice(0, 10);
                    
                    backupsArray.forEach(([id, backup]) => {
                        const item = document.createElement('div');
                        item.className = 'backup-item';
                        item.innerHTML = `
                            <div class="backup-info">
                                <div class="backup-action">${backup.action}</div>
                                <div class="backup-date">${new Date(backup.timestamp).toLocaleString('he-IL')}</div>
                            </div>
                            <button class="restore-btn" onclick="restoreBackup('${id}', '${backup.action}')">â†©ï¸ ×©×—×–×¨</button>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div class="no-backups">××™×Ÿ ×’×™×‘×•×™×™× ×–××™× ×™× ×›×¨×’×¢</div>';
                }
            } catch (error) {
                console.error('Error loading backups:', error);
            }
        }

        window.restoreBackup = async function(backupId, action) {
            if (!confirm(`×”×× ×œ×©×—×–×¨: "${action}"?`)) return;
            
            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const backupRef = ref(database, `backups/${sanitizedEmail}/${backupId}`);
                const snapshot = await get(backupRef);
                
                if (snapshot.exists()) {
                    const backupData = snapshot.val();
                    const { year, month, entries } = backupData.data;
                    const timesheetRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}`);
                    await set(timesheetRef, { entries });
                    
                    showSuccess('×”×’×™×‘×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”');
                    await loadMonthlyTimesheet(currentYear, currentMonth);
                    await loadBackups();
                }
            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×©×—×–×•×¨');
            } finally {
                showLoading(false);
            }
        };

        // Toggle backups list visibility
        window.toggleBackupsList = function toggleBackupsList() {
            const backupsList = document.getElementById('backupsList');
            const toggleIcon = document.getElementById('backupsToggleIcon');

            if (backupsList.style.display === 'none') {
                backupsList.style.display = 'block';
                toggleIcon.textContent = 'â–²';
            } else {
                backupsList.style.display = 'none';
                toggleIcon.textContent = 'â–¼';
            }
        }

        // Export Instructor Timesheet Button
        document.getElementById('exportInstructorTimesheetBtn')?.addEventListener('click', async () => {
            if (document.getElementById('exportInstructorTimesheetBtn').disabled) return;
            await exportOwnTimesheet();
        });

        // Month Navigation
        document.getElementById('prevMonthBtn').addEventListener('click', async () => {
            currentMonth--;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            await loadMonthlyTimesheet(currentYear, currentMonth);
            await updateExportButtonState();
        });

        document.getElementById('nextMonthBtn').addEventListener('click', async () => {
            currentMonth++;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            await loadMonthlyTimesheet(currentYear, currentMonth);
            await updateExportButtonState();
        });

        // Coordinator Export Button
        document.getElementById('exportCoordReportsBtn')?.addEventListener('click', () => {
            document.getElementById('coordExportModal').style.display = 'flex';
        });

        // Close Coordinator Export Modal
        document.getElementById('closeCoordExportModal')?.addEventListener('click', () => {
            document.getElementById('coordExportModal').style.display = 'none';
        });

        // Confirm Coordinator Export
        document.getElementById('confirmCoordExportBtn')?.addEventListener('click', async () => {
            try {
                showLoading(true);

                const layoutType = document.querySelector('input[name="coordExportLayout"]:checked')?.value || 'single';
                const filterType = document.querySelector('input[name="coordExportFilter"]:checked')?.value || 'submitted';

                // Get instructor emails based on filter
                const coordEmail = currentUser.email;
                const sanitizedCoordEmail = sanitizeEmail(coordEmail);
                const instructorEmails = [];

                // Get all assigned instructors
                const coordData = userRoles[coordEmail];
                if (!coordData || !coordData.assignedInstructors) {
                    showError('×œ× × ××¦××• ××“×¨×™×›×™× ××©×•×™×›×™×');
                    showLoading(false);
                    return;
                }

                // Check each instructor for submissions
                for (const assignment of coordData.assignedInstructors) {
                    const instructorEmail = typeof assignment === 'string' ? assignment : assignment.email;
                    const sanitizedInstructorEmail = sanitizeEmail(instructorEmail);

                    // Check if instructor submitted to this coordinator
                    const submissionRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/submissions/${sanitizedCoordEmail}`);
                    const submissionSnapshot = await get(submissionRef);

                    if (submissionSnapshot.exists()) {
                        if (filterType === 'submitted') {
                            // Include all who submitted
                            instructorEmails.push(instructorEmail);
                        } else if (filterType === 'approved') {
                            // Only include those sent to finance
                            const financeSubmissionsRef = ref(database, `timesheets/${sanitizedInstructorEmail}/${coordReportYear}/${coordReportMonth}/financeSubmissions/${sanitizedCoordEmail}`);
                            const financeSnapshot = await get(financeSubmissionsRef);
                            if (financeSnapshot.exists()) {
                                instructorEmails.push(instructorEmail);
                            }
                        }
                    }
                }

                // Add substitution instructors to the list
                const timesheetsRef = ref(database, 'timesheets');
                const timesheetsSnapshot = await get(timesheetsRef);

                if (timesheetsSnapshot.exists()) {
                    const allTimesheets = timesheetsSnapshot.val();
                    const substitutionInstructors = new Set();

                    // Find all instructors with substitutions for this coordinator's departments
                    for (const [sanitizedEmail, instructorData] of Object.entries(allTimesheets)) {
                        const yearData = instructorData[coordReportYear];
                        if (!yearData) continue;

                        const monthData = yearData[coordReportMonth];
                        if (!monthData || !monthData.entries) continue;

                        const entries = monthData.entries;
                        const instructorEmail = Object.keys(userRoles).find(email => sanitizeEmail(email) === sanitizedEmail);
                        if (!instructorEmail) continue;

                        // Skip if already in the regular instructors list
                        if (instructorEmails.includes(instructorEmail)) continue;

                        // Check if this instructor has substitutions in coordinator's departments
                        const coordDepartments = getAllUserSubjects(coordData);
                        let hasSubstitutions = false;

                        Object.entries(entries).forEach(([key, entry]) => {
                            if (key.includes('_substitution_') && coordDepartments.includes(entry.department)) {
                                hasSubstitutions = true;
                            }
                        });

                        if (hasSubstitutions) {
                            substitutionInstructors.add(instructorEmail);
                        }
                    }

                    // Add substitution instructors to the end of the list
                    instructorEmails.push(...Array.from(substitutionInstructors));
                }

                if (instructorEmails.length === 0) {
                    const filterText = filterType === 'submitted' ? '×©×©×™×’×¨×• ××œ×™×š' : '×©×©×™×’×¨×ª ×œ×× ×”×œ×ª ×”×›×¡×¤×™×';
                    showError(`×œ× × ××¦××• ××“×¨×™×›×™× ${filterText}`);
                    showLoading(false);
                    return;
                }

                // Close modal
                document.getElementById('coordExportModal').style.display = 'none';

                // Get coordinator's departments to filter substitutions
                const coordDepartments = getAllUserSubjects(coordData);

                // Export using existing function - pass coordinator departments
                await exportInstructorsToExcel(instructorEmails, coordReportYear, coordReportMonth, null, layoutType, coordDepartments);

                showLoading(false);
            } catch (error) {
                console.error('Error exporting:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×”×“×•×—×•×ª');
                showLoading(false);
            }
        });

        // Coordinator Month Navigation
        document.getElementById('coordPrevMonthBtn').addEventListener('click', () => {
            coordReportMonth--;
            if (coordReportMonth < 1) { coordReportMonth = 12; coordReportYear--; }
            loadInstructorReports();
            loadSubstitutionInstructors();
        });

        document.getElementById('coordNextMonthBtn').addEventListener('click', () => {
            coordReportMonth++;
            if (coordReportMonth > 12) { coordReportMonth = 1; coordReportYear++; }
            loadInstructorReports();
            loadSubstitutionInstructors();
        });

        // Submit to Finance button for regular instructors
        document.getElementById('submitToFinanceBtn').addEventListener('click', submitToFinance);

        // Submit to Finance button for substitution instructors
        const submitSubstitutionsBtn = document.getElementById('submitSubstitutionsToFinanceBtnMain');
        if (submitSubstitutionsBtn) {
            submitSubstitutionsBtn.addEventListener('click', submitAllSubstitutionsToFinance);
        }

        // Finance month navigation
        document.getElementById('financePrevMonthBtn').addEventListener('click', () => {
            // Close any open report
            const reportDiv = document.getElementById('selectedInstructorReport');
            if (reportDiv) {
                reportDiv.style.display = 'none';
                reportDiv.innerHTML = '';
            }

            financeReportMonth--;
            if (financeReportMonth < 1) { financeReportMonth = 12; financeReportYear--; }
            loadFinanceReports();
        });

        document.getElementById('financeNextMonthBtn').addEventListener('click', () => {
            // Close any open report
            const reportDiv = document.getElementById('selectedInstructorReport');
            if (reportDiv) {
                reportDiv.style.display = 'none';
                reportDiv.innerHTML = '';
            }

            financeReportMonth++;
            if (financeReportMonth > 12) { financeReportMonth = 1; financeReportYear++; }
            loadFinanceReports();
        });

        // Department reports month navigation
        // Calculate default month: if before the 5th of the month, default to previous month
        const deptToday = new Date();
        const deptDayOfMonth = deptToday.getDate();
        let departmentReportYear = deptToday.getFullYear();
        let departmentReportMonth = deptToday.getMonth() + 1;

        if (deptDayOfMonth < 5) {
            // Before the 5th - use previous month
            departmentReportMonth--;
            if (departmentReportMonth === 0) {
                departmentReportMonth = 12;
                departmentReportYear--;
            }
        }

        document.getElementById('departmentPrevMonthBtn').addEventListener('click', () => {
            departmentReportMonth--;
            if (departmentReportMonth < 1) { departmentReportMonth = 12; departmentReportYear--; }
            loadDepartmentReports();
        });

        document.getElementById('departmentNextMonthBtn').addEventListener('click', () => {
            departmentReportMonth++;
            if (departmentReportMonth > 12) { departmentReportMonth = 1; departmentReportYear++; }
            loadDepartmentReports();
        });

        // Export reports month navigation
        // Calculate default month: if before the 5th of the month, default to previous month
        const exportToday = new Date();
        const exportDayOfMonth = exportToday.getDate();
        let exportReportYear = exportToday.getFullYear();
        let exportReportMonth = exportToday.getMonth() + 1;

        if (exportDayOfMonth < 5) {
            // Before the 5th - use previous month
            exportReportMonth--;
            if (exportReportMonth === 0) {
                exportReportMonth = 12;
                exportReportYear--;
            }
        }

        document.getElementById('exportPrevMonthBtn').addEventListener('click', () => {
            exportReportMonth--;
            if (exportReportMonth < 1) { exportReportMonth = 12; exportReportYear--; }
            loadExportOptions();
        });

        document.getElementById('exportNextMonthBtn').addEventListener('click', () => {
            exportReportMonth++;
            if (exportReportMonth > 12) { exportReportMonth = 1; exportReportYear++; }
            loadExportOptions();
        });

        // Finance sub-tabs switching
        document.querySelectorAll('.finance-subtab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all
                document.querySelectorAll('.finance-subtab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'transparent';
                    t.style.color = 'var(--text-secondary)';
                });

                // Add active to clicked
                tab.classList.add('active');
                tab.style.background = 'rgba(99, 102, 241, 0.1)';
                tab.style.color = 'var(--text-primary)';

                // Hide all content
                document.querySelectorAll('.finance-subtab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // Show selected content
                const subtab = tab.dataset.subtab;
                if (subtab === 'by-name') {
                    document.getElementById('financeByNameTab').style.display = 'block';
                } else if (subtab === 'by-department') {
                    document.getElementById('financeByDepartmentTab').style.display = 'block';
                    loadDepartmentReports();
                } else if (subtab === 'export') {
                    document.getElementById('financeExportTab').style.display = 'block';
                    loadExportOptions();
                }
            });
        });

        // Themes
        document.querySelectorAll('.theme-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                card.querySelector('input[type="radio"]').checked = true;

                // Show/hide custom theme panel
                const isCustom = card.dataset.theme === 'custom';
                document.getElementById('customThemePanel').style.display = isCustom ? 'block' : 'none';
            });
        });

        // Custom theme color pickers
        document.getElementById('customBgColor')?.addEventListener('input', updateCustomThemePreview);
        document.getElementById('customPrimaryColor')?.addEventListener('input', updateCustomThemePreview);
        document.getElementById('customSecondaryColor')?.addEventListener('input', updateCustomThemePreview);

        function updateCustomThemePreview() {
            const bgColor = document.getElementById('customBgColor').value;
            const primaryColor = document.getElementById('customPrimaryColor').value;
            const secondaryColor = document.getElementById('customSecondaryColor').value;

            // Update preview colors
            const preview = document.getElementById('customThemePreview');
            const colors = preview.querySelectorAll('.theme-color');
            colors[0].style.background = bgColor;
            colors[1].style.background = primaryColor;
            colors[2].style.background = secondaryColor;
        }

        // Apply custom theme button
        document.getElementById('applyCustomThemeBtn')?.addEventListener('click', () => {
            const bgColor = document.getElementById('customBgColor').value;
            const primaryColor = document.getElementById('customPrimaryColor').value;
            const secondaryColor = document.getElementById('customSecondaryColor').value;

            // Calculate card bg color (slightly lighter than bg)
            const cardBgColor = lightenColor(bgColor, 15);

            // Apply custom theme
            applyCustomTheme(bgColor, primaryColor, secondaryColor, cardBgColor);

            showSuccess('×¢×¨×›×ª ×”× ×•×©× ×”××•×ª×××ª ×”×•×—×œ×”! ×œ×—×¥ ×¢×œ "×©××•×¨ ×¢×¨×›×ª × ×•×©×" ×›×“×™ ×œ×©××•×¨');
        });

        function applyCustomTheme(bgColor, primaryColor, secondaryColor, cardBgColor) {
            document.documentElement.style.setProperty('--custom-bg-color', bgColor);
            document.documentElement.style.setProperty('--custom-primary-color', primaryColor);
            document.documentElement.style.setProperty('--custom-secondary-color', secondaryColor);
            document.documentElement.style.setProperty('--custom-card-bg', cardBgColor);

            // Apply theme
            document.body.dataset.theme = 'custom';
        }

        function lightenColor(hex, percent) {
            // Convert hex to RGB
            const num = parseInt(hex.replace('#', ''), 16);
            const r = (num >> 16) + Math.round(2.55 * percent);
            const g = ((num >> 8) & 0x00FF) + Math.round(2.55 * percent);
            const b = (num & 0x0000FF) + Math.round(2.55 * percent);

            // Ensure values stay within 0-255
            const newR = Math.min(255, Math.max(0, r));
            const newG = Math.min(255, Math.max(0, g));
            const newB = Math.min(255, Math.max(0, b));

            return '#' + ((newR << 16) | (newG << 8) | newB).toString(16).padStart(6, '0');
        }

        document.getElementById('saveThemeBtn').addEventListener('click', () => {
            const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
            document.body.dataset.theme = selectedTheme;
            localStorage.setItem('selectedTheme', selectedTheme);

            // Save custom colors if custom theme is selected
            if (selectedTheme === 'custom') {
                const customColors = {
                    bg: document.getElementById('customBgColor').value,
                    primary: document.getElementById('customPrimaryColor').value,
                    secondary: document.getElementById('customSecondaryColor').value
                };
                localStorage.setItem('customThemeColors', JSON.stringify(customColors));

                // Apply the custom theme
                const cardBgColor = lightenColor(customColors.bg, 15);
                applyCustomTheme(customColors.bg, customColors.primary, customColors.secondary, cardBgColor);
            }

            showSuccess('×¢×¨×›×ª ×”× ×•×©× × ×©××¨×”');
        });

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            document.body.dataset.theme = savedTheme;
            const radio = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (radio) {
                radio.checked = true;
                radio.closest('.theme-card').classList.add('selected');
            }

            // Load custom theme colors if custom theme is saved
            if (savedTheme === 'custom') {
                const customColorsStr = localStorage.getItem('customThemeColors');
                if (customColorsStr) {
                    try {
                        const customColors = JSON.parse(customColorsStr);
                        document.getElementById('customBgColor').value = customColors.bg;
                        document.getElementById('customPrimaryColor').value = customColors.primary;
                        document.getElementById('customSecondaryColor').value = customColors.secondary;

                        // Apply custom theme
                        const cardBgColor = lightenColor(customColors.bg, 15);
                        applyCustomTheme(customColors.bg, customColors.primary, customColors.secondary, cardBgColor);

                        // Update preview
                        updateCustomThemePreview();
                    } catch (e) {
                        console.error('Error loading custom theme:', e);
                    }
                }
            }
        }

        // Profile Image Upload
        document.getElementById('profileImageInput')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×” ×‘×œ×‘×“');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('×’×•×“×œ ×”×ª××•× ×” ×—×•×¨×’ ×-5MB');
                return;
            }

            try {
                showLoading(true);

                // Create a reference to the storage location
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const imageRef = storageRef(storage, `profile-images/${sanitizedEmail}`);

                // Upload the file
                await uploadBytes(imageRef, file);

                // Get the download URL
                const downloadURL = await getDownloadURL(imageRef);

                // Save URL to database
                const userPath = getUserPath(currentUser.email);
                await set(ref(database, `${userPath}/profileImage`), downloadURL);

                // Update local data
                currentUserData.profileImage = downloadURL;
                userRoles[currentUser.email].profileImage = downloadURL;

                // Update preview
                displayProfileImage(downloadURL);
                updateHeaderProfileImage(downloadURL);

                showSuccess('×”×ª××•× ×” ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”!');
                showLoading(false);
            } catch (error) {
                console.error('Error uploading image:', error);
                showError('×©×’×™××” ×‘×”×¢×œ××ª ×”×ª××•× ×”: ' + error.message);
                showLoading(false);
            }
        });

        // Remove Profile Image
        document.getElementById('removeProfileImageBtn')?.addEventListener('click', async () => {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×ª××•× ×ª ×”×¤×¨×•×¤×™×œ?')) {
                return;
            }

            try {
                showLoading(true);

                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const imageRef = storageRef(storage, `profile-images/${sanitizedEmail}`);

                // Delete from storage
                try {
                    await deleteObject(imageRef);
                } catch (error) {
                    // Ignore if file doesn't exist
                    console.log('Image file not found in storage');
                }

                // Remove URL from database
                const userPath = getUserPath(currentUser.email);
                await set(ref(database, `${userPath}/profileImage`), null);

                // Update local data
                currentUserData.profileImage = null;
                userRoles[currentUser.email].profileImage = null;

                // Update preview
                displayProfileImage(null);
                updateHeaderProfileImage(null);

                showSuccess('×”×ª××•× ×” ×”×•×¡×¨×” ×‘×”×¦×œ×—×”!');
                showLoading(false);
            } catch (error) {
                console.error('Error removing image:', error);
                showError('×©×’×™××” ×‘×”×¡×¨×ª ×”×ª××•× ×”: ' + error.message);
                showLoading(false);
            }
        });

        // Display profile image in preview
        function displayProfileImage(imageURL) {
            const preview = document.getElementById('profileImagePreview');
            const removeBtn = document.getElementById('removeProfileImageBtn');

            if (imageURL) {
                preview.innerHTML = `<img src="${imageURL}" style="width: 100%; height: 100%; object-fit: cover;">`;
                removeBtn.style.display = 'block';
            } else {
                preview.innerHTML = '<span style="font-size: 48px;">ğŸ‘¤</span>';
                removeBtn.style.display = 'none';
            }
        }

        // Load user's profile image on page load
        function loadProfileImage() {
            if (currentUserData && currentUserData.profileImage) {
                displayProfileImage(currentUserData.profileImage);

                // Also show in header
                const headerImage = document.getElementById('userProfileImage');
                const headerImg = document.getElementById('userProfileImg');
                if (headerImage && headerImg) {
                    headerImg.src = currentUserData.profileImage;
                    headerImage.style.display = 'block';
                }
            }
        }

        // Update header profile image (call after upload/remove)
        function updateHeaderProfileImage(imageURL) {
            const headerImage = document.getElementById('userProfileImage');
            const headerImg = document.getElementById('userProfileImg');

            if (imageURL && headerImage && headerImg) {
                headerImg.src = imageURL;
                headerImage.style.display = 'block';
            } else if (headerImage) {
                headerImage.style.display = 'none';
            }
        }

        // Notification Email Management
        function loadNotificationEmail() {
            const currentEmailDisplay = document.getElementById('currentNotificationEmail');
            if (!currentEmailDisplay) return;

            // Get notification email from user data, default to login email
            const notificationEmail = currentUserData.notificationEmail || currentUser.email;
            currentEmailDisplay.textContent = notificationEmail;

            // If custom email is set, show it in the input field
            if (currentUserData.notificationEmail) {
                const newEmailInput = document.getElementById('newNotificationEmail');
                if (newEmailInput) {
                    newEmailInput.placeholder = `×›×ª×•×‘×ª × ×•×›×—×™×ª: ${notificationEmail}`;
                }
            }
        }

        // Update notification email button
        document.getElementById('updateNotificationEmailBtn')?.addEventListener('click', async () => {
            const newEmail = document.getElementById('newNotificationEmail').value.trim();

            if (!newEmail) {
                showError('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showError('×›×ª×•×‘×ª ×”××™×™×œ ××™× ×” ×ª×§×™× ×”');
                return;
            }

            try {
                showLoading(true);

                // Save to Firebase
                const userPath = getUserPath(currentUser.email);
                await set(ref(database, `${userPath}/notificationEmail`), newEmail);

                // Update local data
                currentUserData.notificationEmail = newEmail;
                userRoles[currentUser.email].notificationEmail = newEmail;

                // Update display
                loadNotificationEmail();

                // Clear input
                document.getElementById('newNotificationEmail').value = '';

                showSuccess('×›×ª×•×‘×ª ×”××™×™×œ ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
                showLoading(false);
            } catch (error) {
                console.error('Error updating notification email:', error);
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×›×ª×•×‘×ª ×”××™×™×œ: ' + error.message);
                showLoading(false);
            }
        });

        // Reset notification email to default (login email)
        document.getElementById('resetNotificationEmailBtn')?.addEventListener('click', async () => {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×œ×›×ª×•×‘×ª ×‘×¨×™×¨×ª ×”××—×“×œ?')) {
                return;
            }

            try {
                showLoading(true);

                // Remove custom email from Firebase
                const userPath = getUserPath(currentUser.email);
                await set(ref(database, `${userPath}/notificationEmail`), null);

                // Update local data
                currentUserData.notificationEmail = null;
                userRoles[currentUser.email].notificationEmail = null;

                // Update display
                loadNotificationEmail();

                // Clear input
                document.getElementById('newNotificationEmail').value = '';

                showSuccess('×›×ª×•×‘×ª ×”××™×™×œ ××•×¤×¡×” ×œ×‘×¨×™×¨×ª ××—×“×œ');
                showLoading(false);
            } catch (error) {
                console.error('Error resetting notification email:', error);
                showError('×©×’×™××” ×‘××™×¤×•×¡ ×›×ª×•×‘×ª ×”××™×™×œ: ' + error.message);
                showLoading(false);
            }
        });

        // Developer Note - Save to Firebase and send email
        document.getElementById('sendNoteBtn').addEventListener('click', async () => {
            const subject = document.getElementById('noteSubject').value.trim();
            const message = document.getElementById('noteMessage').value.trim();

            if (!subject || !message) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            try {
                showLoading(true);

                // Get sender information
                const senderName = currentUserData.fullName || currentUser.email;
                const senderEmail = currentUser.email;
                const senderRole = currentUserData.role === 'instructor' ? '××“×¨×™×š' :
                                   currentUserData.role === 'coordinator' ? '×¨×›×–' :
                                   currentUserData.role === 'finance' ? '×× ×”×œ×ª ×›×¡×¤×™×' :
                                   currentUserData.role === 'admin' ? '××“××™×Ÿ' : '××©×ª××©';

                // Save note to Firebase
                const noteRef = ref(database, `developerNotes/${Date.now()}`);
                await set(noteRef, {
                    subject: subject,
                    message: message,
                    senderName: senderName,
                    senderEmail: senderEmail,
                    senderRole: senderRole,
                    timestamp: Date.now(),
                    date: new Date().toISOString()
                });

                // Send email using EmailJS with developer note template
                const templateParams = {
                    sender_name: senderName,
                    sender_email: senderEmail,
                    sender_role: senderRole,
                    subject: subject,
                    message: message
                };

                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.developerNoteTemplateId,
                    templateParams
                );

                // Clear form
                document.getElementById('noteSubject').value = '';
                document.getElementById('noteMessage').value = '';

                showSuccess('×”×”×¢×¨×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ××¤×ª×—!');
                showLoading(false);
            } catch (error) {
                console.error('Error sending developer note:', error);
                showError('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×¢×¨×”. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
                showLoading(false);
            }
        });

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', async () => {
                const targetTabId = `${tab.dataset.tab}Tab`;
                const targetTab = document.getElementById(targetTabId);

                if (!targetTab) {
                    console.warn(`Tab not found: ${targetTabId}`);
                    return;
                }

                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                targetTab.style.display = 'block';

                // Load statistics when switching to statistics tab
                if (tab.dataset.tab === 'statistics' && currentUserData?.role === 'instructor') {
                    await loadStatisticsOverview();
                }

                // Load reporting status when switching to finance status tab
                if (tab.dataset.tab === 'finance-status' && currentUserData?.role === 'finance') {
                    await loadReportingStatus();
                }

                // Load notifications when switching to notifications tab
                if (tab.dataset.tab === 'finance-notifications' && currentUserData?.role === 'finance') {
                    await loadNotifications();
                    setupNotificationsRealtimeListener();
                }

                // Update coordinator dropdowns and instructors list when switching to admin manage instructors tab
                if (tab.dataset.tab === 'admin-manage-users' && currentUserData?.role === 'admin') {
                    await loadAdminInstructorsList();
                    populateCoordinatorDropdowns();
                }
            });
        });

        // Statistics Sub-Navigation
        document.querySelectorAll('.stats-nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetStatsTab = `stats-${btn.dataset.statsTab}`;
                const targetContent = document.getElementById(targetStatsTab);

                if (!targetContent) {
                    console.warn(`Stats tab not found: ${targetStatsTab}`);
                    return;
                }

                // Remove active class from all buttons
                document.querySelectorAll('.stats-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Hide all stats content areas
                document.querySelectorAll('.stats-content').forEach(c => c.style.display = 'none');
                targetContent.style.display = 'block';

                // Load data for specific tabs
                if (btn.dataset.statsTab === 'charts') {
                    loadChartsData(currentChartPeriod);
                } else if (btn.dataset.statsTab === 'subjects') {
                    loadSubjectAnalysis();
                } else if (btn.dataset.statsTab === 'periods') {
                    loadPeriodAnalysis();
                } else if (btn.dataset.statsTab === 'coordinators') {
                    loadCoordinatorsAnalysis();
                } else if (btn.dataset.statsTab === 'records') {
                    loadRecordsAndAchievements();
                }
            });
        });

        // ===== STATISTICS FUNCTIONS =====

        // Load Statistics Overview
        async function loadStatisticsOverview() {
            try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;

                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Calculate current month stats
                const currentMonthRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}/${currentMonth}/entries`);
                const currentMonthSnapshot = await get(currentMonthRef);
                const currentMonthData = currentMonthSnapshot.val() || {};

                let currentMonthTeaching = 0;
                let currentMonthTraining = 0;
                let workingDaysCount = 0;
                const uniqueDates = new Set();
                const activeSubjectsSet = new Set();

                Object.values(currentMonthData).forEach(entry => {
                    currentMonthTeaching += entry.hours?.teaching || 0;
                    currentMonthTraining += entry.hours?.training || 0;
                    uniqueDates.add(entry.date);
                    if (entry.subject) activeSubjectsSet.add(entry.subject);
                });

                workingDaysCount = uniqueDates.size;
                const currentMonthTotal = currentMonthTeaching + currentMonthTraining;

                // Calculate last month stats
                let lastMonth = currentMonth - 1;
                let lastYear = currentYear;
                if (lastMonth === 0) {
                    lastMonth = 12;
                    lastYear = currentYear - 1;
                }

                const lastMonthRef = ref(database, `timesheets/${sanitizedEmail}/${lastYear}/${lastMonth}/entries`);
                const lastMonthSnapshot = await get(lastMonthRef);
                const lastMonthData = lastMonthSnapshot.val() || {};

                let lastMonthTotal = 0;
                Object.values(lastMonthData).forEach(entry => {
                    lastMonthTotal += (entry.hours?.teaching || 0) + (entry.hours?.training || 0);
                });

                // Calculate comparison percentage
                let comparisonPercentage = 0;
                let comparisonColor = '#22c55e';
                let comparisonSign = '+';

                if (lastMonthTotal > 0) {
                    comparisonPercentage = Math.round(((currentMonthTotal - lastMonthTotal) / lastMonthTotal) * 100);
                    if (comparisonPercentage < 0) {
                        comparisonColor = '#ef4444';
                        comparisonSign = '';
                    } else {
                        comparisonSign = '+';
                    }
                }

                // Calculate year total
                const yearRef = ref(database, `timesheets/${sanitizedEmail}/${currentYear}`);
                const yearSnapshot = await get(yearRef);
                const yearData = yearSnapshot.val() || {};

                let yearTeaching = 0;
                let yearTraining = 0;
                let monthsWithData = 0;

                Object.values(yearData).forEach(monthData => {
                    if (monthData.entries && Object.keys(monthData.entries).length > 0) {
                        monthsWithData++;
                        Object.values(monthData.entries).forEach(entry => {
                            yearTeaching += entry.hours?.teaching || 0;
                            yearTraining += entry.hours?.training || 0;
                        });
                    }
                });

                const yearTotal = yearTeaching + yearTraining;
                const monthlyAverage = monthsWithData > 0 ? Math.round(yearTotal / monthsWithData) : 0;
                const avgPerDay = workingDaysCount > 0 ? (currentMonthTotal / workingDaysCount).toFixed(1) : 0;

                // Update UI
                document.getElementById('currentMonthTotal').textContent = currentMonthTotal;
                document.getElementById('currentMonthTeaching').textContent = currentMonthTeaching;
                document.getElementById('currentMonthTraining').textContent = currentMonthTraining;

                const comparisonEl = document.getElementById('comparisonPercentage');
                comparisonEl.textContent = `${comparisonSign}${Math.abs(comparisonPercentage)}%`;
                comparisonEl.style.background = `linear-gradient(135deg, ${comparisonColor} 0%, ${comparisonColor} 100%)`;
                comparisonEl.style.webkitBackgroundClip = 'text';
                comparisonEl.style.webkitTextFillColor = 'transparent';

                document.getElementById('lastMonthTotal').textContent = lastMonthTotal;

                document.getElementById('yearTotal').textContent = yearTotal;
                document.getElementById('yearTeaching').textContent = yearTeaching;
                document.getElementById('yearTraining').textContent = yearTraining;
                document.getElementById('currentYear').textContent = currentYear;

                document.getElementById('monthlyAverage').textContent = monthlyAverage;
                document.getElementById('monthsCount').textContent = monthsWithData;

                document.getElementById('workingDays').textContent = workingDaysCount;
                document.getElementById('avgPerDay').textContent = avgPerDay;
                document.getElementById('activeSubjects').textContent = activeSubjectsSet.size;

            } catch (error) {
                console.error('Error loading statistics:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª');
            }
        }

        // Global variable to store current chart period
        let currentChartPeriod = 6;

        // Load Charts and Trends
        async function loadChartsData(periodMonths = 6) {
            try {
                currentChartPeriod = periodMonths;
                const now = new Date();
                const sanitizedEmail = sanitizeEmail(currentUser.email);

                // Update period label
                const labels = { 6: '6 ×—×•×“×©×™× ××—×¨×•× ×™×', 12: '×©× ×” ××—×¨×•× ×”', 24: '×©× ×ª×™×™× ××—×¨×•× ×•×ª' };
                document.getElementById('trendPeriodLabel').textContent = labels[periodMonths];

                // Calculate date range
                const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); // Last day of current month
                const startDate = new Date(now.getFullYear(), now.getMonth() - periodMonths + 1, 1);

                // Collect data by month
                const monthlyData = [];
                const subjectTotals = {};
                const yearlyData = {};

                let totalTeaching = 0;
                let totalTraining = 0;

                // Iterate through each month in the period
                for (let d = new Date(startDate); d <= endDate; d.setMonth(d.getMonth() + 1)) {
                    const year = d.getFullYear();
                    const month = d.getMonth() + 1;
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;

                    const monthRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries`);
                    const monthSnapshot = await get(monthRef);
                    const monthData = monthSnapshot.val() || {};

                    let monthTeaching = 0;
                    let monthTraining = 0;

                    Object.values(monthData).forEach(entry => {
                        const teaching = entry.hours?.teaching || 0;
                        const training = entry.hours?.training || 0;

                        monthTeaching += teaching;
                        monthTraining += training;

                        // Track by subject
                        if (entry.subject) {
                            if (!subjectTotals[entry.subject]) {
                                subjectTotals[entry.subject] = 0;
                            }
                            subjectTotals[entry.subject] += teaching + training;
                        }

                        // Track by year for yearly comparison
                        if (!yearlyData[year]) {
                            yearlyData[year] = 0;
                        }
                        yearlyData[year] += teaching + training;
                    });

                    totalTeaching += monthTeaching;
                    totalTraining += monthTraining;

                    monthlyData.push({
                        monthKey,
                        year,
                        month,
                        teaching: monthTeaching,
                        training: monthTraining,
                        total: monthTeaching + monthTraining
                    });
                }

                // Draw all charts
                drawTrendLineChart(monthlyData);
                drawTeachingVsTrainingChart(monthlyData);
                drawSubjectPieChart(subjectTotals);
                drawYearlyComparisonChart(yearlyData);

                // Update insights
                updateChartInsights(monthlyData, subjectTotals, totalTeaching, totalTraining);

            } catch (error) {
                console.error('Error loading charts:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×¨×¤×™×');
            }
        }

        // Draw Line Chart for Trend
        function drawTrendLineChart(monthlyData) {
            const canvas = document.getElementById('trendLineChart');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (monthlyData.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            // Find max value for scaling
            const maxValue = Math.max(...monthlyData.map(m => m.total), 1);
            const scale = chartHeight / maxValue;

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();

                // Y-axis labels
                const value = Math.round(maxValue - (maxValue / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value, padding - 10, y + 4);
            }

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;

            monthlyData.forEach((data, index) => {
                const x = padding + (chartWidth / (monthlyData.length - 1)) * index;
                const y = canvas.height - padding - data.total * scale;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Draw points
            monthlyData.forEach((data, index) => {
                const x = padding + (chartWidth / (monthlyData.length - 1)) * index;
                const y = canvas.height - padding - data.total * scale;

                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = '#3b82f6';
                ctx.fill();

                // X-axis labels (every other month if too many)
                const showLabel = monthlyData.length <= 12 || index % 2 === 0;
                if (showLabel) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    const monthNames = ['×™× ×•', '×¤×‘×¨', '××¨×¥', '××¤×¨', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’', '×¡×¤×˜', '××•×§', '× ×•×‘', '×“×¦×'];
                    ctx.fillText(monthNames[data.month - 1], x, canvas.height - padding + 20);
                }
            });
        }

        // Draw Teaching vs Training Bar Chart
        function drawTeachingVsTrainingChart(monthlyData) {
            const canvas = document.getElementById('teachingVsTrainingChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (monthlyData.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            // Find max value
            const maxValue = Math.max(...monthlyData.map(m => Math.max(m.teaching, m.training)), 1);
            const scale = chartHeight / maxValue;

            // Calculate bar width
            const barWidth = Math.min(20, chartWidth / (monthlyData.length * 2.5));
            const groupWidth = barWidth * 2.5;

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();

                const value = Math.round(maxValue - (maxValue / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value, padding - 10, y + 4);
            }

            // Draw bars
            monthlyData.forEach((data, index) => {
                const x = padding + (chartWidth / monthlyData.length) * index + (chartWidth / monthlyData.length - groupWidth) / 2;

                // Teaching bar (blue)
                const teachingHeight = data.teaching * scale;
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(x, canvas.height - padding - teachingHeight, barWidth, teachingHeight);

                // Training bar (purple)
                const trainingHeight = data.training * scale;
                ctx.fillStyle = '#8b5cf6';
                ctx.fillRect(x + barWidth + 5, canvas.height - padding - trainingHeight, barWidth, trainingHeight);
            });

            // Legend
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(canvas.width - 120, 20, 15, 15);
            ctx.fillStyle = '#e5e7eb';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('×”×“×¨×›×”', canvas.width - 10, 32);

            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(canvas.width - 120, 40, 15, 15);
            ctx.fillStyle = '#e5e7eb';
            ctx.fillText('×”×©×ª×œ××•×ª', canvas.width - 10, 52);
        }

        // Draw Subject Pie Chart
        function drawSubjectPieChart(subjectTotals) {
            const canvas = document.getElementById('subjectPieChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const subjects = Object.entries(subjectTotals).sort((a, b) => b[1] - a[1]);

            if (subjects.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            const total = subjects.reduce((sum, [_, hours]) => sum + hours, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 30;

            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#6366f1', '#14b8a6', '#f97316', '#84cc16', '#06b6d4'
            ];

            let currentAngle = -Math.PI / 2;

            // Draw pie slices
            subjects.forEach(([subject, hours], index) => {
                const sliceAngle = (hours / total) * 2 * Math.PI;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();

                currentAngle += sliceAngle;
            });

            // Draw legend
            const legendContainer = document.getElementById('subjectLegend');
            legendContainer.innerHTML = subjects.map(([subject, hours], index) => {
                const percentage = ((hours / total) * 100).toFixed(1);
                return `
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 12px; background: ${colors[index % colors.length]}; border-radius: 2px;"></div>
                        <span style="color: var(--text-color);">${subject}</span>
                        <span style="color: var(--text-secondary);">(${percentage}%)</span>
                    </div>
                `;
            }).join('');
        }

        // Draw Yearly Comparison Chart
        function drawYearlyComparisonChart(yearlyData) {
            const canvas = document.getElementById('yearlyComparisonChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const years = Object.entries(yearlyData).sort((a, b) => a[0] - b[0]);

            if (years.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            const maxValue = Math.max(...years.map(([_, hours]) => hours), 1);
            const scale = chartHeight / maxValue;

            const barWidth = Math.min(80, chartWidth / (years.length * 1.5));

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();

                const value = Math.round(maxValue - (maxValue / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value, padding - 10, y + 4);
            }

            // Draw bars
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b'];
            years.forEach(([year, hours], index) => {
                const x = padding + (chartWidth / years.length) * index + (chartWidth / years.length - barWidth) / 2;
                const barHeight = hours * scale;

                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, canvas.height - padding - barHeight, barWidth, barHeight);

                // Year label
                ctx.fillStyle = '#e5e7eb';
                ctx.font = '13px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(year, x + barWidth / 2, canvas.height - padding + 20);

                // Hours label on top of bar
                ctx.fillStyle = '#e5e7eb';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(Math.round(hours), x + barWidth / 2, canvas.height - padding - barHeight - 5);
            });
        }

        // Update Chart Insights
        function updateChartInsights(monthlyData, subjectTotals, totalTeaching, totalTraining) {
            // Overall trend
            if (monthlyData.length >= 2) {
                const firstHalf = monthlyData.slice(0, Math.floor(monthlyData.length / 2));
                const secondHalf = monthlyData.slice(Math.floor(monthlyData.length / 2));

                const firstAvg = firstHalf.reduce((sum, m) => sum + m.total, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((sum, m) => sum + m.total, 0) / secondHalf.length;

                const trendDiff = ((secondAvg - firstAvg) / firstAvg * 100).toFixed(1);
                const trendText = trendDiff > 0 ? `×¢×œ×™×™×” ×©×œ ${trendDiff}%` : `×™×¨×™×“×” ×©×œ ${Math.abs(trendDiff)}%`;
                const trendColor = trendDiff > 0 ? '#10b981' : '#ef4444';

                document.getElementById('overallTrend').innerHTML = `<span style="color: ${trendColor};">${trendText}</span>`;
            } else {
                document.getElementById('overallTrend').textContent = '××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™×';
            }

            // Best month
            const bestMonth = monthlyData.reduce((best, current) =>
                current.total > best.total ? current : best, monthlyData[0]);

            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            document.getElementById('bestMonth').textContent = `${monthNames[bestMonth.month - 1]} ${bestMonth.year} (${Math.round(bestMonth.total)} ×©×¢×•×ª)`;

            // Top subject
            const subjects = Object.entries(subjectTotals).sort((a, b) => b[1] - a[1]);
            if (subjects.length > 0) {
                const topSubject = subjects[0];
                const percentage = ((topSubject[1] / (totalTeaching + totalTraining)) * 100).toFixed(1);
                document.getElementById('topSubject').textContent = `${topSubject[0]} (${percentage}%)`;
            } else {
                document.getElementById('topSubject').textContent = '××™×Ÿ × ×ª×•× ×™×';
            }

            // Teaching/Training ratio
            if (totalTraining > 0) {
                const ratio = (totalTeaching / totalTraining).toFixed(2);
                document.getElementById('teachingRatio').textContent = `${ratio}:1`;
            } else {
                document.getElementById('teachingRatio').textContent = '×”×“×¨×›×” ×‘×œ×‘×“';
            }
        }

        // Chart Period Buttons Event Listeners
        document.querySelectorAll('.chart-period-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const period = parseInt(btn.dataset.period);

                // Update active state
                document.querySelectorAll('.chart-period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Reload charts with new period
                await loadChartsData(period);
            });
        });

        // Load Subject Analysis
        async function loadSubjectAnalysis() {
            try {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const timesheetsRef = ref(database, `timesheets/${sanitizedEmail}`);
                const snapshot = await get(timesheetsRef);
                const data = snapshot.val() || {};

                // Collect all subject data
                const subjectData = {};
                const monthlySubjectData = {}; // Track months per subject
                let totalHours = 0;

                // Iterate through all years and months
                Object.keys(data).forEach(year => {
                    Object.keys(data[year]).forEach(month => {
                        const entries = data[year][month].entries || {};
                        Object.values(entries).forEach(entry => {
                            if (entry.subject) {
                                const subject = entry.subject;
                                const teaching = entry.hours?.teaching || 0;
                                const training = entry.hours?.training || 0;
                                const total = teaching + training;

                                if (!subjectData[subject]) {
                                    subjectData[subject] = {
                                        teaching: 0,
                                        training: 0,
                                        total: 0
                                    };
                                    monthlySubjectData[subject] = new Set();
                                }

                                subjectData[subject].teaching += teaching;
                                subjectData[subject].training += training;
                                subjectData[subject].total += total;
                                totalHours += total;

                                // Track which months this subject appeared in
                                monthlySubjectData[subject].add(`${year}-${month}`);
                            }
                        });
                    });
                });

                // Convert to sorted array
                const subjects = Object.entries(subjectData)
                    .map(([name, hours]) => ({
                        name,
                        teaching: hours.teaching,
                        training: hours.training,
                        total: hours.total,
                        monthsCount: monthlySubjectData[name].size
                    }))
                    .sort((a, b) => b.total - a.total);

                // Update summary cards
                document.getElementById('totalSubjects').textContent = subjects.length;

                if (subjects.length > 0) {
                    const topSubject = subjects[0];
                    document.getElementById('topSubjectName').textContent = topSubject.name;
                    document.getElementById('topSubjectHours').textContent = `${Math.round(topSubject.total)} ×©×¢×•×ª`;

                    const avgHours = totalHours / subjects.length;
                    document.getElementById('avgHoursPerSubject').textContent = Math.round(avgHours);
                } else {
                    document.getElementById('topSubjectName').textContent = '××™×Ÿ × ×ª×•× ×™×';
                    document.getElementById('topSubjectHours').textContent = '--';
                    document.getElementById('avgHoursPerSubject').textContent = '--';
                }

                // Draw horizontal bar chart
                drawSubjectsBarChart(subjects);

                // Fill table
                fillSubjectsTable(subjects, totalHours);

            } catch (error) {
                console.error('Error loading subject analysis:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×™×ª×•×— ××§×¦×•×¢×•×ª');
            }
        }

        // Draw Horizontal Bar Chart for Subjects
        function drawSubjectsBarChart(subjects) {
            const canvas = document.getElementById('subjectsBarChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (subjects.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Adjust canvas height based on number of subjects
            const barHeight = 35;
            const spacing = 10;
            const neededHeight = subjects.length * (barHeight + spacing) + 40;
            canvas.height = Math.max(400, neededHeight);

            const padding = 150; // Left padding for labels
            const chartWidth = canvas.width - padding - 50;
            const maxValue = Math.max(...subjects.map(s => s.total), 1);

            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#6366f1', '#14b8a6', '#f97316', '#84cc16', '#06b6d4'
            ];

            subjects.forEach((subject, index) => {
                const y = 20 + index * (barHeight + spacing);
                const barWidth = (subject.total / maxValue) * chartWidth;

                // Subject name (right-aligned)
                ctx.fillStyle = '#e5e7eb';
                ctx.font = '13px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(subject.name, padding - 10, y + barHeight / 2 + 4);

                // Bar
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(padding, y, barWidth, barHeight);

                // Hours value on the bar
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${Math.round(subject.total)} ×©×¢×•×ª`, padding + barWidth + 5, y + barHeight / 2 + 4);
            });
        }

        // Fill Subjects Table
        function fillSubjectsTable(subjects, totalHours) {
            const tbody = document.getElementById('subjectsTableBody');

            if (subjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</td></tr>';
                return;
            }

            tbody.innerHTML = subjects.map((subject, index) => {
                const percentage = ((subject.total / totalHours) * 100).toFixed(1);
                const avgPerMonth = (subject.total / subject.monthsCount).toFixed(1);

                const rowStyle = index % 2 === 0
                    ? 'background: rgba(255, 255, 255, 0.02);'
                    : 'background: transparent;';

                return `
                    <tr style="${rowStyle} border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.1)'" onmouseout="this.style.background='${index % 2 === 0 ? 'rgba(255, 255, 255, 0.02)' : 'transparent'}'">
                        <td style="padding: 12px; text-align: right; color: var(--text-secondary); font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">${subject.name}</td>
                        <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">${Math.round(subject.teaching)}</td>
                        <td style="padding: 12px; text-align: center; color: #8b5cf6; font-weight: 600;">${Math.round(subject.training)}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 700; font-size: 15px;">${Math.round(subject.total)}</td>
                        <td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${percentage}%</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-secondary); font-weight: 600;">${avgPerMonth}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load Period Analysis
        let currentSelectedYear = new Date().getFullYear();

        async function loadPeriodAnalysis(year = currentSelectedYear) {
            try {
                currentSelectedYear = year;
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;

                document.getElementById('selectedYearDisplay').textContent = year;

                // Get all available years and populate selector
                const timesheetsRef = ref(database, `timesheets/${sanitizedEmail}`);
                const snapshot = await get(timesheetsRef);
                const allData = snapshot.val() || {};
                const availableYears = Object.keys(allData).sort((a, b) => b - a);

                const yearSelector = document.getElementById('periodYearSelector');
                yearSelector.innerHTML = availableYears.map(y =>
                    `<option value="${y}" ${y == year ? 'selected' : ''}>${y}</option>`
                ).join('');

                // Collect monthly data for the selected year
                const monthlyData = [];
                const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];

                for (let month = 1; month <= 12; month++) {
                    const monthRef = ref(database, `timesheets/${sanitizedEmail}/${year}/${month}/entries`);
                    const monthSnapshot = await get(monthRef);
                    const monthEntries = monthSnapshot.val() || {};

                    let teaching = 0, training = 0;
                    const workingDates = new Set();

                    Object.values(monthEntries).forEach(entry => {
                        teaching += entry.hours?.teaching || 0;
                        training += entry.hours?.training || 0;
                        if (entry.date) workingDates.add(entry.date);
                    });

                    const total = teaching + training;
                    const workingDays = workingDates.size;
                    const avgPerDay = workingDays > 0 ? (total / workingDays).toFixed(1) : 0;

                    monthlyData.push({
                        month,
                        monthName: monthNames[month - 1],
                        teaching,
                        training,
                        total,
                        workingDays,
                        avgPerDay
                    });
                }

                // Current month vs last month (only if viewing current year)
                if (year == currentYear) {
                    const current = monthlyData[currentMonth - 1];
                    const last = currentMonth > 1 ? monthlyData[currentMonth - 2] : { total: 0, monthName: '××™×Ÿ × ×ª×•× ×™×' };

                    document.getElementById('currentMonthPeriod').textContent = Math.round(current.total);
                    document.getElementById('currentMonthName').textContent = current.monthName;
                    document.getElementById('lastMonthPeriod').textContent = Math.round(last.total);
                    document.getElementById('lastMonthName').textContent = last.monthName;

                    const diff = current.total - last.total;
                    const diffPercent = last.total > 0 ? ((diff / last.total) * 100).toFixed(1) : 0;
                    const arrow = diff > 0 ? 'â¬†ï¸' : diff < 0 ? 'â¬‡ï¸' : 'â†”ï¸';
                    const color = diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#6b7280';

                    document.getElementById('monthComparisonArrow').textContent = arrow;
                    document.getElementById('monthDifferenceText').innerHTML =
                        `<span style="color: ${color};">${diff > 0 ? '+' : ''}${Math.round(diff)} ×©×¢×•×ª (${diffPercent > 0 ? '+' : ''}${diffPercent}%)</span>`;
                } else {
                    document.getElementById('currentMonthPeriod').textContent = '--';
                    document.getElementById('currentMonthName').textContent = '×œ× ×–××™×Ÿ';
                    document.getElementById('lastMonthPeriod').textContent = '--';
                    document.getElementById('lastMonthName').textContent = '×œ× ×–××™×Ÿ';
                    document.getElementById('monthComparisonArrow').textContent = 'â†”ï¸';
                    document.getElementById('monthDifferenceText').textContent = '×–××™×Ÿ ×¨×§ ×œ×©× ×” ×”× ×•×›×—×™×ª';
                }

                // Quarterly analysis
                const quarters = [
                    { name: '×¨×‘×¢×•×Ÿ 1', months: [0, 1, 2], color: '#3b82f6' },
                    { name: '×¨×‘×¢×•×Ÿ 2', months: [3, 4, 5], color: '#8b5cf6' },
                    { name: '×¨×‘×¢×•×Ÿ 3', months: [6, 7, 8], color: '#ec4899' },
                    { name: '×¨×‘×¢×•×Ÿ 4', months: [9, 10, 11], color: '#f59e0b' }
                ];

                const quarterlyHTML = quarters.map(q => {
                    const total = q.months.reduce((sum, m) => sum + monthlyData[m].total, 0);
                    return `
                        <div style="text-align: center; padding: 10px; background: rgba(255, 255, 255, 0.02); border-radius: 6px; border: 1px solid var(--border-color);">
                            <p style="color: var(--text-secondary); font-size: 11px; margin-bottom: 5px;">${q.name}</p>
                            <div style="font-size: 20px; font-weight: 700; color: ${q.color};">${Math.round(total)}</div>
                        </div>
                    `;
                }).join('');
                document.getElementById('quarterlyStats').innerHTML = quarterlyHTML;

                // Year summary
                const yearTotal = monthlyData.reduce((sum, m) => sum + m.total, 0);
                const yearTeaching = monthlyData.reduce((sum, m) => sum + m.teaching, 0);
                const yearTraining = monthlyData.reduce((sum, m) => sum + m.training, 0);

                document.getElementById('yearTotalPeriod').textContent = Math.round(yearTotal);
                document.getElementById('yearTeachingPeriod').textContent = Math.round(yearTeaching);
                document.getElementById('yearTrainingPeriod').textContent = Math.round(yearTraining);

                // Fill monthly breakdown table
                fillMonthlyBreakdownTable(monthlyData);

                // Draw monthly chart
                drawMonthlyPeriodChart(monthlyData);

            } catch (error) {
                console.error('Error loading period analysis:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×™×ª×•×— ×ª×§×•×¤×•×ª');
            }
        }

        // Fill Monthly Breakdown Table
        function fillMonthlyBreakdownTable(monthlyData) {
            const tbody = document.getElementById('monthlyBreakdownBody');

            tbody.innerHTML = monthlyData.map((month, index) => {
                // Calculate trend (compared to previous month)
                let trendIcon = 'â€“';
                let trendColor = '#6b7280';
                if (index > 0) {
                    const diff = month.total - monthlyData[index - 1].total;
                    if (diff > 0) {
                        trendIcon = `â¬†ï¸ +${Math.round(diff)}`;
                        trendColor = '#10b981';
                    } else if (diff < 0) {
                        trendIcon = `â¬‡ï¸ ${Math.round(diff)}`;
                        trendColor = '#ef4444';
                    } else {
                        trendIcon = 'â¡ï¸ 0';
                    }
                }

                const rowStyle = index % 2 === 0
                    ? 'background: rgba(255, 255, 255, 0.02);'
                    : 'background: transparent;';

                // Highlight current month if viewing current year
                const now = new Date();
                const isCurrentMonth = currentSelectedYear == now.getFullYear() && month.month == (now.getMonth() + 1);
                const highlightStyle = isCurrentMonth ? 'background: rgba(59, 130, 246, 0.15); border-right: 3px solid #3b82f6;' : '';

                return `
                    <tr style="${highlightStyle || rowStyle} border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.1)'" onmouseout="this.style.background='${highlightStyle || (index % 2 === 0 ? 'rgba(255, 255, 255, 0.02)' : 'transparent')}'">
                        <td style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">${month.monthName}${isCurrentMonth ? ' ğŸ”µ' : ''}</td>
                        <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">${Math.round(month.teaching)}</td>
                        <td style="padding: 12px; text-align: center; color: #8b5cf6; font-weight: 600;">${Math.round(month.training)}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 700; font-size: 15px;">${Math.round(month.total)}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-secondary); font-weight: 600;">${month.workingDays}</td>
                        <td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${month.avgPerDay}</td>
                        <td style="padding: 12px; text-align: center; color: ${trendColor}; font-weight: 600; font-size: 13px;">${trendIcon}</td>
                    </tr>
                `;
            }).join('');
        }

        // Draw Monthly Period Chart
        function drawMonthlyPeriodChart(monthlyData) {
            const canvas = document.getElementById('monthlyPeriodChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 50;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            const maxValue = Math.max(...monthlyData.map(m => Math.max(m.teaching, m.training)), 1);
            const scale = chartHeight / maxValue;

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();

                const value = Math.round(maxValue - (maxValue / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value, padding - 10, y + 4);
            }

            // Calculate bar dimensions
            const barWidth = Math.min(25, chartWidth / (monthlyData.length * 2.5));
            const groupWidth = barWidth * 2.5;

            // Draw bars
            monthlyData.forEach((data, index) => {
                const x = padding + (chartWidth / monthlyData.length) * index + (chartWidth / monthlyData.length - groupWidth) / 2;

                // Teaching bar
                const teachingHeight = data.teaching * scale;
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(x, canvas.height - padding - teachingHeight, barWidth, teachingHeight);

                // Training bar
                const trainingHeight = data.training * scale;
                ctx.fillStyle = '#8b5cf6';
                ctx.fillRect(x + barWidth + 5, canvas.height - padding - trainingHeight, barWidth, trainingHeight);

                // Month label
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                const monthNames = ['×™× ×•', '×¤×‘×¨', '××¨×¥', '××¤×¨', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’', '×¡×¤×˜', '××•×§', '× ×•×‘', '×“×¦×'];
                ctx.fillText(monthNames[data.month - 1], x + barWidth + 2.5, canvas.height - padding + 20);
            });

            // Legend
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(canvas.width - 150, 20, 15, 15);
            ctx.fillStyle = '#e5e7eb';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('×”×“×¨×›×”', canvas.width - 10, 32);

            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(canvas.width - 150, 40, 15, 15);
            ctx.fillStyle = '#e5e7eb';
            ctx.fillText('×”×©×ª×œ××•×ª', canvas.width - 10, 52);
        }

        // Year selector change event
        document.getElementById('periodYearSelector')?.addEventListener('change', (e) => {
            loadPeriodAnalysis(parseInt(e.target.value));
        });

        // Load Coordinators Analysis
        async function loadCoordinatorsAnalysis() {
            try {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const timesheetsRef = ref(database, `timesheets/${sanitizedEmail}`);
                const snapshot = await get(timesheetsRef);
                const data = snapshot.val() || {};

                // Build map of subjects to coordinators dynamically from userRoles
                const subjectToCoordinator = {};
                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator') {
                        const subjects = getAllUserSubjects(userData);
                        subjects.forEach(subject => {
                            subjectToCoordinator[subject] = {
                                email: email,
                                name: userData.fullName || email
                            };
                        });
                    }
                });

                // Collect coordinator data based on subjects
                const coordinatorData = {};
                let totalHours = 0;

                // Iterate through all years, months
                Object.keys(data).forEach(year => {
                    Object.keys(data[year]).forEach(month => {
                        const monthData = data[year][month];
                        const entries = monthData.entries || {};

                        Object.values(entries).forEach(entry => {
                            const subject = entry.subject;

                            // Check if this subject has an assigned coordinator
                            if (subject && subjectToCoordinator[subject]) {
                                const coordInfo = subjectToCoordinator[subject];
                                const coordEmail = coordInfo.email;
                                const teaching = entry.hours?.teaching || 0;
                                const training = entry.hours?.training || 0;
                                const total = teaching + training;

                                if (!coordinatorData[coordEmail]) {
                                    coordinatorData[coordEmail] = {
                                        name: coordInfo.name,
                                        teaching: 0,
                                        training: 0,
                                        total: 0,
                                        subjects: new Set()
                                    };
                                }

                                coordinatorData[coordEmail].teaching += teaching;
                                coordinatorData[coordEmail].training += training;
                                coordinatorData[coordEmail].total += total;
                                totalHours += total;

                                coordinatorData[coordEmail].subjects.add(subject);
                            }
                        });
                    });
                });

                // Convert to array of coordinators
                const coordinators = Object.entries(coordinatorData)
                    .map(([email, data]) => {
                        return {
                            email,
                            name: data.name,
                            teaching: data.teaching,
                            training: data.training,
                            total: data.total,
                            subjectsCount: data.subjects.size,
                            subjects: Array.from(data.subjects)
                        };
                    })
                    .sort((a, b) => b.total - a.total);

                // Update summary cards
                document.getElementById('totalCoordinators').textContent = coordinators.length;

                if (coordinators.length > 0) {
                    const topCoord = coordinators[0];
                    document.getElementById('topCoordinatorName').textContent = topCoord.name;
                    document.getElementById('topCoordinatorHours').textContent = `${Math.round(topCoord.total)} ×©×¢×•×ª`;

                    const avgHours = totalHours / coordinators.length;
                    document.getElementById('avgHoursPerCoordinator').textContent = Math.round(avgHours);
                } else {
                    document.getElementById('topCoordinatorName').textContent = '××™×Ÿ × ×ª×•× ×™×';
                    document.getElementById('topCoordinatorHours').textContent = '--';
                    document.getElementById('avgHoursPerCoordinator').textContent = '--';
                }

                // Draw charts
                drawCoordinatorsPieChart(coordinators, totalHours);
                drawCoordinatorsBarChart(coordinators);

                // Fill table
                fillCoordinatorsTable(coordinators, totalHours);

            } catch (error) {
                console.error('Error loading coordinators analysis:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×™×ª×•×— ×¨×›×–×™×');
            }
        }

        // Draw Coordinators Pie Chart
        function drawCoordinatorsPieChart(coordinators, totalHours) {
            const canvas = document.getElementById('coordinatorsPieChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (coordinators.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 30;

            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#6366f1', '#14b8a6', '#f97316', '#84cc16', '#06b6d4'
            ];

            let currentAngle = -Math.PI / 2;

            // Draw pie slices
            coordinators.forEach((coord, index) => {
                const sliceAngle = (coord.total / totalHours) * 2 * Math.PI;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();

                currentAngle += sliceAngle;
            });

            // Draw legend
            const legendContainer = document.getElementById('coordinatorsLegend');
            legendContainer.innerHTML = coordinators.map((coord, index) => {
                const percentage = ((coord.total / totalHours) * 100).toFixed(1);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.02); border-radius: 6px; border: 1px solid var(--border-color);">
                        <div style="width: 20px; height: 20px; background: ${colors[index % colors.length]}; border-radius: 4px; flex-shrink: 0;"></div>
                        <div style="flex: 1;">
                            <div style="color: var(--text-color); font-weight: 600; font-size: 14px;">${coord.name}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${Math.round(coord.total)} ×©×¢×•×ª (${percentage}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Draw Coordinators Bar Chart
        function drawCoordinatorsBarChart(coordinators) {
            const canvas = document.getElementById('coordinatorsBarChart');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (coordinators.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Adjust canvas height based on number of coordinators
            const barHeight = 40;
            const spacing = 15;
            const neededHeight = coordinators.length * (barHeight + spacing) + 40;
            canvas.height = Math.max(400, neededHeight);

            const padding = 180; // Left padding for labels
            const chartWidth = canvas.width - padding - 80;
            const maxValue = Math.max(...coordinators.map(c => c.total), 1);

            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#6366f1', '#14b8a6', '#f97316', '#84cc16', '#06b6d4'
            ];

            coordinators.forEach((coord, index) => {
                const y = 20 + index * (barHeight + spacing);
                const barWidth = (coord.total / maxValue) * chartWidth;

                // Coordinator name (right-aligned)
                ctx.fillStyle = '#e5e7eb';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(coord.name, padding - 15, y + barHeight / 2 + 5);

                // Bar
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(padding, y, barWidth, barHeight);

                // Hours value on the bar
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${Math.round(coord.total)} ×©×¢×•×ª`, padding + barWidth + 8, y + barHeight / 2 + 5);
            });
        }

        // Fill Coordinators Table
        function fillCoordinatorsTable(coordinators, totalHours) {
            const tbody = document.getElementById('coordinatorsTableBody');

            if (coordinators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-secondary);">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</td></tr>';
                return;
            }

            tbody.innerHTML = coordinators.map((coord, index) => {
                const percentage = ((coord.total / totalHours) * 100).toFixed(1);
                const subjectsText = coord.subjects.length > 0 ? coord.subjects.join(', ') : '××™×Ÿ';

                const rowStyle = index % 2 === 0
                    ? 'background: rgba(255, 255, 255, 0.02);'
                    : 'background: transparent;';

                return `
                    <tr style="${rowStyle} border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.1)'" onmouseout="this.style.background='${index % 2 === 0 ? 'rgba(255, 255, 255, 0.02)' : 'transparent'}'">
                        <td style="padding: 12px; text-align: right; color: var(--text-secondary); font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px; text-align: right; color: var(--text-color); font-weight: 600;">${coord.name}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-secondary); font-size: 12px;">${coord.email}</td>
                        <td style="padding: 12px; text-align: center; color: #3b82f6; font-weight: 600;">${Math.round(coord.teaching)}</td>
                        <td style="padding: 12px; text-align: center; color: #8b5cf6; font-weight: 600;">${Math.round(coord.training)}</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-color); font-weight: 700; font-size: 15px;">${Math.round(coord.total)}</td>
                        <td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${percentage}%</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-secondary); font-size: 12px; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${subjectsText}">${subjectsText}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load Records and Achievements
        async function loadRecordsAndAchievements() {
            try {
                const sanitizedEmail = sanitizeEmail(currentUser.email);
                const timesheetsRef = ref(database, `timesheets/${sanitizedEmail}`);
                const snapshot = await get(timesheetsRef);
                const data = snapshot.val() || {};

                // Data structures for analysis
                const dailyTotals = {};  // date -> hours
                const monthlyTotals = {}; // "year-month" -> {teaching, training, total, year, month}
                const subjectTotals = {}; // subject -> hours
                let totalTeaching = 0, totalTraining = 0;
                const allDates = [];

                // Collect all data
                Object.keys(data).forEach(year => {
                    Object.keys(data[year]).forEach(month => {
                        const entries = data[year][month].entries || {};
                        const monthKey = `${year}-${String(month).padStart(2, '0')}`;

                        if (!monthlyTotals[monthKey]) {
                            monthlyTotals[monthKey] = { teaching: 0, training: 0, total: 0, year: parseInt(year), month: parseInt(month) };
                        }

                        Object.values(entries).forEach(entry => {
                            const teaching = entry.hours?.teaching || 0;
                            const training = entry.hours?.training || 0;
                            const total = teaching + training;

                            // Daily totals
                            if (!dailyTotals[entry.date]) {
                                dailyTotals[entry.date] = 0;
                                allDates.push(entry.date);
                            }
                            dailyTotals[entry.date] += total;

                            // Monthly totals
                            monthlyTotals[monthKey].teaching += teaching;
                            monthlyTotals[monthKey].training += training;
                            monthlyTotals[monthKey].total += total;

                            // Subject totals
                            if (entry.subject) {
                                if (!subjectTotals[entry.subject]) subjectTotals[entry.subject] = 0;
                                subjectTotals[entry.subject] += total;
                            }

                            // Overall totals
                            totalTeaching += teaching;
                            totalTraining += training;
                        });
                    });
                });

                // Find best month
                const monthsArray = Object.entries(monthlyTotals).map(([key, data]) => ({ key, ...data }));
                const bestMonth = monthsArray.reduce((best, current) => current.total > best.total ? current : best, monthsArray[0] || { total: 0 });

                // Find best day
                const daysArray = Object.entries(dailyTotals).map(([date, hours]) => ({ date, hours }));
                const bestDay = daysArray.reduce((best, current) => current.hours > best.hours ? current : best, daysArray[0] || { hours: 0 });

                // Find longest streak
                const sortedDates = allDates.sort();
                let longestStreak = 0, currentStreak = 1, streakStart = null, longestStreakStart = null, longestStreakEnd = null;

                for (let i = 1; i < sortedDates.length; i++) {
                    const prevDate = new Date(sortedDates[i - 1]);
                    const currDate = new Date(sortedDates[i]);
                    const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        if (currentStreak > longestStreak) {
                            longestStreak = currentStreak;
                            longestStreakStart = sortedDates[i - currentStreak];
                            longestStreakEnd = sortedDates[i - 1];
                        }
                        currentStreak = 1;
                    }
                }

                if (currentStreak > longestStreak) {
                    longestStreak = currentStreak;
                    longestStreakStart = sortedDates[sortedDates.length - currentStreak];
                    longestStreakEnd = sortedDates[sortedDates.length - 1];
                }

                // Find top subject
                const subjectsArray = Object.entries(subjectTotals).map(([name, hours]) => ({ name, hours }));
                const topSubject = subjectsArray.reduce((best, current) => current.hours > best.hours ? current : best, subjectsArray[0] || { hours: 0, name: '××™×Ÿ' });

                // Update UI - Best Month
                const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
                document.getElementById('bestMonthValue').textContent = Math.round(bestMonth.total);
                document.getElementById('bestMonthDate').textContent = `${monthNames[bestMonth.month - 1]} ${bestMonth.year}`;

                // Update UI - Best Day
                document.getElementById('bestDayValue').textContent = Math.round(bestDay.hours);
                const bestDayDate = new Date(bestDay.date);
                document.getElementById('bestDayDate').textContent = bestDayDate.toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' });

                // Update UI - Longest Streak
                document.getElementById('longestStreakValue').textContent = longestStreak;
                if (longestStreakStart && longestStreakEnd) {
                    const startDate = new Date(longestStreakStart);
                    const endDate = new Date(longestStreakEnd);
                    document.getElementById('longestStreakDate').textContent =
                        `${startDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                } else {
                    document.getElementById('longestStreakDate').textContent = '--';
                }

                // Update UI - Top Subject
                document.getElementById('topSubjectName').textContent = topSubject.name;
                document.getElementById('topSubjectValue').textContent = Math.round(topSubject.hours);

                // Additional stats
                const totalWorkingDays = allDates.length;
                const totalHours = totalTeaching + totalTraining;
                const monthsWithData = monthsArray.filter(m => m.total > 0).length;

                document.getElementById('avgHoursPerWorkingDay').textContent = totalWorkingDays > 0 ? (totalHours / totalWorkingDays).toFixed(1) : '0';
                document.getElementById('avgHoursPerMonth').textContent = monthsWithData > 0 ? Math.round(totalHours / monthsWithData) : '0';
                document.getElementById('avgHoursPerWeek').textContent = totalWorkingDays > 0 ? ((totalHours / totalWorkingDays) * 5).toFixed(1) : '0';
                document.getElementById('totalWorkingDays').textContent = totalWorkingDays;
                document.getElementById('teachingPercentage').textContent = totalHours > 0 ? `${((totalTeaching / totalHours) * 100).toFixed(1)}%` : '0%';
                document.getElementById('trainingPercentage').textContent = totalHours > 0 ? `${((totalTraining / totalHours) * 100).toFixed(1)}%` : '0%';

                // Milestones
                const milestones = [];
                if (totalHours >= 1000) milestones.push({ icon: 'ğŸŠ', text: '×¢×‘×¨×ª 1,000 ×©×¢×•×ª!', color: '#f59e0b' });
                if (totalHours >= 2000) milestones.push({ icon: 'ğŸŒŸ', text: '×¢×‘×¨×ª 2,000 ×©×¢×•×ª!', color: '#ec4899' });
                if (totalHours >= 3000) milestones.push({ icon: 'ğŸ†', text: '×¢×‘×¨×ª 3,000 ×©×¢×•×ª!', color: '#8b5cf6' });
                if (totalHours >= 5000) milestones.push({ icon: 'ğŸ‘‘', text: '×¢×‘×¨×ª 5,000 ×©×¢×•×ª - ××œ×š/×ª ×”×”×“×¨×›×”!', color: '#10b981' });
                if (longestStreak >= 30) milestones.push({ icon: 'ğŸ”¥', text: `×¨×¦×£ ×©×œ ${longestStreak} ×™××™× - ××“×”×™×!`, color: '#ef4444' });
                if (totalWorkingDays >= 365) milestones.push({ icon: 'ğŸ“…', text: `${totalWorkingDays} ×™××™ ×¢×‘×•×“×” - ××—×•×™×™×‘×•×ª ××¨×©×™××”!`, color: '#3b82f6' });

                const milestonesContainer = document.getElementById('milestonesList');
                if (milestones.length > 0) {
                    milestonesContainer.innerHTML = milestones.map(m => `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border-left: 4px solid ${m.color};">
                            <div style="font-size: 32px;">${m.icon}</div>
                            <div style="color: ${m.color}; font-weight: 600; font-size: 16px;">${m.text}</div>
                        </div>
                    `).join('');
                } else {
                    milestonesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">×”××©×š ×œ×¢×‘×•×“ ×§×©×” ×›×“×™ ×œ×¤×ª×•×— ××‘× ×™ ×“×¨×š! ğŸ’ª</p>';
                }

            } catch (error) {
                console.error('Error loading records:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×©×™××™×');
            }
        }

        // Initialize DateTime update
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ===== REGISTER & DELETE INSTRUCTORS (ADMIN) =====

        // Open Register Modal
        document.getElementById('registerInstructorBtn')?.addEventListener('click', async () => {
            const modal = document.getElementById('registerInstructorModal');
            modal.style.display = 'flex';

            // Load all coordinators
            const coordSelect = document.getElementById('registerInstructorCoordinator');
            coordSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¨×›×– (××•×¤×¦×™×•× ×œ×™) --</option>';

            const coordinators = Object.entries(userRoles)
                .filter(([email, userData]) => userData.role === 'coordinator')
                .map(([email, userData]) => ({
                    email: email,
                    name: userData.fullName || userData.email || email
                }))
                .sort((a, b) => a.name.localeCompare(b.name, 'he'));

            coordinators.forEach(coord => {
                const option = document.createElement('option');
                option.value = coord.email;
                option.textContent = coord.name;
                coordSelect.appendChild(option);
            });

            // Hide subjects area initially
            document.getElementById('registerSubjectsArea').style.display = 'none';
            document.getElementById('registerSubjectsContainer').innerHTML = '';
        });

        // When coordinator is selected, show subjects
        document.getElementById('registerInstructorCoordinator')?.addEventListener('change', function() {
            const coordEmail = this.value;
            const subjectsArea = document.getElementById('registerSubjectsArea');
            const subjectsContainer = document.getElementById('registerSubjectsContainer');

            if (!coordEmail) {
                subjectsArea.style.display = 'none';
                subjectsContainer.innerHTML = '';
                return;
            }

            const coordData = userRoles[coordEmail];
            const coordSubjects = getAllUserSubjects(coordData);

            if (coordSubjects.length === 0) {
                subjectsArea.style.display = 'none';
                subjectsContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">×œ×¨×›×– ×–×” ××™×Ÿ ××§×¦×•×¢×•×ª ××•×’×“×¨×™×</div>';
                return;
            }

            // Show subjects area
            subjectsArea.style.display = 'block';
            subjectsContainer.innerHTML = '';

            coordSubjects.sort((a, b) => a.localeCompare(b, 'he')).forEach(subject => {
                const checkbox = document.createElement('label');
                checkbox.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(99, 102, 241, 0.1); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text-primary);';
                checkbox.innerHTML = `
                    <input type="checkbox" class="register-subject-checkbox" value="${subject}" style="cursor: pointer;">
                    <span>${subject}</span>
                `;
                subjectsContainer.appendChild(checkbox);
            });
        });

        // Close Register Modal
        document.getElementById('closeRegisterModal')?.addEventListener('click', () => {
            document.getElementById('registerInstructorModal').style.display = 'none';
            document.getElementById('registerInstructorForm').reset();
        });

        // Submit Registration Form
        const registerForm = document.getElementById('registerInstructorForm');
        console.log('Register form element:', registerForm);
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();

            const fullName = document.getElementById('instructorFullName').value.trim();
            const email = document.getElementById('instructorEmail').value.trim().toLowerCase();

            if (!fullName || !email) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                return;
            }

            // Check if email already exists
            if (userRoles[email]) {
                showError('××™××™×™×œ ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
                return;
            }

            try {
                showLoading(true);

                // Get selected coordinator and subjects
                const selectedCoordinator = document.getElementById('registerInstructorCoordinator').value;
                const selectedSubjects = Array.from(document.querySelectorAll('.register-subject-checkbox:checked'))
                    .map(cb => cb.value);

                // Validate: if subjects are selected, coordinator must be selected too
                if (selectedSubjects.length > 0 && !selectedCoordinator) {
                    showError('×™×© ×œ×‘×—×•×¨ ×¨×›×– ×ª×—×™×œ×” ×œ×¤× ×™ ×‘×—×™×¨×ª ××§×¦×•×¢×•×ª');
                    showLoading(false);
                    return;
                }

                const sanitizedEmail = sanitizeEmail(email);
                const userData = {
                    fullName: fullName,
                    email: email,
                    role: 'instructor',
                    subjects: { morning: [], afternoon: [] },
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email
                };

                // Check if using hierarchical or flat structure
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                const firebaseUsers = snapshot.exists() ? snapshot.val() : {};

                if (firebaseUsers.instructors || firebaseUsers.coordinators || firebaseUsers.admins || firebaseUsers.finance) {
                    // Hierarchical structure - save under users/instructors
                    await set(ref(database, `users/instructors/${sanitizedEmail}`), userData);
                    console.log('Saved to hierarchical structure: users/instructors/' + sanitizedEmail);
                } else {
                    // Flat structure - save directly under users
                    await set(ref(database, `users/${sanitizedEmail}`), userData);
                    console.log('Saved to flat structure: users/' + sanitizedEmail);
                }

                // Add to userRoles immediately
                userRoles[email] = userData;

                showSuccess(`××“×¨×™×š ${fullName} × ×¨×©× ×‘×”×¦×œ×—×”!`);
                document.getElementById('registerInstructorModal').style.display = 'none';
                document.getElementById('registerInstructorForm').reset();

                // Reload users to sync with Firebase FIRST
                await loadUsersFromFirebase();

                // THEN assign instructor to selected coordinator if any (after reload)
                if (selectedCoordinator) {
                    console.log('Assigning instructor to coordinator:', selectedCoordinator, 'with subjects:', selectedSubjects);

                    const coordData = userRoles[selectedCoordinator];
                    if (coordData) {
                        // Initialize assignedInstructors if needed
                        if (!coordData.assignedInstructors) {
                            coordData.assignedInstructors = [];
                        }

                        // Check if already assigned
                        const existingIndex = coordData.assignedInstructors.findIndex(
                            instructor => (typeof instructor === 'string' ? instructor : instructor.email) === email
                        );

                        const assignment = {
                            email: email,
                            subjects: selectedSubjects  // Can be empty array
                        };

                        if (existingIndex !== -1) {
                            // Update existing assignment
                            coordData.assignedInstructors[existingIndex] = assignment;
                        } else {
                            // Add new assignment
                            coordData.assignedInstructors.push(assignment);
                        }

                        // Update in userRoles
                        userRoles[selectedCoordinator].assignedInstructors = coordData.assignedInstructors;

                        // Save to Firebase
                        const coordPath = getUserPath(selectedCoordinator);
                        const coordRef = ref(database, `${coordPath}/assignedInstructors`);
                        await set(coordRef, coordData.assignedInstructors);

                        console.log(`Assigned ${email} to coordinator ${selectedCoordinator} for subjects:`, selectedSubjects);
                    }
                }

                // Update lists dynamically
                // Check if admin tab is visible and update admin instructors list
                if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                    await loadAdminInstructorsList();
                }

                // Update coordinator's instructor dropdown for assignment (if element exists)
                const instructorDropdown = document.getElementById('selectInstructorToAssign');
                if (instructorDropdown) {
                    await populateInstructorDropdown();
                }

                // Check if coordinator tab is visible and update coordinator instructors list
                if (document.getElementById('coordinatorPanel')?.style.display === 'block') {
                    await loadCoordinatorData();
                }

                showLoading(false);
            } catch (error) {
                console.error('Error registering instructor:', error);
                showError('×©×’×™××” ×‘×¨×™×©×•× ×”××“×¨×™×š: ' + error.message);
                showLoading(false);
            }
            });
        } else {
            console.error('Register form not found! DOM may not be loaded yet.');
        }

        // Open Delete Modal
        document.getElementById('deleteInstructorBtn')?.addEventListener('click', async () => {
            const modal = document.getElementById('deleteInstructorModal');
            modal.style.display = 'flex';

            loadDeleteInstructorsList();
        });

        // Close Delete Modal
        document.getElementById('closeDeleteModal')?.addEventListener('click', () => {
            document.getElementById('deleteInstructorModal').style.display = 'none';
        });

        // Load instructors list for deletion
        function loadDeleteInstructorsList(searchQuery = '') {
            const listContainer = document.getElementById('deleteInstructorsList');
            listContainer.innerHTML = '';

            const instructors = Object.entries(userRoles)
                .filter(([email, userData]) => userData.role === 'instructor')
                .filter(([email, userData]) => {
                    if (!searchQuery) return true;
                    const query = searchQuery.toLowerCase();
                    return userData.fullName?.toLowerCase().includes(query) || email.toLowerCase().includes(query);
                })
                .sort((a, b) => (a[1].fullName || a[0]).localeCompare(b[1].fullName || b[0], 'he'));

            if (instructors.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">×œ× × ××¦××• ××“×¨×™×›×™×</p>';
                return;
            }

            instructors.forEach(([email, userData]) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); border-radius: 8px;';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary);">${userData.fullName || '×œ×œ× ×©×'}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${email}</div>
                    </div>
                    <button class="delete-instructor-btn" data-email="${email}" style="padding: 8px 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                        ğŸ—‘ï¸ ××—×§
                    </button>
                `;
                listContainer.appendChild(item);
            });

            // Add delete button listeners
            document.querySelectorAll('.delete-instructor-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const email = e.target.getAttribute('data-email');
                    const userData = userRoles[email];

                    if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ${userData.fullName || email}?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ ×”××“×¨×™×š ×œ×¦××™×ª×•×ª!`)) {
                        return;
                    }

                    try {
                        showLoading(true);

                        const sanitizedEmail = sanitizeEmail(email);

                        // Check if using hierarchical or flat structure
                        const usersRef = ref(database, 'users');
                        const snapshot = await get(usersRef);
                        const firebaseUsers = snapshot.exists() ? snapshot.val() : {};

                        if (firebaseUsers.instructors || firebaseUsers.coordinators || firebaseUsers.admins || firebaseUsers.finance) {
                            // Hierarchical structure - delete from users/instructors
                            await remove(ref(database, `users/instructors/${sanitizedEmail}`));
                            console.log('Deleted from hierarchical structure: users/instructors/' + sanitizedEmail);
                        } else {
                            // Flat structure - delete directly from users
                            await remove(ref(database, `users/${sanitizedEmail}`));
                            console.log('Deleted from flat structure: users/' + sanitizedEmail);
                        }

                        // Delete all timesheets
                        await remove(ref(database, `timesheets/${sanitizedEmail}`));

                        // Remove from userRoles immediately
                        delete userRoles[email];

                        // Reload users
                        await loadUsersFromFirebase();

                        showSuccess(`××“×¨×™×š ${userData.fullName || email} × ××—×§ ×‘×”×¦×œ×—×”`);
                        loadDeleteInstructorsList();

                        // Update lists dynamically
                        // Check if admin tab is visible and update admin instructors list
                        if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                            await loadAdminInstructorsList();
                        }

                        // Update coordinator's instructor dropdown for assignment (if element exists)
                        const instructorDropdown = document.getElementById('selectInstructorToAssign');
                        if (instructorDropdown) {
                            await populateInstructorDropdown();
                        }

                        // Check if coordinator tab is visible and update coordinator instructors list
                        if (document.getElementById('coordinatorPanel')?.style.display === 'block') {
                            await loadCoordinatorData();
                        }

                        showLoading(false);
                    } catch (error) {
                        console.error('Error deleting instructor:', error);
                        showError('×©×’×™××” ×‘××—×™×§×ª ×”××“×¨×™×š: ' + error.message);
                        showLoading(false);
                    }
                });
            });
        }

        // Search in delete modal
        document.getElementById('deleteSearchInput')?.addEventListener('input', (e) => {
            loadDeleteInstructorsList(e.target.value);
        });

        // ============================================
        // ADMIN: ASSIGN INSTRUCTOR TO COORDINATOR
        // ============================================

        // Helper function to populate coordinator dropdowns (called dynamically after adding coordinator)
        function populateCoordinatorDropdowns() {
            // Update all coordinator dropdowns in the system
            const coordinators = Object.entries(userRoles)
                .filter(([email, data]) => data.role === 'coordinator')
                .sort((a, b) => (a[1].fullName || a[0]).localeCompare(b[1].fullName || b[0], 'he'));

            // 1. Update dropdown in "Assign to Coordinator" modal (adminSelectCoordinator)
            const adminCoordSelect = document.getElementById('adminSelectCoordinator');
            if (adminCoordSelect) {
                const currentValue = adminCoordSelect.value;
                adminCoordSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¨×›×– --</option>';
                coordinators.forEach(([email, data]) => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = data.fullName || email;
                    adminCoordSelect.appendChild(option);
                });
                // Restore previous selection if it still exists
                if (currentValue && coordinators.some(([email]) => email === currentValue)) {
                    adminCoordSelect.value = currentValue;
                }
            }

            // 2. Update dropdown in "Register Instructor" modal (registerInstructorCoordinator)
            const registerCoordSelect = document.getElementById('registerInstructorCoordinator');
            if (registerCoordSelect) {
                const currentValue = registerCoordSelect.value;
                registerCoordSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¨×›×– (××•×¤×¦×™×•× ×œ×™) --</option>';
                coordinators.forEach(([email, data]) => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = data.fullName || email;
                    registerCoordSelect.appendChild(option);
                });
                // Restore previous selection if it still exists
                if (currentValue && coordinators.some(([email]) => email === currentValue)) {
                    registerCoordSelect.value = currentValue;
                }
            }
        }

        // Open Assign to Coordinator Modal
        document.getElementById('assignInstructorToCoordBtn')?.addEventListener('click', async () => {
            const modal = document.getElementById('assignToCoordModal');
            modal.style.display = 'flex';

            // Populate instructors dropdown
            const instructorSelect = document.getElementById('adminSelectInstructor');
            instructorSelect.innerHTML = '<option value="">-- ×‘×—×¨ ××“×¨×™×š --</option>';

            const instructors = Object.entries(userRoles)
                .filter(([email, data]) => data.role === 'instructor')
                .sort((a, b) => (a[1].fullName || a[0]).localeCompare(b[1].fullName || b[0], 'he'));

            instructors.forEach(([email, data]) => {
                const option = document.createElement('option');
                option.value = email;
                option.textContent = data.fullName || email;
                instructorSelect.appendChild(option);
            });

            // Populate coordinators dropdown using the helper function
            populateCoordinatorDropdowns();
        });

        // Close Assign to Coordinator Modal
        document.getElementById('closeAssignToCoordModal')?.addEventListener('click', () => {
            document.getElementById('assignToCoordModal').style.display = 'none';
            resetAssignToCoordForm();
        });

        function resetAssignToCoordForm() {
            document.getElementById('adminSelectInstructor').value = '';
            document.getElementById('adminSelectCoordinator').value = '';
            document.getElementById('adminCurrentAssignments').style.display = 'none';
            document.getElementById('adminSubjectSelectionArea').style.display = 'none';
            document.getElementById('adminSubjectCheckboxes').innerHTML = '';
            document.getElementById('adminCurrentAssignmentsList').innerHTML = '';
            const confirmBtn = document.getElementById('confirmAssignToCoordBtn');
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.pointerEvents = 'none';
        }

        // Show current assignments when instructor is selected
        document.getElementById('adminSelectInstructor')?.addEventListener('change', function() {
            const instructorEmail = this.value;
            const assignmentsArea = document.getElementById('adminCurrentAssignments');
            const assignmentsList = document.getElementById('adminCurrentAssignmentsList');

            if (!instructorEmail) {
                assignmentsArea.style.display = 'none';
                return;
            }

            // Find all coordinators that have this instructor assigned
            const assignments = [];
            Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                if (coordData.role !== 'coordinator') return;
                if (!coordData.assignedInstructors) return;

                const assignment = coordData.assignedInstructors.find(
                    inst => (typeof inst === 'string' ? inst : inst.email) === instructorEmail
                );

                if (assignment) {
                    const subjects = typeof assignment === 'string' ? [] : (assignment.subjects || []);
                    assignments.push({
                        coordEmail,
                        coordName: coordData.fullName || coordEmail,
                        subjects
                    });
                }
            });

            if (assignments.length === 0) {
                assignmentsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 12px;">××™×Ÿ ×©×™×•×›×™× ×§×™×™××™×</p>';
                assignmentsArea.style.display = 'block';
                return;
            }

            // Display assignments
            assignmentsList.innerHTML = '';
            assignments.forEach(({ coordEmail, coordName, subjects }) => {
                const assignmentCard = document.createElement('div');
                assignmentCard.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px;';
                assignmentCard.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${coordName}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${subjects.length > 0 ? subjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª'}
                        </div>
                    </div>
                    <button class="remove-assignment-btn" data-coord-email="${coordEmail}" data-instructor-email="${instructorEmail}"
                        style="padding: 6px 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                        ğŸ—‘ï¸ ×”×¡×¨
                    </button>
                `;
                assignmentsList.appendChild(assignmentCard);
            });

            // Add remove button listeners
            document.querySelectorAll('.remove-assignment-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const coordEmail = e.target.getAttribute('data-coord-email');
                    const instructorEmail = e.target.getAttribute('data-instructor-email');

                    if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×”×©×™×•×š?`)) {
                        return;
                    }

                    try {
                        showLoading(true);

                        const coordData = userRoles[coordEmail];

                        // Remove the instructor from coordinator's assignedInstructors
                        coordData.assignedInstructors = coordData.assignedInstructors.filter(
                            inst => (typeof inst === 'string' ? inst : inst.email) !== instructorEmail
                        );

                        // Update in userRoles
                        userRoles[coordEmail].assignedInstructors = coordData.assignedInstructors;

                        // Save to Firebase
                        const coordPath = getUserPath(coordEmail);
                        const coordRef = ref(database, `${coordPath}/assignedInstructors`);
                        await set(coordRef, coordData.assignedInstructors);

                        showSuccess('×”×©×™×•×š ×”×•×¡×¨ ×‘×”×¦×œ×—×”');

                        // Refresh the assignments list
                        document.getElementById('adminSelectInstructor').dispatchEvent(new Event('change'));

                        // Update admin instructors list to show removed assignments
                        if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                            await loadAdminInstructorsList();
                        }

                        // Update coordinator's view if they're viewing their panel
                        if (document.getElementById('coordinatorPanel')?.style.display === 'block') {
                            await loadCoordinatorData();
                        }

                        showLoading(false);
                    } catch (error) {
                        console.error('Error removing assignment:', error);
                        showError('×©×’×™××” ×‘×”×¡×¨×ª ×”×©×™×•×š: ' + error.message);
                        showLoading(false);
                    }
                });
            });

            assignmentsArea.style.display = 'block';
        });

        // Show subjects when coordinator is selected
        document.getElementById('adminSelectCoordinator')?.addEventListener('change', async function() {
            const coordEmail = this.value;
            const subjectArea = document.getElementById('adminSubjectSelectionArea');
            const subjectCheckboxes = document.getElementById('adminSubjectCheckboxes');
            const confirmBtn = document.getElementById('confirmAssignToCoordBtn');

            if (!coordEmail) {
                subjectArea.style.display = 'none';
                confirmBtn.style.opacity = '0.5';
                confirmBtn.style.pointerEvents = 'none';
                return;
            }

            // Enable confirm button immediately when coordinator is selected
            confirmBtn.style.opacity = '1';
            confirmBtn.style.pointerEvents = 'auto';

            const instructorEmail = window.currentAssignInstructorEmail;
            const instructorData = userRoles[instructorEmail];
            const coordData = userRoles[coordEmail];

            // ALWAYS show the selected coordinator's subjects, not all departments
            // This ensures that subjects are filtered by the coordinator being assigned to
            const coordSubjects = getAllUserSubjects(coordData);

            if (coordSubjects.length === 0) {
                // No subjects available, but still allow assignment without subjects
                subjectArea.style.display = 'none';
                subjectCheckboxes.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">×œ×¨×›×– ×–×” ××™×Ÿ ××§×¦×•×¢×•×ª ××•×’×“×¨×™×. × ×™×ª×Ÿ ×œ×©×™×™×š ××ª ×”××“×¨×™×š ×œ×œ× ××§×¦×•×¢×•×ª.</div>';
                return;
            }

            // Show subject selection
            subjectArea.style.display = 'block';
            subjectCheckboxes.innerHTML = '';

            // Separate subjects by period - get directly from coordinator's subjects structure
            const morningSubjs = coordData.subjects?.morning || [];
            const afternoonSubjs = coordData.subjects?.afternoon || [];

            // Add morning section
            if (morningSubjs.length > 0) {
                const morningHeader = document.createElement('div');
                morningHeader.style.cssText = 'font-weight: 700; font-size: 15px; color: #3b82f6; margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border-radius: 10px; border-left: 5px solid #3b82f6;';
                morningHeader.innerHTML = 'ğŸ“… ××©××¨×ª ×‘×•×§×¨';
                subjectCheckboxes.appendChild(morningHeader);

                const morningContainer = document.createElement('div');
                morningContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;';

                morningSubjs.forEach(subject => {
                    const checkbox = document.createElement('label');
                    checkbox.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text-primary);';
                    checkbox.innerHTML = `
                        <input type="checkbox" class="admin-subject-checkbox" value="${subject}" style="cursor: pointer;">
                        <span>${subject}</span>
                    `;
                    morningContainer.appendChild(checkbox);
                });
                subjectCheckboxes.appendChild(morningContainer);
            }

            // Add afternoon section
            if (afternoonSubjs.length > 0) {
                const afternoonHeader = document.createElement('div');
                afternoonHeader.style.cssText = 'font-weight: 700; font-size: 15px; color: #f59e0b; margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); border-radius: 10px; border-left: 5px solid #f59e0b;';
                afternoonHeader.innerHTML = 'ğŸŒ† ××©××¨×ª ××—×”"×¦';
                subjectCheckboxes.appendChild(afternoonHeader);

                const afternoonContainer = document.createElement('div');
                afternoonContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';

                afternoonSubjs.forEach(subject => {
                    const checkbox = document.createElement('label');
                    checkbox.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text-primary);';
                    checkbox.innerHTML = `
                        <input type="checkbox" class="admin-subject-checkbox" value="${subject}" style="cursor: pointer;">
                        <span>${subject}</span>
                    `;
                    afternoonContainer.appendChild(checkbox);
                });
                subjectCheckboxes.appendChild(afternoonContainer);
            }
        });

        // Confirm assignment
        document.getElementById('confirmAssignToCoordBtn')?.addEventListener('click', async () => {
            const instructorEmail = window.currentAssignInstructorEmail;
            const coordEmail = document.getElementById('adminSelectCoordinator').value;
            const selectedSubjects = Array.from(document.querySelectorAll('.admin-subject-checkbox:checked'))
                .map(cb => cb.value);

            if (!instructorEmail) {
                showError('×‘×—×¨ ××“×¨×™×š');
                return;
            }

            if (!coordEmail) {
                showError('×‘×—×¨ ×¨×›×–');
                return;
            }

            // Subjects are now optional - no need to check if selectedSubjects.length === 0

            try {
                showLoading(true);

                const coordData = userRoles[coordEmail];

                if (!coordData) {
                    showError('×œ× × ××¦× ×¨×›×– ×‘××¢×¨×›×ª');
                    showLoading(false);
                    return;
                }

                // Initialize assignedInstructors if needed
                if (!coordData.assignedInstructors) {
                    coordData.assignedInstructors = [];
                }

                // Check if already assigned
                const existingIndex = coordData.assignedInstructors.findIndex(
                    instructor => (typeof instructor === 'string' ? instructor : instructor.email) === instructorEmail
                );

                if (existingIndex !== -1) {
                    // Update existing assignment
                    coordData.assignedInstructors[existingIndex] = {
                        email: instructorEmail,
                        subjects: selectedSubjects
                    };
                    console.log('Updated existing assignment');
                } else {
                    // Add new assignment
                    coordData.assignedInstructors.push({
                        email: instructorEmail,
                        subjects: selectedSubjects
                    });
                    console.log('Added new assignment');
                }

                // Update in userRoles
                userRoles[coordEmail].assignedInstructors = coordData.assignedInstructors;

                // Save to Firebase
                const coordPath = getUserPath(coordEmail);
                console.log('Saving to Firebase path:', `${coordPath}/assignedInstructors`);
                console.log('Assignment data:', coordData.assignedInstructors);

                const coordRef = ref(database, `${coordPath}/assignedInstructors`);
                await set(coordRef, coordData.assignedInstructors);

                console.log('Successfully saved to Firebase');

                const instructorName = userRoles[instructorEmail]?.fullName || instructorEmail;
                const coordName = coordData.fullName || coordEmail;

                const subjectsText = selectedSubjects.length > 0 ? selectedSubjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª';
                showSuccess(`${instructorName} ×©×•×™×š ×‘×”×¦×œ×—×” ×œ×¨×›×– ${coordName} ×¢×‘×•×¨: ${subjectsText}`);

                // Update admin instructors list to show new assignments
                if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                    await loadAdminInstructorsList();
                }

                // Update coordinators list to show new assignments
                if (document.getElementById('adminManageCoordinators')?.style.display !== 'none') {
                    await loadAdminCoordinatorsList();
                }

                // Update coordinator's view if they're viewing their panel
                if (document.getElementById('coordinatorPanel')?.style.display === 'block') {
                    await loadCoordinatorData();
                }

                // Close the modal
                document.getElementById('assignToCoordModal').style.display = 'none';

                showLoading(false);
            } catch (error) {
                console.error('Error assigning instructor to coordinator:', error);
                showError('×©×’×™××” ×‘×©×™×•×š ×”××“×¨×™×š: ' + error.message);
                showLoading(false);
            }
        });

        // Close modals on outside click
        document.getElementById('registerInstructorModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'registerInstructorModal') {
                document.getElementById('registerInstructorModal').style.display = 'none';
                document.getElementById('registerInstructorForm').reset();
            }
        });

        document.getElementById('deleteInstructorModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'deleteInstructorModal') {
                document.getElementById('deleteInstructorModal').style.display = 'none';
            }
        });

        document.getElementById('assignToCoordModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'assignToCoordModal') {
                document.getElementById('assignToCoordModal').style.display = 'none';
                resetAssignToCoordForm();
            }
        });

        // ===== COORDINATORS MANAGEMENT EVENT LISTENERS =====

        // Add Coordinator Button - Open Modal
        document.getElementById('addCoordinatorBtn')?.addEventListener('click', () => {
            document.getElementById('addCoordinatorModal').style.display = 'flex';
            document.getElementById('addCoordinatorForm').reset();
        });

        // Close Add Coordinator Modal
        document.getElementById('closeAddCoordinatorModal')?.addEventListener('click', () => {
            document.getElementById('addCoordinatorModal').style.display = 'none';
            document.getElementById('addCoordinatorForm').reset();
        });

        // Click outside to close
        document.getElementById('addCoordinatorModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'addCoordinatorModal') {
                document.getElementById('addCoordinatorModal').style.display = 'none';
                document.getElementById('addCoordinatorForm').reset();
            }
        });

        // Add Coordinator Form Submit
        document.getElementById('addCoordinatorForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('coordinatorFullName').value.trim();
            const email = document.getElementById('coordinatorEmail').value.trim();
            const employmentType = document.getElementById('coordinatorEmploymentType').value;

            if (!fullName || !email || !employmentType) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            const normalizedEmail = email.toLowerCase();
            const sanitizedEmail = sanitizeEmail(normalizedEmail);

            // Check if email already exists in Firebase
            const checkRef = ref(database, `userRoles/${sanitizedEmail}`);
            const checkSnapshot = await get(checkRef);

            if (checkSnapshot.exists()) {
                showError('××™××™×™×œ ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
                return;
            }

            try {
                showLoading(true);

                // Add coordinator to users/coordinators (use sanitized for Firebase path)
                const coordRef = ref(database, `users/coordinators/${sanitizedEmail}`);
                await set(coordRef, {
                    role: 'coordinator',
                    fullName: fullName,
                    email: normalizedEmail,  // Store original email
                    subjects: { morning: [], afternoon: [] },
                    assignedInstructors: [],
                    employmentType: employmentType  // 'hourly' or 'global'
                });

                // Update local userRoles immediately (use REAL email as key, not sanitized)
                userRoles[normalizedEmail] = {
                    role: 'coordinator',
                    fullName: fullName,
                    email: normalizedEmail,
                    subjects: { morning: [], afternoon: [] },
                    assignedInstructors: [],
                    employmentType: employmentType
                };

                showSuccess(`×”×¨×›×– ${fullName} × ×•×¡×£ ×‘×”×¦×œ×—×”! âœ…`);
                document.getElementById('addCoordinatorModal').style.display = 'none';
                document.getElementById('addCoordinatorForm').reset();
                await loadAdminCoordinatorsList();

                // If hourly coordinator, also update instructors list (they appear in both lists)
                if (employmentType === 'hourly') {
                    await loadAdminInstructorsList();
                }

                // Update all coordinator dropdowns dynamically (fix for Bug #1)
                populateCoordinatorDropdowns();
            } catch (error) {
                console.error('Error adding coordinator:', error);
                showError('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¨×›×–');
            } finally {
                showLoading(false);
            }
        });

        // ===== FINANCE MANAGERS MODAL HANDLERS =====

        // Close Add Finance Manager Modal
        document.getElementById('closeAddFinanceManagerModal')?.addEventListener('click', () => {
            document.getElementById('addFinanceManagerModal').style.display = 'none';
            document.getElementById('addFinanceManagerForm').reset();
        });

        // Click outside to close
        document.getElementById('addFinanceManagerModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'addFinanceManagerModal') {
                document.getElementById('addFinanceManagerModal').style.display = 'none';
                document.getElementById('addFinanceManagerForm').reset();
            }
        });

        // Add Finance Manager Form Submit
        document.getElementById('addFinanceManagerForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('financeManagerFullName').value.trim();
            const email = document.getElementById('financeManagerEmail').value.trim();

            if (!fullName || !email) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            const normalizedEmail = email.toLowerCase();
            const sanitizedEmail = sanitizeEmail(normalizedEmail);

            // Check if email already exists in Firebase
            const checkRef = ref(database, `userRoles/${sanitizedEmail}`);
            const checkSnapshot = await get(checkRef);

            if (checkSnapshot.exists()) {
                showError('××™××™×™×œ ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
                return;
            }

            try {
                showLoading(true);

                // Add finance manager to users/finance (use sanitized for Firebase path)
                const financeRef = ref(database, `users/finance/${sanitizedEmail}`);
                await set(financeRef, {
                    role: 'finance',
                    fullName: fullName,
                    email: normalizedEmail  // Store original email
                });

                // Update local userRoles immediately (use REAL email as key, not sanitized)
                userRoles[normalizedEmail] = {
                    role: 'finance',
                    fullName: fullName,
                    email: normalizedEmail
                };

                showSuccess(`×× ×”×œ×ª ×”×›×¡×¤×™× ${fullName} × ×•×¡×¤×” ×‘×”×¦×œ×—×”! âœ…`);
                document.getElementById('addFinanceManagerModal').style.display = 'none';
                document.getElementById('addFinanceManagerForm').reset();
                await loadAdminFinanceManagersList();
            } catch (error) {
                console.error('Error adding finance manager:', error);
                showError('×©×’×™××” ×‘×”×•×¡×¤×ª ×× ×”×œ×ª ×›×¡×¤×™×');
                showLoading(false);
            }
        });

        // Close Edit Finance Manager Modal
        document.getElementById('closeEditFinanceManagerModal')?.addEventListener('click', () => {
            document.getElementById('editFinanceManagerModal').style.display = 'none';
            document.getElementById('editFinanceManagerForm').reset();
        });

        // Click outside to close
        document.getElementById('editFinanceManagerModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'editFinanceManagerModal') {
                document.getElementById('editFinanceManagerModal').style.display = 'none';
                document.getElementById('editFinanceManagerForm').reset();
            }
        });

        // Edit Finance Manager Form Submit
        document.getElementById('editFinanceManagerForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('editFinanceManagerEmail').value;
            const fullName = document.getElementById('editFinanceManagerName').value.trim();

            if (!fullName) {
                showError('× × ×œ××œ× ××ª ×©× ××œ×');
                return;
            }

            try {
                showLoading(true);
                const sanitizedEmail = sanitizeEmail(email);

                // Update finance manager in Firebase
                const financeRef = ref(database, `users/finance/${sanitizedEmail}`);
                await set(financeRef, {
                    role: 'finance',
                    fullName: fullName,
                    email: email
                });

                // Update local userRoles
                if (userRoles[email]) {
                    userRoles[email].fullName = fullName;
                }

                showSuccess(`×× ×”×œ×ª ×”×›×¡×¤×™× ${fullName} ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”! âœ…`);
                document.getElementById('editFinanceManagerModal').style.display = 'none';
                document.getElementById('editFinanceManagerForm').reset();
                await loadAdminFinanceManagersList();
            } catch (error) {
                console.error('Error updating finance manager:', error);
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×× ×”×œ×ª ×›×¡×¤×™×');
                showLoading(false);
            }
        });

        // Open Assign Subjects Modal (global function for onclick)
        window.openAssignSubjectsModal = async function(coordEmail) {
            try {
                showLoading(true);

                const coordData = userRoles[coordEmail];
                if (!coordData) {
                    showError('×¨×›×– ×œ× × ××¦×');
                    showLoading(false);
                    return;
                }

                // Load departments from Firebase
                const morningRef = ref(database, 'departments/morning');
                const afternoonRef = ref(database, 'departments/afternoon');

                const [morningSnapshot, afternoonSnapshot] = await Promise.all([
                    get(morningRef),
                    get(afternoonRef)
                ]);

                const morningSubjects = [];
                const afternoonSubjects = [];

                if (morningSnapshot.exists()) {
                    // Department names are stored as keys in Firebase
                    morningSubjects.push(...Object.keys(morningSnapshot.val()));
                }

                if (afternoonSnapshot.exists()) {
                    // Department names are stored as keys in Firebase
                    afternoonSubjects.push(...Object.keys(afternoonSnapshot.val()));
                }

                // Sort subjects
                morningSubjects.sort((a, b) => a.localeCompare(b, 'he'));
                afternoonSubjects.sort((a, b) => a.localeCompare(b, 'he'));

                // Find subjects already assigned to OTHER coordinators
                const assignedToOthers = { morning: new Set(), afternoon: new Set() };
                Object.entries(userRoles).forEach(([otherCoordEmail, coordInfo]) => {
                    if (coordInfo.role === 'coordinator' && otherCoordEmail !== coordEmail) {
                        if (coordInfo.subjects?.morning) {
                            coordInfo.subjects.morning.forEach(s => assignedToOthers.morning.add(s));
                        }
                        if (coordInfo.subjects?.afternoon) {
                            coordInfo.subjects.afternoon.forEach(s => assignedToOthers.afternoon.add(s));
                        }
                    }
                });

                // Filter out subjects assigned to other coordinators
                const availableMorning = morningSubjects.filter(s => !assignedToOthers.morning.has(s));
                const availableAfternoon = afternoonSubjects.filter(s => !assignedToOthers.afternoon.has(s));

                // Store data for the modal
                window.currentAssignSubjectData = {
                    coordEmail: coordEmail,
                    coordData: coordData,
                    morningSubjects: availableMorning,
                    afternoonSubjects: availableAfternoon,
                    allMorningSubjects: morningSubjects,  // Keep all for display of current
                    allAfternoonSubjects: afternoonSubjects
                };

                // Display coordinator name in modal
                const currentMorning = coordData?.subjects?.morning || [];
                const currentAfternoon = coordData?.subjects?.afternoon || [];

                // Display current subjects
                const currentSubjectsList = document.getElementById('currentSubjectsList');
                if (currentMorning.length === 0 && currentAfternoon.length === 0) {
                    currentSubjectsList.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">××™×Ÿ ××§×¦×•×¢×•×ª ××©×•×™×›×™×</div>';
                } else {
                    let html = '';
                    if (currentMorning.length > 0) {
                        html += `<div style="margin-bottom: 8px;"><strong style="color: var(--accent-blue);">×‘×•×§×¨:</strong> ${currentMorning.join(', ')}</div>`;
                    }
                    if (currentAfternoon.length > 0) {
                        html += `<div><strong style="color: var(--accent-purple);">××—×¨ ×”×¦×”×¨×™×™×:</strong> ${currentAfternoon.join(', ')}</div>`;
                    }
                    currentSubjectsList.innerHTML = html;
                }

                document.getElementById('currentSubjectsDisplay').style.display = 'block';

                // Populate subject checkboxes
                const morningContainer = document.getElementById('morningSubjectsCheckboxes');
                const afternoonContainer = document.getElementById('afternoonSubjectsCheckboxes');

                morningContainer.innerHTML = '';
                afternoonContainer.innerHTML = '';

                // Morning subjects (only show available ones)
                if (availableMorning.length === 0 && currentMorning.length === 0) {
                    morningContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">××™×Ÿ ××§×¦×•×¢×•×ª ×‘×•×§×¨ ×–××™× ×™× (×›×œ ×”××§×¦×•×¢×•×ª ××©×•×™×›×™× ×œ×¨×›×–×™× ××—×¨×™×)</div>';
                } else {
                    // Show current assigned subjects (even if they're "taken" by this coordinator)
                    const morningToShow = new Set([...availableMorning, ...currentMorning]);
                    Array.from(morningToShow).sort((a, b) => a.localeCompare(b, 'he')).forEach(subject => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-primary);';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = subject;
                        checkbox.checked = currentMorning.includes(subject);
                        checkbox.dataset.timeOfDay = 'morning';
                        checkbox.style.cursor = 'pointer';

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(subject));
                        morningContainer.appendChild(label);
                    });
                }

                // Afternoon subjects (only show available ones)
                if (availableAfternoon.length === 0 && currentAfternoon.length === 0) {
                    afternoonContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px;">××™×Ÿ ××§×¦×•×¢×•×ª ××—×¨ ×”×¦×”×¨×™×™× ×–××™× ×™× (×›×œ ×”××§×¦×•×¢×•×ª ××©×•×™×›×™× ×œ×¨×›×–×™× ××—×¨×™×)</div>';
                } else {
                    // Show current assigned subjects (even if they're "taken" by this coordinator)
                    const afternoonToShow = new Set([...availableAfternoon, ...currentAfternoon]);
                    Array.from(afternoonToShow).sort((a, b) => a.localeCompare(b, 'he')).forEach(subject => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-primary);';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = subject;
                        checkbox.checked = currentAfternoon.includes(subject);
                        checkbox.dataset.timeOfDay = 'afternoon';
                        checkbox.style.cursor = 'pointer';

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(subject));
                        afternoonContainer.appendChild(label);
                    });
                }

                document.getElementById('subjectSelectionArea').style.display = 'block';
                document.getElementById('confirmAssignSubjectBtn').style.opacity = '1';
                document.getElementById('confirmAssignSubjectBtn').style.pointerEvents = 'auto';

                showLoading(false);

                // Show the modal
                document.getElementById('assignSubjectModal').style.display = 'flex';

            } catch (error) {
                console.error('Error opening assign subjects modal:', error);
                showError('×©×’×™××” ×‘×¤×ª×™×—×ª ×—×œ×•×Ÿ ×©×™×•×š ××§×¦×•×¢×•×ª');
                showLoading(false);
            }
        }

        // Open Assign Instructor to Coordinator Modal (global function for onclick)
        window.openAssignInstructorToCoordModal = async function(instructorEmail) {
            try {
                showLoading(true);

                const instructorData = userRoles[instructorEmail];
                if (!instructorData) {
                    showError('××“×¨×™×š ×œ× × ××¦×');
                    showLoading(false);
                    return;
                }

                // Store the instructor email for later use
                window.currentAssignInstructorEmail = instructorEmail;

                // Display instructor name
                document.getElementById('adminSelectedInstructorName').textContent = `ğŸ‘¤ ${instructorData.fullName || instructorEmail}`;

                // Load all coordinators
                const coordinators = Object.entries(userRoles)
                    .filter(([email, userData]) => userData.role === 'coordinator')
                    .map(([email, userData]) => ({
                        email: email,
                        name: userData.fullName || email
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

                // Populate coordinator dropdown
                const coordSelect = document.getElementById('adminSelectCoordinator');
                coordSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¨×›×– --</option>';
                coordinators.forEach(coord => {
                    const option = document.createElement('option');
                    option.value = coord.email;
                    option.textContent = coord.name;
                    coordSelect.appendChild(option);
                });

                // Show current assignments for this instructor
                const assignmentsArea = document.getElementById('adminCurrentAssignments');
                const assignmentsList = document.getElementById('adminCurrentAssignmentsList');

                const assignments = [];
                Object.entries(userRoles).forEach(([coordEmail, coordData]) => {
                    if (coordData.role !== 'coordinator') return;
                    if (!coordData.assignedInstructors) return;

                    const assignment = coordData.assignedInstructors.find(
                        inst => (typeof inst === 'string' ? inst : inst.email) === instructorEmail
                    );

                    if (assignment) {
                        const subjects = typeof assignment === 'string' ? [] : (assignment.subjects || []);
                        assignments.push({
                            coordEmail,
                            coordName: coordData.fullName || coordEmail,
                            subjects
                        });
                    }
                });

                if (assignments.length === 0) {
                    assignmentsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 12px;">××™×Ÿ ×©×™×•×›×™× ×§×™×™××™×</p>';
                } else {
                    assignmentsList.innerHTML = '';
                    assignments.forEach(({ coordEmail, coordName, subjects }) => {
                        const assignmentCard = document.createElement('div');
                        assignmentCard.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px;';
                        assignmentCard.innerHTML = `
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${coordName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${subjects.length > 0 ? subjects.join(', ') : '×œ×œ× ××§×¦×•×¢×•×ª'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="edit-assignment-btn" data-coord-email="${coordEmail}" data-instructor-email="${instructorEmail}"
                                    style="padding: 6px 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                                    âœï¸ ×¢×¨×•×š
                                </button>
                                <button class="remove-assignment-btn" data-coord-email="${coordEmail}" data-instructor-email="${instructorEmail}"
                                    style="padding: 6px 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Bricolage Grotesque', sans-serif;">
                                    ğŸ—‘ï¸ ×”×¡×¨
                                </button>
                            </div>
                        `;
                        assignmentsList.appendChild(assignmentCard);
                    });

                    // Add edit button listeners
                    document.querySelectorAll('.edit-assignment-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const coordEmail = e.target.getAttribute('data-coord-email');
                            const instructorEmailToEdit = e.target.getAttribute('data-instructor-email');

                            try {
                                showLoading(true);

                                const coordData = userRoles[coordEmail];
                                const assignment = coordData.assignedInstructors.find(
                                    inst => (typeof inst === 'string' ? inst : inst.email) === instructorEmailToEdit
                                );

                                if (!assignment) {
                                    showError('×œ× × ××¦× ×©×™×•×š');
                                    showLoading(false);
                                    return;
                                }

                                const currentSubjects = typeof assignment === 'object' ? (assignment.subjects || []) : [];
                                const coordSubjects = getAllUserSubjects(coordData);

                                // Create edit modal
                                const editModal = document.createElement('div');
                                editModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10001;';

                                const editModalContent = document.createElement('div');
                                editModalContent.style.cssText = 'background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border-color);';

                                const instructorData = userRoles[instructorEmailToEdit];
                                editModalContent.innerHTML = `
                                    <h3 style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">
                                        âœï¸ ×¢×¨×•×š ×©×™×•×š ××§×¦×•×¢×•×ª
                                    </h3>
                                    <p style="color: var(--text-secondary); margin-bottom: 8px;">××“×¨×™×š: <strong>${instructorData.fullName}</strong></p>
                                    <p style="color: var(--text-secondary); margin-bottom: 24px;">×¨×›×–: <strong>${coordData.fullName}</strong></p>
                                    <div id="editSubjectCheckboxesAdmin" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px;"></div>
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button id="cancelEditAdminBtn" class="btn" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
                                            ×‘×™×˜×•×œ
                                        </button>
                                        <button id="saveEditAdminBtn" class="btn btn-primary" style="padding: 12px 24px;">
                                            ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
                                        </button>
                                    </div>
                                `;

                                editModal.appendChild(editModalContent);
                                document.body.appendChild(editModal);

                                // Populate checkboxes - get directly from coordinator's subjects structure
                                const checkboxContainer = document.getElementById('editSubjectCheckboxesAdmin');
                                const morningSubjs = coordData.subjects?.morning || [];
                                const afternoonSubjs = coordData.subjects?.afternoon || [];

                                // Add morning subjects
                                if (morningSubjs.length > 0) {
                                    const morningSection = document.createElement('div');
                                    morningSection.innerHTML = '<div style="font-weight: 600; color: #3b82f6; margin-bottom: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-right: 4px solid #3b82f6;">ğŸ“… ××©××¨×ª ×‘×•×§×¨</div>';
                                    checkboxContainer.appendChild(morningSection);

                                    morningSubjs.forEach(subject => {
                                        const wrapper = document.createElement('label');
                                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; cursor: pointer; margin-right: 16px;';

                                        const checkbox = document.createElement('input');
                                        checkbox.type = 'checkbox';
                                        checkbox.value = subject;
                                        checkbox.checked = currentSubjects.includes(subject);
                                        checkbox.className = 'edit-subject-checkbox-admin';
                                        checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';

                                        const label = document.createElement('span');
                                        label.textContent = subject;
                                        label.style.cssText = 'color: var(--text-primary); font-size: 15px; font-weight: 500;';

                                        wrapper.appendChild(checkbox);
                                        wrapper.appendChild(label);
                                        checkboxContainer.appendChild(wrapper);
                                    });
                                }

                                // Add afternoon subjects
                                if (afternoonSubjs.length > 0) {
                                    const afternoonSection = document.createElement('div');
                                    afternoonSection.innerHTML = '<div style="font-weight: 600; color: #f59e0b; margin: 16px 0 8px 0; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-right: 4px solid #f59e0b;">ğŸŒ… ××©××¨×ª ××—×¨ ×”×¦×”×¨×™×™×</div>';
                                    checkboxContainer.appendChild(afternoonSection);

                                    afternoonSubjs.forEach(subject => {
                                        const wrapper = document.createElement('label');
                                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; cursor: pointer; margin-right: 16px;';

                                        const checkbox = document.createElement('input');
                                        checkbox.type = 'checkbox';
                                        checkbox.value = subject;
                                        checkbox.checked = currentSubjects.includes(subject);
                                        checkbox.className = 'edit-subject-checkbox-admin';
                                        checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';

                                        const label = document.createElement('span');
                                        label.textContent = subject;
                                        label.style.cssText = 'color: var(--text-primary); font-size: 15px; font-weight: 500;';

                                        wrapper.appendChild(checkbox);
                                        wrapper.appendChild(label);
                                        checkboxContainer.appendChild(wrapper);
                                    });
                                }

                                // Handle cancel
                                document.getElementById('cancelEditAdminBtn').addEventListener('click', () => {
                                    document.body.removeChild(editModal);
                                });

                                // Handle save
                                document.getElementById('saveEditAdminBtn').addEventListener('click', async () => {
                                    const checkboxes = document.querySelectorAll('.edit-subject-checkbox-admin:checked');
                                    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);

                                    if (selectedSubjects.length === 0) {
                                        showError('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××§×¦×•×¢ ××—×“');
                                        return;
                                    }

                                    try {
                                        showLoading(true);

                                        // Find and update the assignment
                                        const assignmentIndex = coordData.assignedInstructors.findIndex(
                                            inst => (typeof inst === 'string' ? inst : inst.email) === instructorEmailToEdit
                                        );

                                        if (assignmentIndex > -1) {
                                            coordData.assignedInstructors[assignmentIndex] = {
                                                email: instructorEmailToEdit,
                                                subjects: selectedSubjects
                                            };
                                        }

                                        // Update in userRoles
                                        userRoles[coordEmail].assignedInstructors = coordData.assignedInstructors;

                                        // Save to Firebase
                                        const coordPath = getUserPath(coordEmail);
                                        const coordRef = ref(database, `${coordPath}/assignedInstructors`);
                                        await set(coordRef, coordData.assignedInstructors);

                                        showSuccess('×”×©×™×•×š ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! âœ…');
                                        document.body.removeChild(editModal);

                                        // Refresh the main modal
                                        window.openAssignInstructorToCoordModal(instructorEmailToEdit);

                                        // Update admin lists
                                        if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                                            await loadAdminInstructorsList();
                                        }
                                        if (document.getElementById('adminManageCoordinators')?.style.display !== 'none') {
                                            await loadAdminCoordinatorsList();
                                        }

                                        showLoading(false);
                                    } catch (error) {
                                        console.error('Error updating assignment:', error);
                                        showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×™×•×š: ' + error.message);
                                        showLoading(false);
                                    }
                                });

                                showLoading(false);
                            } catch (error) {
                                console.error('Error editing assignment:', error);
                                showError('×©×’×™××” ×‘×¢×¨×™×›×ª ×”×©×™×•×š: ' + error.message);
                                showLoading(false);
                            }
                        });
                    });

                    // Add remove button listeners
                    document.querySelectorAll('.remove-assignment-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const coordEmail = e.target.getAttribute('data-coord-email');
                            const instructorEmailToRemove = e.target.getAttribute('data-instructor-email');

                            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×”×©×™×•×š?`)) {
                                return;
                            }

                            try {
                                showLoading(true);

                                const coordData = userRoles[coordEmail];

                                // Remove the instructor from coordinator's assignedInstructors
                                coordData.assignedInstructors = coordData.assignedInstructors.filter(
                                    inst => (typeof inst === 'string' ? inst : inst.email) !== instructorEmailToRemove
                                );

                                // Update in userRoles
                                userRoles[coordEmail].assignedInstructors = coordData.assignedInstructors;

                                // Save to Firebase
                                const coordPath = getUserPath(coordEmail);
                                const coordRef = ref(database, `${coordPath}/assignedInstructors`);
                                await set(coordRef, coordData.assignedInstructors);

                                showSuccess('×”×©×™×•×š ×”×•×¡×¨ ×‘×”×¦×œ×—×”');

                                // Refresh the modal
                                window.openAssignInstructorToCoordModal(instructorEmailToRemove);

                                // Update admin instructors list
                                if (document.getElementById('adminManageInstructors')?.style.display !== 'none') {
                                    await loadAdminInstructorsList();
                                }

                                // Update coordinators list
                                if (document.getElementById('adminManageCoordinators')?.style.display !== 'none') {
                                    await loadAdminCoordinatorsList();
                                }

                                showLoading(false);
                            } catch (error) {
                                console.error('Error removing assignment:', error);
                                showError('×©×’×™××” ×‘×”×¡×¨×ª ×”×©×™×•×š: ' + error.message);
                                showLoading(false);
                            }
                        });
                    });
                }

                assignmentsArea.style.display = 'block';

                showLoading(false);

                // Show the modal
                document.getElementById('assignToCoordModal').style.display = 'flex';

            } catch (error) {
                console.error('Error opening assign instructor modal:', error);
                showError('×©×’×™××” ×‘×¤×ª×™×—×ª ×—×œ×•×Ÿ ×©×™×•×š ××“×¨×™×š');
                showLoading(false);
            }
        }

        // Close Assign Subject Modal
        document.getElementById('closeAssignSubjectModal')?.addEventListener('click', () => {
            document.getElementById('assignSubjectModal').style.display = 'none';
            document.getElementById('assignSubjectCoordSelect').value = '';
            document.getElementById('currentSubjectsDisplay').style.display = 'none';
            document.getElementById('subjectSelectionArea').style.display = 'none';
            document.getElementById('confirmAssignSubjectBtn').style.opacity = '0.5';
            document.getElementById('confirmAssignSubjectBtn').style.pointerEvents = 'none';
        });

        // Click outside to close
        document.getElementById('assignSubjectModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'assignSubjectModal') {
                document.getElementById('assignSubjectModal').style.display = 'none';
                document.getElementById('assignSubjectCoordSelect').value = '';
                document.getElementById('currentSubjectsDisplay').style.display = 'none';
                document.getElementById('subjectSelectionArea').style.display = 'none';
                document.getElementById('confirmAssignSubjectBtn').style.opacity = '0.5';
                document.getElementById('confirmAssignSubjectBtn').style.pointerEvents = 'none';
            }
        });

        // Confirm Assign Subject Button
        document.getElementById('confirmAssignSubjectBtn')?.addEventListener('click', async () => {
            const data = window.currentAssignSubjectData;
            if (!data) return;

            try {
                showLoading(true);

                // Collect selected subjects
                const selectedMorning = [];
                const selectedAfternoon = [];

                document.querySelectorAll('#morningSubjectsCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                    selectedMorning.push(cb.value);
                });

                document.querySelectorAll('#afternoonSubjectsCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                    selectedAfternoon.push(cb.value);
                });

                // Update Firebase
                const sanitizedEmail = sanitizeEmail(data.coordEmail);
                const coordRef = ref(database, `users/coordinators/${sanitizedEmail}/subjects`);
                await set(coordRef, {
                    morning: selectedMorning,
                    afternoon: selectedAfternoon
                });

                // Update local userRoles immediately
                if (userRoles[data.coordEmail]) {
                    userRoles[data.coordEmail].subjects = {
                        morning: selectedMorning,
                        afternoon: selectedAfternoon
                    };
                }

                showSuccess('×”××§×¦×•×¢×•×ª ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”! âœ…');
                document.getElementById('assignSubjectModal').style.display = 'none';
                await loadAdminCoordinatorsList();
                await loadAdminDepartmentsList();
            } catch (error) {
                console.error('Error assigning subjects:', error);
                showError('×©×’×™××” ×‘×©×™×•×š ×”××§×¦×•×¢×•×ª');
            } finally {
                showLoading(false);
            }
        });

        // Delete Coordinator (global function for onclick)
        window.deleteCoordinator = async function(coordEmail) {
            const coordData = userRoles[coordEmail];
            if (!coordData) return;

            const displayName = coordData.fullName || coordData.email || coordEmail;

            const confirmed = await showConfirmation(
                '××—×™×§×ª ×¨×›×–',
                `×”×× ×œ××—×•×§ ××ª ×”×¨×›×– "${displayName}"?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`,
                'ğŸ—‘ï¸'
            );

            if (!confirmed) return;

            try {
                showLoading(true);

                // Delete from users/coordinators
                const sanitizedEmail = sanitizeEmail(coordEmail);
                const coordRef = ref(database, `users/coordinators/${sanitizedEmail}`);
                await remove(coordRef);

                // Remove from local userRoles
                delete userRoles[coordEmail];

                showSuccess(`×”×¨×›×– ${displayName} × ××—×§ ×‘×”×¦×œ×—×” âœ…`);
                await loadAdminCoordinatorsList();
            } catch (error) {
                console.error('Error deleting coordinator:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¨×›×–');
            } finally {
                showLoading(false);
            }
        }

        // ===== DEPARTMENTS MANAGEMENT EVENT LISTENERS =====

        // Add Department Button - Open Modal
        document.getElementById('addDepartmentBtn')?.addEventListener('click', () => {
            document.getElementById('addDepartmentModal').style.display = 'flex';
            document.getElementById('addDepartmentForm').reset();
        });

        // Close Add Department Modal
        document.getElementById('closeAddDepartmentModal')?.addEventListener('click', () => {
            document.getElementById('addDepartmentModal').style.display = 'none';
            document.getElementById('addDepartmentForm').reset();
        });

        // Click outside to close
        document.getElementById('addDepartmentModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'addDepartmentModal') {
                document.getElementById('addDepartmentModal').style.display = 'none';
                document.getElementById('addDepartmentForm').reset();
            }
        });

        // Add Department Form Submit
        document.getElementById('addDepartmentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const deptName = document.getElementById('departmentName').value.trim();
            const timeOfDay = document.querySelector('input[name="timeOfDay"]:checked')?.value;

            if (!deptName || !timeOfDay) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            try {
                showLoading(true);

                // Save to departments/{timeOfDay}/{name}
                const deptRef = ref(database, `departments/${timeOfDay}/${deptName}`);

                // Check if already exists
                const snapshot = await get(deptRef);
                if (snapshot.exists()) {
                    showError('××—×œ×§×” ×–×• ×›×‘×¨ ×§×™×™××ª');
                    showLoading(false);
                    return;
                }

                await set(deptRef, true);  // Just store true to mark existence

                showSuccess(`×”××—×œ×§×” "${deptName}" × ×•×¡×¤×” ×‘×”×¦×œ×—×”! âœ…`);
                document.getElementById('addDepartmentModal').style.display = 'none';
                document.getElementById('addDepartmentForm').reset();
                await loadAdminDepartmentsList();
            } catch (error) {
                console.error('Error adding department:', error);
                showError('×©×’×™××” ×‘×”×•×¡×¤×ª ×”××—×œ×§×”');
            } finally {
                showLoading(false);
            }
        });

        // Delete Department (global function for onclick)
        window.deleteDepartment = async function(timeOfDay, deptName) {
            const confirmed = await showConfirmation(
                '××—×™×§×ª ××—×œ×§×”',
                `×”×× ×œ××—×•×§ ××ª ×”××—×œ×§×” "${deptName}"?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`,
                'ğŸ—‘ï¸'
            );

            if (!confirmed) return;

            try {
                showLoading(true);

                // Delete from departments/{timeOfDay}/{name}
                const deptRef = ref(database, `departments/${timeOfDay}/${deptName}`);
                await remove(deptRef);

                // Remove from all coordinators' subjects
                const updates = {};
                Object.entries(userRoles).forEach(([email, userData]) => {
                    if (userData.role === 'coordinator' && userData.subjects) {
                        if (typeof userData.subjects === 'object' && !Array.isArray(userData.subjects)) {
                            // Handle {morning: [...], afternoon: [...]} structure
                            const newMorning = (userData.subjects.morning || []).filter(s => s !== deptName);
                            const newAfternoon = (userData.subjects.afternoon || []).filter(s => s !== deptName);

                            if (newMorning.length !== (userData.subjects.morning || []).length ||
                                newAfternoon.length !== (userData.subjects.afternoon || []).length) {
                                updates[`users/coordinators/${email}/subjects`] = {
                                    morning: newMorning,
                                    afternoon: newAfternoon
                                };
                            }
                        }
                    }
                });

                if (Object.keys(updates).length > 0) {
                    await update(ref(database), updates);
                }

                showSuccess(`×”××—×œ×§×” "${deptName}" × ××—×§×” ×‘×”×¦×œ×—×” âœ…`);
                await loadAdminDepartmentsList();
                await loadAdminCoordinatorsList();
            } catch (error) {
                console.error('Error deleting department:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ×”××—×œ×§×”');
            } finally {
                showLoading(false);
            }
        }

        // ===== REALTIME LISTENERS FOR DYNAMIC UPDATES =====

        // Setup listeners for coordinators changes
        const coordinatorsRef = ref(database, 'users/coordinators');
        onValue(coordinatorsRef, (snapshot) => {
            if (snapshot.exists()) {
                const coordinators = snapshot.val();

                // First, remove all old coordinators from userRoles
                Object.keys(userRoles).forEach(key => {
                    if (userRoles[key]?.role === 'coordinator') {
                        delete userRoles[key];
                    }
                });

                // Then add the current coordinators
                Object.entries(coordinators).forEach(([sanitizedEmail, data]) => {
                    // Ensure email field exists, if not, unsanitize the key
                    if (!data.email) {
                        data.email = sanitizedEmail.replace(/_/g, '.');
                    }
                    // IMPORTANT: Use the REAL email (with dots) as the key, not sanitized!
                    const normalEmail = data.email || unsanitizeEmail(sanitizedEmail);
                    userRoles[normalEmail] = data;
                });

                // Check if current user is admin and update relevant lists
                if (currentUserData?.role === 'admin') {
                    const currentTab = document.querySelector('.nav-tab.active')?.dataset.tab;

                    if (currentTab === 'admin-manage-coordinators') {
                        loadAdminCoordinatorsList();
                    }
                }
            }
        });

        // Setup listeners for departments changes
        const departmentsRef = ref(database, 'departments');
        onValue(departmentsRef, (snapshot) => {
            if (currentUserData?.role === 'admin') {
                const currentTab = document.querySelector('.nav-tab.active')?.dataset.tab;

                if (currentTab === 'admin-manage-departments') {
                    loadAdminDepartmentsList();
                }
            }
        });

    </script>
</body>
</html>

